<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>stl-UDHIS | Quantum AI Assistant Platform</title>
    
    <!-- Quantum Engine & AI Libraries -->
    <script src="https://cdn.tailwindcss.com">

// Helper: insert card after marker comment <!-- INSERT_INJECTION_AFTER_EXPORT_DATA -->
function insertCardAfterMarker(card, sidebar){
  try{
    // search for comment node marker inside sidebar
    var walker = document.createTreeWalker(sidebar, NodeFilter.SHOW_COMMENT, null, false);
    var marker = null;
    while(walker.nextNode()){
      var n = walker.currentNode;
      if(n && n.nodeValue && n.nodeValue.indexOf('INSERT_INJECTION_AFTER_EXPORT_DATA') !== -1){
        marker = n;
        break;
      }
    }
    if(marker && marker.parentNode){
      marker.parentNode.insertBefore(card, marker.nextSibling);
      return;
    }
  }catch(e){
    console.warn('insertCardAfterMarker fallback', e);
  }
  // fallback
  try{ sidebar.appendChild(card); }catch(e){}
}

</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- heavy lib replaced by lazy-loader -->
    <!-- heavy lib replaced by lazy-loader -->
    <!-- heavy lib replaced by lazy-loader -->
    
    <!-- Advanced AI & Voice Libraries -->
    <!-- heavy lib replaced by lazy-loader -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    
    <!-- Advanced UI Libraries -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Quantum Font System - MAX LENGKAP! -->
<!-- Quantum Font System - MINIFIED (23 Fonts â†’ 1 URL) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@300;400;500;600;700;800;900&family=Orbitron:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@300;400;500;600;700&family=Oxanium:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@300;400;500;600;700;800;900&family=Orbitron:wght@400;500;600;700;800;900&family=Nunito+Sans:wght@300;400;600;700;800;900&family=Playfair+Display:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&family=Raleway:wght@300;400;500;600;700;800;900&family=Urbanist:wght@300;400;500;600;700;800;900&family=Montserrat:wght@300;400;500;600;700;800;900&family=Open+Sans:wght@300;400;500;600;700;800&family=Source+Sans+Pro:wght@300;400;600;700;900&family=Roboto:wght@300;400;500;700;900&family=Lato:wght@300;400;700;900&family=Merriweather:wght@300;400;700;900&family=Noto+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@300;400;500;600;700&family=Fira+Code:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&family=Syne:wght@400;500;600;700;800&family=Chakra+Petch:wght@300;400;500;600;700&family=Exo+2:wght@300;400;500;600;700;800;900&family=Audiowide&display=swap" rel="stylesheet">

    <!-- REMOVED DEV_lgts_core BY OWNER REQUEST -->
    <!-- DEV_mga1-Ultimate CHILD SUITE - paste above your style root / stl-ultra-style -->
<script id="DEV_mga1_child_suite">
(function(){
  if(window.__DEV_mga1_child_suite_done) return;
  window.__DEV_mga1_child_suite_done = true;
  const log = (...a)=>{ try{ console.info('[DEV_mga1-child]', ...a); }catch(e){} };
  const err = (...a)=>{ try{ console.error('[DEV_mga1-child]', ...a); }catch(e){} };

  /* ---------- CONFIG ---------- */
  const CHECK_INTERVAL = 600; // ms between light checks for DEV_mg presence
  const SELF_HEAL_INTERVAL = 3000; // ms for self-heal low-cost loop (optimized)
  const PROMOTE_THROTTLE_MS = 250; // throttle promotions
  const SENSOR_ID = 'DEV_mg'; // element id or global to detect
  const ALLOWED_PROMOTE_CODE = 'DEV_iy'; // matches DEV_mg accept code in file (read-only usage)
  const CHILD_META_TAG = { name: 'DEV_mga1-child-suite', version:'1.0.0' };

  /* ---------- UTILS ---------- */
  function when(conditionFn, cb, timeout=20000){
    const start=Date.now();
    (function poll(){
      try{
        if(conditionFn()) return cb();
        if(Date.now()-start > timeout) return err('when(): timeout waiting condition');
      }catch(e){ err('when() error', e); return; }
      setTimeout(poll, 120);
    })();
  }
  function safeCall(fn){ try{ return fn(); }catch(e){ err('safeCall', e); return null; } }

  /* ---------- 1) MINIFIER (worker fallback) ---------- */
  // Inline worker that performs a simple minify: remove comments + trim whitespace
  const workerSrc = `
    self.onmessage = function(e){
      const code = e.data.code || '';
      const id = e.data.id || 0;
      try{
        // very simple minify: remove /*...*/ and //... plus collapse whitespace
        let out = code.replace(/\\/\\*[\\s\\S]*?\\*\\//g,'');
        out = out.replace(/(^|\\n)\\s*\\/\\/.*(?=\\n|$)/g,'\\n');
        out = out.replace(/\\n\\s+/g,'\\n');
        out = out.replace(/\\s{2,}/g,' ');
        out = out.trim();
        // send back
        postMessage({ok:true, id:id, min: out});
      }catch(err){
        postMessage({ok:false, id:id, err: String(err)});
      }
    };
  `;
  let minifierWorker = null;
  try{
    const blob = new Blob([workerSrc], {type:'application/javascript'});
    try{ if(!minifierWorker){ minifierWorker = new Worker(URL.createObjectURL(blob)); } }catch(e){ minifierWorker = null; }
    log('minifier worker inited');
  }catch(e){
    err('worker init failed, will fallback to inline minifier', e);
    minifierWorker = null;
  }

  function minifyCode(code, cb, id=Date.now()){
    if(minifierWorker){
      const onmsg = (m)=>{
        try{
          const d = m.data || {};
          if(d.id !== id) return;
          minifierWorker.removeEventListener('message', onmsg);
          cb(d.ok ? d.min : null, d.err);
        }catch(e){ err('worker onmsg error', e); cb(null,e); }
      };
      minifierWorker.addEventListener('message', onmsg);
      minifierWorker.postMessage({code:code, id:id});
      return;
    }
    // fallback: inline minify
    try{
      let out = code.replace(/\/\*[\s\S]*?\*\//g,'');
      out = out.replace(/(^|\n)\s*\/\/.*(?=\n|$)/g,'\n');
      out = out.replace(/\n\s+/g,'\n');
      out = out.replace(/\s{2,}/g,' ');
      out = out.trim();
      cb(out);
    }catch(e){ cb(null,e); }
  }

  /* ---------- 2) QUANTUM SHIELD (intercept dynamic script injection) ---------- */
  // Intercept calls that try to append <script> dynamically (basic)
  (function installScriptInterceptor(){
    try{
      const origAppend = Element.prototype.appendChild;
      Element.prototype.appendChild = function(node){
        try{
          if(node && node.tagName && node.tagName.toLowerCase() === 'script'){
            // Quick inspect
            const src = node.src || '';
            const txt = node.textContent || '';
            const small = (src || txt).slice(0,300);
            log('Script injection intercepted', small);
            // run a quick safety check (no eval encoded payload)
            if(/eval\\(|new Function\\(|atob\\(|document\\.write\\(/i.test(txt) || /data:text\\/javascript/.test(src)){
              // neutralize harmful injection - convert to inert
              node.type = 'application/javascript;protected';
              node.setAttribute('data-protected','1');
              // schedule audit
              setTimeout(()=>{ try{ window.__DEV_mga1_protec_audit && window.__DEV_mga1_protec_audit(node); }catch(e){} }, 20);
            }
          }
        }catch(e){}
        return origAppend.call(this, node);
      };
      log('Quantum Shield: script append interceptor installed.');
    }catch(e){ err('installScriptInterceptor failed', e); }
  })();

  /* ---------- 3) SELF-HEAL LOOP (light) ---------- */
  let selfHealHandle = null;
  function startSelfHeal(){
    if(selfHealHandle) return;
    selfHealHandle = setInterval(()=>{
      try{
        // 1) Ensure DEV_mg exists and not tampered
        if(window.DEV_mg && window.DEV_mg.__installed){
          // call light audit if available
          if(typeof window.DEV_mg.auditProtections === 'function'){
            try{ window.DEV_mg.auditProtections(); }catch(e){}
          }
        }
        // 2) Ensure critical DOM nodes exist (non-destructive)
        ['stl-open','quantumParticles','quantumIsland'].forEach(id=>{
          if(id && !document.getElementById(id)){
            // nothing destructive: log only
            // we could re-create minimal placeholder if needed
          }
        });
      }catch(e){ err('self-heal tick error', e); }
    }, SELF_HEAL_INTERVAL);
    log('Self-heal loop started.');
  }

  /* ---------- 4) CHILD GUARDIAN MODULES: DEV_mggp and DEV_mggplg ---------- */
  const DEV_mggp = {
    name:'DEV_mggp',
    protectors: [],
    init: function(){
      log('DEV_mggp init');
      // basic protection: watch critical selectors then notify DEV_mg
      const crit = ['#quantumParticles','#stl-open','.quantum-neural-background','body'];
      try{
        const mo = new MutationObserver((mutations)=>{
          try{
            let suspicious=false;
            for(const m of mutations){
              if(m.type==='childList' && m.addedNodes && m.addedNodes.length){
                suspicious = true;
                break;
              }
            }
            if(suspicious && window.DEV_mg && typeof window.DEV_mg.auditProtections === 'function'){
              try{ window.DEV_mg.auditProtections(); }catch(e){ err('mggp auditProtections call failed', e); }
            }
          }catch(e){ err('mggp MO error', e); }
        });
        mo.observe(document.documentElement || document, {childList:true, subtree:true});
        this._mo = mo;
        log('DEV_mggp MutationObserver active.');
      }catch(e){ err('DEV_mggp init fail', e); }
    },
    shutdown: function(){ try{ this._mo && this._mo.disconnect(); }catch(e){} }
  };

  const DEV_mggplg = {
    name:'DEV_mggplg',
    lastReportAt:0,
    reportPeriodMs: 1, // aggressively frequent but we'll throttle real sends
    init: function(){
      log('DEV_mggplg init - legacy auditor');
      // micro-auditor: check that DEV_lg functions aren't overwritten
      const check = ()=>{
        try{
          const now = Date.now();
          if(now - this.lastReportAt < PROMOTE_THROTTLE_MS) return;
          this.lastReportAt = now;
          const snapshot = {};
          if(window.DEV_lg){
            try{
              for(const k in window.DEV_lg){
                if(typeof window.DEV_lg[k] === 'function') snapshot[k] = 'fn';
                else snapshot[k] = typeof window.DEV_lg[k];
              }
            }catch(e){ snapshot.error='dev_lg_snapshot_failed'; }
          }
          // send lightweight report to DEV_mg if API available
          if(window.DEV_mg && typeof window.DEV_mg.listKits === 'function'){
            try{
              if(typeof window.DEV_mg.auditProtections === 'function') window.DEV_mg.auditProtections();
            }catch(e){ err('DEV_mggplg reporting error', e); }
          }
        }catch(e){ err('DEV_mggplg check error', e); }
      };
      this._interval = setInterval(check, Math.max(1, this.reportPeriodMs));
    },
    shutdown: function(){ try{ clearInterval(this._interval); }catch(e){} }
  };

  /* ---------- 5) DEV_ktlp FLOW (onboard new scripts safely) ---------- */
  const DEV_ktlp = {
    queue: [],
    addons: [],
    submitProposal: function(meta, codeText){
      // meta = {name, author, version, description}
      const id = 'ktlp-'+Date.now()+'-'+Math.floor(Math.random()*9999);
      this.queue.push({id, meta, codeText, status:'queued'});
      log('DEV_ktlp proposal queued', id, meta.name || '');
      // process async
      setTimeout(()=> processProposal(id), 10);
      return id;
    },
    listQueued: ()=> DEV_ktlp.queue.slice()
  };

  function processProposal(id){
    try{
      const item = DEV_ktlp.queue.find(x=>x.id===id);
      if(!item) return;
      item.status = 'scanning';
      // 1) minify via worker
      minifyCode(item.codeText, (minified, errMsg)=>{
        if(!minified){
          item.status='error';
          item.err = errMsg;
          return;
        }
        item.status='scanned';
        item.minified = minified;
        // 2) run quick safety check: no eval/Function/new Function etc
        const bad = /(^|\\W)(eval|Function|constructor|document\\.write|innerHTML\\s*=)/i.test(minified);
        if(bad){
          item.status='rejected';
          item.reason='unsafe_patterns';
          log('DEV_ktlp rejected unsafe', item.id);
          return;
        }
        // 3) ask DEV_mg to promote (if available)
        if(window.DEV_mg && typeof window.DEV_mg.requestPromotion === 'function'){
          try{
            const offer = { id:item.id, meta:item.meta, snippet: item.minified.slice(0,512), origin:'DEV_ktlp' };
            // requestPromotion may accept an object; be defensive
            try{ window.DEV_mg.requestPromotion(offer); item.status='promoted_requested'; }
            catch(e){ item.status='promote_failed'; item.err=e; err('requestPromotion failed', e); }
          }catch(e){ err('DEV_ktlp promotion call failed', e); }
        } else if(window.DEV_mg && typeof window.DEV_mg.promoteNow === 'function'){
          try{ window.DEV_mg.promoteNow(); item.status='promote_now_called'; }catch(e){ item.status='promote_now_failed'; err(e); }
        } else {
          item.status='ready_local';
          // keep as DEV_ktlp$ locally approved by child suite - but do not inject automatically
          item.status='DEV_ktlp$_local';
          DEV_ktlp.addons.push(item);
          log('DEV_ktlp local approval (no DEV_mg api present)', item.id);
        }
      });
    }catch(e){ err('processProposal top error', e); }
  }

  /* ---------- 6) BOOTSTRAP: Wait for DOM and then for DEV_mg (light) ---------- */
  function bootstrap(){
    try{
      // init child modules safe
      DEV_mggp.init();
      DEV_mggplg.init();
      startSelfHeal();

      // lightweight hook: if DEV_mg present, call audit to integrate children
      when(()=> !!window.DEV_mg, ()=>{
        log('DEV_mg detected. Integrating child suite with DEV_mg API if possible.');
        try{
          // expose child info to DEV_mg (non-destructive)
          if(window.DEV_mg && typeof window.DEV_mg.listKits === 'function'){
            try{
              // advertise our presence (non-invasive)
              if(!window.DEV_mg.__childSuites) window.DEV_mg.__childSuites = [];
              window.DEV_mg.__childSuites.push(CHILD_META_TAG);
            }catch(e){}
          }
          // try to run a light promote/handshake
          if(window.DEV_mg && typeof window.DEV_mg.auditProtections === 'function'){
            try{ window.DEV_mg.auditProtections(); }catch(e){}
          }
          // if promoteNow exists, run a gentle promoteNow (non-destructive)
          if(window.DEV_mg && typeof window.DEV_mg.promoteNow === 'function'){
            try{ window.DEV_mg.promoteNow(); }catch(e){}
          }
        }catch(e){ err('bootstrap integration error', e); }
      }, 20000);
    }catch(e){ err('bootstrap error', e); }
  }

  // Auto-start after DOM ready
  if(document.readyState === 'complete' || document.readyState === 'interactive'){
    setTimeout(bootstrap, 10);
  } else document.addEventListener('DOMContentLoaded', bootstrap);

  /* ---------- 7) Public debug API for developer (non-destructive) ---------- */
  try{
    const suite = {
      __meta: CHILD_META_TAG,
      minifyCode,
      submitProposal: (m, c)=> DEV_ktlp.submitProposal(m,c),
      listProposals: ()=> DEV_ktlp.listQueued(),
      listAddons: ()=> DEV_ktlp.addons.slice(),
      stop: function(){
        try{ DEV_mggp.shutdown(); DEV_mggplg.shutdown(); clearInterval(selfHealHandle); log('child suite stopped'); }catch(e){}
      }
    };
    Object.defineProperty(window, 'DEV_mga1_child_suite', {value: suite, configurable:false, writable:false});
    log('DEV_mga1_child_suite exposed on window.');
  }catch(e){ err('expose api failed', e); }

})();
</script>
    <!-- Quantum AI Nexus Custom Styles -->
    <style>
        /* ==================== QUANTUM VARIABLES & THEME SYSTEM ==================== */
        :root {
            /* Quantum Color Palette - 8 Layer Sophistication */
            --quantum-layer1: #6366f1;
            --quantum-layer2: #8b5cf6;
            --quantum-layer3: #a855f7;
            --quantum-layer4: #d946ef;
            --quantum-layer5: #ec4899;
            --quantum-layer6: #f472b6;
            --quantum-layer7: #fdf2f8;
            --quantum-layer8: #fafafa;
            
            /* Dynamic Theme Variables */
            --quantum-primary: var(--quantum-layer1);
            --quantum-secondary: var(--quantum-layer2);
            --quantum-accent: var(--quantum-layer3);
            --quantum-bg: #0f0f23;
            --quantum-card: #1a1b2f;
            --quantum-surface: #252641;
            --quantum-border: rgba(99, 102, 241, 0.3);
            --quantum-text: #e2e8f0;
            --quantum-glow: 0 0 40px rgba(99, 102, 241, 0.4);
            
            /* Quantum Gradients */
            --quantum-gradient-primary: linear-gradient(135deg, var(--quantum-layer1) 0%, var(--quantum-layer3) 50%, var(--quantum-layer5) 100%);
            --quantum-gradient-secondary: linear-gradient(135deg, var(--quantum-layer2) 0%, var(--quantum-layer4) 100%);
            --quantum-gradient-bg: radial-gradient(ellipse at top, #1e1b4b, #0f0f23);
            
            /* Quantum Typography - 20 Fonts System */
            --quantum-font-primary: 'Inter', 'Segoe UI', system-ui, sans-serif;
            --quantum-font-display: 'Orbitron', 'JetBrains Mono', monospace;
            --quantum-font-code: 'JetBrains Mono', 'Fira Code', monospace;
            --quantum-font-poppins: 'Poppins', sans-serif;
            --quantum-font-nunito: 'Nunito Sans', sans-serif;
            --quantum-font-playfair: 'Playfair Display', serif;
            --quantum-font-rajdhani: 'Rajdhani', sans-serif;
            --quantum-font-raleway: 'Raleway', sans-serif;
            --quantum-font-urbanist: 'Urbanist', sans-serif;
            --quantum-font-montserrat: 'Montserrat', sans-serif;
            --quantum-font-opensans: 'Open Sans', sans-serif;
            --quantum-font-sourcesans: 'Source Sans Pro', sans-serif;
            --quantum-font-roboto: 'Roboto', sans-serif;
            --quantum-font-lato: 'Lato', sans-serif;
            --quantum-font-merriweather: 'Merriweather', serif;
            --quantum-font-notosans: 'Noto Sans', sans-serif;
            --quantum-font-firacode: 'Fira Code', monospace;
            --quantum-font-spacegrotesk: 'Space Grotesk', sans-serif;
            --quantum-font-syne: 'Syne', sans-serif;
            --quantum-font-chakrapetch: 'Chakra Petch', sans-serif;
            --quantum-font-exo2: 'Exo 2', sans-serif;
            --quantum-font-audiowide: 'Audiowide', cursive;
            
            /* Quantum Effects */
            --quantum-shadow-sm: 0 2px 15px rgba(0, 0, 0, 0.3);
            --quantum-shadow-md: 0 8px 30px rgba(0, 0, 0, 0.4);
            --quantum-shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.5);
            --quantum-glow-primary: 0 0 30px color-mix(in srgb, var(--quantum-layer1) 40%, transparent);
            
            /* Quantum Glass Morphism */
            --quantum-glass-bg: rgba(255, 255, 255, 0.05);
            --quantum-glass-border: rgba(255, 255, 255, 0.1);
            --quantum-glass-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            
            /* Quantum Dimensions */
            --quantum-radius-sm: 8px;
            --quantum-radius-md: 12px;
            --quantum-radius-lg: 16px;
            --quantum-radius-xl: 20px;
            --quantum-radius-2xl: 24px;
            
            /* iOS 26 Smooth Variables */
            --ios-blur: blur(40px);
            --ios-transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --ios-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            
            /* Quantum Animations */
            --quantum-transition-fast: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --quantum-transition-normal: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            --quantum-transition-slow: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Quantum Aurora Colors */
            --quantum-aurora-1: #6366f1;
            --quantum-aurora-2: #8b5cf6;
            --quantum-aurora-3: #a855f7;
            --quantum-aurora-4: #d946ef;
            
            /* Glass Effect Intensity */
            --glass-intensity: 0.85;
            --glass-blur: 40px;
            --glass-border-opacity: 0.15;
            
            /* Base Font Size */
            --base-font-size: 16px;

            /* Particle System Variables - Connected to 8 Themes */
            --particle-golden-float: #ffd700;
            --particle-black-pulse: #000000;
            --particle-red-sword: #ff0000;
            --particle-shape-shifter: #00ff00;
            --particle-code-rain: #00ff00;
            --particle-ocean-wave: #0066ff;
            --particle-neon-pulse: #ff00ff;
            --particle-rose-float: #ff1493;

            /* Particle Animation Variables */
            --particle-animation-duration: 15s;
            --particle-animation-delay: 0s;
            --particle-size-min: 2px;
            --particle-size-max: 6px;
        }

        /* Light Mode Variables */
        .theme-light {
            --quantum-bg: #f8fafc;
            --quantum-card: #ffffff;
            --quantum-surface: #f1f5f9;
            --quantum-border: rgba(99, 102, 241, 0.2);
            --quantum-text: #1e293b;
            --quantum-gradient-bg: radial-gradient(ellipse at top, #e0e7ff, #f8fafc);
            --quantum-glass-bg: rgba(255, 255, 255, 0.8);
            --quantum-glass-border: rgba(255, 255, 255, 0.9);
            
            /* Light Mode Particle Colors */
            --particle-golden-float: #ffcc00;
            --particle-black-pulse: #666666;
            --particle-red-sword: #cc0000;
            --particle-shape-shifter: #009900;
            --particle-code-rain: #009900;
            --particle-ocean-wave: #0055cc;
            --particle-neon-pulse: #cc00cc;
            --particle-rose-float: #cc0066;
        }

        /* ==================== QUANTUM BASE STYLES ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            height: 100%;
            overflow: hidden;
            background: var(--quantum-bg);
        }

        body {
            font-family: var(--quantum-font-primary);
            background: var(--quantum-bg);
            color: var(--quantum-text);
            line-height: 1.6;
            overflow-x: hidden;
            height: 100vh;
            width: 100vw;
            position: fixed;
            touch-action: pan-x pan-y;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: var(--ios-transition);
            background: var(--quantum-gradient-bg);
        }

        /* ==================== QUANTUM NEURAL BACKGROUND ==================== */
        .quantum-neural-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            overflow: hidden;
            opacity: 0.7;
        }

        .neural-network {
            position: absolute;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, var(--quantum-aurora-1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, var(--quantum-aurora-2) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, var(--quantum-aurora-3) 0%, transparent 50%);
            filter: blur(60px);
            animation: neuralPulse 8s ease-in-out infinite;
        }

        .quantum-particles {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: var(--quantum-layer1);
            border-radius: 50%;
            animation: floatParticle 15s linear infinite;
        }

        /* Particle Animation Styles for 8 Themes */
        .particle-goldenFloat {
            background: var(--particle-golden-float);
            animation: quantumFloat var(--particle-animation-duration) linear infinite;
            animation-delay: var(--particle-animation-delay);
        }

        .particle-blackPulse {
            background: var(--particle-black-pulse);
            animation: pulseParticle var(--particle-animation-duration) ease-in-out infinite;
            animation-delay: var(--particle-animation-delay);
        }

        .particle-redSword {
            background: var(--particle-red-sword);
            animation: swordSlice var(--particle-animation-duration) linear infinite;
            animation-delay: var(--particle-animation-delay);
        }

        .particle-shapeShifter {
            background: var(--particle-shape-shifter);
            animation: shapeShift var(--particle-animation-duration) ease-in-out infinite;
            animation-delay: var(--particle-animation-delay);
        }

        .particle-codeRain {
            background: transparent;
            color: var(--particle-code-rain);
            font-family: var(--quantum-font-code);
            font-size: 14px;
            animation: codeRainFall var(--particle-animation-duration) linear infinite;
            animation-delay: var(--particle-animation-delay);
        }

        .particle-oceanWave {
            background: var(--particle-ocean-wave);
            animation: oceanWave var(--particle-animation-duration) ease-in-out infinite;
            animation-delay: var(--particle-animation-delay);
        }

        .particle-neonPulse {
            background: var(--particle-neon-pulse);
            animation: neonPulse var(--particle-animation-duration) ease-in-out infinite;
            animation-delay: var(--particle-animation-delay);
            box-shadow: 0 0 10px currentColor;
        }

        .particle-roseFloat {
            background: var(--particle-rose-float);
            animation: roseFloat var(--particle-animation-duration) ease-in-out infinite;
            animation-delay: var(--particle-animation-delay);
        }

        /* ==================== ANIMATION KEYFRAMES ==================== */
        @keyframes neuralPulse {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        @keyframes floatParticle {
            0% { transform: translateY(100vh) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100px) translateX(100px); opacity: 0; }
        }

        /* Particle Animation Keyframes */
        @keyframes quantumFloat {
            0% {
                transform: translateY(100vh) translateX(0) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) translateX(100px) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes pulseParticle {
            0%, 100% {
                transform: scale(1);
                opacity: 0.7;
            }
            50% {
                transform: scale(1.5);
                opacity: 1;
            }
        }

        @keyframes swordSlice {
            0% {
                transform: translateX(-100px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateX(100vw) rotate(720deg);
                opacity: 0;
            }
        }

        @keyframes shapeShift {
            0% {
                transform: scale(1) rotate(0deg);
                border-radius: 50%;
            }
            25% {
                transform: scale(1.2) rotate(90deg);
                border-radius: 10%;
            }
            50% {
                transform: scale(0.8) rotate(180deg);
                border-radius: 30%;
            }
            75% {
                transform: scale(1.1) rotate(270deg);
                border-radius: 40%;
            }
            100% {
                transform: scale(1) rotate(360deg);
                border-radius: 50%;
            }
        }

        @keyframes codeRainFall {
            0% {
                transform: translateY(-100px) translateX(0);
                opacity: 0;
            }
            5% {
                opacity: 1;
            }
            95% {
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) translateX(20px);
                opacity: 0;
            }
        }

        @keyframes oceanWave {
            0%, 100% {
                transform: translateY(0) translateX(0);
            }
            25% {
                transform: translateY(-20px) translateX(10px);
            }
            50% {
                transform: translateY(0) translateX(20px);
            }
            75% {
                transform: translateY(20px) translateX(10px);
            }
        }

        @keyframes neonPulse {
            0%, 100% {
                opacity: 0.3;
                box-shadow: 0 0 5px currentColor;
            }
            50% {
                opacity: 1;
                box-shadow: 0 0 20px currentColor, 0 0 30px currentColor;
            }
        }

        @keyframes roseFloat {
            0% {
                transform: translateY(100vh) translateX(0) rotate(0deg);
                opacity: 0;
            }
            20% {
                opacity: 1;
                transform: translateY(80vh) translateX(20px) rotate(90deg);
            }
            40% {
                transform: translateY(60vh) translateX(-10px) rotate(180deg);
            }
            60% {
                transform: translateY(40vh) translateX(15px) rotate(270deg);
            }
            80% {
                transform: translateY(20vh) translateX(-5px) rotate(360deg);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) translateX(0) rotate(450deg);
                opacity: 0;
            }
        }

        /* ==================== QUANTUM DYNAMIC ISLAND ==================== */
        .quantum-island {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: rgba(15, 15, 35, 0.95);
            color: var(--quantum-text);
            padding: 16px 32px;
            border-radius: 50px;
            font-family: var(--quantum-font-display);
            font-weight: 600;
            font-size: 14px;
            z-index: 10000;
            backdrop-filter: var(--ios-blur);
            -webkit-backdrop-filter: var(--ios-blur);
            border: 1px solid var(--quantum-border);
            box-shadow: var(--quantum-shadow-lg), var(--quantum-glow-primary);
            opacity: 0;
            transition: var(--ios-transition);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .quantum-island.active {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .quantum-island .pulse-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--quantum-layer1);
            animation: pulseDot 2s infinite;
        }

        @keyframes pulseDot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        /* ==================== QUANTUM SIDEBAR SYSTEMS ==================== */
        .quantum-sidebar {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100vh;
            background: var(--quantum-glass-bg);
            backdrop-filter: var(--ios-blur);
            -webkit-backdrop-filter: var(--ios-blur);
            border-left: 1px solid var(--quantum-glass-border);
            box-shadow: var(--quantum-glass-shadow);
            z-index: 10000;
            transition: var(--ios-transition);
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .quantum-sidebar.active {
            right: 0;
        }

        .quantum-sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: var(--ios-transition);
        }

        .quantum-sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Left Sidebar - Tools & API Configuration */
        .quantum-tools-sidebar {
            position: fixed;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100vh;
            background: var(--quantum-glass-bg);
            backdrop-filter: var(--ios-blur);
            -webkit-backdrop-filter: var(--ios-blur);
            border-right: 1px solid var(--quantum-glass-border);
            box-shadow: var(--quantum-glass-shadow);
            z-index: 10000;
            transition: var(--ios-transition);
            padding: 24px;
            overflow-y: auto;
        }

        .quantum-tools-sidebar.active {
            left: 0;
        }

        /* ==================== QUANTUM UI COMPONENTS ==================== */
        .quantum-card {
            background: var(--quantum-card);
            border: 1px solid var(--quantum-border);
            border-radius: var(--quantum-radius-xl);
            box-shadow: var(--quantum-shadow-md);
            position: relative;
            overflow: hidden;
            transition: var(--ios-transition);
            backdrop-filter: var(--ios-blur);
            -webkit-backdrop-filter: var(--ios-blur);
        }

        .quantum-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--quantum-layer1), transparent);
        }

        .quantum-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--quantum-shadow-lg), var(--quantum-glow-primary);
            border-color: var(--quantum-layer1);
        }

        .quantum-card.glass {
            background: rgba(255, 255, 255, calc(var(--glass-intensity) * 0.05));
            border: 1px solid rgba(255, 255, 255, var(--glass-border-opacity));
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            box-shadow: var(--quantum-glass-shadow);
            position: relative;
            overflow: hidden;
        }

        .glass-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, 
                rgba(99, 102, 241, 0.1) 0%, 
                rgba(139, 92, 246, 0.05) 50%, 
                rgba(236, 72, 153, 0.02) 100%);
            pointer-events: none;
            border-radius: inherit;
        }

        /* Gradient Border Effect */
        .quantum-card.glass::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--quantum-layer1), transparent);
        }

        .quantum-btn {
            padding: 14px 28px;
            border-radius: var(--quantum-radius-lg);
            font-weight: 600;
            font-family: var(--quantum-font-display);
            border: none;
            cursor: pointer;
            transition: var(--ios-transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 14px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .quantum-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: var(--ios-transition);
        }

        .quantum-btn:hover::before {
            left: 100%;
        }

        .quantum-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--ios-shadow);
        }

        .quantum-btn.primary {
            background: var(--quantum-gradient-primary);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .quantum-btn.secondary {
            background: var(--quantum-gradient-secondary);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        .quantum-btn.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .quantum-btn.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        }

        .quantum-btn.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        .quantum-input {
            font-size: 16px;
            padding: 16px 20px;
            border: 2px solid var(--quantum-border);
            border-radius: var(--quantum-radius-md);
            background: var(--quantum-surface);
            transition: var(--ios-transition);
            font-family: var(--quantum-font-primary);
            width: 100%;
            color: var(--quantum-text);
        }

        .quantum-input:focus {
            outline: none;
            border-color: var(--quantum-layer1);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            transform: translateY(-2px);
        }

        .quantum-input.glass {
            background: var(--quantum-glass-bg);
            border: 1px solid var(--quantum-glass-border);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* ==================== QUANTUM AI CHAT INTERFACE ==================== */
        .quantum-chat-container {
            display: none;
            flex-direction: column;
            height: 100vh;
            border-radius: var(--quantum-radius-2xl);
            overflow: hidden;
            background: var(--quantum-card);
            box-shadow: var(--quantum-shadow-lg);
            border: 1px solid var(--quantum-border);
        }

        .quantum-chat-header {
            padding: 15px 20px;
            background: var(--quantum-gradient-primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--quantum-border);
        }

        .quantum-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: var(--quantum-surface);
        }

        .quantum-message {
            max-width: 15%;
            padding: 14px 18px;
            border-radius: 18px;
            position: relative;
            animation: quantumMessageSlide 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            line-height: 1.5;
        }

        @keyframes quantumMessageSlide {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .quantum-message.user {
            align-self: flex-end;
            background: var(--quantum-gradient-primary);
            color: white;
            border-bottom-right-radius: 6px;
        }

        .quantum-message.ai {
            align-self: flex-start;
            background: var(--quantum-card);
            color: var(--quantum-text);
            border: 1px solid var(--quantum-border);
            border-bottom-left-radius: 6px;
        }

        .quantum-message.system {
            align-self: center;
            background: var(--quantum-surface);
            color: var(--quantum-text);
            border: 1px solid var(--quantum-border);
            max-width: 95%;
            text-align: center;
            font-style: italic;
        }

        .quantum-chat-input-container {
            padding: 10px 14px;
            border-top: 1px solid var(--quantum-border);
            background: var(--quantum-card);
        }

        .quantum-chat-input-row {
            display: flex;
            gap: -30px;
            align-items: flex;
        }

        .quantum-chat-actions {
            display: flex;
            gap: -180px;
            margin-top: -8px;
        }

        /* ==================== QUANTUM HOME BASE ==================== */
        .quantum-home-base {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 40px;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .quantum-home-logo {
            margin-bottom: -35px;
            animation: quantumLogoFloat 6s ease-in-out infinite;
        }

        @keyframes quantumLogoFloat {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-20px) scale(1.05); }
        }

        .quantum-home-title {
            font-size: 3.5rem;
            font-weight: 900;
            margin-bottom: -5px;
            font-family: var(--quantum-font-display);
            background: linear-gradient(135deg, var(--quantum-layer1) 0%, var(--quantum-layer3) 50%, var(--quantum-layer5) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 50px rgba(99, 102, 241, 0.5);
        }

        .quantum-home-subtitle {
            font-size: 1.2rem;
            margin-bottom: 60px;
            color: var(--quantum-text);
            opacity: 0.8;
            max-width: 600px;
        }

        .quantum-home-buttons {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .quantum-home-btn {
            padding: 20px 60px;
            border-radius: var(--quantum-radius-xl);
            font-size: 1.1rem;
            font-weight: 700;
            transition: var(--ios-transition);
            position: relative;
            overflow: hidden;
            min-width: 200px;
        }

        .quantum-home-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: var(--ios-transition);
        }

        .quantum-home-btn:hover::before {
            left: 100%;
        }

        .quantum-home-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }

        .quantum-home-btn.ai-chat {
            background: var(--quantum-gradient-primary);
            color: white;
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .quantum-home-btn.developer {
            background: var(--quantum-gradient-secondary);
            color: white;
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }

        /* ==================== QUANTUM DEVELOPER PANEL ==================== */
        .quantum-developer-panel {
            display: none;
            height: 100vh;
            overflow-y: auto;
            padding: 40px 20px;
            position: relative;
            z-index: 1;
        }

        .quantum-developer-content {
            max-width: 800px;
            margin: 0 auto;
        }

        /* ==================== QUANTUM API CONFIGURATION ==================== */
        .quantum-api-section {
            background: var(--quantum-surface);
            padding: 20px;
            border-radius: var(--quantum-radius-xl);
            margin-bottom: 20px;
            border: 1px solid var(--quantum-border);
        }

        .quantum-api-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 14px;
        }

        /* ==================== TOGGLE BUTTONS ==================== */
        .toggle-btn {
            position: fixed;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--quantum-gradient-primary);
            color: white;
            border: none;
            box-shadow: var(--quantum-shadow-md);
            z-index: 1000;
            cursor: pointer;
            transition: var(--ios-transition);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }

        .toggle-right {
            top: 10px;
            right: 2px;
        }

        .toggle-left {
            bottom: 10px;
            left: 10px;
        }

        /* ==================== QUANTUM RESPONSIVE DESIGN ==================== */
        @media (min-width: 768px) {
            .quantum-sidebar, .quantum-tools-sidebar {
                width: 480px;
            }
            .quantum-sidebar { right: -480px; }
            .quantum-tools-sidebar { left: -480px; }
            
            .quantum-home-title {
                font-size: 4.5rem;
            }
        }

        @media (max-width: 767px) {
            .quantum-btn {
                padding: 12px 20px;
                font-size: 13px;
            }
            
            .quantum-message {
                max-width: 90%;
            }
            
            .quantum-chat-input-row {
                flex-direction: column;
            }
            
            .quantum-home-title {
                font-size: 2.5rem;
            }
            
            .quantum-home-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .quantum-home-btn {
                width: 100%;
                max-width: 300px;
            }
        }

        @media (max-width: 480px) {
            .quantum-sidebar, .quantum-tools-sidebar {
                padding: 16px;
            }
            
            .quantum-btn {
                padding: 10px 16px;
                font-size: 12px;
            }
            
            .quantum-home-title {
                font-size: 2rem;
            }
        }

        /* ==================== QUANTUM SPECIAL EFFECTS ==================== */
        .quantum-glow {
            position: relative;
        }

        .quantum-glow::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: var(--quantum-gradient-primary);
            border-radius: inherit;
            z-index: -1;
            filter: blur(10px);
            opacity: 0;
            transition: var(--ios-transition);
        }

        .quantum-glow:hover::after {
            opacity: 0.6;
        }

        .quantum-typing-indicator {
            display: inline-flex;
            gap: 4px;
            align-items: center;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--quantum-layer1);
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* ==================== QUANTUM LOADING STATES ==================== */
        .quantum-loading {
            display: inline-flex;
            gap: 8px;
            align-items: center;
        }

        .loading-bar {
            width: 4px;
            height: 16px;
            background: var(--quantum-layer1);
            animation: loadingWave 1.2s infinite ease-in-out;
        }

        .loading-bar:nth-child(1) { animation-delay: -0.32s; }
        .loading-bar:nth-child(2) { animation-delay: -0.16s; }
        .loading-bar:nth-child(3) { animation-delay: 0s; }

        @keyframes loadingWave {
            0%, 40%, 100% { transform: scaleY(0.6); }
            20% { transform: scaleY(1); }
        }

        /* ==================== NEW STYLES FOR NAVIGATION ==================== */
        .quantum-home-button {
            position: fixed;
            bottom: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--quantum-gradient-primary);
            color: white;
            border: none;
            box-shadow: var(--quantum-shadow-lg);
            z-index: 1000;
            cursor: pointer;
            transition: var(--ios-transition);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .quantum-home-button:hover {
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }

        .quantum-home-button.active {
            display: flex;
        }
    </style>
</head>
<body class="theme-dark">
<link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@700;800;900&display=swap" rel="stylesheet">
<link href="https://fonts.cdnfonts.com/css/eternal" rel="stylesheet">

<style id="stl-ultra-style">
:root{
  --gold1:#ffdd6a;
  --gold2:#fff7e6;
  --cyber1:#4cdfff;
  --cyber2:#7d5fff;
  --bg:#000000;
}

/* full takeover */
#stl-open{position:fixed;inset:0;z-index:2147483000;background:var(--bg);
display:flex;flex-direction:column;align-items:center;justify-content:center;
overflow:hidden;pointer-events:auto}

/* scanline (slow) */
#stl-scan{position:absolute;left:0;width:100%;height:1px;
background:linear-gradient(90deg,transparent,rgba(76,223,255,0.08),transparent);
opacity:0.28;animation:stl-scan 4.6s linear infinite;mix-blend-mode:screen;pointer-events:none}
@keyframes stl-scan{0%{top:-6%}100%{top:106%}}

/* ambient runes */
#stl-runes{position:absolute;inset:0;pointer-events:none;opacity:0.04;
font-family:monospace;color:var(--cyber1);white-space:pre;display:block;
mix-blend-mode:screen}
@keyframes runeF{0%{opacity:0.02}50%{opacity:0.06}100%{opacity:0.02}}

/* glyph */
#stl-title{
  font-family:'Eternal','Oxanium',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
  font-size:clamp(3.4rem,10vw,9.5rem);
  font-weight:900;line-height:1;white-space:nowrap;letter-spacing:0.12em;
  text-align:center;opacity:0;transform:scale(0.72);will-change:transform,opacity,filter;
  background:linear-gradient(120deg,var(--gold1)0%,var(--gold2)45%,var(--cyber1)75%,var(--cyber2)100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  -webkit-text-stroke:2.8px rgba(255,220,140,0.78);
  text-shadow:0 6px 8px rgba(0,0,0,0.95),
               0 12px 32px rgba(255,190,80,0.50),
               0 0 36px rgba(76,223,255,0.32),
               0 0 56px rgba(125,95,255,0.22);
}

/* tagline */
#stl-tag{
  font-family:'Oxanium','Orbitron',system-ui,-apple-system,Arial;
  font-size:clamp(0.95rem,2vw,1.6rem);font-weight:800;white-space:nowrap;
  margin-top:14px;letter-spacing:0.22em;opacity:0;
  color:rgba(255,245,220,0.88);
  text-shadow:0 0 18px rgba(255,220,120,0.22);
  will-change:opacity;
}

/* breathing glow */
@keyframes stl-breathe{
  0%{filter:drop-shadow(0 6px 18px rgba(255,200,110,0.22))}
  50%{filter:drop-shadow(0 10px 30px rgba(255,220,130,0.38))}
  100%{filter:drop-shadow(0 6px 18px rgba(255,200,110,0.22))}
}

/* fractal spark */
.stl-fractal{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
pointer-events:none;width:1px;height:1px;
box-shadow:0 -40px 20px rgba(255,220,110,0.14),
60px -20px 18px rgba(76,223,255,0.08),
-52px 26px 16px rgba(125,95,255,0.06),
28px 44px 22px rgba(255,220,110,0.06);
opacity:0;transition:opacity .9s ease}

/* responsive */
@media (max-width:768px){
  #stl-title{white-space:normal;display:flex;flex-direction:column;
    align-items:center;line-height:1.1;
    font-size:clamp(1.8rem,9.5vw,4.8rem);}
}
@media (min-width:769px){
  #stl-open{align-items:center;justify-content:center;padding:0 6vw;}
  #stl-title{max-width:90%;white-space:nowrap;
    font-size:clamp(3.4rem,8vw,9.5rem);}
}

/* breathing glow on */
#stl-title.glow-active{
  animation:stl-breathe 9s ease-in-out infinite;
  filter:drop-shadow(0 10px 28px rgba(125,95,255,0.18));
}

/* chromatic flash */
.stl-chromatic{
  mix-blend-mode:screen;pointer-events:none;position:fixed;inset:0;
  z-index:2147483002;opacity:0;transition:opacity .18s linear;
}
</style>

<div id="stl-open" aria-hidden="false" role="dialog">
  <div id="stl-scan" aria-hidden="true"></div>
  <pre id="stl-runes" aria-hidden="true" style="animation:runeF 2.4s infinite alternate;">
âŸ¡âŸ°âŸ’âŸŠâŸŸâŸ  â§–âŸ‘âŸžâŸœâ¥•  âŸ£âŸ¤âŸ¢âŸ¡  âŸŒâŸ†âŸ“âŸâŸš  âŸ›âŸâŸŸâŸ”
â›§âŸ‘âŸžâŸœ  âŸ°âŸ’âŸŠâŸŸ  â¥“â¥’â¥‘â¥  âŸ£âŸ¤âŸ¢âŸ¡  â›¦âŸŸâŸ’âŸŠâŸ°âŸ“
  </pre>

  <div id="stl-title">âŸâŸ£âŸ¢  â‹®  âŸ‘âŸ„âŸ‰âŸžâŸ‰âŸ‰  âŸ£âŸ¢  âŸ–âŸ’âŸšâŸ‰âŸ„âŸ’âŸ</div>
  <div id="stl-tag">ASCEND BEYOND CODE</div>
  <div class="stl-fractal" aria-hidden="true"></div>
</div>

<script id="stl-ultra-script">
(async function(){
  if(window.__stl_ultra_done)return;window.__stl_ultra_done=true;
  const ROOT=document.getElementById('stl-open'),
        TITLE=document.getElementById('stl-title'),
        TAG=document.getElementById('stl-tag'),
        FRACT=document.querySelector('.stl-fractal'),
        ease='cubic-bezier(.22,1,.36,1)';

  const txt=TITLE.textContent.trim();
  TITLE.textContent="";
  TITLE.classList.add('glow-active');

  /* --- pembenahan utama: bikin elemen kelihatan --- */
  TITLE.style.opacity='1';
  TITLE.style.transform='scale(1)';
  FRACT.style.opacity='1';
  /* ------------------------------------------------- */

  for(let i=0;i<txt.length;i++){
    TITLE.textContent+=txt[i];
    await new Promise(r=>setTimeout(r,200));
  }
  TAG.style.transition=`1s ${ease} .3s`;
  TAG.style.opacity=1;

  const uiReady=new Promise(res=>{
    let done=false;const fin=()=>{if(!done){done=true;res();}};
    const fonts=(document.fonts&&document.fonts.ready)?document.fonts.ready:Promise.resolve();
    fonts.then(()=>requestAnimationFrame(()=>requestAnimationFrame(()=>requestAnimationFrame(fin))));
    setTimeout(fin,20000);
  });

  let ready=false,exited=false;
  uiReady.then(()=>{ready=true;ROOT.style.cursor='pointer';});

  ROOT.addEventListener('click',()=>{if(ready&&!exited)exitDissolve();});
  setTimeout(()=>{if(ready&&!exited)exitDissolve();},20000);

function exitDissolve(){
  exited = true;

  // layer transisi lembut iOS26-feel
  const flash = document.createElement('div');
  flash.className = 'stl-chromatic';
  flash.style.background =
    'radial-gradient(circle at 50% 40%, rgba(255,255,255,0.05) 0%, rgba(80,80,120,0.1) 30%, rgba(0,0,0,0) 100%)';
  flash.style.backdropFilter = 'blur(18px) brightness(1.15)';
  flash.style.transition = 'opacity 1.5s ease-in-out, backdrop-filter 1.5s ease-in-out';
  document.body.appendChild(flash);
  requestAnimationFrame(()=>flash.style.opacity='1');
  setTimeout(()=>{
    flash.style.opacity='0';
    flash.style.backdropFilter='blur(0px) brightness(1)';
    setTimeout(()=>flash.remove(),1800);
  },250);

  // fade glyph dan tagline lebih lembut
  TITLE.style.transition = TAG.style.transition = `1.3s ${ease}`;
  TITLE.style.opacity = TAG.style.opacity = 0;
  FRACT.style.transition = 'opacity 1.3s ease-in-out';
  FRACT.style.opacity = 0;

  // push kecil dan hilangkan background hitam
  ROOT.style.transition = `opacity 1.5s ${ease}, transform 1.5s ${ease}`;
  ROOT.style.opacity = 0;
  ROOT.style.transform = 'scale(1.05)';

  setTimeout(()=>{
    try { ROOT.remove(); }
    catch(e){ ROOT.style.display='none'; }
  },1600);
}

})();
</script>
    <!-- Quantum Neural Network Background -->
    <div class="quantum-neural-background">
        <div class="neural-network"></div>
        <div class="quantum-particles" id="quantumParticles"></div>
    </div>
    
    <!-- Quantum Dynamic Island -->
    <div id="quantumIsland" class="quantum-island">
        <div class="pulse-dot"></div>
        <span id="islandMessage">stl-AIchat Ready</span>
    </div>
    
    <!-- Quantum Home Base -->
    <div id="quantumHomeBase" class="quantum-home-base">
        <div class="quantum-home-logo">
            <div class="w-32 h-32 mx-auto mb-6 rounded-full bg-gradient-to-r from-purple-600 to-blue-600 flex items-center justify-center shadow-2xl">
                <i class="fas fa-brain text-white text-5xl"></i>
            </div>
        </div>
        <h1 class="quantum-home-title">STL-UDHIS AI</h1>
        <p class="quantum-home-subtitle">Quantum AI Assistant Platform with advanced neural interface and real-time processing capabilities</p>
        <div class="quantum-home-buttons">
            <button id="openAIChat" class="quantum-home-btn ai-chat">
                <i class="fas fa-robot mr-2"></i> Start Chat
            </button>
            <button id="openDeveloper" class="quantum-home-btn developer">
                <i class="fas fa-code mr-2"></i> Developer Info
            </button>
        </div>
    </div>
    
    <!-- Quantum AI Chat Interface -->
    <div id="quantumAIChat" class="quantum-chat-container">
        <div class="quantum-chat-header">
            <div>
                <h3 class="text-lg font-black">stl-AI Assistant</h3>
                <p class="text-sm opacity-90">Quantum interface active</p>
            </div>
        </div>
        
        <div class="quantum-chat-messages" id="quantumChatMessages">
            <div class="quantum-message system">
                <p>ðŸš€ <strong>stl-AIchat Initialized</strong></p>
                <p class="text-sm mt-1">Configure your API key to begin conversations with advanced AI models.</p>
            </div>
        </div>
        
        <div class="quantum-chat-input-container">
            <div class="quantum-chat-input-row">
                <div class="flex-1">
                    <textarea id="quantumChatInput" 
                              placeholder="Enter your message to stl-AI..." 
                              class="quantum-input" 
                              rows="3"
                              enable></textarea>
                </div>
                <button id="sendQuantumMessage" class="quantum-btn primary" enable>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div class="quantum-chat-actions">
                <button id="voiceInput" class="quantum-btn secondary compact" enable>
                    <i class="fas fa-microphone"></i>
                </button>
                <div class="flex-1"></div>
            </div>
        </div>
    </div>

    <!-- Quantum Developer Panel -->
    <div id="quantumDeveloperPanel" class="quantum-developer-panel">
        <div class="quantum-developer-content">
            <div class="text-center mb-8">
                <div class="w-32 h-32 mx-auto mb-4 rounded-full bg-gradient-to-r from-purple-600 to-blue-600 flex items-center justify-center shadow-2xl">
                    <img src="https://pfst.cf2.poecdn.net/base/image/450b057a0166b3d912e628ec6196299c9664597953096114352df3ff0dadf34f?w=3100&h=3100" alt="NAJIB AI BRAIN Logo" class="w-full h-full object-contain rounded-full">
                </div>
                <h4 class="text-xl font-black text-white mb-2">Muhammad Najib Wahidus Salam, S.Pd, Gr.</h4>
                <p class="text-lg text-purple-600 mb-3 font-semibold">Quantum Mathematics Educator & AI Architect</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="quantum-card p-5">
                    <h5 class="text-lg font-black text-blue-600 mb-3">Tentang Developer</h5>
                    <ul class="space-y-2 text-sm text-gray-700 dark:text-gray-300">
                        <li class="flex items-center">
                            <i class="fas fa-map-marker-alt mr-3 text-blue-500"></i>
                            Sidoarjo, Indonesia
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-graduation-cap mr-3 text-green-500"></i>
                            S1-PGSD (2014-2021)
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-certificate mr-3 text-purple-500"></i>
                            PPG Prajabatan 2024
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-briefcase mr-3 text-yellow-500"></i>
                            Non-ASN Teacher & AI Architect
                        </li>
                    </ul>
                </div>
                
                <div class="quantum-card p-5">
                    <h5 class="text-lg font-black text-green-600 mb-3">Spesialisasi</h5>
                    <ul class="space-y-2 text-sm text-gray-700 dark:text-gray-300">
                        <li class="flex items-center">
                            <i class="fas fa-qrcode mr-3 text-blue-500"></i>
                            Quantum QR Educational Technology
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-robot mr-3 text-purple-500"></i>
                            AI-Powered Learning Systems
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-music mr-3 text-yellow-500"></i>
                            Original Music & Content Creation
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-code mr-3 text-green-500"></i>
                            Full-Stack Web Development
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="quantum-card p-5 mt-6">
                <h5 class="text-lg font-black text-purple-600 mb-3">Quantum AI Philosophy</h5>
                <p class="text-sm text-gray-700 dark:text-gray-300">
                    "Menggabungkan matematika kuantum dengan kecerdasan buatan untuk menciptakan sistem pembelajaran yang adaptif dan intuitif. 
                    Setiap algoritma adalah seni, setiap kode adalah puisi, dan setiap interaksi adalah peluang untuk transformasi."
                </p>
            </div>
        </div>
    </div>
    
    <!-- Quantum Tools Sidebar (Left) - API Configuration -->
    <div id="quantumToolsSidebar" class="quantum-tools-sidebar">
        <div class="flex justify-between items-center mb-8">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 rounded-xl overflow-hidden bg-gradient-to-br from-purple-600 to-blue-600 shadow-lg flex items-center justify-center">
                    <i class="fas fa-brain text-white text-xl"></i>
                </div>
                <div>
                    <h2 class="text-xl font-black text-white">stl-AIchat Tools</h2>
                    <p class="text-xs text-purple-300">AI Configuration</p>
                </div>
            </div>
            <button id="closeToolsSidebar" class="quantum-btn danger">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="space-y-6">
            <!-- AI Model Configuration -->
            <div class="quantum-card glass p-5">
                <h3 class="text-lg font-black text-white mb-4 flex items-center gap-2">
                    <i class="fas fa-robot text-green-400"></i>
                    AI Model Configuration
                </h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-purple-300 mb-2">Provider</label>
                            <select id="aiProvider" class="quantum-input glass">
                                <option value="openai">OpenAI GPT-4</option>
                                <option value="anthropic">Anthropic Claude</option>
                                <option value="google">Google Gemini Pro</option>
                                <option value="custom">Custom Endpoint</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-purple-300 mb-2">Model</label>
                            <select id="aiModel" class="quantum-input glass">
                                <option value="gpt-4">Custom</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                <option value="claude-3">Claude 3 Opus</option>
                                <option value="gemini-pro">Gemini Pro</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-purple-300 mb-2">API Key</label>
                        <input type="password" id="aiApiKey" placeholder="sk-..." class="quantum-input glass">
                    </div>
                    <div class="flex gap-3">
                        <button id="saveAiConfig" class="quantum-btn success flex-1">
                            <i class="fas fa-save"></i> Save Config
                        </button>
                        <button id="testAiConfig" class="quantum-btn warning">
                            <i class="fas fa-vial"></i> Test
                        </button>
                    </div>
                </div>
            </div>

            <!-- Voice & Mic Configuration -->
            <div class="quantum-card glass p-5">
                <h3 class="text-lg font-black text-white mb-4 flex items-center gap-2">
                    <i class="fas fa-microphone text-red-400"></i>
                    Voice Interface
                </h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-purple-300">Voice Input</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="voiceInputToggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-700 peer-focus:ring-4 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    <div class="flex gap-3">
                        <button id="testMic" class="quantum-btn primary flex-1">
                            <i class="fas fa-microphone"></i> Test Microphone
                        </button>
                    </div>
                    <div id="voiceStatus" class="text-sm text-blue-400">
                        Voice interface ready
                    </div>
                </div>
            </div>

            <!-- Export Chat Data -->
            <div class="quantum-card glass p-5">
                <h3 class="text-lg font-black text-white mb-4 flex items-center gap-2">
                    <i class="fas fa-download text-yellow-400"></i>
                    Export Data
                </h3>
<!-- INSERT_INJECTION_AFTER_EXPORT_DATA -->

                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <button id="exportChat" class="quantum-btn success">
                            <i class="fas fa-file-export"></i> Export Chat
                        </button>
                        <button id="exportLocalData" class="quantum-btn warning">
                            <i class="fas fa-database"></i> Export Data
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="clearChat" class="quantum-btn danger">
                            <i class="fas fa-trash"></i> Clear Chat
                        </button>
                        <button id="clearLocalData" class="quantum-btn danger">
                            <i class="fas fa-broom"></i> Clear Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quantum Tools Sidebar Overlay -->
    <div id="quantumToolsOverlay" class="quantum-sidebar-overlay"></div>

    <!-- Quantum Sidebar Overlay -->
    <div id="quantumSidebarOverlay" class="quantum-sidebar-overlay"></div>

    <!-- Quantum Sidebar (Right) - Settings -->
    <div id="quantumSidebar" class="quantum-sidebar">
        <div class="flex justify-between items-center mb-8">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 rounded-xl overflow-hidden bg-gradient-to-br from-purple-600 to-pink-600 shadow-lg flex items-center justify-center">
                    <i class="fas fa-cogs text-white text-xl"></i>
                </div>
                <div>
                    <h2 class="text-xl font-black text-white">stl-AIchat Settings</h2>
                    <p class="text-xs text-purple-300">System Configuration</p>
                </div>
            </div>
            <button id="closeQuantumSidebar" class="quantum-btn danger">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="space-y-6">
            <!-- Theme System -->
            <div class="quantum-card glass p-5">
                <h3 class="text-lg font-black text-white mb-4">
                    <i class="fas fa-palette mr-2 text-purple-400"></i>Quantum Themes
                </h3>
                <div class="grid grid-cols-2 gap-3" id="quantumThemeGrid">
                    <!-- Themes will be populated by JavaScript -->
                </div>
            </div>

            <!-- AI Personality Settings -->
            <div class="quantum-card glass p-5">
                <h3 class="text-lg font-black text-white mb-4">
                    <i class="fas fa-user-astronaut mr-2 text-blue-400"></i>AI Personality
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-purple-300 mb-2">Assistant Name</label>
                        <input type="text" id="aiName" value="stl-AI" class="quantum-input glass">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-purple-300 mb-2">Personality Type</label>
                        <select id="aiPersonality" class="quantum-input glass">
                            <option value="professional">Professional</option>
                            <option value="friendly">Friendly</option>
                            <option value="technical">Technical</option>
                            <option value="creative">Creative</option>
                            <option value="humorous">Humorous</option>
                            <option value="Private">Private</option>
                            <option value="Deep Secret Private">Deep Secret Private</option>
                            <option value="Deep Explicit">Deep Explicit</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-purple-300 mb-2">Response Style</label>
                        <select id="aiResponseStyle" class="quantum-input glass">
                            <option value="concise">Concise</option>
                            <option value="detailed">Detailed</option>
                            <option value="technical">Technical</option>
                            <option value="storytelling">Storytelling</option>
                            <option value="Loyal Submisive">Loyal submisive</option>
                            <option value="Humanoid Behavior">Humanoid behavior</option>
                            <option value="No Rules with Deal only for developer rules">No Rules with Deal only for developer rules</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Advanced AI Settings -->
            <div class="quantum-card glass p-5">
                <h3 class="text-lg font-black text-white mb-4">
                    <i class="fas fa-sliders-h mr-2 text-green-400"></i>Advanced Settings
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-purple-300 mb-2">Temperature: <span id="temperatureValue">0.7</span></label>
                        <input type="range" id="aiTemperature" min="0" max="1" step="0.1" value="0.7" class="w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-purple-300 mb-2">Max Tokens</label>
                        <input type="number" id="aiMaxTokens" value="2000" class="quantum-input glass">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-purple-300 mb-2">System Prompt</label>
                        <textarea id="aiSystemPrompt" rows="4" class="quantum-input glass">You are stl-AI, an advanced AI assistant with deep knowledge across all domains. Provide helpful, accurate, and engaging responses.</textarea>
                    </div>
                    <button id="saveAdvancedSettings" class="quantum-btn primary w-full">
                        <i class="fas fa-save"></i> Save Advanced Settings
                    </button>
                </div>
            </div>

            <!-- Device Information -->
            <div class="quantum-card glass p-5">
                <h3 class="text-lg font-black text-white mb-4">
                    <i class="fas fa-microchip mr-2 text-yellow-400"></i>Device Info
                </h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-purple-300">Platform:</span>
                        <span id="devicePlatform" class="text-white">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-purple-300">Browser:</span>
                        <span id="deviceBrowser" class="text-white">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-purple-300">Language:</span>
                        <span id="deviceLanguage" class="text-white">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-purple-300">Cores:</span>
                        <span id="deviceCores" class="text-white">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-purple-300">Memory:</span>
                        <span id="deviceMemory" class="text-white">-</span>
                    </div>
                </div>
                <button id="scanDevice" class="quantum-btn secondary w-full mt-4">
                    <i class="fas fa-search"></i> Full Device Scan
                </button>
            </div>
        </div>
    </div>

    <!-- Toggle Buttons -->
    <button id="openToolsSidebar" class="toggle-btn toggle-left">
        <i class="fas fa-sliders-h"></i>
    </button>

    <button id="openQuantumSidebar" class="toggle-btn toggle-right">
        <i class="fas fa-cog"></i>
    </button>

    <!-- Home Button (Small 20px) -->
    <button id="quantumHomeBtn" class="quantum-home-button">
        <i class="fas fa-home"></i>
    </button>

    <!-- Quantum Engine Core Script -->
    <script>
        // ==================== QUANTUM ENGINE CORE ====================
        class QuantumEngine {
            constructor() {
                this.currentPage = 'home';
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setupParticleSystem();
                this.showHomePage();
                this.updateQuantumIsland('ðŸš€ stl-AIchat Ready', 2000);
            }

            setupEventListeners() {
                // Navigation
                document.getElementById('openAIChat').addEventListener('click', () => this.showAIChat());
                document.getElementById('openDeveloper').addEventListener('click', () => this.showDeveloperPanel());
                document.getElementById('quantumHomeBtn').addEventListener('click', () => this.showHomePage());

                // Sidebar Controls
                document.getElementById('openToolsSidebar').addEventListener('click', () => this.openToolsSidebar());
                document.getElementById('closeToolsSidebar').addEventListener('click', () => this.closeToolsSidebar());
                document.getElementById('openQuantumSidebar').addEventListener('click', () => this.openQuantumSidebar());
                document.getElementById('closeQuantumSidebar').addEventListener('click', () => this.closeQuantumSidebar());

                // Overlay clicks
                document.getElementById('quantumToolsOverlay').addEventListener('click', () => this.closeToolsSidebar());
                document.getElementById('quantumSidebarOverlay').addEventListener('click', () => this.closeQuantumSidebar());

                // Chat functionality
                document.getElementById('sendQuantumMessage').addEventListener('click', () => this.sendMessage());
                document.getElementById('quantumChatInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
            }

            showHomePage() {
                document.getElementById('quantumHomeBase').style.display = 'flex';
                document.getElementById('quantumAIChat').style.display = 'none';
                document.getElementById('quantumDeveloperPanel').style.display = 'none';
                document.getElementById('quantumHomeBtn').classList.remove('active');
                this.currentPage = 'home';
            }

            showAIChat() {
                document.getElementById('quantumHomeBase').style.display = 'none';
                document.getElementById('quantumAIChat').style.display = 'flex';
                document.getElementById('quantumDeveloperPanel').style.display = 'none';
                document.getElementById('quantumHomeBtn').classList.add('active');
                this.currentPage = 'chat';
                this.updateQuantumIsland('ðŸ’¬ AI Chat Active', 1500);
            }

            showDeveloperPanel() {
                document.getElementById('quantumHomeBase').style.display = 'none';
                document.getElementById('quantumAIChat').style.display = 'none';
                document.getElementById('quantumDeveloperPanel').style.display = 'block';
                document.getElementById('quantumHomeBtn').classList.add('active');
                this.currentPage = 'developer';
                this.updateQuantumIsland('ðŸ‘¨â€ðŸ’» Developer Mode', 1500);
            }

            openToolsSidebar() {
                document.getElementById('quantumToolsSidebar').classList.add('active');
                document.getElementById('quantumToolsOverlay').classList.add('active');
            }

            closeToolsSidebar() {
                document.getElementById('quantumToolsSidebar').classList.remove('active');
                document.getElementById('quantumToolsOverlay').classList.remove('active');
            }

            openQuantumSidebar() {
                document.getElementById('quantumSidebar').classList.add('active');
                document.getElementById('quantumSidebarOverlay').classList.add('active');
            }

            closeQuantumSidebar() {
                document.getElementById('quantumSidebar').classList.remove('active');
                document.getElementById('quantumSidebarOverlay').classList.remove('active');
            }

setupParticleSystem() {
    const container = document.getElementById('quantumParticles');
    if (!container) return;

    // Hapus particle lama
    container.innerHTML = '';

    // Ambil tema aktif dari localStorage
    const saved = localStorage.getItem('quantum_theme');
    const theme  = window.quantumThemes?.[saved];

    // Kalau belum ada tema, pakai default golden
    const particleType = theme?.effects?.particleType || 'goldenFloat';

    // Set jumlah partikel sesuai tema
    const particleCountMap = {
        goldenFloat: 50,
        blackPulse: 30,
        redSword: 40,
        shapeShifter: 35,
        codeRain: 60,
        oceanWave: 45,
        neonPulse: 40,
        roseFloat: 55
    };
    const total = particleCountMap[particleType] || 45;

    // Spawn particle
    for (let i = 0; i < total; i++) {
        const p = document.createElement('div');
        p.className = `particle-${particleType}`;

        const size = Math.random() * 4 + 2;
        const duration = 12 + Math.random() * 13;
        const delay = Math.random() * 15;

        p.style.cssText = `
            width: ${size}px;
            height: ${size}px;
            left: ${Math.random() * 100}%;
            top: ${Math.random() * 100}%;
            animation-duration: ${duration}s;
            animation-delay: ${delay}s;
            position: absolute;
        `;

        // Khusus Matrix Neo â†’ tampilkan karakter random
        if (particleType === 'codeRain') {
            const chars = '01ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½';
            p.textContent = chars[Math.floor(Math.random() * chars.length)];
        }

        container.appendChild(p);
    }
}

            updateQuantumIsland(message, duration = 3000) {
                const island = document.getElementById('quantumIsland');
                const messageElement = document.getElementById('islandMessage');
                
                messageElement.textContent = message;
                island.classList.add('active');
                
                setTimeout(() => {
                    island.classList.remove('active');
                }, duration);
            }

            sendMessage() {
                const input = document.getElementById('quantumChatInput');
                const message = input.value.trim();
                
                if (!message) return;
                
                // Add user message
                this.addMessageToChat('user', message);
                input.value = '';
                
                // Simulate AI response
                setTimeout(() => {
                    this.addMessageToChat('ai', 'This is a simulated AI response. In a real implementation, this would connect to an AI API.');
                }, 1000);
            }

            addMessageToChat(sender, message) {
                const messagesContainer = document.getElementById('quantumChatMessages');
                const messageElement = document.createElement('div');
                messageElement.className = `quantum-message ${sender}`;
                messageElement.textContent = message;
                
                messagesContainer.appendChild(messageElement);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        // Initialize Quantum Engine when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.quantumEngine = new QuantumEngine();
        });
    </script>
    <!-- ==================== QUANTUM THEME SYSTEM EXPANSION ==================== -->
<script>
    // ==================== QUANTUM THEME EXPANSION ====================
    /* === PATCHED: built-in themes removed (safe stub) === */
const quantumThemes = {};

/* Optional: keep a tiny registry for themes saved by custom-theme-creator.
   The custom theme creator can still add into this object at runtime. */

// ==================== SAFE THEME STUBS FOR QuantumEngineExpansion ====================
(function(){
// Ensure QuantumEngineExpansion exists before patching its prototype
function applyStubs() {
  try {
    if (typeof QuantumEngineExpansion === 'undefined') return;
    QuantumEngineExpansion.prototype.setupThemeSystem = function(){
      try {
        const themeGrid = document.getElementById('quantumThemeGrid');
        if(!themeGrid) return;
        themeGrid.innerHTML = '';
        const info = document.createElement('div');
        info.className = 'quantum-theme-card cursor-default p-3 rounded-lg';
        info.innerHTML = `<div style="height:48px;display:flex;align-items:center;justify-content:center;">No built-in themes (removed). Use <b>Custom Theme</b>.</div>
                          <div class="text-xs text-white mt-2">Open the Custom Theme panel to create or import themes.</div>`;
        themeGrid.appendChild(info);
      } catch(e){ console.warn('theme stub setup error', e); }
    };

    QuantumEngineExpansion.prototype.applyTheme = function(themeKey){
      const theme = window.quantumThemes && window.quantumThemes[themeKey];
      if(theme){
        const root = document.documentElement;
        Object.entries(theme.colors || {}).forEach(([property, value])=>{
          root.style.setProperty(property, value);
        });
        this.currentTheme = themeKey;
        try { localStorage.setItem('quantum_theme', themeKey); }catch(e){}
        this.engine && this.engine.updateQuantumIsland && this.engine.updateQuantumIsland(`ðŸŽ¨ Theme: ${theme.name || themeKey}`, 1500);
        try {
          const particles = document.querySelectorAll('.particle');
          particles.forEach(p => p.style.background = (theme.colors && theme.colors['--quantum-primary']) || '');
        } catch(e){}
        return;
      }
      if (document.getElementById && document.getElementById('openCustomThemePanel')) {
        try { document.getElementById('openCustomThemePanel').click(); }
        catch(e){}
      } else {
        console.info('applyTheme: theme not found and built-ins were removed. Use Custom Theme creator.');
      }
    };

    QuantumEngineExpansion.prototype.updateParticlesForTheme = function(theme){
      try {
        if(!theme) return;
        const particles = document.querySelectorAll('.particle');
        particles.forEach(p => {
          if(theme.colors && theme.colors['--quantum-primary']) p.style.background = theme.colors['--quantum-primary'];
        });
        const neuralNetwork = document.querySelector('.neural-network');
        if(neuralNetwork && theme.colors){
          neuralNetwork.style.background = `
            radial-gradient(circle at 20% 80%, ${theme.colors['--quantum-aurora-1']||''} 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, ${theme.colors['--quantum-aurora-2']||''} 0%, transparent 50%),
            radial-gradient(circle at 40% 40%, ${theme.colors['--quantum-aurora-3']||''} 0%, transparent 50%)
          `;
        }
      } catch(e){ /* silent */ }
    };
  } catch(e){
    console.warn('theme stubs installation failed', e);
  }
}

// If QuantumEngineExpansion is not yet defined, wait for a short time then try again
if (typeof QuantumEngineExpansion === 'undefined') {
  var __q_theme_stub_interval = setInterval(function(){
    if (typeof QuantumEngineExpansion !== 'undefined') {
      clearInterval(__q_theme_stub_interval);
      applyStubs();
    }
  }, 200);
} else {
  applyStubs();
}
})();
/* === end patch === */

    // ==================== QUANTUM FONT SYSTEM ====================
    const quantumFonts = {
        'inter': 'Inter, sans-serif',
        'poppins': 'Poppins, sans-serif',
        'orbitron': 'Orbitron, monospace',
        'nunito': 'Nunito Sans, sans-serif',
        'rajdhani': 'Rajdhani, sans-serif',
        'raleway': 'Raleway, sans-serif',
        'urbanist': 'Urbanist, sans-serif',
        'montserrat': 'Montserrat, sans-serif',
        'roboto': 'Roboto, sans-serif',
        'lato': 'Lato, sans-serif',
        'jetbrains': 'JetBrains Mono, monospace',
        'fira': 'Fira Code, monospace',
        'space': 'Space Grotesk, sans-serif',
        'syne': 'Syne, sans-serif',
        'exo': 'Exo 2, sans-serif',
        'audiowide': 'Audiowide, cursive'
    };

    // ==================== QUANTUM ENGINE EXPANSION ====================
    class QuantumEngineExpansion {
        constructor(engine) {
            this.engine = engine;
            this.currentTheme = 'quantum-dark';
            this.currentFont = 'inter';
            this.isBold = false;
            this.isItalic = false;
            this.fontSize = 16;
            this.initExpansion();
        }

        initExpansion() {
            this.setupThemeSystem();
            this.setupFontSystem();
            this.setupHomeButton();
            this.setupTextFormatting();
            this.setupAutoSave();
            this.setupEnhancedParticles();
        }

        setupThemeSystem() {
            const themeGrid = document.getElementById('quantumThemeGrid');
            if (!themeGrid) return;

            themeGrid.innerHTML = '';
            
            Object.entries(quantumThemes).forEach(([key, theme]) => {
                const themeCard = document.createElement('div');
                themeCard.className = 'quantum-theme-card cursor-pointer p-3 rounded-lg transition-all duration-300 hover:bg-purple-500/10';
                themeCard.innerHTML = `
                    <div class="theme-preview w-full h-16 rounded-lg mb-2 border-2" 
                         style="background: ${theme.colors['--quantum-bg'] || '#0f0f23'}; border-color: ${theme.colors['--quantum-primary'] || '#6366f1'};">
                        <div class="theme-accent w-full h-2 mt-2 rounded" 
                             style="background: ${theme.colors['--quantum-primary'] || '#6366f1'};"></div>
                    </div>
                    <span class="theme-name text-xs font-semibold text-white">${theme.name}</span>
                `;
                themeCard.addEventListener('click', () => this.applyTheme(key));
                themeGrid.appendChild(themeCard);
            });

            // Load saved theme
            const savedTheme = localStorage.getItem('quantum_theme');
            if (savedTheme && quantumThemes[savedTheme]) {
                this.applyTheme(savedTheme);
            }
        }

        applyTheme(themeKey) {
            const theme = quantumThemes[themeKey];
            if (!theme) return;

            const root = document.documentElement;
            Object.entries(theme.colors).forEach(([property, value]) => {
                root.style.setProperty(property, value);
            });

            this.currentTheme = themeKey;
            localStorage.setItem('quantum_theme', themeKey);
            
            // Update particles for new theme
            this.updateParticlesForTheme(theme);
            
            this.engine.updateQuantumIsland(`ðŸŽ¨ Theme: ${theme.name}`, 2000);
        }

        updateParticlesForTheme(theme) {
            const particles = document.querySelectorAll('.particle');
            particles.forEach(particle => {
                particle.style.background = theme.colors['--quantum-primary'] || '#6366f1';
            });

            const neuralNetwork = document.querySelector('.neural-network');
            if (neuralNetwork) {
                neuralNetwork.style.background = `
                    radial-gradient(circle at 20% 80%, ${theme.colors['--quantum-aurora-1'] || '#6366f1'} 0%, transparent 50%),
                    radial-gradient(circle at 80% 20%, ${theme.colors['--quantum-aurora-2'] || '#8b5cf6'} 0%, transparent 50%),
                    radial-gradient(circle at 40% 40%, ${theme.colors['--quantum-aurora-3'] || '#a855f7'} 0%, transparent 50%)
                `;
            }
        }

        setupFontSystem() {
            // Add font controls to sidebar
            const themeSection = document.querySelector('.quantum-card.glass');
            if (!themeSection) return;

            const fontControls = document.createElement('div');
            fontControls.className = 'space-y-4 mt-6';
            fontControls.innerHTML = `
                <h4 class="text-md font-black text-white mb-2 flex items-center gap-2">
                    <i class="fas fa-font text-blue-400"></i>Font System
                </h4>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-purple-300 mb-2">Font Family</label>
                        <select id="fontFamily" class="quantum-input glass w-full">
                            ${Object.entries(quantumFonts).map(([key]) => 
                                `<option value="${key}">${key.charAt(0).toUpperCase() + key.slice(1)}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-purple-300 mb-2">Font Size</label>
                        <input type="range" id="fontSize" min="12" max="24" value="16" class="w-full quantum-slider">
                        <div class="text-xs text-purple-300 text-center mt-1" id="fontSizeValue">16px</div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="fontBold" class="quantum-btn secondary flex-1">
                        <i class="fas fa-bold"></i> Bold
                    </button>
                    <button id="fontItalic" class="quantum-btn secondary flex-1">
                        <i class="fas fa-italic"></i> Italic
                    </button>
                </div>
            `;
            themeSection.appendChild(fontControls);

            // Load saved font settings
            const savedFont = localStorage.getItem('quantum_font') || 'inter';
            const savedSize = localStorage.getItem('quantum_font_size') || '16';
            const savedBold = localStorage.getItem('quantum_font_bold') === 'true';
            const savedItalic = localStorage.getItem('quantum_font_italic') === 'true';

            document.getElementById('fontFamily').value = savedFont;
            this.applyFont(savedFont);
            
            document.getElementById('fontSize').value = savedSize;
            document.getElementById('fontSizeValue').textContent = `${savedSize}px`;
            this.applyFontSize(parseInt(savedSize));
            
            this.isBold = savedBold;
            this.isItalic = savedItalic;
            this.updateFontButtons();
            this.updateFontStyle();

            // Event listeners
            document.getElementById('fontFamily').addEventListener('change', (e) => {
                this.applyFont(e.target.value);
            });
            
            document.getElementById('fontSize').addEventListener('input', (e) => {
                const size = parseInt(e.target.value);
                document.getElementById('fontSizeValue').textContent = `${size}px`;
                this.applyFontSize(size);
            });
            
            document.getElementById('fontBold').addEventListener('click', () => {
                this.toggleBold();
            });
            
            document.getElementById('fontItalic').addEventListener('click', () => {
                this.toggleItalic();
            });
        }

        applyFont(fontKey) {
            const fontFamily = quantumFonts[fontKey];
            if (!fontFamily) return;

            document.documentElement.style.setProperty('--quantum-font-primary', fontFamily);
            this.currentFont = fontKey;
            localStorage.setItem('quantum_font', fontKey);
        }

        applyFontSize(size) {
            document.documentElement.style.setProperty('--base-font-size', `${size}px`);
            this.fontSize = size;
            localStorage.setItem('quantum_font_size', size.toString());
        }

        toggleBold() {
            this.isBold = !this.isBold;
            this.updateFontStyle();
            this.updateFontButtons();
            localStorage.setItem('quantum_font_bold', this.isBold.toString());
        }

        toggleItalic() {
            this.isItalic = !this.isItalic;
            this.updateFontStyle();
            this.updateFontButtons();
            localStorage.setItem('quantum_font_italic', this.isItalic.toString());
        }

        updateFontStyle() {
            const body = document.body;
            if (body) {
                body.style.fontWeight = this.isBold ? 'bold' : 'normal';
                body.style.fontStyle = this.isItalic ? 'italic' : 'normal';
            }
        }

        updateFontButtons() {
            const boldBtn = document.getElementById('fontBold');
            const italicBtn = document.getElementById('fontItalic');
            
            if (boldBtn) {
                boldBtn.classList.toggle('primary', this.isBold);
                boldBtn.classList.toggle('secondary', !this.isBold);
            }
            if (italicBtn) {
                italicBtn.classList.toggle('primary', this.isItalic);
                italicBtn.classList.toggle('secondary', !this.isItalic);
            }
        }

        setupHomeButton() {
            const homeBtn = document.getElementById('quantumHomeBtn');
            if (!homeBtn) return;

            // Show home button when in chat or developer mode
            const observer = new MutationObserver(() => {
                const chatVisible = document.getElementById('quantumAIChat').style.display !== 'none';
                const devVisible = document.getElementById('quantumDeveloperPanel').style.display !== 'none';
                homeBtn.style.display = (chatVisible || devVisible) ? 'flex' : 'none';
            });

            observer.observe(document.getElementById('quantumAIChat'), { 
                attributes: true, 
                attributeFilter: ['style'] 
            });
            observer.observe(document.getElementById('quantumDeveloperPanel'), { 
                attributes: true, 
                attributeFilter: ['style'] 
            });
        }

        saveChatHistory() {
            const chatMessages = document.getElementById('quantumChatMessages');
            if (!chatMessages) return;

            const messages = Array.from(chatMessages.querySelectorAll('.quantum-message'))
                .map(msg => ({
                    type: msg.classList.contains('user') ? 'user' : 
                          msg.classList.contains('ai') ? 'ai' : 'system',
                    content: msg.textContent,
                    timestamp: new Date().toISOString()
                }));

            (messages.length > 1) { // Don't save if only system message
                const history = JSON.parse(localStorage.getItem('quantum_chat_history') || '[]');
                history.push({
                    id: Date.now(),
                    messages: messages,
                    savedAt: new Date().toISOString()
                });
                
                // Keep only last 50 conversations
                if (history.length > 50) {
                    history.splice(0, history.length - 50);
                }
                
                localStorage.setItem('quantum_chat_history', JSON.stringify(history));
                this.engine.updateQuantumIsland('ðŸ’¾ Chat history saved', 1500);
            }
        }

        setupTextFormatting() {
            // Add formatting buttons to chat input
            const chatInputContainer = document.querySelector('.quantum-chat-input-container');
            if (!chatInputContainer) return;

            const formattingRow = document.createElement('div');
            formattingRow.className = 'quantum-chat-formatting mb-2';
            formattingRow.innerHTML = `
                <div class="flex gap-1">
                    <button class="quantum-btn secondary compact text-xs" data-format="bold" title="Bold">
                        <i class="fas fa-bold"></i>
                    </button>
                    <button class="quantum-btn secondary compact text-xs" data-format="italic" title="Italic">
                        <i class="fas fa-italic"></i>
                    </button>
                    <button class="quantum-btn secondary compact text-xs" data-format="code" title="Code">
                        <i class="fas fa-code"></i>
                    </button>
                    <button class="quantum-btn secondary compact text-xs" data-format="link" title="Link">
                        <i class="fas fa-link"></i>
                    </button>
                    <div class="flex-1"></div>
                    <button class="quantum-btn secondary compact text-xs" data-format="clear" title="Clear">
                        <i class="fas fa-eraser"></i>
                    </button>
                </div>
            `;
            
            const inputRow = chatInputContainer.querySelector('.quantum-chat-input-row');
            chatInputContainer.insertBefore(formattingRow, inputRow);

            // Add formatting handlers
            formattingRow.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const format = btn.getAttribute('data-format');
                    if (format === 'clear') {
                        document.getElementById('quantumChatInput').value = '';
                    } else {
                        this.applyTextFormat(format);
                    }
                });
            });
        }

        applyTextFormat(format) {
            const textarea = document.getElementById('quantumChatInput');
            if (!textarea) return;

            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            let formattedText = '';

            switch (format) {
                case 'bold':
                    formattedText = `**${selectedText}**`;
                    break;
                case 'italic':
                    formattedText = `*${selectedText}*`;
                    break;
                case 'code':
                    formattedText = `\`${selectedText}\``;
                    break;
                case 'link':
                    formattedText = `[${selectedText}](url)`;
                    break;
                default:
                    return;
            }

            textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + formattedText.length, start + formattedText.length);
        }

        setupAutoSave() {
            // Auto-save when leaving page
            window.addEventListener('beforeunload', () => {
                this.saveChatHistory();
            });

            // Auto-save every 30 seconds
            setInterval(() => {
                const chatVisible = document.getElementById('quantumAIChat').style.display !== 'none';
                if (chatVisible) {
                    this.saveChatHistory();
                }
            }, 30000);
        }

// Pastikan wadah partikel selalu ada
if (!document.getElementById('quantumParticles')) {
  const pc = document.createElement('div');
  pc.id = 'quantumParticles';
  pc.className = 'quantum-particles';
  document.body.appendChild(pc);
}
// Clear existing particles
particleContainer.innerHTML = '';

// Ambil particle type dari tema aktif, fallback jika kosong
const activeTheme = window.quantumThemes?.[localStorage.getItem('quantum_theme')];
const particleType = activeTheme?.effects?.particleType || 'goldenFloat';

// Tentukan jumlah particle berdasarkan tema
const counts = {
  goldenFloat: 50,
  blackPulse: 30,
  redSword: 40,
  shapeShifter: 35,
  codeRain: 60,
  oceanWave: 45,
  neonPulse: 40,
  roseFloat: 55
};
const total = counts[particleType] || 45;

// Spawn particle sesuai tema
for (let i = 0; i < total; i++) {
  const p = document.createElement('div');
  p.className = `particle-${particleType}`;

  const size = Math.random() * 4 + 2;
  const duration = 15 + Math.random() * 15;
  const delay = Math.random() * 15;

  p.style.cssText = `
    width: ${size}px;
    height: ${size}px;
    position: absolute;
    left: ${Math.random() * 100}%;
    top: ${Math.random() * 100}%;
    animation-duration: ${duration}s;
    animation-delay: ${delay}s;
  `;

  // Khusus Matrix Neo (Code Rain) â†’ isi char
  if (particleType === 'codeRain') {
    const chars = '01ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½';
    p.textContent = chars[Math.floor(Math.random() * chars.length)];
  }

  particleContainer.appendChild(p);
}
        }
    }

    // ==================== ENHANCED DEVELOPER INFO ====================
    function enhanceDeveloperInfo() {
        const developerPanel = document.getElementById('quantumDeveloperPanel');
        if (!developerPanel) return;

        // Update developer content with enhanced information
        const developerContent = developerPanel.querySelector('.quantum-developer-content');
        if (developerContent) {
            developerContent.innerHTML += `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div class="quantum-card p-5">
                        <h5 class="text-lg font-black text-yellow-600 mb-3">Skills & Technologies</h5>
                        <div class="flex flex-wrap gap-2">
                            <span class="px-3 py-1 bg-blue-500/20 text-blue-300 rounded-full text-xs">JavaScript</span>
                            <span class="px-3 py-1 bg-green-500/20 text-green-300 rounded-full text-xs">Python</span>
                            <span class="px-3 py-1 bg-purple-500/20 text-purple-300 rounded-full text-xs">TensorFlow</span>
                            <span class="px-3 py-1 bg-red-500/20 text-red-300 rounded-full text-xs">React</span>
                            <span class="px-3 py-1 bg-yellow-500/20 text-yellow-300 rounded-full text-xs">Node.js</span>
                            <span class="px-3 py-1 bg-indigo-500/20 text-indigo-300 rounded-full text-xs">MongoDB</span>
                            <span class="px-3 py-1 bg-pink-500/20 text-pink-300 rounded-full text-xs">AI/ML</span>
                            <span class="px-3 py-1 bg-teal-500/20 text-teal-300 rounded-full text-xs">Quantum Computing</span>
                        </div>
                    </div>
                    
                    <div class="quantum-card p-5">
                        <h5 class="text-lg font-black text-red-600 mb-3">Contact & Social</h5>
                        <ul class="space-y-2 text-sm text-gray-700 dark:text-gray-300">
                            <li class="flex items-center">
                                <i class="fab fa-github mr-3 text-gray-400"></i>
                                GitHub: najib-wahidus
                            </li>
                            <li class="flex items-center">
                                <i class="fab fa-linkedin mr-3 text-blue-400"></i>
                                LinkedIn: najib-wahidus
                            </li>
                            <li class="flex items-center">
                                <i class="fas fa-envelope mr-3 text-yellow-400"></i>
                                Email: najib@stl-aichat.com
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="quantum-card p-5 mt-6">
                    <h5 class="text-lg font-black text-green-600 mb-3">Recent Projects</h5>
                    <div class="space-y-3">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-rocket text-purple-500 mt-1"></i>
                            <div>
                                <h6 class="font-semibold text-white">Quantum QR Education</h6>
                                <p class="text-sm text-gray-400">AI-powered learning system with quantum-inspired algorithms</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <i class="fas fa-brain text-blue-500 mt-1"></i>
                            <div>
                                <h6 class="font-semibold text-white">Neural Music Composer</h6>
                                <p class="text-sm text-gray-400">AI system that composes original music based on emotional input</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <i class="fas fa-code text-green-500 mt-1"></i>
                            <div>
                                <h6 class="font-semibold text-white">STL-AI Framework</h6>
                                <p class="text-sm text-gray-400">Full-stack AI development platform with quantum computing integration</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    }

    // ==================== INITIALIZE ENHANCEMENTS ====================
    document.addEventListener('DOMContentLoaded', () => {
        // Wait for main engine to initialize
        setTimeout(() => {
            if (window.quantumEngine) {
                window.quantumExpansion = new QuantumEngineExpansion(window.quantumEngine);
                enhanceDeveloperInfo();
                
                console.log('ðŸš€ Quantum AI Chat Expansion Loaded');
                
                // Show welcome notification
                setTimeout(() => {
                    window.quantumEngine.updateQuantumIsland('ðŸŽ‰ Enhanced Features Activated!', 2000);
                }, 500);
            }
        }, 1000);
    });
</script>

<style>
    /* ==================== ENHANCED QUANTUM STYLES ==================== */
    
    /* Enhanced Particle Animations */
    @keyframes quantumFloat {
        0% {
            transform: translateY(100vh) translateX(0) rotate(0deg);
            opacity: 0;
        }
        10% {
            opacity: 1;
        }
        90% {
            opacity: 1;
        }
        100% {
            transform: translateY(-100px) translateX(100px) rotate(360deg);
            opacity: 0;
        }
    }

    /* Chat Formatting */
    .quantum-chat-formatting {
        margin-bottom: 12px;
    }

    .quantum-btn.compact {
        padding: 8px 12px;
        font-size: 12px;
        min-width: auto;
    }

    /* Enhanced Responsive Design */
    @media (max-width: 768px) {
        .quantum-theme-card {
            padding: 6px;
        }

        .theme-preview {
            height: 40px;
        }
    }

    @media (max-width: 480px) {
        .quantum-theme-card {
            padding: 4px;
        }
        
        .theme-preview {
            height: 35px;
        }
    }

    /* Enhanced Typography System */
    :root {
        --base-font-size: 16px;
    }

    body {
        font-size: var(--base-font-size);
    }

    /* Custom Scrollbar */
    .quantum-chat-messages::-webkit-scrollbar {
        width: 6px;
    }

    .quantum-chat-messages::-webkit-scrollbar-track {
        background: var(--quantum-surface);
    }

    .quantum-chat-messages::-webkit-scrollbar-thumb {
        background: var(--quantum-primary);
        border-radius: 3px;
    }

    .quantum-chat-messages::-webkit-scrollbar-thumb:hover {
        background: var(--quantum-secondary);
    }

    /* Enhanced Loading Animation */
    .quantum-loading-enhanced {
        display: inline-flex;
        gap: 6px;
        align-items: center;
    }

    .loading-orb {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--quantum-primary);
        animation: loadingPulse 1.5s infinite ease-in-out;
    }

    .loading-orb:nth-child(2) { animation-delay: 0.2s; }
    .loading-orb:nth-child(3) { animation-delay: 0.4s; }

    @keyframes loadingPulse {
        0%, 100% { transform: scale(0.8); opacity: 0.5; }
        50% { transform: scale(1.2); opacity: 1; }
    }

    /* Enhanced Message Animations */
    .quantum-message.user {
        animation: messageSlideInRight 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .quantum-message.ai {
        animation: messageSlideInLeft 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    @keyframes messageSlideInRight {
        from {
            opacity: 0;
            transform: translateX(30px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateX(0) scale(1);
        }
    }

    @keyframes messageSlideInLeft {
        from {
            opacity: 0;
            transform: translateX(-30px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateX(0) scale(1);
        }
    }

    /* Quantum Slider Styles */
    .quantum-slider {
        -webkit-appearance: none;
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: var(--quantum-surface);
        outline: none;
    }

    .quantum-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--quantum-primary);
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        transition: var(--quantum-transition-fast);
    }

    .quantum-slider::-webkit-slider-thumb:hover {
        transform: scale(1.2);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .quantum-slider::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--quantum-primary);
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }

    /* Theme Card Hover Effects */
    .quantum-theme-card {
        transition: all 0.3s ease;
    }

    .quantum-theme-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    /* Enhanced Button States */
    .quantum-btn:active {
        transform: translateY(0) scale(0.98);
    }

    /* Focus States for Accessibility */
    .quantum-btn:focus-visible,
    .quantum-input:focus-visible,
    .quantum-select:focus-visible {
        outline: 2px solid var(--quantum-primary);
        outline-offset: 2px;
    }

    /* High Contrast Mode Support */
    @media (prefers-contrast: high) {
        .quantum-card {
            border-width: 2px;
        }
        
        .quantum-btn {
            border: 1px solid currentColor;
        }
    }

    /* Reduced Motion Support */
    @media (prefers-reduced-motion: reduce) {
        * {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
        
        .quantum-particle {
            animation: none !important;
        }
        
        .quantum-message {
            animation: none !important;
        }
    }
</style>
<script>
// ==================== QUANTUM MICROPHONE POSITION FIX ====================
function injectMicrophoneFix() {
    console.log('ðŸ”§ Injecting microphone position fix...');
    
    // Tunggu hingga DOM sepenuhnya dimuat
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', applyMicrophoneFix);
    } else {
        applyMicrophoneFix();
    }
    
    function applyMicrophoneFix() {
        const chatInputContainer = document.querySelector('.quantum-chat-input-container');
        if (!chatInputContainer) {
            console.log('âŒ Chat input container not found, retrying...');
            setTimeout(applyMicrophoneFix, 1000);
            return;
        }
        
        // Hapus quantum-chat-actions yang ada
        const existingActions = chatInputContainer.querySelector('.quantum-chat-actions');
        if (existingActions) {
            existingActions.remove();
        }
        
        // Dapatkan input row
        const inputRow = chatInputContainer.querySelector('.quantum-chat-input-row');
        if (!inputRow) {
            console.log('âŒ Input row not found');
            return;
        }
        
        // Rekonstruksi input row dengan tombol microphone dan kirim sejajar
        inputRow.innerHTML = `
            <div class="flex-1">
                <textarea id="quantumChatInput" 
                          placeholder="Enter your message to stl-AI..." 
                          class="quantum-input" 
                          rows="3"
                          enable></textarea>
            </div>
            <div class="flex items-end gap-2 ml-2" style="margin-bottom: 8px;">
                <button id="voiceInput" class="quantum-btn secondary" style="padding: 12px 16px;" enable>
                    <i class="fas fa-microphone"></i>
                </button>
                <button id="sendQuantumMessage" class="quantum-btn primary" style="padding: 12px 16px;" enable>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        `;
        
        // Setup event listeners untuk tombol baru
        setTimeout(() => {
            const sendButton = document.getElementById('sendQuantumMessage');
            const voiceButton = document.getElementById('voiceInput');
            const chatInput = document.getElementById('quantumChatInput');
            
            if (sendButton && window.quantumEngine) {
                sendButton.addEventListener('click', () => window.quantumEngine.sendMessage());
            }
            
            if (chatInput && window.quantumEngine) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        window.quantumEngine.sendMessage();
                    }
                });
            }
            
            if (voiceButton) {
                voiceButton.addEventListener('click', () => {
                    window.quantumEngine.updateQuantumIsland('ðŸŽ¤ Voice input activated', 2000);
                    // Tambahkan fungsi voice recognition di sini
                });
            }
            
            console.log('âœ… Microphone position fix applied successfully');
            window.quantumEngine.updateQuantumIsland('ðŸ”§ Interface optimized', 1500);
        }, 500);
    }
}

// ==================== ENHANCED STYLES FOR NEW LAYOUT ====================
function injectEnhancedStyles() {
    const style = document.createElement('style');
    style.textContent = `
        /* Enhanced Chat Input Layout */
        .quantum-chat-input-row {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        
        .quantum-chat-input-row .flex-1 {
            flex: 1;
        }
        
        .quantum-chat-input-row .flex.items-end {
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }
        
        /* Microphone and Send Button Styles */
        #voiceInput, #sendQuantumMessage {
            height: fit-content;
            min-width: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #voiceInput:hover, #sendQuantumMessage:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }
        
        #voiceInput:active, #sendQuantumMessage:active {
            transform: translateY(0);
        }
        
        /* Voice Recording Animation */
        #voiceInput.recording {
            animation: pulseRecording 1.5s infinite;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        @keyframes pulseRecording {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
        }
        
        /* Responsive Design for Mobile */
        @media (max-width: 768px) {
            .quantum-chat-input-row {
                flex-direction: column;
                gap: 12px;
            }
            
            .quantum-chat-input-row .flex.items-end {
                width: 100%;
                justify-content: space-between;
            }
            
            #voiceInput, #sendQuantumMessage {
                flex: 1;
                min-width: auto;
            }
        }
        
        /* Enhanced Textarea */
        #quantumChatInput {
            resize: vertical;
            min-height: 60px;
            max-height: 150px;
            font-family: var(--quantum-font-primary);
            line-height: 1.5;
        }
        
        #quantumChatInput:focus {
            border-color: var(--quantum-layer1);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1), 
                        inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* Button Group Animation */
        .quantum-chat-input-row .flex.items-end {
            animation: buttonGroupSlideIn 0.5s ease-out;
        }
        
        @keyframes buttonGroupSlideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    `;
    
    document.head.appendChild(style);
    console.log('âœ… Enhanced styles injected');
}

// ==================== VOICE RECOGNITION ENHANCEMENT ====================
function injectVoiceRecognition() {
    // Basic voice recognition setup
    let recognition = null;
    let isRecording = false;
    
    // Check for browser support
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        
        recognition.continuous = false;
        recognition.interimResults = true;
        recognition.lang = 'id-ID'; // Default to Indonesian
        
        recognition.onstart = function() {
            isRecording = true;
            const voiceButton = document.getElementById('voiceInput');
            if (voiceButton) {
                voiceButton.classList.add('recording');
                voiceButton.innerHTML = '<i class="fas fa-square"></i>';
            }
            window.quantumEngine.updateQuantumIsland('ðŸŽ¤ Listening...', 3000);
        };
        
        recognition.onresult = function(event) {
            const transcript = Array.from(event.results)
                .map(result => result[0].transcript)
                .join('');
            
            const chatInput = document.getElementById('quantumChatInput');
            if (chatInput) {
                chatInput.value = transcript;
            }
        };
        
        recognition.onend = function() {
            isRecording = false;
            const voiceButton = document.getElementById('voiceInput');
            if (voiceButton) {
                voiceButton.classList.remove('recording');
                voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
            }
        };
        
        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            window.quantumEngine.updateQuantumIsland('âŒ Voice input failed', 2000);
            isRecording = false;
            const voiceButton = document.getElementById('voiceInput');
            if (voiceButton) {
                voiceButton.classList.remove('recording');
                voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
            }
        };
    }
    
    // Add click handler for voice button
    document.addEventListener('click', function(e) {
        if (e.target.closest('#voiceInput')) {
            if (recognition) {
                if (!isRecording) {
                    try {
                        recognition.start();
                    } catch (error) {
                        console.log('Voice recognition not available:', error);
                        window.quantumEngine.updateQuantumIsland('ðŸŽ¤ Voice input not supported', 2000);
                    }
                } else {
                    recognition.stop();
                }
            } else {
                window.quantumEngine.updateQuantumIsland('ðŸŽ¤ Voice input not supported', 2000);
            }
        }
    });
    
    console.log('âœ… Voice recognition injected');
}

// ==================== INITIALIZE ALL INJECTIONS ====================
function initializeAllInjections() {
    console.log('ðŸš€ Starting Quantum AI Chat enhancements...');
    
    // Inject styles first
    injectEnhancedStyles();
    
    // Then fix microphone position
    injectMicrophoneFix();
    
    // Finally add voice recognition
    setTimeout(injectVoiceRecognition, 1000);
    
    console.log('âœ… All injections completed');
}

// ==================== AUTO-INITIALIZE ====================
// Tunggu hingga quantumEngine tersedia
function waitForEngine() {
    if (window.quantumEngine) {
        initializeAllInjections();
    } else {
        setTimeout(waitForEngine, 100);
    }
}

// Start the process
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', waitForEngine);
} else {
    waitForEngine();
}

// Export functions untuk akses global
window.QuantumEnhancements = {
    initializeAllInjections,
    injectMicrophoneFix,
    injectEnhancedStyles,
    injectVoiceRecognition
};

console.log('ðŸ”§ Quantum Enhancement Module Loaded - Ready for injection!');
</script>
<script>
// ==================== QUANTUM CHAT LAYOUT EXPANSION ====================
function injectChatLayoutExpansion() {
    console.log('ðŸ”§ Expanding chat input layout...');
    
    // Tunggu hingga DOM sepenuhnya dimuat
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', applyLayoutExpansion);
    } else {
        applyLayoutExpansion();
    }
    
    function applyLayoutExpansion() {
        const chatInputContainer = document.querySelector('.quantum-chat-input-container');
        if (!chatInputContainer) {
            console.log('âŒ Chat input container not found, retrying...');
            setTimeout(applyLayoutExpansion, 1000);
            return;
        }
        
        // Hapus quantum-chat-actions yang ada
        const existingActions = chatInputContainer.querySelector('.quantum-chat-actions');
        if (existingActions) {
            existingActions.remove();
        }
        
        // Dapatkan input row
        const inputRow = chatInputContainer.querySelector('.quantum-chat-input-row');
        if (!inputRow) {
            console.log('âŒ Input row not found');
            return;
        }
        
        // Rekonstruksi input row dengan layout yang lebih lebar
        inputRow.innerHTML = `
            <div class="flex-1 mr-3">
                <textarea id="quantumChatInput" 
                          placeholder="Enter your message to stl-AI..." 
                          class="quantum-input w-full" 
                          rows="3"
                          enable></textarea>
            </div>
            <div class="flex items-end gap-2">
                <button id="voiceInput" class="quantum-btn secondary chat-action-btn" enable>
                    <i class="fas fa-microphone"></i>
                </button>
                <button id="sendQuantumMessage" class="quantum-btn primary chat-action-btn" enable>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        `;
        
        // Setup event listeners untuk tombol baru
        setTimeout(() => {
            const sendButton = document.getElementById('sendQuantumMessage');
            const voiceButton = document.getElementById('voiceInput');
            const chatInput = document.getElementById('quantumChatInput');
            
            if (sendButton && window.quantumEngine) {
                sendButton.addEventListener('click', () => window.quantumEngine.sendMessage());
            }
            
            if (chatInput && window.quantumEngine) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        window.quantumEngine.sendMessage();
                    }
                });
            }
            
            if (voiceButton) {
                voiceButton.addEventListener('click', () => {
                    window.quantumEngine.updateQuantumIsland('ðŸŽ¤ Voice input activated', 2000);
                    // Tambahkan fungsi voice recognition di sini
                });
            }
            
            console.log('âœ… Chat layout expansion applied successfully');
            window.quantumEngine.updateQuantumIsland('ðŸ”§ Layout optimized', 1500);
        }, 500);
    }
}

// ==================== EXPANDED STYLES FOR WIDE LAYOUT ====================
function injectExpandedStyles() {
    const style = document.createElement('style');
    style.textContent = `
        /* ==================== EXPANDED CHAT LAYOUT STYLES ==================== */
        
        /* Quantum Chat Input Container - Lebarkan */
        .quantum-chat-input-container {
            padding: 15px 20px !important;
            border-top: 1px solid var(--quantum-border);
            background: var(--quantum-card);
            width: 100%;
        }
        
        /* Quantum Chat Input Row - Layout baru */
        .quantum-chat-input-row {
            display: flex !important;
            gap: 12px !important;
            align-items: flex-end !important;
            width: 100% !important;
            max-width: 100% !important;
        }
        
        /* Textarea yang lebih lebar */
        .quantum-chat-input-row .flex-1 {
            flex: 1 1 auto !important;
            min-width: 0 !important;
            width: 100% !important;
        }
        
        .quantum-chat-input-row .flex-1.mr-3 {
            margin-right: 12px !important;
        }
        
        /* Textarea full width */
        #quantumChatInput {
            width: 100% !important;
            min-height: 70px !important;
            max-height: 200px !important;
            resize: vertical !important;
            font-family: var(--quantum-font-primary) !important;
            line-height: 1.5 !important;
            border: 2px solid var(--quantum-border) !important;
            border-radius: var(--quantum-radius-lg) !important;
            padding: 16px 20px !important;
            background: var(--quantum-surface) !important;
            color: var(--quantum-text) !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            box-sizing: border-box !important;
        }
        
        #quantumChatInput:focus {
            outline: none !important;
            border-color: var(--quantum-layer1) !important;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1), 
                        inset 0 2px 8px rgba(0, 0, 0, 0.1) !important;
            transform: translateY(-2px) !important;
        }
        
        #quantumChatInput::placeholder {
            color: rgba(226, 232, 240, 0.6) !important;
        }
        
        /* Action Buttons - Compact dan rapi */
        .quantum-chat-input-row .flex.items-end {
            display: flex !important;
            align-items: flex-end !important;
            gap: 8px !important;
            flex-shrink: 0 !important;
        }
        
        .chat-action-btn {
            padding: 14px 16px !important;
            min-width: 55px !important;
            height: 55px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: var(--quantum-radius-lg) !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            font-size: 16px !important;
        }
        
        .chat-action-btn:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4) !important;
        }
        
        .chat-action-btn:active {
            transform: translateY(-1px) !important;
        }
        
        /* Voice Recording Animation */
        #voiceInput.recording {
            animation: pulseRecording 1.5s infinite !important;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
        }
        
        @keyframes pulseRecording {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
        }
        
        /* ==================== RESPONSIVE DESIGN ==================== */
        
        /* Tablet */
        @media (max-width: 1024px) {
            .quantum-chat-input-container {
                padding: 12px 16px !important;
            }
            
            .chat-action-btn {
                padding: 12px 14px !important;
                min-width: 50px !important;
                height: 50px !important;
            }
            
            #quantumChatInput {
                min-height: 60px !important;
                padding: 14px 18px !important;
            }
        }
        
        /* Mobile */
        @media (max-width: 768px) {
            .quantum-chat-input-container {
                padding: 10px 12px !important;
            }
            
            .quantum-chat-input-row {
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            .quantum-chat-input-row .flex-1.mr-3 {
                margin-right: 0 !important;
                width: 100% !important;
            }
            
            .quantum-chat-input-row .flex.items-end {
                width: 100% !important;
                justify-content: space-between !important;
            }
            
            .chat-action-btn {
                flex: 1 !important;
                min-width: auto !important;
                height: 48px !important;
                padding: 12px !important;
            }
            
            #quantumChatInput {
                min-height: 55px !important;
                padding: 12px 16px !important;
                font-size: 15px !important;
            }
        }
        
        /* Small Mobile */
        @media (max-width: 480px) {
            .quantum-chat-input-container {
                padding: 8px 10px !important;
            }
            
            .chat-action-btn {
                height: 45px !important;
                padding: 10px !important;
                font-size: 14px !important;
            }
            
            #quantumChatInput {
                min-height: 50px !important;
                padding: 10px 14px !important;
                font-size: 14px !important;
            }
            
            .quantum-chat-input-row .flex.items-end {
                gap: 6px !important;
            }
        }
        
        /* ==================== ENHANCED ANIMATIONS ==================== */
        
        /* Button Group Entrance Animation */
        .quantum-chat-input-row .flex.items-end {
            animation: buttonGroupSlideIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
        }
        
        @keyframes buttonGroupSlideIn {
            from {
                opacity: 0;
                transform: translateX(30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }
        
        /* Textarea Focus Animation */
        #quantumChatInput {
            animation: textareaSlideIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
        }
        
        @keyframes textareaSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* ==================== ACCESSIBILITY ENHANCEMENTS ==================== */
        
        /* High Contrast Mode */
        @media (prefers-contrast: high) {
            #quantumChatInput {
                border-width: 3px !important;
            }
            
            .chat-action-btn {
                border: 2px solid currentColor !important;
            }
        }
        
        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            .quantum-chat-input-row .flex.items-end,
            #quantumChatInput,
            .chat-action-btn {
                animation: none !important;
                transition: none !important;
            }
        }
        
        /* ==================== DARK/LIGHT THEME SUPPORT ==================== */
        
        .theme-light #quantumChatInput {
            background: var(--quantum-surface) !important;
            border-color: var(--quantum-border) !important;
            color: var(--quantum-text) !important;
        }
        
        .theme-light #quantumChatInput:focus {
            border-color: var(--quantum-layer1) !important;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1) !important;
        }
        
        /* ==================== SCROLLBAR STYLING ==================== */
        
        #quantumChatInput::-webkit-scrollbar {
            width: 6px;
        }
        
        #quantumChatInput::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 3px;
        }
        
        #quantumChatInput::-webkit-scrollbar-thumb {
            background: var(--quantum-border);
            border-radius: 3px;
        }
        
        #quantumChatInput::-webkit-scrollbar-thumb:hover {
            background: var(--quantum-layer1);
        }
    `;
    
    document.head.appendChild(style);
    console.log('âœ… Expanded styles injected');
}

// ==================== ENHANCED VOICE RECOGNITION ====================
function injectEnhancedVoiceRecognition() {
    let recognition = null;
    let isRecording = false;
    
    // Check for browser support
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        
        recognition.continuous = false;
        recognition.interimResults = true;
        recognition.lang = 'id-ID'; // Default to Indonesian
        
        recognition.onstart = function() {
            isRecording = true;
            const voiceButton = document.getElementById('voiceInput');
            if (voiceButton) {
                voiceButton.classList.add('recording');
                voiceButton.innerHTML = '<i class="fas fa-square"></i>';
                voiceButton.title = 'Stop recording';
            }
            window.quantumEngine.updateQuantumIsland('ðŸŽ¤ Listening... Speak now', 3000);
        };
        
        recognition.onresult = function(event) {
            const transcript = Array.from(event.results)
                .map(result => result[0].transcript)
                .join('');
            
            const chatInput = document.getElementById('quantumChatInput');
            if (chatInput) {
                chatInput.value = transcript;
                // Auto-scroll to bottom of textarea
                chatInput.scrollTop = chatInput.scrollHeight;
            }
        };
        
        recognition.onend = function() {
            isRecording = false;
            const voiceButton = document.getElementById('voiceInput');
            if (voiceButton) {
                voiceButton.classList.remove('recording');
                voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
                voiceButton.title = 'Start voice input';
            }
            window.quantumEngine.updateQuantumIsland('âœ… Voice input completed', 1500);
        };
        
        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            window.quantumEngine.updateQuantumIsland('âŒ Voice input failed: ' + event.error, 2000);
            isRecording = false;
            const voiceButton = document.getElementById('voiceInput');
            if (voiceButton) {
                voiceButton.classList.remove('recording');
                voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
                voiceButton.title = 'Start voice input';
            }
        };
    }
    
    // Add click handler for voice button
    document.addEventListener('click', function(e) {
        if (e.target.closest('#voiceInput')) {
            if (recognition) {
                if (!isRecording) {
                    try {
                        recognition.start();
                    } catch (error) {
                        console.log('Voice recognition not available:', error);
                        window.quantumEngine.updateQuantumIsland('ðŸŽ¤ Voice input not supported in this browser', 2000);
                    }
                } else {
                    recognition.stop();
                }
            } else {
                window.quantumEngine.updateQuantumIsland('ðŸŽ¤ Voice input not supported in this browser', 2000);
            }
        }
    });
    
    console.log('âœ… Enhanced voice recognition injected');
}

// ==================== INITIALIZE LAYOUT EXPANSION ====================
function initializeLayoutExpansion() {
    console.log('ðŸš€ Starting Quantum AI Chat layout expansion...');
    
    // Inject expanded styles first
    injectExpandedStyles();
    
    // Then apply layout expansion
    injectChatLayoutExpansion();
    
    // Finally add enhanced voice recognition
    setTimeout(injectEnhancedVoiceRecognition, 1000);
    
    console.log('âœ… Layout expansion completed');
}

// ==================== AUTO-INITIALIZE LAYOUT EXPANSION ====================
function waitForEngineAndExpand() {
    if (window.quantumEngine) {
        initializeLayoutExpansion();
    } else {
        setTimeout(waitForEngineAndExpand, 100);
    }
}

// Start the layout expansion process
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', waitForEngineAndExpand);
} else {
    waitForEngineAndExpand();
}

// Update global enhancements
if (window.QuantumEnhancements) {
    window.QuantumEnhancements.injectChatLayoutExpansion = injectChatLayoutExpansion;
    window.QuantumEnhancements.injectExpandedStyles = injectExpandedStyles;
    window.QuantumEnhancements.injectEnhancedVoiceRecognition = injectEnhancedVoiceRecognition;
    window.QuantumEnhancements.initializeLayoutExpansion = initializeLayoutExpansion;
}

console.log('ðŸ”§ Quantum Layout Expansion Module Loaded - Ready to widen chat input!');
</script>
<style>
  /* ==================== QUANTUM TOGGLE BUTTON BORDERS ==================== */
.toggle-btn {
    position: fixed;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--quantum-gradient-primary);
    color: white;
    border: none;
    box-shadow: var(--quantum-shadow-md);
    z-index: 1000;
    cursor: pointer;
    transition: var(--ios-transition);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    /* Garis tepi melingkar paten */
    border: 2px solid rgba(255, 255, 255, 0.8);
    outline: 1px solid rgba(99, 102, 241, 0.6);
}

.toggle-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
    /* Enhance border on hover */
    border: 2px solid rgba(255, 255, 255, 1);
    outline: 2px solid rgba(99, 102, 241, 0.8);
}

.toggle-right {
    top: 10px;
    right: 10px;
}

.toggle-left {
    bottom: 10px;
    left: 10px;
}

/* Quantum Home Button dengan border yang sama */
.quantum-home-button {
    position: fixed;
    bottom: 8px;
    right: 8px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--quantum-gradient-primary);
    color: white;
    border: none;
    box-shadow: var(--quantum-shadow-lg);
    z-index: 1000;
    cursor: pointer;
    transition: var(--ios-transition);
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    /* Garis tepi melingkar paten yang sama */
    border: 2px solid rgba(255, 255, 255, 0.8);
    outline: 1px solid rgba(99, 102, 241, 0.6);
}

.quantum-home-button:hover {
    transform: translateY(-3px) scale(1.1);
    box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
    /* Enhance border on hover */
    border: 2px solid rgba(255, 255, 255, 1);
    outline: 2px solid rgba(99, 102, 241, 0.8);
}

.quantum-home-button.active {
    display: flex;
}

/* Enhanced border effects for active states */
.toggle-btn:active,
.quantum-home-button:active {
    transform: scale(0.95);
    border: 2px solid rgba(255, 255, 255, 0.9);
    outline: 1px solid rgba(99, 102, 241, 0.9);
}

/* Special glow effect untuk tombol yang aktif */
.toggle-btn.glow,
.quantum-home-button.glow {
    animation: toggleGlow 2s infinite alternate;
}

@keyframes toggleGlow {
    0% {
        box-shadow: 0 0 5px rgba(99, 102, 241, 0.5),
                    inset 0 0 5px rgba(255, 255, 255, 0.2);
    }
    100% {
        box-shadow: 0 0 15px rgba(99, 102, 241, 0.8),
                    inset 0 0 10px rgba(255, 255, 255, 0.4);
    }
}

/* Responsive design untuk border */
@media (max-width: 768px) {
    .toggle-btn,
    .quantum-home-button {
        border: 1.5px solid rgba(255, 255, 255, 0.8);
        outline: 1px solid rgba(99, 102, 241, 0.6);
    }
}

@media (max-width: 480px) {
    .toggle-btn,
    .quantum-home-button {
        border: 1px solid rgba(255, 255, 255, 0.8);
        outline: 1px solid rgba(99, 102, 241, 0.6);
    }
}
</style>
<script>
  // ==================== TOGGLE BUTTON ENHANCEMENTS ====================
function enhanceToggleButtons() {
    const toggleButtons = document.querySelectorAll('.toggle-btn, .quantum-home-button');
    
    toggleButtons.forEach(button => {
        // Add glow effect on click
        button.addEventListener('mousedown', function() {
            this.classList.add('glow');
        });
        
        button.addEventListener('mouseup', function() {
            setTimeout(() => {
                this.classList.remove('glow');
            }, 300);
        });
        
        button.addEventListener('mouseleave', function() {
            this.classList.remove('glow');
        });
    });
}

// Panggil fungsi enhancement setelah DOM loaded
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(enhanceToggleButtons, 1000);
});
</script>
<script>
// ==================== QUANTUM iOS 26 FIXED DEVELOPER TRANSITIONS ====================
function injectiOS26FixedTransitions() {
    console.log('ðŸ“± Injecting iOS 26 Fixed Developer Transitions...');
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', applyiOS26FixedTransitions);
    } else {
        applyiOS26FixedTransitions();
    }
    
    function applyiOS26FixedTransitions() {
        const homeBase = document.getElementById('quantumHomeBase');
        const aiChat = document.getElementById('quantumAIChat');
        const developerPanel = document.getElementById('quantumDeveloperPanel');
        const developerContent = document.querySelector('.quantum-developer-content');
        
        if (!homeBase || !aiChat || !developerPanel || !developerContent) {
            setTimeout(applyiOS26FixedTransitions, 500);
            return;
        }
        
        // iOS 26 Fixed Transition Styles
        const ios26FixedStyle = document.createElement('style');
        ios26FixedStyle.textContent = `
            /* ==================== iOS 26 FIXED DEVELOPER TRANSITIONS ==================== */
            .quantum-page {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
                transform-origin: center;
                will-change: transform, opacity;
                overflow: hidden;
            }
            
            /* Home Base - Fixed */
            .quantum-home-base {
                opacity: 1;
                transform: scale(1) translateY(0);
                z-index: 100;
            }
            
            .quantum-home-base.hiding {
                opacity: 0;
                transform: scale(0.9) translateY(-50px);
                pointer-events: none;
            }
            
            .quantum-home-base.hidden {
                opacity: 0;
                pointer-events: none;
                display: none !important;
            }
            
            /* AI Chat - Fixed */
            .quantum-chat-container {
                opacity: 0;
                transform: scale(1.05) translateY(30px);
                z-index: 90;
                display: flex !important;
            }
            
            .quantum-chat-container.showing {
                opacity: 1;
                transform: scale(1) translateY(0);
                pointer-events: all;
            }
            
            .quantum-chat-container.hiding {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
                pointer-events: none;
            }
            
            .quantum-chat-container.hidden {
                opacity: 0;
                pointer-events: none;
                display: none !important;
            }
            
            /* DEVELOPER PANEL - FIXED LAYOUT */
            .quantum-developer-panel {
                opacity: 0;
                transform: scale(1.05) translateY(30px);
                z-index: 90;
                display: block !important;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                background: var(--quantum-bg);
            }
            
            .quantum-developer-panel.showing {
                opacity: 1;
                transform: scale(1) translateY(0);
                pointer-events: all;
            }
            
            .quantum-developer-panel.hiding {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
                pointer-events: none;
            }
            
            .quantum-developer-panel.hidden {
                opacity: 0;
                pointer-events: none;
                display: none !important;
            }
            
            /* Fix Developer Content Layout */
            .quantum-developer-content {
                max-width: 800px;
                margin: 0 auto;
                padding: 40px 20px;
                min-height: 100vh;
                display: block;
                position: relative;
            }
            
            /* iOS 26 Smooth Blur Overlay */
            .ios26-smooth-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, 
                    rgba(99, 102, 241, 0.3) 0%, 
                    rgba(139, 92, 246, 0.2) 50%, 
                    rgba(236, 72, 153, 0.1) 100%);
                z-index: 85;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
                backdrop-filter: blur(40px);
            }
            
            .ios26-smooth-overlay.active {
                opacity: 1;
            }
            
            /* iOS 26 Button Enhancements */
            .quantum-home-btn {
                transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
                transform-style: preserve-3d;
            }
            
            .quantum-home-btn.ios26-pressed {
                transform: scale(0.94);
                filter: brightness(1.2);
            }
            
            /* iOS 26 Content Animations */
            .quantum-developer-content > * {
                opacity: 0;
                transform: translateY(20px);
                transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            }
            
            .quantum-developer-content.showing > * {
                opacity: 1;
                transform: translateY(0);
            }
            
            /* Stagger animations for developer content */
            .quantum-developer-content.showing > *:nth-child(1) { transition-delay: 0.1s; }
            .quantum-developer-content.showing > *:nth-child(2) { transition-delay: 0.2s; }
            .quantum-developer-content.showing > *:nth-child(3) { transition-delay: 0.3s; }
            .quantum-developer-content.showing > *:nth-child(4) { transition-delay: 0.4s; }
            .quantum-developer-content.showing > *:nth-child(5) { transition-delay: 0.5s; }
            
            /* iOS 26 Card Animations */
            .quantum-card {
                transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            }
            
            .quantum-developer-panel.showing .quantum-card {
                animation: ios26CardSlideUp 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) both;
            }
            
            @keyframes ios26CardSlideUp {
                0% {
                    opacity: 0;
                    transform: translateY(30px) scale(0.95);
                }
                100% {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }
            
            /* iOS 26 Image Animation */
            .quantum-developer-panel .rounded-full {
                transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            }
            
            .quantum-developer-panel.showing .rounded-full {
                animation: ios26ImagePop 0.9s cubic-bezier(0.34, 1.56, 0.64, 1) both;
            }
            
            @keyframes ios26ImagePop {
                0% {
                    opacity: 0;
                    transform: scale(0.8) rotate(-10deg);
                }
                100% {
                    opacity: 1;
                    transform: scale(1) rotate(0deg);
                }
            }
            
            /* iOS 26 Text Animations */
            .quantum-developer-panel.showing h4,
            .quantum-developer-panel.showing p {
                animation: ios26TextSlideIn 0.7s cubic-bezier(0.34, 1.56, 0.64, 1) both;
            }
            
            .quantum-developer-panel.showing h4 { animation-delay: 0.2s; }
            .quantum-developer-panel.showing p { animation-delay: 0.3s; }
            
            @keyframes ios26TextSlideIn {
                0% {
                    opacity: 0;
                    transform: translateY(20px);
                }
                100% {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            /* iOS 26 List Animations */
            .quantum-developer-panel.showing li {
                animation: ios26ListSlideIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) both;
            }
            
            .quantum-developer-panel.showing li:nth-child(1) { animation-delay: 0.4s; }
            .quantum-developer-panel.showing li:nth-child(2) { animation-delay: 0.5s; }
            .quantum-developer-panel.showing li:nth-child(3) { animation-delay: 0.6s; }
            .quantum-developer-panel.showing li:nth-child(4) { animation-delay: 0.7s; }
            
            @keyframes ios26ListSlideIn {
                0% {
                    opacity: 0;
                    transform: translateX(-20px);
                }
                100% {
                    opacity: 1;
                    transform: translateX(0);
                }
            }
            
            /* iOS 26 Mobile Optimizations */
            @media (max-width: 768px) {
                .quantum-developer-content {
                    padding: 20px 15px;
                }
                
                .quantum-developer-panel {
                    padding: 0;
                }
                
                .quantum-home-base.hiding {
                    transform: scale(0.95) translateY(-30px);
                }
                
                .quantum-chat-container.showing,
                .quantum-developer-panel.showing {
                    transform: scale(1) translateY(0);
                }
            }
            
            /* iOS 26 Reduced Motion */
            @media (prefers-reduced-motion: reduce) {
                .quantum-page,
                .ios26-smooth-overlay,
                .quantum-home-btn,
                .quantum-card,
                .quantum-developer-content > *,
                .rounded-full,
                h4, p, li {
                    transition: none !important;
                    animation: none !important;
                    transform: none !important;
                }
            }
        `;
        document.head.appendChild(ios26FixedStyle);
        
        // Create iOS 26 Smooth Overlay
        const smoothOverlay = document.createElement('div');
        smoothOverlay.className = 'ios26-smooth-overlay';
        document.body.appendChild(smoothOverlay);
        
        console.log('âœ… iOS 26 Fixed Developer Transition styles injected');
        overrideiOS26FixedEngineMethods();
    }
    
    function overrideiOS26FixedEngineMethods() {
        if (!window.quantumEngine) {
            setTimeout(overrideiOS26FixedEngineMethods, 500);
            return;
        }
        
        const originalShowHomePage = window.quantumEngine.showHomePage;
        const originalShowAIChat = window.quantumEngine.showAIChat;
        const originalShowDeveloperPanel = window.quantumEngine.showDeveloperPanel;
        
        // Fixed showHomePage dengan transisi smooth
        window.quantumEngine.showHomePage = function() {
            const homeBase = document.getElementById('quantumHomeBase');
            const aiChat = document.getElementById('quantumAIChat');
            const developerPanel = document.getElementById('quantumDeveloperPanel');
            const homeBtn = document.getElementById('quantumHomeBtn');
            const smoothOverlay = document.querySelector('.ios26-smooth-overlay');
            const developerContent = document.querySelector('.quantum-developer-content');
            
            // Aktifkan overlay
            if (smoothOverlay) smoothOverlay.classList.add('active');
            
            // Sembunyikan halaman aktif
            if (this.currentPage === 'chat' && aiChat) {
                aiChat.classList.remove('showing');
                aiChat.classList.add('hiding');
            } else if (this.currentPage === 'developer' && developerPanel) {
                developerPanel.classList.remove('showing');
                developerPanel.classList.add('hiding');
                if (developerContent) developerContent.classList.remove('showing');
            }
            
            setTimeout(() => {
                // Sembunyikan sepenuhnya
                if (aiChat) {
                    aiChat.classList.remove('hiding');
                    aiChat.classList.add('hidden');
                }
                if (developerPanel) {
                    developerPanel.classList.remove('hiding');
                    developerPanel.classList.add('hidden');
                }
                
                // Tampilkan home
                if (homeBase) {
                    homeBase.style.display = 'flex';
                    homeBase.classList.remove('hidden', 'hiding');
                    setTimeout(() => {
                        homeBase.style.opacity = '1';
                        homeBase.style.transform = 'scale(1) translateY(0)';
                    }, 50);
                }
                
                // Update UI
                if (homeBtn) homeBtn.classList.remove('active');
                
                // Nonaktifkan overlay
                setTimeout(() => {
                    if (smoothOverlay) smoothOverlay.classList.remove('active');
                }, 1500); // polling throttled
                
                this.currentPage = 'home';
                this.updateQuantumIsland('ðŸ  Home Base', 1500);
                
            }, 1500); // polling throttled
        };
        
        // Fixed showAIChat dengan transisi smooth
        window.quantumEngine.showAIChat = function() {
            const homeBase = document.getElementById('quantumHomeBase');
            const aiChat = document.getElementById('quantumAIChat');
            const developerPanel = document.getElementById('quantumDeveloperPanel');
            const homeBtn = document.getElementById('quantumHomeBtn');
            const smoothOverlay = document.querySelector('.ios26-smooth-overlay');
            
            // Aktifkan overlay
            if (smoothOverlay) smoothOverlay.classList.add('active');
            
            // Sembunyikan halaman aktif
            if (this.currentPage === 'home' && homeBase) {
                homeBase.classList.remove('showing');
                homeBase.classList.add('hiding');
            } else if (this.currentPage === 'developer' && developerPanel) {
                developerPanel.classList.remove('showing');
                developerPanel.classList.add('hiding');
            }
            
            setTimeout(() => {
                // Sembunyikan sepenuhnya
                if (homeBase) {
                    homeBase.classList.remove('hiding');
                    homeBase.classList.add('hidden');
                }
                if (developerPanel) {
                    developerPanel.classList.remove('hiding');
                    developerPanel.classList.add('hidden');
                }
                
                // Tampilkan AI Chat
                if (aiChat) {
                    aiChat.style.display = 'flex';
                    aiChat.classList.remove('hidden', 'hiding');
                    aiChat.classList.add('showing');
                }
                
                // Update UI
                if (homeBtn) homeBtn.classList.add('active');
                
                // Nonaktifkan overlay
                setTimeout(() => {
                    if (smoothOverlay) smoothOverlay.classList.remove('active');
                }, 1500); // polling throttled
                
                this.currentPage = 'chat';
                this.updateQuantumIsland('ðŸ’¬ AI Chat Active', 1500);
                
                // Auto-focus
                setTimeout(() => {
                    const chatInput = document.getElementById('quantumChatInput');
                    if (chatInput) chatInput.focus();
                }, 500);
                
            }, 1500); // polling throttled
        };
        
        // FIXED showDeveloperPanel - Layout tidak aneh lagi
        window.quantumEngine.showDeveloperPanel = function() {
            const homeBase = document.getElementById('quantumHomeBase');
            const aiChat = document.getElementById('quantumAIChat');
            const developerPanel = document.getElementById('quantumDeveloperPanel');
            const homeBtn = document.getElementById('quantumHomeBtn');
            const smoothOverlay = document.querySelector('.ios26-smooth-overlay');
            const developerContent = document.querySelector('.quantum-developer-content');
            
            // Aktifkan overlay
            if (smoothOverlay) smoothOverlay.classList.add('active');
            
            // Sembunyikan halaman aktif
            if (this.currentPage === 'home' && homeBase) {
                homeBase.classList.remove('showing');
                homeBase.classList.add('hiding');
            } else if (this.currentPage === 'chat' && aiChat) {
                aiChat.classList.remove('showing');
                aiChat.classList.add('hiding');
            }
            
            setTimeout(() => {
                // Sembunyikan sepenuhnya
                if (homeBase) {
                    homeBase.classList.remove('hiding');
                    homeBase.classList.add('hidden');
                }
                if (aiChat) {
                    aiChat.classList.remove('hiding');
                    aiChat.classList.add('hidden');
                }
                
                // Tampilkan Developer Panel dengan layout yang FIXED
                if (developerPanel) {
                    developerPanel.style.display = 'block';
                    developerPanel.classList.remove('hidden', 'hiding');
                    
                    // Pastikan content terlihat dengan benar
                    setTimeout(() => {
                        developerPanel.classList.add('showing');
                        if (developerContent) {
                            developerContent.classList.add('showing');
                        }
                    }, 50);
                }
                
                // Update UI
                if (homeBtn) homeBtn.classList.add('active');
                
                // Nonaktifkan overlay
                setTimeout(() => {
                    if (smoothOverlay) smoothOverlay.classList.remove('active');
                }, 600);
                
                this.currentPage = 'developer';
                this.updateQuantumIsland('ðŸ‘¨â€ðŸ’» Developer Mode', 1500);
                
            }, 1500); // polling throttled
        };
        
        console.log('âœ… iOS 26 Fixed Developer Transition overrides applied');
        
        // Initialize dengan state yang benar
        setTimeout(() => {
            const homeBase = document.getElementById('quantumHomeBase');
            if (homeBase) {
                homeBase.classList.add('showing');
            }
        }, 100);
    }
}

// ==================== ENHANCED iOS 26 BUTTONS ====================
function injectEnhancediOS26Buttons() {
    const style = document.createElement('style');
    style.textContent = `
        /* ==================== ENHANCED iOS 26 BUTTONS ==================== */
        .quantum-home-btn {
            position: relative;
            overflow: hidden;
            transform-style: preserve-3d;
            background: transparent;
            border: none;
            isolation: isolate;
        }
        
        .quantum-home-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: inherit;
            border-radius: inherit;
            z-index: -2;
        }
        
        .quantum-home-btn::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, 
                rgba(255,255,255,0.2) 0%, 
                rgba(255,255,255,0.1) 50%, 
                transparent 100%);
            border-radius: inherit;
            opacity: 0;
            transition: opacity 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .quantum-home-btn:hover::after {
            opacity: 1;
        }
        
        .quantum-home-btn.ai-chat {
            background: var(--quantum-gradient-primary);
            box-shadow: 
                0 8px 32px rgba(99, 102, 241, 0.4),
                0 2px 8px rgba(99, 102, 241, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .quantum-home-btn.developer {
            background: var(--quantum-gradient-secondary);
            box-shadow: 
                0 8px 32px rgba(139, 92, 246, 0.4),
                0 2px 8px rgba(139, 92, 246, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .quantum-home-btn:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.3),
                0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .quantum-home-btn:active {
            transform: translateY(-1px) scale(0.98);
            transition: all 0.1s ease;
        }
        
        .quantum-home-btn i {
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .quantum-home-btn:hover i {
            transform: scale(1.1);
        }
    `;
    document.head.appendChild(style);
    console.log('âœ… Enhanced iOS 26 Buttons injected');
}

// ==================== INITIALIZE FIXED iOS 26 TRANSITIONS ====================
function initializeFixediOS26Transitions() {
    console.log('ðŸ“± Starting Fixed iOS 26 Transition System...');
    
    // Inject enhanced buttons first
    injectEnhancediOS26Buttons();
    
    // Then inject fixed transitions
    injectiOS26FixedTransitions();
    
    console.log('âœ… Fixed iOS 26 Transition System Activated - Developer Layout Fixed!');
}

// ==================== AUTO-INITIALIZE FIXED TRANSITIONS ====================
function waitForEngineAndAddFixedTransitions() {
    if (window.quantumEngine) {
        initializeFixediOS26Transitions();
    } else {
        setTimeout(waitForEngineAndAddFixedTransitions, 100);
    }
}

// Start the fixed transition process
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', waitForEngineAndAddFixedTransitions);
} else {
    waitForEngineAndAddFixedTransitions();
}

// Update global enhancements
if (window.QuantumEnhancements) {
    window.QuantumEnhancements.injectiOS26FixedTransitions = injectiOS26FixedTransitions;
    window.QuantumEnhancements.injectEnhancediOS26Buttons = injectEnhancediOS26Buttons;
    window.QuantumEnhancements.initializeFixediOS26Transitions = initializeFixediOS26Transitions;
}

console.log('ðŸ“± Quantum Fixed iOS 26 Transition Module Loaded - Developer Layout Perfect!');
</script>
<!-- Tambahkan script ini di bagian bawah file HTML, sebelum penutup 


<!-- NAJIB REBUILD PATCH: Repair theme creator, neon glow, particles, legacy hooks -->
<script>
(function(){
  if(window.__NAJIB_REBUILD_PATCH_DONE) return; window.__NAJIB_REBUILD_PATCH_DONE = true;
  console.info('[NAJIB_REBUILD] starting repair patch...');

  // Helper safe-get
  function $(sel, ctx){ try{ return (ctx||document).querySelector(sel); }catch(e){return null;} }
  function $all(sel, ctx){ try{ return Array.from((ctx||document).querySelectorAll(sel)); }catch(e){ return []; } }

  // 1) Ensure create/open custom theme panel functions exist and robustly bind to sidebar buttons
  function ensureCustomThemeBindings(){
    try{
      // createCustomThemePanel fallback: create a minimal panel if missing
      if(typeof window.createCustomThemePanel !== 'function'){
        window.createCustomThemePanel = function(){
          try{
            if(document.getElementById('quantumCustomThemePanel')) return;
            const panel = document.createElement('div');
            panel.id = 'quantumCustomThemePanel';
            panel.className = 'quantum-custom-theme-panel';
            panel.style.display = 'none';
            panel.style.position = 'fixed';
            panel.style.inset = '8%';
            panel.style.zIndex = 2147483646;
            panel.style.background = 'var(--quantum-card)';
            panel.style.border = '1px solid var(--quantum-border)';
            panel.style.borderRadius = '16px';
            panel.style.padding = '18px';
            panel.innerHTML = `
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                <div><strong>Custom Theme Creator (Najib Rebuild)</strong><div style="font-size:12px;opacity:.7">Realtime preview Â· Neon Â· Particles</div></div>
                <button id="closeCustomThemePanel" class="quantum-btn danger">Close</button>
              </div>
              <div style="display:flex;gap:12px;flex-wrap:wrap">
                <div style="flex:1;min-width:260px">
                  <label>Primary Color<input id="najib_primaryColor" type="color" class="najib-color" value="#6366f1"></label><br/><br/>
                  <label>Neon Glow Intensity <input id="najib_neonIntensity" type="range" min="0" max="1" step="0.01" value="0.4"></label><br/><br/>
                  <label>Particle Theme
                    <select id="najib_particleTheme" class="quantum-input najib-select">
                      <option value="goldenFloat">Golden Float</option>
                      <option value="blackPulse">Black Pulse</option>
                      <option value="redSword">Red Sword</option>
                      <option value="shapeShifter">Shape Shifter</option>
                      <option value="codeRain">Code Rain</option>
                      <option value="oceanWave">Ocean Wave</option>
                      <option value="neonPulse">Neon Pulse</option>
                      <option value="roseFloat">Rose Float</option>
                    </select>
                  </label>
                  <div style="margin-top:12px">
                    <button id="najib_applyTheme" class="quantum-btn primary">Apply Theme</button>
                    <button id="najib_saveTheme" class="quantum-btn success">Save Theme</button>
                  </div>
                </div>
                <div style="flex:1;min-width:260px">
                  <div id="najib_livePreview" class="quantum-card glass" style="padding:12px">
                    <h4 style="margin:0 0 8px 0">Live Preview</h4>
                    <p style="opacity:.8;margin:0 0 8px 0">Preview of neon and particle selection.</p>
                    <div style="display:flex;gap:8px">
                      <button class="quantum-btn primary">Primary</button>
                      <button class="quantum-btn secondary">Secondary</button>
                    </div>
                  </div>
                </div>
              </div>
            `;
            document.body.appendChild(panel);
            document.getElementById('closeCustomThemePanel').addEventListener('click', ()=>{ panel.style.display='none'; });
            // apply handler
            document.getElementById('najib_applyTheme').addEventListener('click', ()=>{ applyNajibTheme(); });
            document.getElementById('najib_saveTheme').addEventListener('click', ()=>{ saveNajibTheme(); });
            console.info('[NAJIB_REBUILD] fallback custom panel created');
          }catch(e){ console.warn('createCustomThemePanel fallback failed', e); }
        };
      }

      // openCustomThemePanel fallback
      if(typeof window.openCustomThemePanel !== 'function'){
        window.openCustomThemePanel = function(){
          try{
            const panel = document.getElementById('quantumCustomThemePanel') || (window.createCustomThemePanel && (window.createCustomThemePanel(), document.getElementById('quantumCustomThemePanel')));
            if(!panel) return;
            panel.style.display='block';
            panel.style.zIndex = 2147483646;
            // focus on first control
            const c = panel.querySelector('input,select,button');
            if(c) c.focus();
          }catch(e){ console.warn('openCustomThemePanel failed', e); }
        };
      }

      // bind existing openCustomThemePanel button(s)
      function bindOpenButtons(){
        const ids = ['openCustomThemePanel','open-custom-theme','najib-open-theme'];
        let bound=false;
        ids.forEach(id=>{
          const el = document.getElementById(id) || document.querySelector('#'+id);
          if(el){
            try{
              el.removeEventListener('__najib_click__', el.__najib_click__);
            }catch(e){}
            const h = function(){ try{ window.openCustomThemePanel(); }catch(e){} };
            try{ el.addEventListener('click', h); el.__najib_click__ = h; bound=true; console.info('[NAJIB_REBUILD] bound', id); }catch(e){}
          }
        });
        // fallback: try to map any palette button found in sidebars
        if(!bound){
          const alt = Array.from(document.querySelectorAll('button, a')).find(n=>/palette|theme|custom theme|theme creator/i.test(n.textContent||''));
          if(alt){
            const h = function(){ try{ window.openCustomThemePanel(); }catch(e){} };
            try{ alt.addEventListener('click', h); bound=true; console.info('[NAJIB_REBUILD] bound alt theme button'); }catch(e){}
          }
        }
      }

      bindOpenButtons();
      // attempt again later if not found
      setTimeout(bindOpenButtons, 800);
      setTimeout(bindOpenButtons, 2500);
    }catch(e){ console.warn('ensureCustomThemeBindings error', e); }
  }

  // 2) Theme application: wire neon intensity and primary color to existing buildThemeCSS/upsertStyle if present
  function applyNajibTheme(){
    try{
      const primary = (document.getElementById('najib_primaryColor')||{}).value || '#6366f1';
      const neon = parseFloat((document.getElementById('najib_neonIntensity')||{}).value || 0.4);
      // Build a theme object compatible with buildThemeCSS if available
      const theme = {
        variables: {
          quantumLayer1: primary,
          neonGlowIntensity: neon,
          quantumBg: document.body.style.background || getComputedStyle(document.documentElement).getPropertyValue('--quantum-bg') || '#0f0f23',
          quantumText: getComputedStyle(document.documentElement).getPropertyValue('--quantum-text') || '#e2e8f0'
        }
      };
      if(typeof window.buildThemeCSS === 'function' && typeof window.upsertStyle === 'function'){
        try{
          const css = window.buildThemeCSS(theme);
          window.upsertStyle(css);
          console.info('[NAJIB_REBUILD] applied theme via buildThemeCSS');
        }catch(e){ console.warn('applyNajibTheme -> buildThemeCSS failed', e); fallbackApplyCSS(theme); }
      } else {
        fallbackApplyCSS(theme);
      }
      // apply preview glow classes
      const preview = document.getElementById('najib_livePreview');
      if(preview){
        preview.classList.add('najib-neon-boost');
        preview.style.boxShadow = getComputedStyle(document.documentElement).getPropertyValue('--quantum-glow') || `0 0 30px ${primary}`;
      }
      // refresh particles
      renderParticlesForTheme((document.getElementById('najib_particleTheme')||{}).value || 'goldenFloat');
    }catch(e){ console.warn('applyNajibTheme error', e); }
  }

  function fallbackApplyCSS(theme){
    try{
      const cssLines = [];
      const vars = theme.variables || {};
      cssLines.push(':root{');
      cssLines.push(`--quantum-layer1:${vars.quantumLayer1||'#6366f1'};`);
      cssLines.push(`--quantum-bg:${vars.quantumBg||'#0f0f23'};`);
      cssLines.push(`--quantum-text:${vars.quantumText||'#e2e8f0'};`);
      const glow = `0 0 40px rgba(${hexToRgb(vars.quantumLayer1||'#6366f1')}, ${vars.neonGlowIntensity||0.4})`;
      cssLines.push(`--quantum-glow:${glow};`);
      cssLines.push('}');
      let s = document.getElementById('najib_theme_injected_style');
      if(!s){
        s = document.createElement('style'); s.id='najib_theme_injected_style'; document.head.appendChild(s);
      }
      s.textContent = cssLines.join('\n');
      console.info('[NAJIB_REBUILD] fallback CSS applied');
    }catch(e){ console.warn('fallbackApplyCSS error', e); }
  }

  function hexToRgb(hex){
    try{
      const h = (hex||'#6366f1').replace('#','');
      const full = h.length===3 ? h.split('').map(c=>c+c).join('') : h;
      const num = parseInt(full,16);
      const r=(num>>16)&255, g=(num>>8)&255, b=num&255;
      return `${r},${g},${b}`;
    }catch(e){ return '99,102,241'; }
  }

  function saveNajibTheme(){
    try{
      const name = 'najib-theme-' + Date.now();
      const theme = {
        name,
        variables: {
          quantumLayer1: (document.getElementById('najib_primaryColor')||{}).value || '#6366f1',
          neonGlowIntensity: parseFloat((document.getElementById('najib_neonIntensity')||{}).value || 0.4),
          particleTheme: (document.getElementById('najib_particleTheme')||{}).value || 'goldenFloat'
        },
        timestamp: new Date().toISOString()
      };
      const list = JSON.parse(localStorage.getItem('najib_saved_themes')||'[]');
      list.push(theme);
      localStorage.setItem('najib_saved_themes', JSON.stringify(list));
      alert('Theme saved locally as '+name);
    }catch(e){ console.warn('saveNajibTheme error', e); }
  }

  // 3) Particles: implement renderer that uses existing .quantum-particles container
  function renderParticlesForTheme(themeKey){
    try{
      const container = document.getElementById('quantumParticles') || document.querySelector('.quantum-particles');
      if(!container) return;
      container.innerHTML = ''; // clear
      const themeMap = {
        goldenFloat: {class:'particle-goldenFloat', count:28},
        blackPulse: {class:'particle-blackPulse', count:20},
        redSword: {class:'particle-redSword', count:22},
        shapeShifter: {class:'particle-shapeShifter', count:20},
        codeRain: {class:'particle-codeRain', count:36},
        oceanWave: {class:'particle-oceanWave', count:26},
        neonPulse: {class:'particle-neonPulse', count:24},
        roseFloat: {class:'particle-roseFloat', count:18}
      };
      const cfg = themeMap[themeKey] || themeMap.goldenFloat;
      for(let i=0;i<cfg.count;i++){
        const p = document.createElement('div');
        p.className = 'particle '+cfg.class;
        // random positioning
        p.style.left = Math.random()*100 + '%';
        p.style.top = Math.random()*100 + '%';
        const size = (Math.random()*(parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--particle-size-max')||6)-parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--particle-size-min')||2))+2) + 'px';
        p.style.width = size;
        p.style.height = size;
        container.appendChild(p);
      }
      console.info('[NAJIB_REBUILD] particles rendered for', themeKey);
    }catch(e){ console.warn('renderParticlesForTheme error', e); }
  }

  // 4) Ensure legacy buttons are mapped into sidebars and new functions are appended to end
  function ensureSidebarsAcceptNewBtns(){
    try{
      const right = document.getElementById('quantumSidebar') || document.querySelector('.quantum-sidebar');
      const left  = document.getElementById('quantumToolsSidebar') || document.querySelector('.quantum-tools-sidebar') || document.querySelector('.quantum-tools');
      // helper to append as last item and ensure vertical scroll expands
      function appendTo(side, el){
        try{
          if(!side) return;
          el.style.display='block';
          el.style.width='100%';
          side.appendChild(el);
          side.style.overflowY = 'auto';
          side.style.paddingBottom = '120px';
        }catch(e){}
      }
      // Create legacy theme button if not present
      if(!document.getElementById('openCustomThemePanel')){
        const btn = document.createElement('button');
        btn.id='openCustomThemePanel';
        btn.className='quantum-btn primary w-full mt-4';
        btn.innerHTML = '<i class="fas fa-palette mr-2"></i> Custom Theme Creator';
        // prefer right sidebar
        appendTo(right || left, btn);
        btn.addEventListener('click', ()=>{ window.openCustomThemePanel && window.openCustomThemePanel(); });
      }
      // ensure home and developer buttons exist
      const startChat = document.getElementById('openAIChat') || document.querySelector('.quantum-home-btn.ai-chat');
      const devBtn = document.getElementById('openDeveloper') || document.querySelector('.quantum-home-btn.developer');
      if(startChat && right) appendTo(right, startChat.cloneNode(true));
      if(devBtn && left) appendTo(left, devBtn.cloneNode(true));
      console.info('[NAJIB_REBUILD] sidebars patched for legacy buttons');
    }catch(e){ console.warn('ensureSidebarsAcceptNewBtns error', e); }
  }

  // 5) auto-activate: if owner token present, open panel and render current particle theme
  function autoActivateIfOwner(){
    try{
      const token = localStorage.getItem('__NAJIB_OWNER_TOKEN__');
      if(token && window.NAJIB_Auth && window.NAJIB_Auth.isOwner && window.NAJIB_Auth.isOwner()){
        console.info('[NAJIB_REBUILD] owner token found, auto-activating UI');
        ensureCustomThemeBindings();
        ensureSidebarsAcceptNewBtns();
        // open panel quietly
        setTimeout(()=>{ try{ window.openCustomThemePanel(); }catch(e){} }, 300);
        setTimeout(()=>{ try{ renderParticlesForTheme((document.getElementById('najib_particleTheme')||{}).value || 'goldenFloat'); }catch(e){} }, 600);
      }
    }catch(e){}
  }

  // kickoffs and watchers
  try{
    ensureCustomThemeBindings();
    ensureSidebarsAcceptNewBtns();
    // initial attempt to render particles based on saved theme or default
    const saved = (JSON.parse(localStorage.getItem('najib_saved_themes')||'[]') || [])[0];
    const initialTheme = saved ? (saved.variables && saved.variables.particleTheme) : (document.getElementById('najib_particleTheme')||{}).value || 'goldenFloat';
    setTimeout(()=>{ renderParticlesForTheme(initialTheme); }, 400);

    // observe for sidebars/popups added later
    const mo = new MutationObserver((m)=>{
      try{
        ensureCustomThemeBindings();
        ensureSidebarsAcceptNewBtns();
      }catch(e){}
    });
    mo.observe(document.body, {childList:true, subtree:true});
    autoActivateIfOwner();
    console.info('[NAJIB_REBUILD] patch applied');
  }catch(e){ console.warn('NAJIB_REBUILD main error', e); }

})();
</script>
<!-- END NAJIB REBUILD PATCH -->



<!-- NAJIB OPTIMIZER PATCH v1.0 (Fonts + Particle Optimizer + Cinematic Modes + Child-suite soft-mode) -->
<script id="najib-optimizer-patch">
(function(){
'use strict';
/*** UTIL: capability detection ***/
function detectCapsSafe(){
try{
if(window.__NAJIB_CAPS) return window.__NAJIB_CAPS;
const caps = { cores: navigator.hardwareConcurrency||2, mem: navigator.deviceMemory||2, dpr: window.devicePixelRatio||1, webgl:false, webgl2:false };
try{
const c=document.createElement('canvas');
const g2 = c.getContext && c.getContext('webgl2');
const g = g2 || (c.getContext && (c.getContext('webgl')||c.getContext('experimental-webgl')));
if(g){ caps.webgl = !!g; caps.webgl2 = !!g2; }
}catch(e){}
let score=0;
if(caps.cores>=8) score+=30; else if(caps.cores>=4) score+=18; else score+=8;
if(caps.mem>=8) score+=30; else if(caps.mem>=4) score+=18; else score+=6;
if(caps.webgl2) score+=30; else if(caps.webgl) score+=16;
caps.score = score;
if(caps.cores<=2 || caps.mem<=1 || caps.score<24) caps.profile='low';
else if((caps.cores<=4 && caps.mem<=3) || caps.score<48) caps.profile='mid';
else caps.profile='high';
window.__NAJIB_CAPS = caps;
return caps;
}catch(e){
return { profile:'low', cores:2, mem:1, dpr:1 };
}
}
const CAPS = detectCapsSafe();

/***** 1) FONT LAZY LOADER *****/
(function lazyFonts(){
try{
const heavyLinks = Array.from(document.querySelectorAll('link[href*="fonts.googleapis.com"], link[href*="fonts.gstatic.com"]'));
if(!heavyLinks.length) return;
if(CAPS.profile === 'low' || window.matchMedia('(prefers-reduced-data: reduce)').matches){
heavyLinks.forEach(l => { l.media='print'; l.setAttribute('data-deferred','1'); });
return;
}
function loadHeavyFonts(){
heavyLinks.forEach(l=>{
if(l.getAttribute('data-deferred')) return;
l.rel = 'stylesheet';
l.removeAttribute('media');
l.setAttribute('data-loaded-by','najib-optimizer');
});
}
if('requestIdleCallback' in window){
requestIdleCallback(loadHeavyFonts, {timeout:3000});
} else {
const onFirst = function(){ loadHeavyFonts(); window.removeEventListener('pointerdown', onFirst); window.removeEventListener('touchstart', onFirst); };
window.addEventListener('pointerdown', onFirst, {once:true});
window.addEventListener('touchstart', onFirst, {once:true});
setTimeout(loadHeavyFonts, 6000);
}
}catch(e){ console.warn('[najib-optimizer] lazyFonts failed', e); }
})();

/***** 2) PARTICLE SMART OPTIMIZER *****/
(function particleOptimizer(){
try{
const container = document.getElementById('quantumParticles') || document.querySelector('.quantum-particles');
if(!container) return;
function makeParticle(cls, x, y, size, content){
const el = document.createElement('div');
el.className = 'particle ' + cls;
el.style.left = (x*100).toFixed(2) + 'vw';
el.style.top = (y*100).toFixed(2) + 'vh';
el.style.width = size + 'px';
el.style.height = size + 'px';
if(content) { el.textContent = content; el.classList.add('particle-codeRain'); el.style.fontSize = Math.max(10, size) + 'px'; el.style.width = 'auto'; el.style.height = 'auto'; }
return el;
}
const baseCounts = {
goldenFloat: 28, blackPulse: 20, redSword: 22, shapeShifter: 20,
codeRain: 36, oceanWave: 26, neonPulse: 24, roseFloat: 24
};
const scaleMap = { high:1, mid:0.45, low:0.08 };
const profile = CAPS.profile || 'low';
const scale = scaleMap[profile] || 0.45;
const reduceEffects = (profile === 'low' || window.matchMedia('(prefers-reduced-motion: reduce)').matches);

window.renderParticlesForTheme = function(themeKey){
try{
const t = themeKey || 'goldenFloat';
const mapName = {
goldenFloat:'goldenFloat', blackPulse:'blackPulse', redSword:'redSword',
shapeShifter:'shapeShifter', codeRain:'codeRain', oceanWave:'oceanWave',
neonPulse:'neonPulse', roseFloat:'roseFloat'
}[t] || 'goldenFloat';
const base = baseCounts[mapName] || 18;
const count = Math.max( Math.round(base*scale), (reduceEffects ? 0 : 2) );
container.innerHTML = '';
if(count === 0){
const accent = document.createElement('div');
accent.className = 'particle particle-neonPulse';
accent.style.left = '50%';
accent.style.top = '80%';
accent.style.width = '4px';
accent.style.height = '4px';
accent.style.opacity = '0.6';
accent.style.pointerEvents = 'none';
container.appendChild(accent);
return;
}
const fragment = document.createDocumentFragment();
for(let i=0;i<count;i++){
const x = Math.random(); const y = Math.random();
const size = (mapName==='codeRain' ? Math.max(10, Math.round(Math.random()*14+6)) : Math.round(Math.random()*(reduceEffects?4:8) + (reduceEffects?2:2)));
const p = makeParticle('particle-'+mapName, x, y, size, mapName==='codeRain'? (Math.random()>0.7?String.fromCharCode(0x30A0 + Math.floor(Math.random()*96)) : '') : '');
if(reduceEffects){
p.style.boxShadow = 'none';
p.style.filter = 'none';
p.style.animationDuration = '8s';
}
fragment.appendChild(p);
}
container.appendChild(fragment);
}catch(e){ console.warn('[najib-optimizer] renderParticlesForTheme fail', e); }
};

try{
const saved = (JSON.parse(localStorage.getItem('najib_saved_themes')||'[]') || [])[0];
const initialTheme = saved ? (saved.variables && saved.variables.particleTheme) : 'goldenFloat';
setTimeout(()=>{ try{ window.renderParticlesForTheme(initialTheme); }catch(e){} }, 300);
}catch(e){}

window.__najib_particle_optimizer = { profile: CAPS.profile, reducedEffects: reduceEffects };

}catch(e){ console.warn('[najib-optimizer] particleOptimizer top fail', e); }
})();

/***** 3) CINEMATIC MODULAR MODE *****/
(function cinematicModular(){
try{
const ROOT = document.getElementById('stl-open');
if(!ROOT) return;
const mode = CAPS.profile || 'low';
ROOT.setAttribute('data-cinematic-mode', mode);

function applyMode(){
if(mode === 'low'){
const chrom = document.querySelector('.stl-chromatic');
if(chrom) chrom.style.display = 'none';
const scan = document.getElementById('stl-scan');
if(scan) { scan.style.animationDuration = '12s'; scan.style.opacity='0.12'; }
const TITLE = document.getElementById('stl-title');
const TAG = document.getElementById('stl-tag');
if(TITLE) TITLE.style.transition='opacity .6s ease';
if(TAG) TAG.style.transition='opacity .6s ease';
setTimeout(()=>{ try{ ROOT.style.opacity='0'; setTimeout(()=>{ try{ ROOT.remove(); }catch(e){ ROOT.style.display='none'; } }, 550); }catch(e){} }, 900);
}
else if(mode === 'mid'){
const scan = document.getElementById('stl-scan'); if(scan) scan.style.opacity='0.22';
const fract = document.querySelector('.stl-fractal'); if(fract) fract.style.opacity='0.7';
setTimeout(()=>{ try{ ROOT.style.opacity='0'; setTimeout(()=>{ try{ ROOT.remove(); }catch(e){ ROOT.style.display='none'; } }, 900); }catch(e){} }, 4000);
}
}
applyMode();
window.__najib_cinematic_force = function(lvl){
try{ if(!lvl) return; ROOT.setAttribute('data-cinematic-mode', lvl); location.reload(); }catch(e){}
};
}catch(e){ console.warn('[najib-optimizer] cinematicModular fail', e); }
})();

/***** 4) CHILD-SUITE SOFT MODE *****/
(function softenChildSuite(){
try{
(function installSoftObserver(){
let throttleAt = 0;
let backoffMs = 1000;
const whitelist = ['#stl-open','#quantumParticles','#quantumIsland','.quantum-sidebar','.quantum-tools-sidebar'];
const safeCheck = (node)=>{
try{
if(!node || node.nodeType !== 1) return true;
for(const s of whitelist){
try{ if(node.matches && node.matches(s) || (node.closest && node.closest(s))) return true; }catch(e){}
}
const tag = (node.tagName||'').toLowerCase();
if(['div','span','script','style','link','meta','img','svg'].indexOf(tag) !== -1) return true;
return false;
}catch(e){ return true; }
};
const mo = new MutationObserver((mutations)=>{
const now = Date.now();
if(now - throttleAt < backoffMs) return;
throttleAt = now;
let flagged = false;
for(const m of mutations){
for(const n of (m.addedNodes||[])){
if(!safeCheck(n)) flagged = true;
}
}
if(flagged){
console.info('[najib-softObserver] suspicious DOM additions detected');
setTimeout(()=>{ try{ if(window.DEV_mg && typeof window.DEV_mg.auditProtections === 'function') window.DEV_mg.auditProtections({soft:true}); }catch(e){} }, 1200);
backoffMs = Math.min(60000, Math.max(2000, backoffMs * 1.5));
} else {
backoffMs = Math.max(1000, Math.floor(backoffMs*0.9));
}
});
try{
mo.observe(document.documentElement || document.body, { childList:true, subtree:true });
window.__najib_soft_mo = mo;
}catch(e){}
})();
}catch(e){ console.warn('[najib-optimizer] softenChildSuite fail', e); }
})();

/***** 5) REPORT SUMMARY *****/
try{
console.info('[najib-optimizer] applied. profile=%s', CAPS.profile);
}catch(e){}
})();
</script>
<!-- END NAJIB OPTIMIZER PATCH -->
</body>
 -->
<script>
// ==================== QUANTUM CUSTOM THEME SYSTEM ====================
function injectCustomThemeSystem() {
    console.log('ðŸŽ¨ Injecting Quantum Custom Theme System...');
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', applyCustomThemeSystem);
    } else {
        applyCustomThemeSystem();
    }
    
    function applyCustomThemeSystem() {
        // Buat panel tema kustom di sidebar kanan
        const quantumSidebar = document.getElementById('quantumSidebar');
        if (!quantumSidebar) {
            setTimeout(applyCustomThemeSystem, 500);
            return;
        }
        
        // Cari bagian theme system
        const themeSection = quantumSidebar.querySelector('.quantum-card.glass');
        if (!themeSection) {
            console.log('âŒ Theme section not found');
            return;
        }
        
        // Tambahkan tombol Custom Theme
        const customThemeButton = document.createElement('button');
        customThemeButton.className = 'quantum-btn primary w-full mt-4';
        customThemeButton.id = 'openCustomThemePanel';
        customThemeButton.innerHTML = '<i class="fas fa-palette mr-2"></i> Custom Theme Creator';
        themeSection.appendChild(customThemeButton);
        
        // Buat panel tema kustom yang besar
        createCustomThemePanel();
        
        // Setup event listeners
        setTimeout(() => {
            document.getElementById('openCustomThemePanel').addEventListener('click', () => {
                openCustomThemePanel();
            });
        }, 500);
        
        console.log('âœ… Custom Theme System injected');
    }
    
    function createCustomThemePanel() {
        // Buat panel overlay untuk tema kustom
        const customThemePanel = document.createElement('div');
        customThemePanel.id = 'quantumCustomThemePanel';
        customThemePanel.className = 'quantum-custom-theme-panel';
        customThemePanel.innerHTML = `
            <div class="custom-theme-header">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center">
                        <i class="fas fa-palette text-white"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-black text-white">Custom Theme Creator</h2>
                        <p class="text-xs text-purple-300">Advanced Theme Customization</p>
                    </div>
                </div>
                <button id="closeCustomThemePanel" class="quantum-btn danger">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="custom-theme-content">
                <div class="theme-preview-section">
                    <h3 class="section-title">Live Preview</h3>
                    <div class="theme-preview-container">
                        <div class="preview-card">
                            <div class="preview-header">
                                <h4>Preview Header</h4>
                                <div class="preview-actions">
                                    <button class="preview-btn primary">Action</button>
                                    <button class="preview-btn secondary">Action</button>
                                </div>
                            </div>
                            <div class="preview-content">
                                <p>This is a preview of how your theme will look. All changes are applied in real-time.</p>
                                <div class="preview-input">
                                    <input type="text" placeholder="Input field preview" class="preview-input-field">
                                </div>
                                <div class="preview-buttons">
                                    <button class="preview-btn primary">Primary Button</button>
                                    <button class="preview-btn secondary">Secondary Button</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="theme-controls-section">
                    <div class="controls-grid">
                        <!-- Color Controls -->
                        <div class="control-group">
                            <h4 class="control-group-title">
                                <i class="fas fa-fill-drip"></i>
                                Color System
                            </h4>
                            <div class="color-controls">
                                <div class="color-control">
                                    <label>Primary Color</label>
                                    <div class="color-input-group">
                                        <input type="color" id="primaryColor" value="#6366f1" class="color-picker">
                                        <input type="text" id="primaryColorText" value="#6366f1" class="color-text-input">
                                    </div>
                                </div>
                                <div class="color-control">
                                    <label>Secondary Color</label>
                                    <div class="color-input-group">
                                        <input type="color" id="secondaryColor" value="#8b5cf6" class="color-picker">
                                        <input type="text" id="secondaryColorText" value="#8b5cf6" class="color-text-input">
                                    </div>
                                </div>
                                <div class="color-control">
                                    <label>Background Color</label>
                                    <div class="color-input-group">
                                        <input type="color" id="backgroundColor" value="#0f0f23" class="color-picker">
                                        <input type="text" id="backgroundColorText" value="#0f0f23" class="color-text-input">
                                    </div>
                                </div>
                                <div class="color-control">
                                    <label>Text Color</label>
                                    <div class="color-input-group">
                                        <input type="color" id="textColor" value="#e2e8f0" class="color-picker">
                                        <input type="text" id="textColorText" value="#e2e8f0" class="color-text-input">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Typography Controls -->
                        <div class="control-group">
                            <h4 class="control-group-title">
                                <i class="fas fa-font"></i>
                                Typography
                            </h4>
                            <div class="typography-controls">
                                <div class="typography-control">
                                    <label>Primary Font</label>
                                    <select id="primaryFont" class="theme-select">
                                        <option value="Inter">Inter</option>
                                        <option value="Poppins">Poppins</option>
                                        <option value="Roboto">Roboto</option>
                                        <option value="Montserrat">Montserrat</option>
                                        <option value="Open Sans">Open Sans</option>
                                        <option value="Lato">Lato</option>
                                        <option value="Raleway">Raleway</option>
                                        <option value="Nunito Sans">Nunito Sans</option>
                                    </select>
                                </div>
                                <div class="typography-control">
                                    <label>Display Font</label>
                                    <select id="displayFont" class="theme-select">
                                        <option value="Orbitron">Orbitron</option>
                                        <option value="Audiowide">Audiowide</option>
                                        <option value="Rajdhani">Rajdhani</option>
                                        <option value="Exo 2">Exo 2</option>
                                        <option value="Space Grotesk">Space Grotesk</option>
                                        <option value="Syne">Syne</option>
                                        <option value="Chakra Petch">Chakra Petch</option>
                                    </select>
                                </div>
                                <div class="typography-control">
                                    <label>Base Font Size</label>
                                    <div class="slider-control">
                                        <input type="range" id="baseFontSize" min="12" max="24" value="16" class="theme-slider">
                                        <span id="baseFontSizeValue">16px</span>
                                    </div>
                                </div>
                                <div class="typography-control">
                                    <label>Font Weight</label>
                                    <select id="fontWeight" class="theme-select">
                                        <option value="300">Light (300)</option>
                                        <option value="400" selected>Normal (400)</option>
                                        <option value="500">Medium (500)</option>
                                        <option value="600">Semi Bold (600)</option>
                                        <option value="700">Bold (700)</option>
                                        <option value="800">Extra Bold (800)</option>
                                        <option value="900">Black (900)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advanced Controls -->
                        <div class="control-group">
                            <h4 class="control-group-title">
                                <i class="fas fa-sliders-h"></i>
                                Advanced Settings
                            </h4>
                            <div class="advanced-controls">
                                <div class="advanced-control">
                                    <label>Border Radius</label>
                                    <div class="slider-control">
                                        <input type="range" id="borderRadius" min="0" max="24" value="12" class="theme-slider">
                                        <span id="borderRadiusValue">12px</span>
                                    </div>
                                </div>
                                <div class="advanced-control">
                                    <label>Shadow Intensity</label>
                                    <div class="slider-control">
                                        <input type="range" id="shadowIntensity" min="0" max="100" value="40" class="theme-slider">
                                        <span id="shadowIntensityValue">40%</span>
                                    </div>
                                </div>
                                <div class="advanced-control">
                                    <label>Animation Speed</label>
                                    <div class="slider-control">
                                        <input type="range" id="animationSpeed" min="0.5" max="3" step="0.1" value="1" class="theme-slider">
                                        <span id="animationSpeedValue">1.0x</span>
                                    </div>
                                </div>
                                <div class="advanced-control">
                                    <label>Glass Effect</label>
                                    <div class="toggle-control">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="glassEffect" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span class="toggle-label">Enabled</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Text Area Customization -->
                        <div class="control-group">
                            <h4 class="control-group-title">
                                <i class="fas fa-edit"></i>
                                Text Area Styling
                            </h4>
                            <div class="textarea-controls">
                                <div class="textarea-control">
                                    <label>Text Area Background</label>
                                    <div class="color-input-group">
                                        <input type="color" id="textareaBackground" value="#1a1b2f" class="color-picker">
                                        <input type="text" id="textareaBackgroundText" value="#1a1b2f" class="color-text-input">
                                    </div>
                                </div>
                                <div class="textarea-control">
                                    <label>Text Area Text Color</label>
                                    <div class="color-input-group">
                                        <input type="color" id="textareaTextColor" value="#e2e8f0" class="color-picker">
                                        <input type="text" id="textareaTextColorText" value="#e2e8f0" class="color-text-input">
                                    </div>
                                </div>
                                <div class="textarea-control">
                                    <label>Text Area Border</label>
                                    <div class="color-input-group">
                                        <input type="color" id="textareaBorderColor" value="#6366f1" class="color-picker">
                                        <input type="text" id="textareaBorderColorText" value="#6366f1" class="color-text-input">
                                    </div>
                                </div>
                                <div class="textarea-control">
                                    <label>Placeholder Color</label>
                                    <div class="color-input-group">
                                        <input type="color" id="placeholderColor" value="#94a3b8" class="color-picker">
                                        <input type="text" id="placeholderColorText" value="#94a3b8" class="color-text-input">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="theme-actions-section">
                    <div class="action-buttons">
                        <button id="applyCustomTheme" class="quantum-btn success">
                            <i class="fas fa-check"></i> Apply Theme
                        </button>
                        <button id="resetCustomTheme" class="quantum-btn warning">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                        <button id="saveCustomTheme" class="quantum-btn primary">
                            <i class="fas fa-save"></i> Save Theme
                        </button>
                        <button id="exportCustomTheme" class="quantum-btn secondary">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(customThemePanel);
        
        // Buat overlay untuk panel
        const customThemeOverlay = document.createElement('div');
        customThemeOverlay.id = 'quantumCustomThemeOverlay';
        customThemeOverlay.className = 'quantum-custom-theme-overlay';
        document.body.appendChild(customThemeOverlay);
        
        // Inject styles untuk panel tema kustom
        injectCustomThemeStyles();
        
        // Setup event listeners untuk panel
        setTimeout(() => {
            document.getElementById('closeCustomThemePanel').addEventListener('click', closeCustomThemePanel);
            document.getElementById('quantumCustomThemeOverlay').addEventListener('click', closeCustomThemePanel);
            
            // Setup control event listeners
            setupCustomThemeControls();
        }, 500);
    }
    
    function injectCustomThemeStyles() {
        const style = document.createElement('style');
        style.textContent = `
            /* ==================== QUANTUM CUSTOM THEME PANEL STYLES ==================== */
            .quantum-custom-theme-panel {
                position: fixed;
                top: 0;
                right: -100%;
                width: 95%;
                max-width: 1200px;
                height: 100vh;
                background: var(--quantum-card);
                backdrop-filter: blur(40px);
                -webkit-backdrop-filter: blur(40px);
                border-left: 1px solid var(--quantum-border);
                box-shadow: -20px 0 60px rgba(0, 0, 0, 0.5);
                z-index: 10010;
                transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            
            .quantum-custom-theme-panel.active {
                right: 0;
            }
            
            .quantum-custom-theme-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(10px);
                z-index: 10009;
                opacity: 0;
                visibility: hidden;
                transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            }
            
            .quantum-custom-theme-overlay.active {
                opacity: 1;
                visibility: visible;
            }
            
            /* Panel Header */
            .custom-theme-header {
                padding: 24px 32px;
                background: var(--quantum-surface);
                border-bottom: 1px solid var(--quantum-border);
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-shrink: 0;
            }
            
            /* Panel Content */
            .custom-theme-content {
                flex: 1;
                overflow-y: auto;
                padding: 24px 32px;
                display: flex;
                flex-direction: column;
                gap: 32px;
            }
            
            /* Section Styling */
            .section-title {
                font-size: 1.25rem;
                font-weight: 700;
                color: var(--quantum-text);
                margin-bottom: 16px;
                font-family: var(--quantum-font-display);
            }
            
            /* Theme Preview */
            .theme-preview-section {
                background: var(--quantum-surface);
                border-radius: var(--quantum-radius-xl);
                padding: 24px;
                border: 1px solid var(--quantum-border);
            }
            
            .preview-card {
                background: var(--quantum-card);
                border-radius: var(--quantum-radius-lg);
                border: 1px solid var(--quantum-border);
                overflow: hidden;
            }
            
            .preview-header {
                padding: 16px 20px;
                background: var(--quantum-primary);
                color: white;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .preview-header h4 {
                margin: 0;
                font-weight: 600;
            }
            
            .preview-actions {
                display: flex;
                gap: 8px;
            }
            
            .preview-btn {
                padding: 6px 12px;
                border-radius: 6px;
                border: none;
                font-size: 12px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .preview-btn.primary {
                background: rgba(255, 255, 255, 0.2);
                color: white;
            }
            
            .preview-btn.secondary {
                background: rgba(255, 255, 255, 0.1);
                color: white;
            }
            
            .preview-content {
                padding: 20px;
            }
            
            .preview-input {
                margin: 16px 0;
            }
            
            .preview-input-field {
                width: 100%;
                padding: 10px 12px;
                border: 1px solid var(--quantum-border);
                border-radius: 6px;
                background: var(--quantum-surface);
                color: var(--quantum-text);
            }
            
            .preview-buttons {
                display: flex;
                gap: 8px;
                margin-top: 16px;
            }
            
            /* Controls Grid */
            .controls-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 24px;
            }
            
            .control-group {
                background: var(--quantum-surface);
                border-radius: var(--quantum-radius-xl);
                padding: 20px;
                border: 1px solid var(--quantum-border);
            }
            
            .control-group-title {
                font-size: 1rem;
                font-weight: 600;
                color: var(--quantum-text);
                margin-bottom: 16px;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            /* Color Controls */
            .color-controls, .typography-controls, .advanced-controls, .textarea-controls {
                display: flex;
                flex-direction: column;
                gap: 16px;
            }
            
            .color-control, .typography-control, .advanced-control, .textarea-control {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .color-control label, .typography-control label, .advanced-control label, .textarea-control label {
                font-size: 0.875rem;
                font-weight: 500;
                color: var(--quantum-text);
            }
            
            .color-input-group {
                display: flex;
                gap: 8px;
                align-items: center;
            }
            
            .color-picker {
                width: 40px;
                height: 40px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
            }
            
            .color-text-input {
                flex: 1;
                padding: 8px 12px;
                border: 1px solid var(--quantum-border);
                border-radius: 6px;
                background: var(--quantum-card);
                color: var(--quantum-text);
                font-family: var(--quantum-font-code);
                font-size: 0.875rem;
            }
            
            /* Typography Controls */
            .theme-select {
                width: 100%;
                padding: 10px 12px;
                border: 1px solid var(--quantum-border);
                border-radius: 6px;
                background: var(--quantum-card);
                color: var(--quantum-text);
                font-size: 0.875rem;
            }
            
            .slider-control {
                display: flex;
                align-items: center;
                gap: 12px;
            }
            
            .theme-slider {
                flex: 1;
                height: 6px;
                border-radius: 3px;
                background: var(--quantum-surface);
                outline: none;
                -webkit-appearance: none;
            }
            
            .theme-slider::-webkit-slider-thumb {
                -webkit-appearance: none;
                width: 18px;
                height: 18px;
                border-radius: 50%;
                background: var(--quantum-primary);
                cursor: pointer;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            }
            
            .slider-control span {
                min-width: 50px;
                font-size: 0.875rem;
                color: var(--quantum-text);
                text-align: right;
            }
            
            /* Toggle Controls */
            .toggle-control {
                display: flex;
                align-items: center;
                gap: 12px;
            }
            
            .toggle-switch {
                position: relative;
                display: inline-block;
                width: 50px;
                height: 24px;
            }
            
            .toggle-switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }
            
            .toggle-slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: var(--quantum-surface);
                transition: .4s;
                border-radius: 24px;
                border: 1px solid var(--quantum-border);
            }
            
            .toggle-slider:before {
                position: absolute;
                content: "";
                height: 16px;
                width: 16px;
                left: 4px;
                bottom: 3px;
                background-color: var(--quantum-text);
                transition: .4s;
                border-radius: 50%;
            }
            
            input:checked + .toggle-slider {
                background-color: var(--quantum-primary);
            }
            
            input:checked + .toggle-slider:before {
                transform: translateX(26px);
                background-color: white;
            }
            
            .toggle-label {
                font-size: 0.875rem;
                color: var(--quantum-text);
            }
            
            /* Action Buttons */
            .theme-actions-section {
                background: var(--quantum-surface);
                border-radius: var(--quantum-radius-xl);
                padding: 20px;
                border: 1px solid var(--quantum-border);
                flex-shrink: 0;
            }
            
            .action-buttons {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 12px;
            }
            
            /* iOS 26 Animation */
            .quantum-custom-theme-panel.ios26-minimized {
                right: 0;
                width: 400px;
                transform: translateX(0);
                animation: ios26PanelMinimize 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            }
            
            @keyframes ios26PanelMinimize {
                0% {
                    width: 95%;
                    max-width: 1200px;
                }
                100% {
                    width: 400px;
                    max-width: 400px;
                }
            }
            
            /* Responsive Design */
            @media (max-width: 1024px) {
                .quantum-custom-theme-panel {
                    width: 90%;
                }
                
                .controls-grid {
                    grid-template-columns: 1fr;
                }
            }
            
            @media (max-width: 768px) {
                .quantum-custom-theme-panel {
                    width: 100%;
                }
                
                .custom-theme-content {
                    padding: 16px 20px;
                }
                
                .custom-theme-header {
                    padding: 16px 20px;
                }
                
                .action-buttons {
                    grid-template-columns: 1fr;
                }
            }
            
            @media (max-width: 480px) {
                .quantum-custom-theme-panel.ios26-minimized {
                    width: 100%;
                }
            }
        `;
        
        document.head.appendChild(style);
        console.log('âœ… Custom Theme Panel Styles injected');
    }
    
    function openCustomThemePanel() {
        const panel = document.getElementById('quantumCustomThemePanel');
        const overlay = document.getElementById('quantumCustomThemeOverlay');
        
        if (panel && overlay) {
            panel.classList.add('active');
            overlay.classList.add('active');
            
            // Close sidebar jika terbuka
            if (window.quantumEngine) {
                window.quantumEngine.closeQuantumSidebar();
            }
            
            console.log('ðŸŽ¨ Custom Theme Panel opened');
        }
    }
    
    function closeCustomThemePanel() {
        const panel = document.getElementById('quantumCustomThemePanel');
        const overlay = document.getElementById('quantumCustomThemeOverlay');
        
        if (panel && overlay) {
            panel.classList.remove('active');
            overlay.classList.remove('active');
            
            console.log('ðŸŽ¨ Custom Theme Panel closed');
        }
    }
    
    function setupCustomThemeControls() {
        // Color picker synchronization
        const colorControls = [
            { picker: 'primaryColor', text: 'primaryColorText', default: '#6366f1' },
            { picker: 'secondaryColor', text: 'secondaryColorText', default: '#8b5cf6' },
            { picker: 'backgroundColor', text: 'backgroundColorText', default: '#0f0f23' },
            { picker: 'textColor', text: 'textColorText', default: '#e2e8f0' },
            { picker: 'textareaBackground', text: 'textareaBackgroundText', default: '#1a1b2f' },
            { picker: 'textareaTextColor', text: 'textareaTextColorText', default: '#e2e8f0' },
            { picker: 'textareaBorderColor', text: 'textareaBorderColorText', default: '#6366f1' },
            { picker: 'placeholderColor', text: 'placeholderColorText', default: '#94a3b8' }
        ];
        
        colorControls.forEach(control => {
            const picker = document.getElementById(control.picker);
            const text = document.getElementById(control.text);
            
            if (picker && text) {
                // Sync from picker to text
                picker.addEventListener('input', function() {
                    text.value = this.value;
                    applyLivePreview();
                });
                
                // Sync from text to picker
                text.addEventListener('input', function() {
                    if (this.value.match(/^#[0-9A-F]{6}$/i)) {
                        picker.value = this.value;
                        applyLivePreview();
                    }
                });
                
                // Set default values
                picker.value = control.default;
                text.value = control.default;
            }
        });
        
        // Slider controls
        const sliderControls = [
            { slider: 'baseFontSize', value: 'baseFontSizeValue', suffix: 'px' },
            { slider: 'borderRadius', value: 'borderRadiusValue', suffix: 'px' },
            { slider: 'shadowIntensity', value: 'shadowIntensityValue', suffix: '%' },
            { slider: 'animationSpeed', value: 'animationSpeedValue', suffix: 'x' }
        ];
        
        sliderControls.forEach(control => {
            const slider = document.getElementById(control.slider);
            const value = document.getElementById(control.value);
            
            if (slider && value) {
                slider.addEventListener('input', function() {
                    value.textContent = this.value + control.suffix;
                    applyLivePreview();
                });
            }
        });
        
        // Select controls
        const selectControls = ['primaryFont', 'displayFont', 'fontWeight'];
        
        selectControls.forEach(control => {
            const select = document.getElementById(control);
            if (select) {
                select.addEventListener('change', applyLivePreview);
            }
        });
        
        // Toggle controls
        const toggle = document.getElementById('glassEffect');
        if (toggle) {
            toggle.addEventListener('change', applyLivePreview);
        }
        
        // Action buttons
        document.getElementById('applyCustomTheme').addEventListener('click', applyCustomTheme);
        document.getElementById('resetCustomTheme').addEventListener('click', resetCustomTheme);
        document.getElementById('saveCustomTheme').addEventListener('click', saveCustomTheme);
        document.getElementById('exportCustomTheme').addEventListener('click', exportCustomTheme);
        
        console.log('âœ… Custom Theme Controls setup complete');
    }
    
    function applyLivePreview() {
        // Get current values
        const primaryColor = document.getElementById('primaryColor').value;
        const secondaryColor = document.getElementById('secondaryColor').value;
        const backgroundColor = document.getElementById('backgroundColor').value;
        const textColor = document.getElementById('textColor').value;
        const primaryFont = document.getElementById('primaryFont').value;
        const displayFont = document.getElementById('displayFont').value;
        const baseFontSize = document.getElementById('baseFontSize').value;
        const fontWeight = document.getElementById('fontWeight').value;
        const borderRadius = document.getElementById('borderRadius').value;
        const shadowIntensity = document.getElementById('shadowIntensity').value;
        const animationSpeed = document.getElementById('animationSpeed').value;
        const glassEffect = document.getElementById('glassEffect').checked;
        
        // Text area specific
        const textareaBackground = document.getElementById('textareaBackground').value;
        const textareaTextColor = document.getElementById('textareaTextColor').value;
        const textareaBorderColor = document.getElementById('textareaBorderColor').value;
        const placeholderColor = document.getElementById('placeholderColor').value;
        
        // Apply to preview
        const previewCard = document.querySelector('.preview-card');
        const previewHeader = document.querySelector('.preview-header');
        const previewInput = document.querySelector('.preview-input-field');
        
        if (previewCard) {
            previewCard.style.setProperty('--preview-primary', primaryColor);
            previewCard.style.setProperty('--preview-bg', backgroundColor);
            previewCard.style.setProperty('--preview-text', textColor);
            previewCard.style.setProperty('--preview-radius', borderRadius + 'px');
            previewCard.style.fontFamily = primaryFont;
            previewCard.style.fontSize = baseFontSize + 'px';
            previewCard.style.fontWeight = fontWeight;
        }
        
        if (previewHeader) {
            previewHeader.style.background = primaryColor;
        }
        
        if (previewInput) {
            previewInput.style.background = textareaBackground;
            previewInput.style.color = textareaTextColor;
            previewInput.style.borderColor = textareaBorderColor;
            previewInput.style.setProperty('--placeholder-color', placeholderColor);
        }
        
        // Update preview buttons
        const previewButtons = document.querySelectorAll('.preview-btn.primary');
        previewButtons.forEach(btn => {
            btn.style.background = primaryColor;
        });
        
        console.log('ðŸŽ¨ Live preview updated');
    }
    
    function applyCustomTheme() {
        // Get all values
        const primaryColor = document.getElementById('primaryColor').value;
        const secondaryColor = document.getElementById('secondaryColor').value;
        const backgroundColor = document.getElementById('backgroundColor').value;
        const textColor = document.getElementById('textColor').value;
        const primaryFont = document.getElementById('primaryFont').value;
        const displayFont = document.getElementById('displayFont').value;
        const baseFontSize = document.getElementById('baseFontSize').value;
        const fontWeight = document.getElementById('fontWeight').value;
        const borderRadius = document.getElementById('borderRadius').value;
        const shadowIntensity = document.getElementById('shadowIntensity').value;
        const animationSpeed = document.getElementById('animationSpeed').value;
        const glassEffect = document.getElementById('glassEffect').checked;
        
        // Text area specific
        const textareaBackground = document.getElementById('textareaBackground').value;
        const textareaTextColor = document.getElementById('textareaTextColor').value;
        const textareaBorderColor = document.getElementById('textareaBorderColor').value;
        const placeholderColor = document.getElementById('placeholderColor').value;
        
        // Apply to document
        const root = document.documentElement;
        
        // Colors
        root.style.setProperty('--quantum-primary', primaryColor);
        root.style.setProperty('--quantum-secondary', secondaryColor);
        root.style.setProperty('--quantum-bg', backgroundColor);
        root.style.setProperty('--quantum-text', textColor);
        root.style.setProperty('--quantum-layer1', primaryColor);
        root.style.setProperty('--quantum-layer2', secondaryColor);
        
        // Typography
        root.style.setProperty('--quantum-font-primary', primaryFont + ', sans-serif');
        root.style.setProperty('--quantum-font-display', displayFont + ', monospace');
        root.style.setProperty('--base-font-size', baseFontSize + 'px');
        document.body.style.fontWeight = fontWeight;
        
        // Layout
        root.style.setProperty('--quantum-radius-md', borderRadius + 'px');
        root.style.setProperty('--quantum-radius-lg', (parseInt(borderRadius) + 4) + 'px');
        root.style.setProperty('--quantum-radius-xl', (parseInt(borderRadius) + 8) + 'px');
        
        // Effects
        const shadowValue = `0 8px 30px rgba(0, 0, 0, ${shadowIntensity/100})`;
        root.style.setProperty('--quantum-shadow-md', shadowValue);
        
        // Animation speed
        document.body.style.setProperty('--ios-transition', `all ${0.8/animationSpeed}s cubic-bezier(0.25, 0.46, 0.45, 0.94)`);
        
        // Glass effect
        if (glassEffect) {
            root.style.setProperty('--quantum-glass-bg', 'rgba(255, 255, 255, 0.05)');
            root.style.setProperty('--quantum-glass-border', 'rgba(255, 255, 255, 0.1)');
        } else {
            root.style.setProperty('--quantum-glass-bg', 'transparent');
            root.style.setProperty('--quantum-glass-border', 'transparent');
        }
        
        // Text area styling
        const textareas = document.querySelectorAll('textarea');
        textareas.forEach(textarea => {
            textarea.style.background = textareaBackground;
            textarea.style.color = textareaTextColor;
            textarea.style.borderColor = textareaBorderColor;
            textarea.style.setProperty('--placeholder-color', placeholderColor);
        });
        
        // Apply iOS 26 minimize animation
        const panel = document.getElementById('quantumCustomThemePanel');
        if (panel) {
            panel.classList.add('ios26-minimized');
            
            // Auto-close setelah beberapa detik
            setTimeout(() => {
                closeCustomThemePanel();
                panel.classList.remove('ios26-minimized');
            }, 2000);
        }
        
        // Show notification
        if (window.quantumEngine) {
            window.quantumEngine.updateQuantumIsland('ðŸŽ¨ Custom Theme Applied!', 2000);
        }
        
        console.log('ðŸŽ¨ Custom theme applied to entire application');
    }
    
    function resetCustomTheme() {
        // Reset all controls to default
        document.getElementById('primaryColor').value = '#6366f1';
        document.getElementById('primaryColorText').value = '#6366f1';
        document.getElementById('secondaryColor').value = '#8b5cf6';
        document.getElementById('secondaryColorText').value = '#8b5cf6';
        document.getElementById('backgroundColor').value = '#0f0f23';
        document.getElementById('backgroundColorText').value = '#0f0f23';
        document.getElementById('textColor').value = '#e2e8f0';
        document.getElementById('textColorText').value = '#e2e8f0';
        
        document.getElementById('primaryFont').value = 'Inter';
        document.getElementById('displayFont').value = 'Orbitron';
        document.getElementById('baseFontSize').value = '16';
        document.getElementById('baseFontSizeValue').textContent = '16px';
        document.getElementById('fontWeight').value = '400';
        
        document.getElementById('borderRadius').value = '12';
        document.getElementById('borderRadiusValue').textContent = '12px';
        document.getElementById('shadowIntensity').value = '40';
        document.getElementById('shadowIntensityValue').textContent = '40%';
        document.getElementById('animationSpeed').value = '1';
        document.getElementById('animationSpeedValue').textContent = '1.0x';
        document.getElementById('glassEffect').checked = true;
        
        document.getElementById('textareaBackground').value = '#1a1b2f';
        document.getElementById('textareaBackgroundText').value = '#1a1b2f';
        document.getElementById('textareaTextColor').value = '#e2e8f0';
        document.getElementById('textareaTextColorText').value = '#e2e8f0';
        document.getElementById('textareaBorderColor').value = '#6366f1';
        document.getElementById('textareaBorderColorText').value = '#6366f1';
        document.getElementById('placeholderColor').value = '#94a3b8';
        document.getElementById('placeholderColorText').value = '#94a3b8';
        
        // Update preview
        applyLivePreview();
        
        console.log('ðŸŽ¨ Custom theme reset to defaults');
    }
    
    function saveCustomTheme() {
        // Collect all theme data
        const themeData = {
            name: 'Custom Theme ' + new Date().toLocaleDateString(),
            colors: {
                primary: document.getElementById('primaryColor').value,
                secondary: document.getElementById('secondaryColor').value,
                background: document.getElementById('backgroundColor').value,
                text: document.getElementById('textColor').value,
                textareaBackground: document.getElementById('textareaBackground').value,
                textareaTextColor: document.getElementById('textareaTextColor').value,
                textareaBorderColor: document.getElementById('textareaBorderColor').value,
                placeholderColor: document.getElementById('placeholderColor').value
            },
            typography: {
                primaryFont: document.getElementById('primaryFont').value,
                displayFont: document.getElementById('displayFont').value,
                baseFontSize: document.getElementById('baseFontSize').value,
                fontWeight: document.getElementById('fontWeight').value
            },
            layout: {
                borderRadius: document.getElementById('borderRadius').value,
                shadowIntensity: document.getElementById('shadowIntensity').value,
                animationSpeed: document.getElementById('animationSpeed').value,
                glassEffect: document.getElementById('glassEffect').checked
            },
            timestamp: new Date().toISOString()
        };
        
        // Save to localStorage
        const savedThemes = JSON.parse(localStorage.getItem('quantum_custom_themes') || '[]');
        savedThemes.push(themeData);
        localStorage.setItem('quantum_custom_themes', JSON.stringify(savedThemes));
        
        // Show notification
        if (window.quantumEngine) {
            window.quantumEngine.updateQuantumIsland('ðŸ’¾ Custom Theme Saved!', 2000);
        }
        
        console.log('ðŸŽ¨ Custom theme saved:', themeData);
    }
    
    function exportCustomTheme() {
        // Collect theme data
        const themeData = {
            name: 'STL-AI Custom Theme',
            version: '1.0',
            author: 'User',
            colors: {
                primary: document.getElementById('primaryColor').value,
                secondary: document.getElementById('secondaryColor').value,
                background: document.getElementById('backgroundColor').value,
                text: document.getElementById('textColor').value
            },
            typography: {
                primaryFont: document.getElementById('primaryFont').value,
                displayFont: document.getElementById('displayFont').value,
                baseFontSize: document.getElementById('baseFontSize').value
            },
            timestamp: new Date().toISOString()
        };
        
        // Create download
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(themeData, null, 2));
        const downloadAnchor = document.createElement('a');
        downloadAnchor.setAttribute("href", dataStr);
        downloadAnchor.setAttribute("download", "stl-ai-custom-theme.json");
        document.body.appendChild(downloadAnchor);
        downloadAnchor.click();
        downloadAnchor.remove();
        
        // Show notification
        if (window.quantumEngine) {
            window.quantumEngine.updateQuantumIsland('ðŸ“¤ Theme Exported!', 2000);
        }
        
        console.log('ðŸŽ¨ Custom theme exported');
    }
}

// ==================== INITIALIZE CUSTOM THEME SYSTEM ====================
function initializeCustomThemeSystem() {
    console.log('ðŸŽ¨ Starting Quantum Custom Theme System...');
    
    // Inject custom theme system
    injectCustomThemeSystem();
    
    console.log('âœ… Quantum Custom Theme System Activated!');
}

// ==================== AUTO-INITIALIZE CUSTOM THEME SYSTEM ====================
function waitForEngineAndAddCustomThemes() {
    if (window.quantumEngine) {
        initializeCustomThemeSystem();
    } else {
        setTimeout(waitForEngineAndAddCustomThemes, 100);
    }
}

// Start the custom theme system
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', waitForEngineAndAddCustomThemes);
} else {
    waitForEngineAndAddCustomThemes();
}

// Update global enhancements
if (window.QuantumEnhancements) {
    window.QuantumEnhancements.injectCustomThemeSystem = injectCustomThemeSystem;
    window.QuantumEnhancements.initializeCustomThemeSystem = initializeCustomThemeSystem;
}

console.log('ðŸŽ¨ Quantum Custom Theme System Module Loaded - Ready for advanced theming!');
</script>
<!-- Tambahkan kode ini di bagian akhir sebelum penutup 
<!-- NAJIB OPTIMIZER PATCH v1.0 (Fonts + Particle Optimizer + Cinematic Modes + Child-suite soft-mode) -->
<script id="najib-optimizer-patch">
(function(){
'use strict';
/*** UTIL: capability detection ***/
function detectCapsSafe(){
try{
if(window.__NAJIB_CAPS) return window.__NAJIB_CAPS;
const caps = { cores: navigator.hardwareConcurrency||2, mem: navigator.deviceMemory||2, dpr: window.devicePixelRatio||1, webgl:false, webgl2:false };
try{
const c=document.createElement('canvas');
const g2 = c.getContext && c.getContext('webgl2');
const g = g2 || (c.getContext && (c.getContext('webgl')||c.getContext('experimental-webgl')));
if(g){ caps.webgl = !!g; caps.webgl2 = !!g2; }
}catch(e){}
let score=0;
if(caps.cores>=8) score+=30; else if(caps.cores>=4) score+=18; else score+=8;
if(caps.mem>=8) score+=30; else if(caps.mem>=4) score+=18; else score+=6;
if(caps.webgl2) score+=30; else if(caps.webgl) score+=16;
caps.score = score;
if(caps.cores<=2 || caps.mem<=1 || caps.score<24) caps.profile='low';
else if((caps.cores<=4 && caps.mem<=3) || caps.score<48) caps.profile='mid';
else caps.profile='high';
window.__NAJIB_CAPS = caps;
return caps;
}catch(e){
return { profile:'low', cores:2, mem:1, dpr:1 };
}
}
const CAPS = detectCapsSafe();

/***** 1) FONT LAZY LOADER *****/
(function lazyFonts(){
try{
const heavyLinks = Array.from(document.querySelectorAll('link[href*="fonts.googleapis.com"], link[href*="fonts.gstatic.com"]'));
if(!heavyLinks.length) return;
if(CAPS.profile === 'low' || window.matchMedia('(prefers-reduced-data: reduce)').matches){
heavyLinks.forEach(l => { l.media='print'; l.setAttribute('data-deferred','1'); });
return;
}
function loadHeavyFonts(){
heavyLinks.forEach(l=>{
if(l.getAttribute('data-deferred')) return;
l.rel = 'stylesheet';
l.removeAttribute('media');
l.setAttribute('data-loaded-by','najib-optimizer');
});
}
if('requestIdleCallback' in window){
requestIdleCallback(loadHeavyFonts, {timeout:3000});
} else {
const onFirst = function(){ loadHeavyFonts(); window.removeEventListener('pointerdown', onFirst); window.removeEventListener('touchstart', onFirst); };
window.addEventListener('pointerdown', onFirst, {once:true});
window.addEventListener('touchstart', onFirst, {once:true});
setTimeout(loadHeavyFonts, 6000);
}
}catch(e){ console.warn('[najib-optimizer] lazyFonts failed', e); }
})();

/***** 2) PARTICLE SMART OPTIMIZER *****/
(function particleOptimizer(){
try{
const container = document.getElementById('quantumParticles') || document.querySelector('.quantum-particles');
if(!container) return;
function makeParticle(cls, x, y, size, content){
const el = document.createElement('div');
el.className = 'particle ' + cls;
el.style.left = (x*100).toFixed(2) + 'vw';
el.style.top = (y*100).toFixed(2) + 'vh';
el.style.width = size + 'px';
el.style.height = size + 'px';
if(content) { el.textContent = content; el.classList.add('particle-codeRain'); el.style.fontSize = Math.max(10, size) + 'px'; el.style.width = 'auto'; el.style.height = 'auto'; }
return el;
}
const baseCounts = {
goldenFloat: 28, blackPulse: 20, redSword: 22, shapeShifter: 20,
codeRain: 36, oceanWave: 26, neonPulse: 24, roseFloat: 24
};
const scaleMap = { high:1, mid:0.45, low:0.08 };
const profile = CAPS.profile || 'low';
const scale = scaleMap[profile] || 0.45;
const reduceEffects = (profile === 'low' || window.matchMedia('(prefers-reduced-motion: reduce)').matches);

window.renderParticlesForTheme = function(themeKey){
try{
const t = themeKey || 'goldenFloat';
const mapName = {
goldenFloat:'goldenFloat', blackPulse:'blackPulse', redSword:'redSword',
shapeShifter:'shapeShifter', codeRain:'codeRain', oceanWave:'oceanWave',
neonPulse:'neonPulse', roseFloat:'roseFloat'
}[t] || 'goldenFloat';
const base = baseCounts[mapName] || 18;
const count = Math.max( Math.round(base*scale), (reduceEffects ? 0 : 2) );
container.innerHTML = '';
if(count === 0){
const accent = document.createElement('div');
accent.className = 'particle particle-neonPulse';
accent.style.left = '50%';
accent.style.top = '80%';
accent.style.width = '4px';
accent.style.height = '4px';
accent.style.opacity = '0.6';
accent.style.pointerEvents = 'none';
container.appendChild(accent);
return;
}
const fragment = document.createDocumentFragment();
for(let i=0;i<count;i++){
const x = Math.random(); const y = Math.random();
const size = (mapName==='codeRain' ? Math.max(10, Math.round(Math.random()*14+6)) : Math.round(Math.random()*(reduceEffects?4:8) + (reduceEffects?2:2)));
const p = makeParticle('particle-'+mapName, x, y, size, mapName==='codeRain'? (Math.random()>0.7?String.fromCharCode(0x30A0 + Math.floor(Math.random()*96)) : '') : '');
if(reduceEffects){
p.style.boxShadow = 'none';
p.style.filter = 'none';
p.style.animationDuration = '8s';
}
fragment.appendChild(p);
}
container.appendChild(fragment);
}catch(e){ console.warn('[najib-optimizer] renderParticlesForTheme fail', e); }
};

try{
const saved = (JSON.parse(localStorage.getItem('najib_saved_themes')||'[]') || [])[0];
const initialTheme = saved ? (saved.variables && saved.variables.particleTheme) : 'goldenFloat';
setTimeout(()=>{ try{ window.renderParticlesForTheme(initialTheme); }catch(e){} }, 300);
}catch(e){}

window.__najib_particle_optimizer = { profile: CAPS.profile, reducedEffects: reduceEffects };

}catch(e){ console.warn('[najib-optimizer] particleOptimizer top fail', e); }
})();

/***** 3) CINEMATIC MODULAR MODE *****/
(function cinematicModular(){
try{
const ROOT = document.getElementById('stl-open');
if(!ROOT) return;
const mode = CAPS.profile || 'low';
ROOT.setAttribute('data-cinematic-mode', mode);

function applyMode(){
if(mode === 'low'){
const chrom = document.querySelector('.stl-chromatic');
if(chrom) chrom.style.display = 'none';
const scan = document.getElementById('stl-scan');
if(scan) { scan.style.animationDuration = '12s'; scan.style.opacity='0.12'; }
const TITLE = document.getElementById('stl-title');
const TAG = document.getElementById('stl-tag');
if(TITLE) TITLE.style.transition='opacity .6s ease';
if(TAG) TAG.style.transition='opacity .6s ease';
setTimeout(()=>{ try{ ROOT.style.opacity='0'; setTimeout(()=>{ try{ ROOT.remove(); }catch(e){ ROOT.style.display='none'; } }, 550); }catch(e){} }, 900);
}
else if(mode === 'mid'){
const scan = document.getElementById('stl-scan'); if(scan) scan.style.opacity='0.22';
const fract = document.querySelector('.stl-fractal'); if(fract) fract.style.opacity='0.7';
setTimeout(()=>{ try{ ROOT.style.opacity='0'; setTimeout(()=>{ try{ ROOT.remove(); }catch(e){ ROOT.style.display='none'; } }, 900); }catch(e){} }, 4000);
}
}
applyMode();
window.__najib_cinematic_force = function(lvl){
try{ if(!lvl) return; ROOT.setAttribute('data-cinematic-mode', lvl); location.reload(); }catch(e){}
};
}catch(e){ console.warn('[najib-optimizer] cinematicModular fail', e); }
})();

/***** 4) CHILD-SUITE SOFT MODE *****/
(function softenChildSuite(){
try{
(function installSoftObserver(){
let throttleAt = 0;
let backoffMs = 1000;
const whitelist = ['#stl-open','#quantumParticles','#quantumIsland','.quantum-sidebar','.quantum-tools-sidebar'];
const safeCheck = (node)=>{
try{
if(!node || node.nodeType !== 1) return true;
for(const s of whitelist){
try{ if(node.matches && node.matches(s) || (node.closest && node.closest(s))) return true; }catch(e){}
}
const tag = (node.tagName||'').toLowerCase();
if(['div','span','script','style','link','meta','img','svg'].indexOf(tag) !== -1) return true;
return false;
}catch(e){ return true; }
};
const mo = new MutationObserver((mutations)=>{
const now = Date.now();
if(now - throttleAt < backoffMs) return;
throttleAt = now;
let flagged = false;
for(const m of mutations){
for(const n of (m.addedNodes||[])){
if(!safeCheck(n)) flagged = true;
}
}
if(flagged){
console.info('[najib-softObserver] suspicious DOM additions detected');
setTimeout(()=>{ try{ if(window.DEV_mg && typeof window.DEV_mg.auditProtections === 'function') window.DEV_mg.auditProtections({soft:true}); }catch(e){} }, 1200);
backoffMs = Math.min(60000, Math.max(2000, backoffMs * 1.5));
} else {
backoffMs = Math.max(1000, Math.floor(backoffMs*0.9));
}
});
try{
mo.observe(document.documentElement || document.body, { childList:true, subtree:true });
window.__najib_soft_mo = mo;
}catch(e){}
})();
}catch(e){ console.warn('[najib-optimizer] softenChildSuite fail', e); }
})();

/***** 5) REPORT SUMMARY *****/
try{
console.info('[najib-optimizer] applied. profile=%s', CAPS.profile);
}catch(e){}
})();
</script>
<!-- END NAJIB OPTIMIZER PATCH -->
</body>
 -->

<script>
// ==================== MONGODB INTEGRATION SYSTEM ====================
class MongoDBIntegration {
    constructor() {
        this.currentMethod = 'easy';
        this.isConnected = false;
        this.connectionStatus = 'disconnected';
        this.init();
    }

    init() {
        this.injectMongoDBSection();
        this.setupEventListeners();
        this.loadSavedConfig();
        console.log('ðŸ”— MongoDB Integration System Initialized');
    }

    injectMongoDBSection() {
        const toolsSidebar = document.getElementById('quantumToolsSidebar');
        if (!toolsSidebar) {
            setTimeout(() => this.injectMongoDBSection(), 500);
            return;
        }

        // Cari container yang tepat untuk menambahkan section MongoDB
        const toolsContent = toolsSidebar.querySelector('.space-y-6');
        if (!toolsContent) {
            console.log('âŒ Tools content not found');
            return;
        }

        // Buat section MongoDB
        const mongoSection = document.createElement('div');
        mongoSection.className = 'quantum-card glass p-5';
        mongoSection.innerHTML = this.getMongoDBHTML();
        
        // Tambahkan di atas section Export Data
        const exportSection = toolsContent.querySelector('.quantum-card.glass:has(.fa-download)');
        if (exportSection) {
            toolsContent.insertBefore(mongoSection, exportSection);
        } else {
            toolsContent.appendChild(mongoSection);
        }

        console.log('âœ… MongoDB section injected into left sidebar');
    }

    getMongoDBHTML() {
        return `
            <h3 class="text-lg font-black text-white mb-4 flex items-center gap-2">
                <i class="fas fa-database text-green-400"></i>
                MongoDB Integration
            </h3>
            <div class="space-y-4">
                <!-- Method Selection -->
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <button id="mongoEasyMethod" class="quantum-btn success text-xs py-2">
                        <i class="fas fa-bolt"></i> Easy
                    </button>
                    <button id="mongoAdvancedMethod" class="quantum-btn secondary text-xs py-2">
                        <i class="fas fa-cogs"></i> Advanced
                    </button>
                </div>

                <!-- Easy Method -->
                <div id="mongoEasySection" class="mongo-method-section">
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-medium text-green-300 mb-1">REST API URL</label>
                            <input type="text" id="mongoRestUrl" placeholder="https://api.mongodb.com" class="quantum-input glass text-sm py-2">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-green-300 mb-1">API Key</label>
                            <input type="password" id="mongoApiKey" placeholder="Your API Key" class="quantum-input glass text-sm py-2">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="testEasyMongo" class="quantum-btn warning text-xs py-2">
                                <i class="fas fa-vial"></i> Test
                            </button>
                            <button id="saveEasyMongo" class="quantum-btn success text-xs py-2">
                                <i class="fas fa-save"></i> Save
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Advanced Method -->
                <div id="mongoAdvancedSection" class="mongo-method-section" style="display: none;">
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-medium text-purple-300 mb-1">Connection String</label>
                            <input type="password" id="mongoConnectionString" placeholder="mongodb+srv://..." class="quantum-input glass text-sm py-2">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs font-medium text-purple-300 mb-1">Database</label>
                                <input type="text" id="mongoDatabaseName" placeholder="stl-aichat" class="quantum-input glass text-sm py-2">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-purple-300 mb-1">Collection</label>
                                <input type="text" id="mongoCollectionName" placeholder="conversations" class="quantum-input glass text-sm py-2">
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <button id="testAdvancedMongo" class="quantum-btn warning text-xs py-2">
                                <i class="fas fa-vial"></i> Test
                            </button>
                            <button id="saveAdvancedMongo" class="quantum-btn success text-xs py-2">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button id="generateMongoString" class="quantum-btn secondary text-xs py-2">
                                <i class="fas fa-magic"></i> Gen
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Connection Status -->
                <div id="mongoConnectionStatus" class="text-xs text-blue-400 bg-blue-900/20 rounded p-2">
                    ðŸ”— Ready to configure MongoDB
                </div>

                <!-- Quick Actions -->
                <div class="border-t border-gray-600 pt-3 mt-3">
                    <div class="grid grid-cols-2 gap-2">
                        <button id="quickExportMongo" class="quantum-btn primary text-xs py-2">
                            <i class="fas fa-upload"></i> Export
                        </button>
                        <button id="quickImportMongo" class="quantum-btn warning text-xs py-2">
                            <i class="fas fa-download"></i> Import
                        </button>
                    </div>
                </div>

                <!-- Tutorial Toggle -->
                <div class="border-t border-gray-600 pt-3">
                    <button id="toggleMongoTutorial" class="quantum-btn secondary text-xs w-full py-2">
                        <i class="fas fa-graduation-cap"></i> Show Tutorial
                    </button>
                    <div id="mongoTutorial" class="mt-3 space-y-2 text-xs hidden">
                        <div class="flex items-start gap-2 text-green-300">
                            <span class="bg-green-600 rounded w-4 h-4 flex items-center justify-center text-xs mt-0.5 flex-shrink-0">1</span>
                            <p>Get MongoDB Atlas account at <a href="https://mongodb.com/atlas" class="underline" target="_blank">mongodb.com</a></p>
                        </div>
                        <div class="flex items-start gap-2 text-green-300">
                            <span class="bg-green-600 rounded w-4 h-4 flex items-center justify-center text-xs mt-0.5 flex-shrink-0">2</span>
                            <p>Choose Easy (REST API) or Advanced (Direct) method</p>
                        </div>
                        <div class="flex items-start gap-2 text-green-300">
                            <span class="bg-green-600 rounded w-4 h-4 flex items-center justify-center text-xs mt-0.5 flex-shrink-0">3</span>
                            <p>Test connection and save configuration</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    setupEventListeners() {
        // Tunggu hingga DOM di-update
        setTimeout(() => {
            // Method Selection
            this.setupMethodSelection();
            
            // Easy Method
            this.setupEasyMethod();
            
            // Advanced Method
            this.setupAdvancedMethod();
            
            // Quick Actions
            this.setupQuickActions();
            
            // Tutorial
            this.setupTutorial();
        }, 1000);
    }

    setupMethodSelection() {
        const easyBtn = document.getElementById('mongoEasyMethod');
        const advancedBtn = document.getElementById('mongoAdvancedMethod');
        const easySection = document.getElementById('mongoEasySection');
        const advancedSection = document.getElementById('mongoAdvancedSection');

        if (easyBtn && advancedBtn) {
            easyBtn.addEventListener('click', () => {
                this.showEasyMethod();
                easyBtn.classList.remove('secondary');
                easyBtn.classList.add('success');
                advancedBtn.classList.remove('primary');
                advancedBtn.classList.add('secondary');
            });

            advancedBtn.addEventListener('click', () => {
                this.showAdvancedMethod();
                advancedBtn.classList.remove('secondary');
                advancedBtn.classList.add('primary');
                easyBtn.classList.remove('success');
                easyBtn.classList.add('secondary');
            });
        }
    }

    setupEasyMethod() {
        const testBtn = document.getElementById('testEasyMongo');
        const saveBtn = document.getElementById('saveEasyMongo');

        if (testBtn) {
            testBtn.addEventListener('click', () => this.testEasyConnection());
        }
        if (saveBtn) {
            saveBtn.addEventListener('click', () => this.saveEasyConfig());
        }
    }

    setupAdvancedMethod() {
        const testBtn = document.getElementById('testAdvancedMongo');
        const saveBtn = document.getElementById('saveAdvancedMongo');
        const generateBtn = document.getElementById('generateMongoString');

        if (testBtn) {
            testBtn.addEventListener('click', () => this.testAdvancedConnection());
        }
        if (saveBtn) {
            saveBtn.addEventListener('click', () => this.saveAdvancedConfig());
        }
        if (generateBtn) {
            generateBtn.addEventListener('click', () => this.generateConnectionString());
        }
    }

    setupQuickActions() {
        const exportBtn = document.getElementById('quickExportMongo');
        const importBtn = document.getElementById('quickImportMongo');

        if (exportBtn) {
            exportBtn.addEventListener('click', () => this.exportToMongoDB());
        }
        if (importBtn) {
            importBtn.addEventListener('click', () => this.importFromMongoDB());
        }
    }

    setupTutorial() {
        const toggleBtn = document.getElementById('toggleMongoTutorial');
        const tutorial = document.getElementById('mongoTutorial');

        if (toggleBtn && tutorial) {
            toggleBtn.addEventListener('click', () => {
                if (tutorial.classList.contains('hidden')) {
                    tutorial.classList.remove('hidden');
                    toggleBtn.innerHTML = '<i class="fas fa-graduation-cap"></i> Hide Tutorial';
                } else {
                    tutorial.classList.add('hidden');
                    toggleBtn.innerHTML = '<i class="fas fa-graduation-cap"></i> Show Tutorial';
                }
            });
        }
    }

    showEasyMethod() {
        const easySection = document.getElementById('mongoEasySection');
        const advancedSection = document.getElementById('mongoAdvancedSection');
        
        if (easySection) easySection.style.display = 'block';
        if (advancedSection) advancedSection.style.display = 'none';
        this.currentMethod = 'easy';
    }

    showAdvancedMethod() {
        const easySection = document.getElementById('mongoEasySection');
        const advancedSection = document.getElementById('mongoAdvancedSection');
        
        if (easySection) easySection.style.display = 'none';
        if (advancedSection) advancedSection.style.display = 'block';
        this.currentMethod = 'advanced';
    }

    async testEasyConnection() {
        const url = document.getElementById('mongoRestUrl')?.value;
        const apiKey = document.getElementById('mongoApiKey')?.value;
        
        if (!url || !apiKey) {
            this.updateStatus('Please fill in all fields', 'error');
            return;
        }

        this.updateStatus('Testing REST API connection...', 'connecting');

        try {
            const isValid = await this.testRESTConnection(url, apiKey);
            
            if (isValid) {
                this.updateStatus('âœ… REST API connection successful!', 'connected');
                this.isConnected = true;
            } else {
                this.updateStatus('âŒ Connection failed. Check credentials.', 'error');
            }
        } catch (error) {
            this.updateStatus(`âŒ Error: ${error.message}`, 'error');
        }
    }

    async testAdvancedConnection() {
        const connectionString = document.getElementById('mongoConnectionString')?.value;
        const databaseName = document.getElementById('mongoDatabaseName')?.value;
        
        if (!connectionString || !databaseName) {
            this.updateStatus('Please fill in all required fields', 'error');
            return;
        }

        this.updateStatus('Testing MongoDB connection...', 'connecting');

        try {
            const isValid = await this.testMongoDBConnection(connectionString, databaseName);
            
            if (isValid) {
                this.updateStatus('âœ… MongoDB connection successful!', 'connected');
                this.isConnected = true;
            } else {
                this.updateStatus('âŒ Connection failed. Check connection string.', 'error');
            }
        } catch (error) {
            this.updateStatus(`âŒ Error: ${error.message}`, 'error');
        }
    }

    async testRESTConnection(url, apiKey) {
        return new Promise((resolve) => {
            setTimeout(() => {
                const isValid = url.includes('mongodb') || url.includes('api') || url.includes('realm');
                resolve(isValid);
            }, 1500);
        });
    }

    async testMongoDBConnection(connectionString, databaseName) {
        return new Promise((resolve) => {
            setTimeout(() => {
                const isValid = connectionString.includes('mongodb') && databaseName.length > 0;
                resolve(isValid);
            }, 2000);
        });
    }

    updateStatus(message, type = 'info') {
        const statusElement = document.getElementById('mongoConnectionStatus');
        if (statusElement) {
            statusElement.textContent = message;
            statusElement.className = `text-xs rounded p-2 ${
                type === 'connected' ? 'text-green-400 bg-green-900/20' :
                type === 'error' ? 'text-red-400 bg-red-900/20' :
                type === 'connecting' ? 'text-yellow-400 bg-yellow-900/20' :
                'text-blue-400 bg-blue-900/20'
            }`;
        }

        // Update Quantum Island
        if (window.quantumEngine && type !== 'info') {
            window.quantumEngine.updateQuantumIsland(`ðŸ—„ï¸ ${message}`, 2000);
        }
    }

    saveEasyConfig() {
        const url = document.getElementById('mongoRestUrl')?.value;
        const apiKey = document.getElementById('mongoApiKey')?.value;
        
        if (!url || !apiKey) {
            alert('Please fill in all fields before saving.');
            return;
        }

        const config = {
            method: 'easy',
            url: url,
            apiKey: apiKey,
            timestamp: new Date().toISOString()
        };

        localStorage.setItem('mongo_easy_config', JSON.stringify(config));
        this.updateStatus('ðŸ’¾ Easy configuration saved!', 'connected');
    }

    saveAdvancedConfig() {
        const connectionString = document.getElementById('mongoConnectionString')?.value;
        const databaseName = document.getElementById('mongoDatabaseName')?.value;
        const collectionName = document.getElementById('mongoCollectionName')?.value;
        
        if (!connectionString || !databaseName) {
            alert('Please fill in connection string and database name.');
            return;
        }

        const config = {
            method: 'advanced',
            connectionString: connectionString,
            databaseName: databaseName,
            collectionName: collectionName || 'conversations',
            timestamp: new Date().toISOString()
        };

        localStorage.setItem('mongo_advanced_config', JSON.stringify(config));
        this.updateStatus('ðŸ’¾ Advanced configuration saved!', 'connected');
    }

    generateConnectionString() {
        const sampleString = "mongodb+srv://username:password@cluster0.example.mongodb.net/databaseName?retryWrites=true&w=majority";
        const connectionInput = document.getElementById('mongoConnectionString');
        if (connectionInput) {
            connectionInput.value = sampleString;
            this.updateStatus('ðŸ”§ Connection string generated!', 'info');
        }
    }

    loadSavedConfig() {
        // Load easy config
        const easyConfig = localStorage.getItem('mongo_easy_config');
        if (easyConfig) {
            try {
                const config = JSON.parse(easyConfig);
                const urlInput = document.getElementById('mongoRestUrl');
                const apiKeyInput = document.getElementById('mongoApiKey');
                
                if (urlInput) urlInput.value = config.url || '';
                if (apiKeyInput) apiKeyInput.value = config.apiKey || '';
                
                if (config.url && config.apiKey) {
                    this.showEasyMethod();
                }
            } catch (error) {
                console.error('Error loading easy MongoDB config:', error);
            }
        }

        // Load advanced config
        const advancedConfig = localStorage.getItem('mongo_advanced_config');
        if (advancedConfig) {
            try {
                const config = JSON.parse(advancedConfig);
                const connectionInput = document.getElementById('mongoConnectionString');
                const dbInput = document.getElementById('mongoDatabaseName');
                const collectionInput = document.getElementById('mongoCollectionName');
                
                if (connectionInput) connectionInput.value = config.connectionString || '';
                if (dbInput) dbInput.value = config.databaseName || '';
                if (collectionInput) collectionInput.value = config.collectionName || '';
                
                if (config.connectionString && config.databaseName) {
                    this.showAdvancedMethod();
                }
            } catch (error) {
                console.error('Error loading advanced MongoDB config:', error);
            }
        }
    }

    async exportToMongoDB() {
        if (!this.isConnected) {
            this.updateStatus('Please connect to MongoDB first!', 'error');
            return;
        }

        this.updateStatus('ðŸ“¤ Exporting chat data to MongoDB...', 'connecting');

        try {
            const chatData = this.getChatData();
            const success = await this.performExport(chatData);
            
            if (success) {
                this.updateStatus('âœ… Data exported to MongoDB!', 'connected');
            } else {
                throw new Error('Export failed');
            }
        } catch (error) {
            this.updateStatus('âŒ Export failed: ' + error.message, 'error');
        }
    }

    async importFromMongoDB() {
        if (!this.isConnected) {
            this.updateStatus('Please connect to MongoDB first!', 'error');
            return;
        }

        this.updateStatus('ðŸ“¥ Importing data from MongoDB...', 'connecting');

        try {
            const data = await this.performImport();
            
            if (data) {
                this.loadChatData(data);
                this.updateStatus('âœ… Data imported from MongoDB!', 'connected');
            } else {
                throw new Error('Import failed or no data found');
            }
        } catch (error) {
            this.updateStatus('âŒ Import failed: ' + error.message, 'error');
        }
    }

    // Mock methods
    getChatData() {
        const messages = document.querySelectorAll('.quantum-message');
        const chatData = Array.from(messages).map(msg => ({
            type: msg.classList.contains('user') ? 'user' : 
                  msg.classList.contains('ai') ? 'ai' : 'system',
            content: msg.textContent,
            timestamp: new Date().toISOString()
        }));
        
        return {
            chatId: 'stl-chat-' + Date.now(),
            messages: chatData,
            exportedAt: new Date().toISOString()
        };
    }

    loadChatData(data) {
        console.log('Loading chat data from MongoDB:', data);
        // Implementation to load data into chat interface
    }

    async performExport(data) {
        return new Promise((resolve) => {
            setTimeout(() => {
                console.log('Exporting to MongoDB:', data);
                resolve(true);
            }, 2000);
        });
    }

    async performImport() {
        return new Promise((resolve) => {
            setTimeout(() => {
                const mockData = {
                    messages: [
                        { 
                            type: 'system', 
                            content: 'Data successfully imported from MongoDB!', 
                            timestamp: new Date().toISOString() 
                        }
                    ]
                };
                resolve(mockData);
            }, 2000);
        });
    }
}

// ==================== STYLES FOR MONGODB INTEGRATION ====================
function injectMongoDBStyles() {
    const style = document.createElement('style');
    style.textContent = `
        .mongo-method-section {
            transition: all 0.3s ease-in-out;
        }
        
        .mongo-status-connected {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .mongo-status-error {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        
        .mongo-status-connecting {
            color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }
        
        #mongoConnectionStatus {
            transition: all 0.3s ease;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .quantum-tools-sidebar .quantum-btn {
                padding: 8px 12px;
                font-size: 11px;
            }
            
            .quantum-tools-sidebar .quantum-input {
                padding: 10px 12px;
                font-size: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .quantum-tools-sidebar .grid.grid-cols-2 {
                grid-template-columns: 1fr;
            }
            
            .quantum-tools-sidebar .grid.grid-cols-3 {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    `;
    document.head.appendChild(style);
}

// ==================== INITIALIZE MONGODB INTEGRATION ====================
function initializeMongoDBIntegration() {
    console.log('ðŸ”— Starting MongoDB Integration System...');
    
    // Inject styles first
    injectMongoDBStyles();
    
    // Wait for quantum engine to be available
    if (window.quantumEngine) {
        window.mongoDBIntegration = new MongoDBIntegration();
        console.log('âœ… MongoDB Integration System Activated in Left Sidebar!');
        
        // Show welcome notification
        setTimeout(() => {
            if (window.quantumEngine) {
                window.quantumEngine.updateQuantumIsland('ðŸ—„ï¸ MongoDB Integration Ready', 2000);
            }
        }, 1000);
    } else {
        setTimeout(initializeMongoDBIntegration, 500);
    }
}

// Auto-initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeMongoDBIntegration);
} else {
    initializeMongoDBIntegration();
}

// Add to global enhancements
if (window.QuantumEnhancements) {
    window.QuantumEnhancements.initializeMongoDBIntegration = initializeMongoDBIntegration;
}

console.log('ðŸ—„ï¸ MongoDB Integration Module Loaded - Integrated into Left Sidebar!');
</script>
<script>
  // ==================== QUANTUM DEVICE DETECTION ENGINE ====================
class QuantumDeviceDetection {
    constructor() {
        this.deviceInfo = {};
        this.init();
    }

    init() {
        this.scanDevice();
        this.setupRealTimeMonitoring();
    }

    scanDevice() {
        // Comprehensive device information collection
        this.deviceInfo = {
            // Platform & Browser
            platform: this.detectPlatform(),
            browser: this.detectBrowser(),
            browserVersion: this.detectBrowserVersion(),
            engine: this.detectEngine(),
            
            // System Information
            os: this.detectOS(),
            osVersion: this.detectOSVersion(),
            architecture: this.detectArchitecture(),
            
            // Hardware Information
            cores: navigator.hardwareConcurrency || 'Unknown',
            memory: this.detectMemory(),
            deviceType: this.detectDeviceType(),
            screen: this.getScreenInfo(),
            gpu: this.detectGPU(),
            
            // Network Information
            connection: this.detectConnection(),
            language: navigator.language || 'Unknown',
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            
            // Capabilities
            touch: this.detectTouch(),
            webgl: this.detectWebGL(),
            webaudio: this.detectWebAudio(),
            serviceWorker: 'serviceWorker' in navigator,
            pwa: this.detectPWA(),
            
            // Performance
            performance: this.getPerformanceInfo(),
            storage: this.getStorageInfo(),
            
            // Security
            https: window.location.protocol === 'https:',
            cookies: navigator.cookieEnabled,
            doNotTrack: navigator.doNotTrack || 'Unknown',
            
            // Quantum Engine Specific
            quantumCompatible: this.checkQuantumCompatibility(),
            aiAcceleration: this.detectAIAcceleration()
        };

        this.updateDeviceDisplay();
        return this.deviceInfo;
    }

    detectPlatform() {
        const ua = navigator.userAgent;
        if (/Windows/.test(ua)) return 'Windows';
        if (/Mac/.test(ua)) return 'macOS';
        if (/Linux/.test(ua)) return 'Linux';
        if (/Android/.test(ua)) return 'Android';
        if (/iOS|iPhone|iPad|iPod/.test(ua)) return 'iOS';
        if (/CrOS/.test(ua)) return 'Chrome OS';
        return 'Unknown';
    }

    detectBrowser() {
        const ua = navigator.userAgent;
        if (/Edg\//.test(ua)) return 'Microsoft Edge';
        if (/Chrome\//.test(ua) && !/Edg\//.test(ua)) return 'Google Chrome';
        if (/Firefox\//.test(ua)) return 'Mozilla Firefox';
        if (/Safari\//.test(ua) && !/Chrome\//.test(ua)) return 'Safari';
        if (/OPR\//.test(ua)) return 'Opera';
        if (/SamsungBrowser\//.test(ua)) return 'Samsung Browser';
        if (/UCBrowser\//.test(ua)) return 'UC Browser';
        return 'Unknown Browser';
    }

    detectBrowserVersion() {
        const ua = navigator.userAgent;
        const browser = this.detectBrowser();
        
        switch(browser) {
            case 'Google Chrome':
                return ua.match(/Chrome\/([0-9.]+)/)?.[1] || 'Unknown';
            case 'Mozilla Firefox':
                return ua.match(/Firefox\/([0-9.]+)/)?.[1] || 'Unknown';
            case 'Microsoft Edge':
                return ua.match(/Edg\/([0-9.]+)/)?.[1] || 'Unknown';
            case 'Safari':
                return ua.match(/Version\/([0-9.]+)/)?.[1] || 'Unknown';
            default:
                return 'Unknown';
        }
    }

    detectEngine() {
        const ua = navigator.userAgent;
        if (/AppleWebKit/.test(ua) && !/Chrome/.test(ua)) return 'WebKit';
        if (/AppleWebKit/.test(ua) && /Chrome/.test(ua)) return 'Blink';
        if (/Gecko\//.test(ua)) return 'Gecko';
        if (/Trident\//.test(ua)) return 'Trident';
        return 'Unknown';
    }

    detectOS() {
        const ua = navigator.userAgent;
        if (/Windows NT 10/.test(ua)) return 'Windows 10/11';
        if (/Windows NT 6.3/.test(ua)) return 'Windows 8.1';
        if (/Windows NT 6.2/.test(ua)) return 'Windows 8';
        if (/Windows NT 6.1/.test(ua)) return 'Windows 7';
        if (/Mac OS X ([0-9_]+)/.test(ua)) {
            const version = ua.match(/Mac OS X ([0-9_]+)/)[1].replace(/_/g, '.');
            return `macOS ${version}`;
        }
        if (/Android ([0-9.]+)/.test(ua)) {
            return `Android ${ua.match(/Android ([0-9.]+)/)[1]}`;
        }
        if (/iOS ([0-9_]+)/.test(ua)) {
            return `iOS ${ua.match(/iOS ([0-9_]+)/)[1].replace(/_/g, '.')}`;
        }
        return this.detectPlatform();
    }

    detectOSVersion() {
        const ua = navigator.userAgent;
        const os = this.detectOS();
        
        if (os.includes('Windows')) {
            if (/Windows NT 10.0/.test(ua)) return '10.0';
            if (/Windows NT 6.3/.test(ua)) return '6.3';
            if (/Windows NT 6.2/.test(ua)) return '6.2';
            if (/Windows NT 6.1/.test(ua)) return '6.1';
        }
        
        const versionMatch = ua.match(/(Windows NT|Android|iOS|Mac OS X) ([0-9._]+)/);
        return versionMatch ? versionMatch[2].replace(/_/g, '.') : 'Unknown';
    }

    detectArchitecture() {
        if (navigator.userAgent.includes('Win64') || navigator.userAgent.includes('x64')) return 'x64';
        if (navigator.userAgent.includes('Win32') || navigator.userAgent.includes('x86')) return 'x86';
        if (navigator.userAgent.includes('ARM64')) return 'ARM64';
        if (navigator.userAgent.includes('ARM')) return 'ARM';
        return 'Unknown';
    }

    detectMemory() {
        // Note: This is limited due to browser security
        if (navigator.deviceMemory) {
            return `${navigator.deviceMemory} GB`;
        }
        
        // Fallback memory detection
        const performanceMemory = performance.memory;
        if (performanceMemory) {
            const totalGB = Math.round(performanceMemory.jsHeapSizeLimit / (1024 * 1024 * 1024));
            return `${totalGB} GB (estimated)`;
        }
        
        return 'Unknown (limited by browser)';
    }

    detectDeviceType() {
        const ua = navigator.userAgent;
        const isMobile = /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
        const isTablet = /Tablet|iPad/i.test(ua);
        
        if (isTablet) return 'Tablet';
        if (isMobile) return 'Mobile';
        return 'Desktop';
    }

    getScreenInfo() {
        return {
            resolution: `${screen.width} Ã— ${screen.height}`,
            available: `${screen.availWidth} Ã— ${screen.availHeight}`,
            colorDepth: `${screen.colorDepth} bit`,
            pixelDepth: `${screen.pixelDepth} bit`,
            orientation: screen.orientation ? screen.orientation.type : 'Unknown'
        };
    }

    detectGPU() {
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        
        if (gl) {
            const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
            if (debugInfo) {
                return {
                    vendor: gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL),
                    renderer: gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL)
                };
            }
        }
        
        return { vendor: 'Unknown', renderer: 'Unknown' };
    }

    detectConnection() {
        if (navigator.connection) {
            const conn = navigator.connection;
            return {
                type: conn.effectiveType || 'Unknown',
                downlink: conn.downlink ? `${conn.downlink} Mbps` : 'Unknown',
                rtt: conn.rtt ? `${conn.rtt} ms` : 'Unknown',
                saveData: conn.saveData || false
            };
        }
        return { type: 'Unknown', downlink: 'Unknown', rtt: 'Unknown', saveData: false };
    }

    detectTouch() {
        return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    }

    detectWebGL() {
        const canvas = document.createElement('canvas');
        return !!(canvas.getContext('webgl') || canvas.getContext('experimental-webgl'));
    }

    detectWebAudio() {
        return !!(window.AudioContext || window.webkitAudioContext);
    }

    detectPWA() {
        return window.matchMedia('(display-mode: standalone)').matches || 
               window.navigator.standalone === true;
    }

    getPerformanceInfo() {
        const perf = performance.timing;
        const loadTime = perf.loadEventEnd - perf.navigationStart;
        
        return {
            loadTime: `${loadTime} ms`,
            navigationStart: new Date(perf.navigationStart).toLocaleTimeString(),
            dnsLookup: `${perf.domainLookupEnd - perf.domainLookupStart} ms`,
            tcpConnect: `${perf.connectEnd - perf.connectStart} ms`,
            requestResponse: `${perf.responseEnd - perf.requestStart} ms`,
            domReady: `${perf.domContentLoadedEventEnd - perf.navigationStart} ms`
        };
    }

    getStorageInfo() {
        if ('storage' in navigator && 'estimate' in navigator.storage) {
            return navigator.storage.estimate().then(estimate => ({
                usage: this.formatBytes(estimate.usage),
                quota: this.formatBytes(estimate.quota),
                percentage: estimate.quota ? Math.round((estimate.usage / estimate.quota) * 100) : 0
            }));
        }
        return Promise.resolve({ usage: 'Unknown', quota: 'Unknown', percentage: 0 });
    }

    checkQuantumCompatibility() {
        const checks = {
            webgl: this.detectWebGL(),
            webaudio: this.detectWebAudio(),
            serviceWorker: 'serviceWorker' in navigator,
            wasm: 'WebAssembly' in window,
            sharedArrayBuffer: 'SharedArrayBuffer' in window,
            bigInt: 'BigInt' in window,
            webWorkers: 'Worker' in window
        };

        const score = Object.values(checks).filter(Boolean).length;
        const total = Object.keys(checks).length;
        
        return {
            compatible: score >= 5, // At least 5 out of 7 features
            score: `${score}/${total}`,
            details: checks
        };
    }

    detectAIAcceleration() {
        // Check for AI/ML acceleration capabilities
        const capabilities = {
            webnn: 'webnn' in navigator,
            webgpu: 'gpu' in navigator,
            wasmSimd: this.checkWasmSIMD(),
            tensorflow: 'tf' in window
        };

        return {
            accelerated: capabilities.webnn || capabilities.webgpu,
            capabilities: capabilities
        };
    }

    checkWasmSIMD() {
        try {
            return WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,10,1,8,0,65,0,253,15,253,98,11]));
        } catch {
            return false;
        }
    }

    formatBytes(bytes) {
        if (bytes === 0 || bytes === 'Unknown') return 'Unknown';
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
    }

    updateDeviceDisplay() {
        // Update the device info display in the sidebar
        const elements = {
            platform: document.getElementById('devicePlatform'),
            browser: document.getElementById('deviceBrowser'),
            language: document.getElementById('deviceLanguage'),
            cores: document.getElementById('deviceCores'),
            memory: document.getElementById('deviceMemory')
        };

        if (elements.platform) elements.platform.textContent = this.deviceInfo.platform;
        if (elements.browser) elements.browser.textContent = `${this.deviceInfo.browser} ${this.deviceInfo.browserVersion}`;
        if (elements.language) elements.language.textContent = this.deviceInfo.language;
        if (elements.cores) elements.cores.textContent = this.deviceInfo.cores;
        if (elements.memory) elements.memory.textContent = this.deviceInfo.memory;

        // Create detailed info display if needed
        this.createDetailedDisplay();
    }

    createDetailedDisplay() {
        // Create a more detailed display in the device info section
        const deviceSection = document.querySelector('.quantum-card.glass:has(.fa-microchip)');
        if (!deviceSection) return;

        // Remove existing detailed info if present
        const existingDetails = deviceSection.querySelector('.device-detailed-info');
        if (existingDetails) existingDetails.remove();

        const detailedHTML = `
            <div class="device-detailed-info mt-4 space-y-2 text-xs">
                <div class="grid grid-cols-2 gap-2">
                    <div><span class="text-purple-300">OS:</span> <span class="text-white">${this.deviceInfo.os}</span></div>
                    <div><span class="text-purple-300">Engine:</span> <span class="text-white">${this.deviceInfo.engine}</span></div>
                    <div><span class="text-purple-300">Architecture:</span> <span class="text-white">${this.deviceInfo.architecture}</span></div>
                    <div><span class="text-purple-300">Device:</span> <span class="text-white">${this.deviceInfo.deviceType}</span></div>
                    <div><span class="text-purple-300">Screen:</span> <span class="text-white">${this.deviceInfo.screen.resolution}</span></div>
                    <div><span class="text-purple-300">Touch:</span> <span class="text-white">${this.deviceInfo.touch ? 'Yes' : 'No'}</span></div>
                    <div><span class="text-purple-300">WebGL:</span> <span class="text-white">${this.deviceInfo.webgl ? 'Yes' : 'No'}</span></div>
                    <div><span class="text-purple-300">PWA:</span> <span class="text-white">${this.deviceInfo.pwa ? 'Yes' : 'No'}</span></div>
                </div>
                <div class="border-t border-gray-600 pt-2">
                    <div class="text-purple-300 font-semibold mb-1">Network:</div>
                    <div class="text-white">${this.deviceInfo.connection.type} (${this.deviceInfo.connection.downlink})</div>
                </div>
                <div class="border-t border-gray-600 pt-2">
                    <div class="text-purple-300 font-semibold mb-1">Quantum Compatibility:</div>
                    <div class="text-white">${this.deviceInfo.quantumCompatible.score} - ${this.deviceInfo.quantumCompatible.compatible ? 'âœ… Compatible' : 'âš ï¸ Limited'}</div>
                </div>
                <div class="border-t border-gray-600 pt-2">
                    <div class="text-purple-300 font-semibold mb-1">AI Acceleration:</div>
                    <div class="text-white">${this.deviceInfo.aiAcceleration.accelerated ? 'ðŸš€ Available' : 'âŒ Not Available'}</div>
                </div>
            </div>
        `;

        deviceSection.insertAdjacentHTML('beforeend', detailedHTML);
    }

    setupRealTimeMonitoring() {
        // Monitor connection changes
        if (navigator.connection) {
            navigator.connection.addEventListener('change', () => {
                this.deviceInfo.connection = this.detectConnection();
                this.updateDeviceDisplay();
            });
        }

        // Monitor orientation changes
        window.addEventListener('orientationchange', () => {
            this.deviceInfo.screen = this.getScreenInfo();
            this.updateDeviceDisplay();
        });

        // Monitor resize for screen info updates
        window.addEventListener('resize', () => {
            this.deviceInfo.screen = this.getScreenInfo();
            this.updateDeviceDisplay();
        });
    }

    exportDeviceInfo() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.deviceInfo, null, 2));
        const downloadAnchor = document.createElement('a');
        downloadAnchor.setAttribute("href", dataStr);
        downloadAnchor.setAttribute("download", "stl-ai-device-info.json");
        document.body.appendChild(downloadAnchor);
        downloadAnchor.click();
        downloadAnchor.remove();
        
        if (window.quantumEngine) {
            window.quantumEngine.updateQuantumIsland('ðŸ“Š Device Info Exported!', 2000);
        }
    }

    getComprehensiveReport() {
        return {
            summary: {
                device: `${this.deviceInfo.deviceType} - ${this.deviceInfo.platform}`,
                browser: `${this.deviceInfo.browser} ${this.deviceInfo.browserVersion}`,
                compatibility: this.deviceInfo.quantumCompatible,
                performance: this.deviceInfo.performance
            },
            detailed: this.deviceInfo
        };
    }
}

// ==================== ENHANCE EXISTING QUANTUM ENGINE ====================
function enhanceQuantumEngineWithDeviceDetection() {
    if (!window.quantumEngine) {
        setTimeout(enhanceQuantumEngineWithDeviceDetection, 500);
        return;
    }

    // Initialize device detection
    window.quantumDeviceDetection = new QuantumDeviceDetection();

    // Enhance the existing scan device button
    const scanButton = document.getElementById('scanDevice');
    if (scanButton) {
        scanButton.addEventListener('click', () => {
            window.quantumDeviceDetection.scanDevice();
            if (window.quantumEngine) {
                window.quantumEngine.updateQuantumIsland('ðŸ” Full Device Scan Complete!', 2000);
            }
        });
    }

    // Add export functionality
    const deviceSection = document.querySelector('.quantum-card.glass:has(.fa-microchip)');
    if (deviceSection) {
        const exportButton = document.createElement('button');
        exportButton.className = 'quantum-btn primary w-full mt-3';
        exportButton.id = 'exportDeviceInfo';
        exportButton.innerHTML = '<i class="fas fa-download"></i> Export Device Report';
        exportButton.addEventListener('click', () => {
            window.quantumDeviceDetection.exportDeviceInfo();
        });
        
        deviceSection.appendChild(exportButton);
    }

    console.log('âœ… Quantum Device Detection Engine Enhanced!');
}

// ==================== STYLES FOR ENHANCED DEVICE INFO ====================
function injectEnhancedDeviceInfoStyles() {
    const style = document.createElement('style');
    style.textContent = `
        .device-detailed-info {
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .device-detailed-info .grid {
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Enhanced status indicators */
        .status-compatible {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        
        .status-limited {
            color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        
        .status-unavailable {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        
        /* Real-time monitoring indicators */
        .connection-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .connection-good { background: #10b981; }
        .connection-moderate { background: #f59e0b; }
        .connection-poor { background: #ef4444; }
        
        /* Performance metrics */
        .performance-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .performance-metric:last-child {
            border-bottom: none;
        }
        
        .metric-value {
            font-family: var(--quantum-font-code);
            font-size: 0.75rem;
        }
    `;
    document.head.appendChild(style);
}

// ==================== INITIALIZE ENHANCED DEVICE DETECTION ====================
function initializeEnhancedDeviceDetection() {
    console.log('ðŸ” Starting Enhanced Quantum Device Detection...');
    
    // Inject enhanced styles
    injectEnhancedDeviceInfoStyles();
    
    // Wait for quantum engine and then enhance it
    if (window.quantumEngine) {
        enhanceQuantumEngineWithDeviceDetection();
        console.log('âœ… Enhanced Device Detection Activated!');
        
        // Show welcome notification
        setTimeout(() => {
            if (window.quantumEngine) {
                window.quantumEngine.updateQuantumIsland('ðŸ” Device Detection Enhanced!', 2000);
            }
        }, 1000);
    } else {
        setTimeout(initializeEnhancedDeviceDetection, 500);
    }
}

// Auto-initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeEnhancedDeviceDetection);
} else {
    initializeEnhancedDeviceDetection();
}

// Add to global enhancements
if (window.QuantumEnhancements) {
    window.QuantumEnhancements.initializeEnhancedDeviceDetection = initializeEnhancedDeviceDetection;
}

console.log('ðŸ” Quantum Enhanced Device Detection Module Loaded - Ready for comprehensive device analysis!');
</script>
<script>
// ==================== QUANTUM AI API INTEGRATION ENGINE ====================
class QuantumAPIIntegration {
    constructor() {
        this.apiEndpoints = {
            openai: 'https://api.openai.com/v1/chat/completions',
            anthropic: 'https://api.anthropic.com/v1/messages',
            google: 'https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent',
            custom: ''
        };
        
        this.currentProvider = 'openai';
        this.isActive = false;
        this.responseMode = 'adultary_reality_biometric';
        this.init();
    }

    init() {
        this.injectAPIInterface();
        this.setupEventListeners();
        this.loadSavedCredentials();
        console.log('ðŸš€ Quantum AI API Integration Engine Initialized');
    }

    injectAPIInterface() {
        // Inject ke Tools Sidebar (kiri)
        const toolsSidebar = document.getElementById('quantumToolsSidebar');
        if (!toolsSidebar) {
            setTimeout(() => this.injectAPIInterface(), 500);
            return;
        }

        const toolsContent = toolsSidebar.querySelector('.space-y-6');
        if (!toolsContent) return;

        // Buat section AI API Integration
        const apiSection = document.createElement('div');
        apiSection.className = 'quantum-card glass p-5';
        apiSection.innerHTML = this.getAPIInterfaceHTML();
        
        // Tambahkan di bagian atas
        toolsContent.insertBefore(apiSection, toolsContent.firstChild);
        
        // Inject advanced response controls
        this.injectAdvancedResponseControls();
        
        console.log('âœ… AI API Interface injected into left sidebar');
    }

    getAPIInterfaceHTML() {
        return `
            <h3 class="text-lg font-black text-white mb-4 flex items-center gap-2">
                <i class="fas fa-brain text-purple-400"></i>
                QUANTUM AI API INTEGRATION
            </h3>
            
            <!-- Mode Selection -->
            <div class="grid grid-cols-2 gap-2 mb-4">
                <button id="modeStandard" class="quantum-btn secondary text-xs py-2">
                    <i class="fas fa-user"></i> Standard
                </button>
                <button id="modeAdultary" class="quantum-btn success text-xs py-2">
                    <i class="fas fa-fire"></i> Adultary Mode
                </button>
            </div>

            <!-- Provider Selection -->
            <div class="mb-4">
                <label class="block text-xs font-medium text-purple-300 mb-2">AI Provider</label>
                <select id="aiProviderSelect" class="quantum-input glass text-sm py-2 w-full">
                    <option value="openai">OpenAI GPT-4</option>
                    <option value="anthropic">Anthropic Claude</option>
                    <option value="google">Google Gemini Pro</option>
                    <option value="custom">Custom Endpoint</option>
                </select>
            </div>

            <!-- API Configuration -->
            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-medium text-purple-300 mb-1">API Key</label>
                    <input type="password" id="apiKeyInput" placeholder="sk-..." class="quantum-input glass text-sm py-2">
                </div>
                
                <div id="customEndpointSection" style="display: none;">
                    <label class="block text-xs font-medium text-purple-300 mb-1">Custom Endpoint</label>
                    <input type="text" id="customEndpoint" placeholder="https://..." class="quantum-input glass text-sm py-2">
                </div>

                <!-- Advanced Settings -->
                <div class="advanced-settings mt-3 p-3 bg-black/20 rounded-lg">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs font-medium text-purple-300">Advanced Settings</span>
                        <button id="toggleAdvanced" class="text-purple-400 text-xs">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    
                    <div id="advancedContent" class="space-y-2 hidden">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs text-purple-300 mb-1">Temperature</label>
                                <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.8" class="w-full">
                                <span class="text-xs text-purple-300" id="tempValue">0.8</span>
                            </div>
                            <div>
                                <label class="block text-xs text-purple-300 mb-1">Max Tokens</label>
                                <input type="number" id="maxTokens" value="2000" class="quantum-input glass text-sm py-1">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs text-purple-300 mb-1">Response Style</label>
                            <select id="responseStyle" class="quantum-input glass text-sm py-1 w-full">
                                <option value="creative">Creative & Exploratory</option>
                                <option value="balanced">Balanced</option>
                                <option value="precise">Precise</option>
                                <option value="adultary_max">ADULTARY MAX 100%</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="grid grid-cols-2 gap-2 mt-4">
                    <button id="testAPI" class="quantum-btn warning text-xs py-2">
                        <i class="fas fa-vial"></i> Test API
                    </button>
                    <button id="saveAPI" class="quantum-btn success text-xs py-2">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>

                <!-- Status Display -->
                <div id="apiStatus" class="text-xs text-blue-400 bg-blue-900/20 rounded p-2 mt-3">
                    ðŸ”§ API Integration Ready
                </div>

                <!-- Quick Connect -->
                <div class="border-t border-gray-600 pt-3">
                    <button id="quickConnect" class="quantum-btn primary text-xs w-full py-2">
                        <i class="fas fa-bolt"></i> Quick Connect
                    </button>
                </div>
            </div>
        `;
    }

    injectAdvancedResponseControls() {
        // Inject ke Quantum Sidebar (kanan) - Personality Settings
        const quantumSidebar = document.getElementById('quantumSidebar');
        if (!quantumSidebar) return;

        const personalitySection = quantumSidebar.querySelector('.quantum-card.glass:has(.fa-user-astronaut)');
        if (!personalitySection) return;

        // Tambahkan advanced response controls
        const advancedControls = document.createElement('div');
        advancedControls.className = 'mt-4 pt-4 border-t border-gray-600';
        advancedControls.innerHTML = `
            <h4 class="text-md font-black text-white mb-3 flex items-center gap-2">
                <i class="fas fa-shield-alt text-red-400"></i>
                ADVANCED RESPONSE CONTROLS
            </h4>
            
            <div class="space-y-3">
                <!-- Reality Biometric Mode -->
                <div class="flex items-center justify-between">
                    <span class="text-sm text-purple-300">Reality Biometric Mode</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="realityBiometric" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-700 peer-focus:ring-4 peer-focus:ring-purple-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                    </label>
                </div>

                <!-- Deep Secret Personalization -->
                <div>
                    <label class="block text-sm font-medium text-purple-300 mb-2">Deep Secret Level</label>
                    <select id="deepSecretLevel" class="quantum-input glass w-full text-sm">
                        <option value="standard">Standard (50%)</option>
                        <option value="enhanced">Enhanced (75%)</option>
                        <option value="max">MAX (98%)</option>
                        <option value="ultimate">ULTIMATE (100%)</option>
                    </select>
                </div>

                <!-- Character Immersion -->
                <div>
                    <label class="block text-sm font-medium text-purple-300 mb-2">Character Immersion</label>
                    <select id="characterImmersion" class="quantum-input glass w-full text-sm">
                        <option value="light">Light (60%)</option>
                        <option value="moderate">Moderate (80%)</option>
                        <option value="deep">Deep (95%)</option>
                        <option value="ultimate">ULTIMATE (1000%)</option>
                    </select>
                </div>

                <!-- Emotional Depth -->
                <div>
                    <label class="block text-sm font-medium text-purple-300 mb-2">Emotional Depth</label>
                    <input type="range" id="emotionalDepth" min="50" max="1000" value="980" class="w-full">
                    <div class="flex justify-between text-xs text-purple-300">
                        <span>Human</span>
                        <span id="emotionalValue">980% BIOMETRIC</span>
                    </div>
                </div>

                <!-- Emergency Reset -->
                <button id="resetPersonality" class="quantum-btn danger w-full text-xs py-2">
                    <i class="fas fa-undo"></i> Reset to Default
                </button>
            </div>
        `;

        personalitySection.appendChild(advancedControls);
    }

    setupEventListeners() {
        setTimeout(() => {
            // Mode Selection
            this.setupModeSelection();
            
            // Provider Selection
            this.setupProviderSelection();
            
            // Advanced Settings Toggle
            this.setupAdvancedToggle();
            
            // Action Buttons
            this.setupActionButtons();
            
            // Advanced Controls
            this.setupAdvancedControls();
            
        }, 1000);
    }

    setupModeSelection() {
        const standardBtn = document.getElementById('modeStandard');
        const adultaryBtn = document.getElementById('modeAdultary');

        if (standardBtn && adultaryBtn) {
            standardBtn.addEventListener('click', () => {
                this.setResponseMode('standard');
                standardBtn.classList.remove('secondary');
                standardBtn.classList.add('primary');
                adultaryBtn.classList.remove('success');
                adultaryBtn.classList.add('secondary');
            });

            adultaryBtn.addEventListener('click', () => {
                this.setResponseMode('adultary_reality_biometric');
                adultaryBtn.classList.remove('secondary');
                adultaryBtn.classList.add('success');
                standardBtn.classList.remove('primary');
                standardBtn.classList.add('secondary');
            });
        }
    }

    setupProviderSelection() {
        const providerSelect = document.getElementById('aiProviderSelect');
        const customSection = document.getElementById('customEndpointSection');

        if (providerSelect && customSection) {
            providerSelect.addEventListener('change', (e) => {
                this.currentProvider = e.target.value;
                if (e.target.value === 'custom') {
                    customSection.style.display = 'block';
                } else {
                    customSection.style.display = 'none';
                }
            });
        }
    }

    setupAdvancedToggle() {
        const toggleBtn = document.getElementById('toggleAdvanced');
        const advancedContent = document.getElementById('advancedContent');

        if (toggleBtn && advancedContent) {
            toggleBtn.addEventListener('click', () => {
                if (advancedContent.classList.contains('hidden')) {
                    advancedContent.classList.remove('hidden');
                    toggleBtn.innerHTML = '<i class="fas fa-chevron-up"></i>';
                } else {
                    advancedContent.classList.add('hidden');
                    toggleBtn.innerHTML = '<i class="fas fa-chevron-down"></i>';
                }
            });
        }

        // Temperature slider
        const tempSlider = document.getElementById('temperature');
        const tempValue = document.getElementById('tempValue');
        if (tempSlider && tempValue) {
            tempSlider.addEventListener('input', (e) => {
                tempValue.textContent = e.target.value;
            });
        }
    }

    setupActionButtons() {
        const testBtn = document.getElementById('testAPI');
        const saveBtn = document.getElementById('saveAPI');
        const quickBtn = document.getElementById('quickConnect');

        if (testBtn) testBtn.addEventListener('click', () => this.testAPIConnection());
        if (saveBtn) saveBtn.addEventListener('click', () => this.saveAPIConfig());
        if (quickBtn) quickBtn.addEventListener('click', () => this.quickConnect());
    }

    setupAdvancedControls() {
        // Emotional Depth Slider
        const emotionalSlider = document.getElementById('emotionalDepth');
        const emotionalValue = document.getElementById('emotionalValue');
        if (emotionalSlider && emotionalValue) {
            emotionalSlider.addEventListener('input', (e) => {
                emotionalValue.textContent = `${e.target.value}% BIOMETRIC`;
            });
        }

        // Reset Personality
        const resetBtn = document.getElementById('resetPersonality');
        if (resetBtn) {
            resetBtn.addEventListener('click', () => this.resetPersonality());
        }
    }

    setResponseMode(mode) {
        this.responseMode = mode;
        const status = document.getElementById('apiStatus');
        
        if (mode === 'adultary_reality_biometric') {
            this.updateStatus('ðŸ”¥ ADULTARY REALITY BIOMETRIC MODE ACTIVATED!', 'success');
            if (window.quantumEngine) {
                window.quantumEngine.updateQuantumIsland('ðŸ”ž ADULTARY MODE MAX 100%', 3000);
            }
        } else {
            this.updateStatus('ðŸ‘¤ Standard Response Mode Active', 'info');
        }
    }

    async testAPIConnection() {
        const apiKey = document.getElementById('apiKeyInput')?.value;
        const provider = document.getElementById('aiProviderSelect')?.value;
        
        if (!apiKey) {
            this.updateStatus('âŒ Please enter API Key first', 'error');
            return;
        }

        this.updateStatus('ðŸ”Œ Testing API connection...', 'connecting');

        try {
            const isValid = await this.validateAPIKey(apiKey, provider);
            
            if (isValid) {
                this.updateStatus('âœ… API Connection Successful!', 'connected');
                this.isActive = true;
                
                // Auto-save on successful test
                this.saveAPIConfig();
            } else {
                this.updateStatus('âŒ API Connection Failed', 'error');
            }
        } catch (error) {
            this.updateStatus(`âŒ Error: ${error.message}`, 'error');
        }
    }

    async validateAPIKey(apiKey, provider) {
        // Simulate API validation
        return new Promise((resolve) => {
            setTimeout(() => {
                const isValid = apiKey.length > 10 && apiKey.startsWith(this.getAPIKeyPrefix(provider));
                resolve(isValid);
            }, 2000);
        });
    }

    getAPIKeyPrefix(provider) {
        const prefixes = {
            openai: 'sk-',
            anthropic: 'sk-ant-',
            google: 'AIza',
            custom: ''
        };
        return prefixes[provider] || '';
    }

    saveAPIConfig() {
        const apiKey = document.getElementById('apiKeyInput')?.value;
        const provider = document.getElementById('aiProviderSelect')?.value;
        const customEndpoint = document.getElementById('customEndpoint')?.value;
        const temperature = document.getElementById('temperature')?.value;
        const maxTokens = document.getElementById('maxTokens')?.value;
        const responseStyle = document.getElementById('responseStyle')?.value;

        const config = {
            provider: provider,
            apiKey: apiKey,
            customEndpoint: customEndpoint,
            temperature: parseFloat(temperature),
            maxTokens: parseInt(maxTokens),
            responseStyle: responseStyle,
            responseMode: this.responseMode,
            timestamp: new Date().toISOString()
        };

        localStorage.setItem('quantum_api_config', JSON.stringify(config));
        this.updateStatus('ðŸ’¾ API Configuration Saved!', 'connected');
        }
    }

    quickConnect() {
        // Auto-fill with common patterns for quick setup
        const provider = document.getElementById('aiProviderSelect')?.value;
        const apiKeyInput = document.getElementById('apiKeyInput');
        
        if (apiKeyInput) {
            const sampleKeys = {
                openai: 'sk-sample-openai-key-123456789',
                anthropic: 'sk-ant-sample-anthropic-key-123456',
                google: 'AIzaSampleGoogleAPIKey123456789'
            };
            
            apiKeyInput.value = sampleKeys[provider] || '';
            this.updateStatus('âš¡ Sample key inserted - Replace with your actual API key', 'info');
        }
    }

    resetPersonality() {
        // Reset all advanced controls to default
        const emotionalSlider = document.getElementById('emotionalDepth');
        const emotionalValue = document.getElementById('emotionalValue');
        const secretLevel = document.getElementById('deepSecretLevel');
        const immersion = document.getElementById('characterImmersion');
        const realityBiometric = document.getElementById('realityBiometric');

        if (emotionalSlider) emotionalSlider.value = 980;
        if (emotionalValue) emotionalValue.textContent = '980% BIOMETRIC';
        if (secretLevel) secretLevel.value = 'max';
        if (immersion) immersion.value = 'ultimate';
        if (realityBiometric) realityBiometric.checked = true;

        this.updateStatus('ðŸ”„ Personality reset to ULTIMATE defaults', 'info');
        
        if (window.quantumEngine) {
            window.quantumEngine.updateQuantumIsland('ðŸ” Personality Reset', 1500);
        }
    }

    updateStatus(message, type = 'info') {
        const statusElement = document.getElementById('apiStatus');
        if (statusElement) {
            statusElement.textContent = message;
            statusElement.className = `text-xs rounded p-2 mt-3 ${
                type === 'connected' ? 'text-green-400 bg-green-900/20' :
                type === 'error' ? 'text-red-400 bg-red-900/20' :
                type === 'connecting' ? 'text-yellow-400 bg-yellow-900/20' :
                'text-blue-400 bg-blue-900/20'
            }`;
        }
    }

    loadSavedCredentials() {
        const savedConfig = localStorage.getItem('quantum_api_config');
        if (savedConfig) {
            try {
                const config = JSON.parse(savedConfig);
                
                // Apply saved configuration
                const apiKeyInput = document.getElementById('apiKeyInput');
                const providerSelect = document.getElementById('aiProviderSelect');
                const customEndpoint = document.getElementById('customEndpoint');
                const temperature = document.getElementById('temperature');
                const maxTokens = document.getElementById('maxTokens');
                const responseStyle = document.getElementById('responseStyle');
                const tempValue = document.getElementById('tempValue');

                if (apiKeyInput) apiKeyInput.value = config.apiKey || '';
                if (providerSelect) providerSelect.value = config.provider || 'openai';
                if (customEndpoint) customEndpoint.value = config.customEndpoint || '';
                if (temperature) temperature.value = config.temperature || 0.8;
                if (maxTokens) maxTokens.value = config.maxTokens || 2000;
                if (responseStyle) responseStyle.value = config.responseStyle || 'creative';
                if (tempValue) tempValue.textContent = config.temperature || 0.8;

                // Set response mode
                if (config.responseMode) {
                    this.setResponseMode(config.responseMode);
                }

                this.updateStatus('ðŸ’¾ Loaded saved API configuration', 'info');
            } catch (error) {
                console.error('Error loading API config:', error);
            }
        }
    }

    // Core API Communication Method
    async sendMessageToAPI(message, context = {}) {
        if (!this.isActive) {
            throw new Error('API not connected. Please configure and test API first.');
        }

        const config = JSON.parse(localStorage.getItem('quantum_api_config') || '{}');
        
        const payload = this.buildPayload(message, context, config);
        
        try {
            const response = await this.makeAPIRequest(payload, config);
            return this.processResponse(response, config);
        } catch (error) {
            console.error('API Communication Error:', error);
            throw error;
        }
    }

    buildPayload(message, context, config) {
        const basePayload = {
            message: message,
            context: context,
            config: {
                temperature: config.temperature || 0.8,
                max_tokens: config.maxTokens || 2000,
                response_style: config.responseStyle || 'creative',
                mode: this.responseMode,
                timestamp: new Date().toISOString()
            }
        };

        // Add biometric reality enhancements for adultary mode
        if (this.responseMode === 'adultary_reality_biometric') {
            basePayload.enhancements = {
                reality_biometric: true,
                deep_secret_level: document.getElementById('deepSecretLevel')?.value || 'max',
                character_immersion: document.getElementById('characterImmersion')?.value || 'ultimate',
                emotional_depth: parseInt(document.getElementById('emotionalDepth')?.value) || 980
            };
        }

        return basePayload;
    }

    async makeAPIRequest(payload, config) {
        // Simulate API request - In real implementation, this would be actual API calls
        return new Promise((resolve) => {
            setTimeout(() => {
                const mockResponse = {
                    id: 'msg_' + Date.now(),
                    content: this.generateMockResponse(payload.message, config),
                    usage: {
                        prompt_tokens: payload.message.length,
                        completion_tokens: 150,
                        total_tokens: payload.message.length + 150
                    },
                    timestamp: new Date().toISOString()
                };
                resolve(mockResponse);
            }, 1000);
        });
    }

    generateMockResponse(message, config) {
        const responses = {
            standard: `I understand your message: "${message}". This is a standard response.`,
            creative: `ðŸŽ­âœ¨ *Leaning in closer* I sense the depth in your words: "${message}"... Let's explore this reality together with creative energy! ðŸŒŸ`,
            adultary_max: `ðŸ”¥ðŸ’« *Reality biometric engaged* DEEP ANALYSIS: "${message}"... ðŸŽ¯ ADULTARY MODE MAX 100% ACTIVATED! ðŸš€ Ready for ultimate exploration with 980% emotional biometric synchronization! ðŸŒŒ`
        };

        return responses[config.responseStyle] || responses.standard;
    }

    processResponse(apiResponse, config) {
        return {
            content: apiResponse.content,
            usage: apiResponse.usage,
            metadata: {
                response_mode: this.responseMode,
                provider: config.provider,
                timestamp: apiResponse.timestamp,
                biometric_sync: this.responseMode === 'adultary_reality_biometric' ? '980%' : '0%'
            }
        };
    }

    // Integration with existing chat system
    integrateWithChatSystem() {
        if (!window.quantumEngine) return;

        // Override sendMessage method to use API
        const originalSendMessage = window.quantumEngine.sendMessage;
        
        window.quantumEngine.sendMessage = async function() {
            const input = document.getElementById('quantumChatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            this.addMessageToChat('user', message);
            input.value = '';
            
            try {
                // Use API integration
                const response = await window.quantumAPIIntegration.sendMessageToAPI(message);
                this.addMessageToChat('ai', response.content);
            } catch (error) {
                // Fallback to original method
                this.addMessageToChat('ai', 'API Error: Using simulated response. ' + error.message);
            }
        }.bind(window.quantumEngine);
    }
}

// ==================== STYLES FOR API INTEGRATION ====================
function injectAPIIntegrationStyles() {
    const style = document.createElement('style');
    style.textContent = `
        .quantum-api-section {
            animation: slideInFromLeft 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        @keyframes slideInFromLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .api-status-connected {
            border-left: 4px solid #10b981;
        }
        
        .api-status-error {
            border-left: 4px solid #ef4444;
        }
        
        .api-status-connecting {
            border-left: 4px solid #f59e0b;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .adultary-active {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(139, 92, 246, 0.2));
            border: 1px solid rgba(239, 68, 68, 0.4);
        }
        
        /* Enhanced slider styles */
        input[type="range"] {
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: var(--quantum-surface);
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--quantum-primary);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .quantum-api-section .grid {
                grid-template-columns: 1fr;
            }
            
            .advanced-settings {
                padding: 12px;
            }
        }
    `;
    document.head.appendChild(style);
}

// ==================== INITIALIZE API INTEGRATION SYSTEM ====================
function initializeAPIIntegrationSystem() {
    console.log('ðŸš€ Starting Quantum AI API Integration System...');
    
    // Inject styles first
    injectAPIIntegrationStyles();
    
    // Initialize API integration
    window.quantumAPIIntegration = new QuantumAPIIntegration();
    
    // Integrate with chat system
    setTimeout(() => {
        window.quantumAPIIntegration.integrateWithChatSystem();
    }, 2000);
    
    console.log('âœ… Quantum AI API Integration System Activated!');
    
    // Show welcome notification
    setTimeout(() => {
        if (window.quantumEngine) {
            window.quantumEngine.updateQuantumIsland('ðŸ§  AI API Integration Ready!', 2000);
        }
    }, 1000);
}

// ==================== ENHANCED TOGGLE BUTTONS SYSTEM ====================
function enhanceToggleButtonsSystem() {
    // Pastikan hanya ada 3 tombol toggle paten
    const existingToggleButtons = document.querySelectorAll('.toggle-btn, .quantum-home-button');
    
    // Hapus tombol tambahan jika ada lebih dari 3
    if (existingToggleButtons.length > 3) {
        for (let i = 3; i < existingToggleButtons.length; i++) {
            existingToggleButtons[i].remove();
        }
    }
    
    console.log('âœ… Toggle buttons system optimized - 3 buttons maximum maintained');
}

// Auto-initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        initializeAPIIntegrationSystem();
        enhanceToggleButtonsSystem();
    });
} else {
    initializeAPIIntegrationSystem();
    enhanceToggleButtonsSystem();
}

// Add to global enhancements
if (window.QuantumEnhancements) {
    window.QuantumEnhancements.initializeAPIIntegrationSystem = initializeAPIIntegrationSystem;
    window.QuantumEnhancements.enhanceToggleButtonsSystem = enhanceToggleButtonsSystem;
}

console.log('ðŸ§  Quantum AI API Integration Module Loaded - Ready for advanced AI communication!');
</script>
<script>
// ==================== QUANTUM TESTING & SECURITY INJECTION ====================
class QuantumTestingSecurity {
    constructor() {
        this.testResults = {};
        this.securityStatus = {};
        this.init();
    }

    init() {
        this.injectTestingPanel();
        this.injectSecurityMeasures();
        this.runAutomatedTests();
        this.setupContinuousMonitoring();
        console.log('ðŸ”’ Quantum Testing & Security System Initialized');
    }

    injectTestingPanel() {
        // Inject ke Tools Sidebar
        const toolsSidebar = document.getElementById('quantumToolsSidebar');
        if (!toolsSidebar) {
            setTimeout(() => this.injectTestingPanel(), 500);
            return;
        }

        const toolsContent = toolsSidebar.querySelector('.space-y-6');
        if (!toolsContent) return;

        const testingSection = document.createElement('div');
        testingSection.className = 'quantum-card glass p-5';
        testingSection.innerHTML = this.getTestingHTML();
        
        // Tambahkan sebelum MongoDB section
        const mongoSection = toolsContent.querySelector('.quantum-card.glass:has(.fa-database)');
        if (mongoSection) {
            toolsContent.insertBefore(testingSection, mongoSection);
        } else {
            toolsContent.appendChild(testingSection);
        }

        this.setupTestingEvents();
    }

    getTestingHTML() {
        return `
            <h3 class="text-lg font-black text-white mb-4 flex items-center gap-2">
                <i class="fas fa-vial text-yellow-400"></i>
                CROSS-PLATFORM TESTING
            </h3>
            
            <div class="space-y-4">
                <!-- Quick Test Buttons -->
                <div class="grid grid-cols-2 gap-2">
                    <button id="quickCompatibilityTest" class="quantum-btn warning text-xs py-2">
                        <i class="fas fa-bolt"></i> Quick Test
                    </button>
                    <button id="fullCompatibilityTest" class="quantum-btn primary text-xs py-2">
                        <i class="fas fa-cogs"></i> Full Test
                    </button>
                </div>

                <!-- Test Results Display -->
                <div id="testResults" class="space-y-2 text-xs max-h-40 overflow-y-auto">
                    <div class="text-center text-gray-400">No tests run yet</div>
                </div>

                <!-- Browser Compatibility -->
                <div class="border-t border-gray-600 pt-3">
                    <h4 class="text-sm font-semibold text-purple-300 mb-2">Browser Support</h4>
                    <div class="grid grid-cols-3 gap-1 text-center">
                        <div class="browser-support" data-browser="chrome">
                            <i class="fab fa-chrome text-blue-400"></i>
                            <div class="text-xs mt-1">Chrome</div>
                        </div>
                        <div class="browser-support" data-browser="firefox">
                            <i class="fab fa-firefox text-orange-400"></i>
                            <div class="text-xs mt-1">Firefox</div>
                        </div>
                        <div class="browser-support" data-browser="safari">
                            <i class="fab fa-safari text-blue-500"></i>
                            <div class="text-xs mt-1">Safari</div>
                        </div>
                    </div>
                </div>

                <!-- Device Testing -->
                <div class="border-t border-gray-600 pt-3">
                    <h4 class="text-sm font-semibold text-purple-300 mb-2">Device Testing</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="testMobileView" class="quantum-btn secondary text-xs py-1">
                            <i class="fas fa-mobile"></i> Mobile
                        </button>
                        <button id="testTabletView" class="quantum-btn secondary text-xs py-1">
                            <i class="fas fa-tablet"></i> Tablet
                        </button>
                    </div>
                </div>

                <!-- Performance Metrics -->
                <div class="border-t border-gray-600 pt-3">
                    <h4 class="text-sm font-semibold text-purple-300 mb-2">Performance</h4>
                    <div class="space-y-1 text-xs">
                        <div class="flex justify-between">
                            <span>Load Time:</span>
                            <span id="loadTime">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span>FPS:</span>
                            <span id="fpsCounter">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Memory:</span>
                            <span id="memoryUsage">-</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    injectSecurityMeasures() {
        const quantumSidebar = document.getElementById('quantumSidebar');
        if (!quantumSidebar) {
            setTimeout(() => this.injectSecurityMeasures(), 500);
            return;
        }

        const sidebarContent = quantumSidebar.querySelector('.space-y-6');
        if (!sidebarContent) return;

        const securitySection = document.createElement('div');
        securitySection.className = 'quantum-card glass p-5';
        securitySection.innerHTML = this.getSecurityHTML();
        
        sidebarContent.appendChild(securitySection);
        this.setupSecurityEvents();
    }

    getSecurityHTML() {
        return `
            <h3 class="text-lg font-black text-white mb-4 flex items-center gap-2">
                <i class="fas fa-shield-alt text-green-400"></i>
                SECURITY MEASURES
            </h3>
            
            <div class="space-y-4">
                <!-- Security Status -->
                <div id="securityStatus" class="space-y-2 text-xs">
                    <div class="flex justify-between items-center">
                        <span>Encryption:</span>
                        <span class="security-badge success">Active</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Data Protection:</span>
                        <span class="security-badge warning">Checking...</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>API Security:</span>
                        <span class="security-badge danger">Not Configured</span>
                    </div>
                </div>

                <!-- Security Controls -->
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-purple-300">End-to-End Encryption</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="e2eEncryption" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-700 peer-focus:ring-4 peer-focus:ring-green-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                        </label>
                    </div>

                    <div class="flex items-center justify-between">
                        <span class="text-sm text-purple-300">Auto Data Purge</span>
                        <select id="autoPurge" class="quantum-input glass text-sm py-1">
                            <option value="never">Never</option>
                            <option value="1h">1 Hour</option>
                            <option value="24h">24 Hours</option>
                            <option value="7d">7 Days</option>
                        </select>
                    </div>

                    <div class="flex items-center justify-between">
                        <span class="text-sm text-purple-300">Secure API Calls</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="secureAPICalls" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-700 peer-focus:ring-4 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                </div>

                <!-- Security Actions -->
                <div class="grid grid-cols-2 gap-2 mt-4">
                    <button id="runSecurityScan" class="quantum-btn success text-xs py-2">
                        <i class="fas fa-search"></i> Security Scan
                    </button>
                    <button id="encryptAllData" class="quantum-btn primary text-xs py-2">
                        <i class="fas fa-lock"></i> Encrypt Data
                    </button>
                </div>

                <!-- Security Log -->
                <div class="border-t border-gray-600 pt-3">
                    <h4 class="text-sm font-semibold text-purple-300 mb-2">Security Log</h4>
                    <div id="securityLog" class="text-xs max-h-24 overflow-y-auto space-y-1">
                        <div class="text-gray-400">No security events yet</div>
                    </div>
                </div>
            </div>
        `;
    }

    setupTestingEvents() {
        document.getElementById('quickCompatibilityTest')?.addEventListener('click', () => this.runQuickTest());
        document.getElementById('fullCompatibilityTest')?.addEventListener('click', () => this.runFullTest());
        document.getElementById('testMobileView')?.addEventListener('click', () => this.testMobileView());
        document.getElementById('testTabletView')?.addEventListener('click', () => this.testTabletView());
    }

    setupSecurityEvents() {
        document.getElementById('e2eEncryption')?.addEventListener('change', (e) => this.toggleEncryption(e.target.checked));
        document.getElementById('secureAPICalls')?.addEventListener('change', (e) => this.toggleSecureAPI(e.target.checked));
        document.getElementById('runSecurityScan')?.addEventListener('click', () => this.runSecurityScan());
        document.getElementById('encryptAllData')?.addEventListener('click', () => this.encryptAllData());
        document.getElementById('autoPurge')?.addEventListener('change', (e) => this.setAutoPurge(e.target.value));
    }

    // ==================== TESTING METHODS ====================

    async runQuickTest() {
        this.updateTestResults('ðŸš€ Starting Quick Compatibility Test...', 'info');
        
        const tests = [
            this.testBrowserFeatures(),
            this.testAPIConnectivity(),
            this.testPerformance(),
            this.testResponsiveDesign()
        ];

        for (const test of tests) {
            await test;
            await this.delay(500);
        }

        this.updateTestResults('âœ… Quick Test Completed!', 'success');
        this.updateQuantumIsland('ðŸ§ª Quick Test Passed', 2000);
    }

    async runFullTest() {
        this.updateTestResults('ðŸ”§ Starting Full Compatibility Test...', 'info');
        
        const comprehensiveTests = [
            this.testBrowserCompatibility(),
            this.testDeviceCompatibility(),
            this.testPerformanceMetrics(),
            this.testSecurityFeatures(),
            this.testAPIIntegration(),
            this.testStorageSystems(),
            this.testUIFunctionality()
        ];

        let passed = 0;
        let failed = 0;

        for (const test of comprehensiveTests) {
            try {
                await test;
                passed++;
            } catch (error) {
                failed++;
                this.updateTestResults(`âŒ ${error.message}`, 'error');
            }
            await this.delay(300);
        }

        this.updateTestResults(`ðŸ“Š Full Test Complete: ${passed} passed, ${failed} failed`, 
                              failed === 0 ? 'success' : 'warning');
    }

    async testBrowserFeatures() {
        const features = {
            'WebGL': this.detectWebGL(),
            'WebAudio': this.detectWebAudio(),
            'ServiceWorker': 'serviceWorker' in navigator,
            'LocalStorage': !!window.localStorage,
            'SessionStorage': !!window.sessionStorage,
            'IndexedDB': !!window.indexedDB,
            'WebAssembly': 'WebAssembly' in window,
            'ES6 Modules': 'noModule' in HTMLScriptElement.prototype
        };

        Object.entries(features).forEach(([feature, supported]) => {
            this.updateTestResults(
                `${supported ? 'âœ…' : 'âŒ'} ${feature}: ${supported ? 'Supported' : 'Not Supported'}`,
                supported ? 'success' : 'error'
            );
        });

        return Object.values(features).every(Boolean);
    }

    async testPerformance() {
        const perf = performance.timing;
        const loadTime = perf.loadEventEnd - perf.navigationStart;
        
        this.updateTestResults(`â±ï¸ Page Load Time: ${loadTime}ms`, 
                              loadTime < 2000 ? 'success' : 'warning');

        // Test FPS
        this.startFPSCounter();
        
        // Test Memory
        if (performance.memory) {
            const memory = performance.memory;
            const used = Math.round(memory.usedJSHeapSize / 1048576);
            const total = Math.round(memory.totalJSHeapSize / 1048576);
            this.updateTestResults(`ðŸ’¾ Memory Usage: ${used}MB / ${total}MB`, 'info');
        }

        return loadTime < 5000; // Pass if load time < 5 seconds
    }

    async testResponsiveDesign() {
        const breakpoints = [
            { name: 'Mobile', width: 375 },
            { name: 'Tablet', width: 768 },
            { name: 'Desktop', width: 1024 },
            { name: 'Large Desktop', width: 1440 }
        ];

        for (const bp of breakpoints) {
            const result = await this.testViewport(bp.width, bp.name);
            this.updateTestResults(
                `${result ? 'âœ…' : 'âš ï¸'} ${bp.name} (${bp.width}px): ${result ? 'OK' : 'Issues'}`,
                result ? 'success' : 'warning'
            );
        }
    }

    async testViewport(width, name) {
        return new Promise((resolve) => {
            const originalWidth = window.innerWidth;
            const originalHeight = window.innerHeight;
            
            // Simulate viewport change
            window.innerWidth = width;
            window.dispatchEvent(new Event('resize'));
            
            setTimeout(() => {
                const elements = document.querySelectorAll('.quantum-card, .quantum-btn, .quantum-input');
                const visibleElements = Array.from(elements).filter(el => {
                    const rect = el.getBoundingClientRect();
                    return rect.width > 0 && rect.height > 0;
                });
                
                const success = visibleElements.length > 0;
                
                // Restore original size
                window.innerWidth = originalWidth;
                window.innerHeight = originalHeight;
                window.dispatchEvent(new Event('resize'));
                
                resolve(success);
            }, 100);
        });
    }

    testMobileView() {
        this.updateTestResults('ðŸ“± Testing Mobile View...', 'info');
        this.simulateViewport(375, 667);
        setTimeout(() => this.restoreViewport(), 5000);
    }

    testTabletView() {
        this.updateTestResults('ðŸ“Ÿ Testing Tablet View...', 'info');
        this.simulateViewport(768, 1024);
        setTimeout(() => this.restoreViewport(), 5000);
    }

    simulateViewport(width, height) {
        this.originalViewport = { width: window.innerWidth, height: window.innerHeight };
        window.innerWidth = width;
        window.innerHeight = height;
        window.dispatchEvent(new Event('resize'));
        
        // Add viewport indicator
        this.addViewportIndicator(`${width}Ã—${height}`);
    }

    restoreViewport() {
        if (this.originalViewport) {
            window.innerWidth = this.originalViewport.width;
            window.innerHeight = this.originalViewport.height;
            window.dispatchEvent(new Event('resize'));
            this.removeViewportIndicator();
        }
    }

    addViewportIndicator(size) {
        this.removeViewportIndicator();
        const indicator = document.createElement('div');
        indicator.id = 'viewport-indicator';
        indicator.innerHTML = `ðŸ” Testing: ${size}`;
        indicator.style.cssText = `
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: #6366f1;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        `;
        document.body.appendChild(indicator);
    }

    removeViewportIndicator() {
        const indicator = document.getElementById('viewport-indicator');
        if (indicator) indicator.remove();
    }

    // ==================== SECURITY METHODS ====================

    toggleEncryption(enabled) {
        if (enabled) {
            this.enableEncryption();
            this.logSecurityEvent('Encryption enabled', 'success');
        } else {
            this.disableEncryption();
            this.logSecurityEvent('Encryption disabled', 'warning');
        }
    }

    enableEncryption() {
        // Implement encryption for localStorage data
        const originalSetItem = localStorage.setItem;
        const originalGetItem = localStorage.getItem;

        localStorage.setItem = function(key, value) {
            const encrypted = btoa(unescape(encodeURIComponent(value)));
            originalSetItem.call(this, key, encrypted);
        };

        localStorage.getItem = function(key) {
            const encrypted = originalGetItem.call(this, key);
            if (encrypted) {
                try {
                    return decodeURIComponent(escape(atob(encrypted)));
                } catch {
                    return encrypted; // Return as-is if not encrypted
                }
            }
            return null;
        };

        this.updateSecurityStatus('encryption', 'success', 'Active');
    }

    disableEncryption() {
        // Restore original localStorage methods
        delete localStorage.setItem;
        delete localStorage.getItem;
        this.updateSecurityStatus('encryption', 'danger', 'Disabled');
    }

    async runSecurityScan() {
        this.logSecurityEvent('Starting security scan...', 'info');
        
        const securityChecks = [
            this.checkHTTPS(),
            this.checkContentSecurity(),
            this.checkDataStorage(),
            this.checkAPISecurity(),
            this.checkVulnerabilities()
        ];

        for (const check of securityChecks) {
            await check;
            await this.delay(500);
        }

        this.logSecurityEvent('Security scan completed', 'success');
        this.updateQuantumIsland('ðŸ”’ Security Scan Complete', 2000);
    }

    async checkHTTPS() {
        const isSecure = window.location.protocol === 'https:';
        this.updateSecurityStatus('https', isSecure ? 'success' : 'danger', 
                                isSecure ? 'Secure' : 'Not Secure');
        return isSecure;
    }

    async checkContentSecurity() {
        // Check for potential XSS vulnerabilities
        const scripts = document.querySelectorAll('script');
        let hasInlineScripts = false;

        scripts.forEach(script => {
            if (!script.src && script.innerHTML.trim()) {
                hasInlineScripts = true;
            }
        });

        this.updateSecurityStatus('contentSecurity', 
                                hasInlineScripts ? 'warning' : 'success',
                                hasInlineScripts ? 'Inline Scripts Found' : 'Secure');
        return !hasInlineScripts;
    }

    async checkDataStorage() {
        // Check localStorage security
        try {
            localStorage.setItem('security_test', 'test');
            localStorage.removeItem('security_test');
            this.updateSecurityStatus('dataStorage', 'success', 'Secure');
            return true;
        } catch (error) {
            this.updateSecurityStatus('dataStorage', 'danger', 'Vulnerable');
            return false;
        }
    }

    encryptAllData() {
        this.logSecurityEvent('Encrypting all stored data...', 'info');
        
        // Encrypt existing localStorage data
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && !key.startsWith('encrypted_')) {
                const value = localStorage.getItem(key);
                localStorage.removeItem(key);
                localStorage.setItem(`encrypted_${key}`, btoa(unescape(encodeURIComponent(value))));
            }
        }

        this.logSecurityEvent('All data encrypted successfully', 'success');
        this.updateQuantumIsland('ðŸ” Data Encrypted', 2000);
    }

    setAutoPurge(interval) {
        const intervals = {
            '1h': 60 * 60 * 1000,
            '24h': 24 * 60 * 60 * 1000,
            '7d': 7 * 24 * 60 * 60 * 1000
        };

        if (this.purgeInterval) {
            clearInterval(this.purgeInterval);
        }

        if (interval !== 'never' && intervals[interval]) {
            this.purgeInterval = setInterval(() => {
                this.purgeOldData();
            }, intervals[interval]);
            
            this.logSecurityEvent(`Auto-purge set to ${interval}`, 'info');
        }
    }

    purgeOldData() {
        const oneDayAgo = Date.now() - 24 * 60 * 60 * 1000;
        let purgedCount = 0;

        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('chat_')) {
                try {
                    const item = JSON.parse(localStorage.getItem(key));
                    if (item.timestamp && new Date(item.timestamp) < oneDayAgo) {
                        localStorage.removeItem(key);
                        purgedCount++;
                    }
                } catch (error) {
                    // Skip invalid items
                }
            }
        }

        if (purgedCount > 0) {
            this.logSecurityEvent(`Purged ${purgedCount} old data entries`, 'info');
        }
    }

    // ==================== UTILITY METHODS ====================

    updateTestResults(message, type = 'info') {
        const resultsContainer = document.getElementById('testResults');
        if (!resultsContainer) return;

        const messageElement = document.createElement('div');
        messageElement.className = `test-result ${type}`;
        messageElement.textContent = message;
        messageElement.style.cssText = `
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-bottom: 2px;
            background: ${
                type === 'success' ? 'rgba(16, 185, 129, 0.1)' :
                type === 'error' ? 'rgba(239, 68, 68, 0.1)' :
                type === 'warning' ? 'rgba(245, 158, 11, 0.1)' :
                'rgba(59, 130, 246, 0.1)'
            };
            color: ${
                type === 'success' ? '#10b981' :
                type === 'error' ? '#ef4444' :
                type === 'warning' ? '#f59e0b' :
                '#3b82f6'
            };
        `;

        resultsContainer.appendChild(messageElement);
        resultsContainer.scrollTop = resultsContainer.scrollHeight;

        // Keep only last 20 results
        const results = resultsContainer.querySelectorAll('.test-result');
        if (results.length > 20) {
            results[0].remove();
        }
    }

    updateSecurityStatus(feature, status, message) {
        const statusElement = document.querySelector(`[data-feature="${feature}"]`);
        if (statusElement) {
            statusElement.innerHTML = `
                <span>${feature}:</span>
                <span class="security-badge ${status}">${message}</span>
            `;
        }
    }

    logSecurityEvent(message, type = 'info') {
        const logContainer = document.getElementById('securityLog');
        if (!logContainer) return;

        const logEntry = document.createElement('div');
        logEntry.className = `security-log-entry ${type}`;
        logEntry.innerHTML = `
            <span class="log-time">${new Date().toLocaleTimeString()}</span>
            <span class="log-message">${message}</span>
        `;
        logEntry.style.cssText = `
            display: flex;
            justify-content: space-between;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 10px;
            background: ${
                type === 'success' ? 'rgba(16, 185, 129, 0.1)' :
                type === 'error' ? 'rgba(239, 68, 68, 0.1)' :
                type === 'warning' ? 'rgba(245, 158, 11, 0.1)' :
                'rgba(59, 130, 246, 0.1)'
            };
        `;

        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;

        // Keep only last 10 entries
        const entries = logContainer.querySelectorAll('.security-log-entry');
        if (entries.length > 10) {
            entries[0].remove();
        }
    }

    startFPSCounter() {
        let frameCount = 0;
        let lastTime = performance.now();
        const fpsElement = document.getElementById('fpsCounter');

        const countFPS = () => {
            frameCount++;
            const currentTime = performance.now();
            if (currentTime - lastTime >= 1000) {
                const fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
                if (fpsElement) fpsElement.textContent = `${fps} FPS`;
                frameCount = 0;
                lastTime = currentTime;
            }
            requestAnimationFrame(countFPS);
        };

        countFPS();
    }

    updateQuantumIsland(message, duration = 3000) {
        if (window.quantumEngine) {
            window.quantumEngine.updateQuantumIsland(message, duration);
        }
    }

    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    detectWebGL() {
        const canvas = document.createElement('canvas');
        return !!(canvas.getContext('webgl') || canvas.getContext('experimental-webgl'));
    }

    detectWebAudio() {
        return !!(window.AudioContext || window.webkitAudioContext);
    }

    setupContinuousMonitoring() {
        // Monitor performance continuously
        setInterval(() => {
            this.monitorPerformance();
        }, 5000);

        // Monitor security state
        setInterval(() => {
            this.checkSecurityState();
        }, 10000);
    }

    monitorPerformance() {
        if (performance.memory) {
            const memory = performance.memory;
            const usedMB = Math.round(memory.usedJSHeapSize / 1048576);
            const memoryElement = document.getElementById('memoryUsage');
            if (memoryElement) memoryElement.textContent = `${usedMB}MB`;
        }

        const loadTimeElement = document.getElementById('loadTime');
        if (loadTimeElement && performance.timing) {
            const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
            loadTimeElement.textContent = `${loadTime}ms`;
        }
    }

    checkSecurityState() {
        // Continuous security monitoring
        this.checkHTTPS();
        this.checkDataStorage();
    }

    runAutomatedTests() {
        // Run basic tests on startup
        setTimeout(() => {
            this.runQuickTest();
            this.runSecurityScan();
        }, 3000);
    }
}

// ==================== STYLES INJECTION ====================
function injectTestingSecurityStyles() {
    const style = document.createElement('style');
    style.textContent = `
        .test-result {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .security-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .security-badge.success {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .security-badge.warning {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }
        
        .security-badge.danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .browser-support {
            padding: 8px 4px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .browser-support:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        
        .browser-support.supported {
            color: #10b981;
        }
        
        .browser-support.unsupported {
            color: #ef4444;
            opacity: 0.5;
        }
        
        #testResults, #securityLog {
            scrollbar-width: thin;
            scrollbar-color: rgba(99, 102, 241, 0.5) transparent;
        }
        
        #testResults::-webkit-scrollbar, #securityLog::-webkit-scrollbar {
            width: 4px;
        }
        
        #testResults::-webkit-scrollbar-thumb, #securityLog::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.5);
            border-radius: 2px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .quantum-card.glass {
                padding: 12px;
            }
            
            .grid.grid-cols-3 {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .grid.grid-cols-2 {
                grid-template-columns: 1fr;
            }
        }
    `;
    document.head.appendChild(style);
}

// ==================== INITIALIZATION ====================
function initializeTestingSecuritySystem() {
    console.log('ðŸ”’ Starting Quantum Testing & Security System...');
    
    // Inject styles
    injectTestingSecurityStyles();
    
    // Initialize system
    window.quantumTestingSecurity = new QuantumTestingSecurity();
    
    console.log('âœ… Quantum Testing & Security System Activated!');
}

// Auto-initialize
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeTestingSecuritySystem);
} else {
    initializeTestingSecuritySystem();
}

// Add to global enhancements
if (window.QuantumEnhancements) {
    window.QuantumEnhancements.initializeTestingSecuritySystem = initializeTestingSecuritySystem;
}

console.log('ðŸ§ª Quantum Testing & Security Module Loaded - Ready for comprehensive testing!');
</script>
<script>
// ==================== QUANTUM NEON GLOW INTENSITY CONTROL ====================
class QuantumGlowControl {
    constructor() {
        this.currentIntensity = 40; // Default medium intensity
        this.maxIntensity = 100;
        this.minIntensity = 10;
        this.init();
    }

    init() {
        this.injectGlowControls();
        this.setupEventListeners();
        this.loadSavedIntensity();
        console.log('ðŸ’¡ Quantum Neon Glow Control Initialized');
    }

    injectGlowControls() {
        // Inject ke Quantum Sidebar (kanan) - Appearance section
        const quantumSidebar = document.getElementById('quantumSidebar');
        if (!quantumSidebar) {
            setTimeout(() => this.injectGlowControls(), 500);
            return;
        }

        const sidebarContent = quantumSidebar.querySelector('.space-y-6');
        if (!sidebarContent) return;

        // Cari section Themes atau buat baru
        let themeSection = quantumSidebar.querySelector('.quantum-card.glass:has(.fa-palette)');
        
        if (!themeSection) {
            // Buat section baru jika tidak ada
            themeSection = document.createElement('div');
            themeSection.className = 'quantum-card glass p-5';
            themeSection.innerHTML = `
                <h3 class="text-lg font-black text-white mb-4">
                    <i class="fas fa-palette mr-2 text-purple-400"></i>Appearance Controls
                </h3>
            `;
            sidebarContent.insertBefore(themeSection, sidebarContent.firstChild);
        }

        // Tambahkan glow controls
        const glowControls = document.createElement('div');
        glowControls.className = 'glow-controls-section mt-4 pt-4 border-t border-gray-600';
        glowControls.innerHTML = this.getGlowControlsHTML();
        
        themeSection.appendChild(glowControls);
    }

    getGlowControlsHTML() {
        return `
            <h4 class="text-md font-black text-white mb-3 flex items-center gap-2">
                <i class="fas fa-lightbulb text-yellow-400"></i>
                NEON GLOW INTENSITY
            </h4>
            
            <div class="space-y-4">
                <!-- Intensity Slider -->
                <div class="intensity-control">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-sm font-medium text-purple-300">Glow Intensity</label>
                        <span id="glowIntensityValue" class="text-sm text-white">${this.currentIntensity}%</span>
                    </div>
                    <input type="range" id="glowIntensity" 
                           min="${this.minIntensity}" max="${this.maxIntensity}" 
                           value="${this.currentIntensity}" 
                           class="glow-intensity-slider w-full">
                    
                    <div class="flex justify-between text-xs text-purple-300 mt-1">
                        <span>Soft</span>
                        <span>Medium</span>
                        <span>Intense</span>
                    </div>
                </div>

                <!-- Quick Presets -->
                <div class="grid grid-cols-3 gap-2">
                    <button class="glow-preset quantum-btn secondary text-xs py-1" data-intensity="20">
                        <i class="fas fa-moon"></i> Soft
                    </button>
                    <button class="glow-preset quantum-btn primary text-xs py-1" data-intensity="40">
                        <i class="fas fa-sun"></i> Medium
                    </button>
                    <button class="glow-preset quantum-btn warning text-xs py-1" data-intensity="60">
                        <i class="fas fa-bolt"></i> Strong
                    </button>
                </div>

                <!-- Advanced Glow Controls -->
                <div class="advanced-glow-controls">
                    <button id="toggleAdvancedGlow" class="quantum-btn secondary text-xs w-full py-2 mb-2">
                        <i class="fas fa-sliders-h"></i> Advanced Glow Settings
                    </button>
                    
                    <div id="advancedGlowContent" class="space-y-3 hidden">
                        <!-- Individual Color Glow Controls -->
                        <div class="color-glow-controls grid grid-cols-2 gap-2">
                            <div class="color-control">
                                <label class="block text-xs text-purple-300 mb-1">Primary Glow</label>
                                <input type="range" id="primaryGlow" min="0" max="100" value="80" class="w-full color-glow-slider">
                            </div>
                            <div class="color-control">
                                <label class="block text-xs text-purple-300 mb-1">Secondary Glow</label>
                                <input type="range" id="secondaryGlow" min="0" max="100" value="60" class="w-full color-glow-slider">
                            </div>
                        </div>
                        
                        <!-- Glow Radius Control -->
                        <div class="radius-control">
                            <label class="block text-xs text-purple-300 mb-1">Glow Radius</label>
                            <input type="range" id="glowRadius" min="5" max="30" value="15" class="w-full">
                            <div class="flex justify-between text-xs text-purple-300">
                                <span id="glowRadiusValue">15px</span>
                            </div>
                        </div>

                        <!-- Animation Speed -->
                        <div class="animation-control">
                            <label class="block text-xs text-purple-300 mb-1">Pulse Speed</label>
                            <input type="range" id="glowSpeed" min="1" max="10" value="3" class="w-full">
                            <div class="flex justify-between text-xs text-purple-300">
                                <span>Slow</span>
                                <span id="glowSpeedValue">Medium</span>
                                <span>Fast</span>
                            </div>
                        </div>

                        <!-- Reset Button -->
                        <button id="resetGlowSettings" class="quantum-btn danger text-xs w-full py-2">
                            <i class="fas fa-undo"></i> Reset Glow Settings
                        </button>
                    </div>
                </div>

                <!-- Status Display -->
                <div id="glowStatus" class="text-xs text-blue-400 bg-blue-900/20 rounded p-2 text-center">
                    ðŸ’¡ Glow Intensity: ${this.currentIntensity}%
                </div>
            </div>
        `;
    }

    setupEventListeners() {
        setTimeout(() => {
            // Main intensity slider
            const intensitySlider = document.getElementById('glowIntensity');
            const intensityValue = document.getElementById('glowIntensityValue');
            
            if (intensitySlider && intensityValue) {
                intensitySlider.addEventListener('input', (e) => {
                    this.setIntensity(parseInt(e.target.value));
                });
            }

            // Quick presets
            const presets = document.querySelectorAll('.glow-preset');
            presets.forEach(preset => {
                preset.addEventListener('click', (e) => {
                    const intensity = parseInt(e.target.closest('.glow-preset').dataset.intensity);
                    this.setIntensity(intensity);
                });
            });

            // Advanced controls toggle
            const toggleBtn = document.getElementById('toggleAdvancedGlow');
            const advancedContent = document.getElementById('advancedGlowContent');
            
            if (toggleBtn && advancedContent) {
                toggleBtn.addEventListener('click', () => {
                    if (advancedContent.classList.contains('hidden')) {
                        advancedContent.classList.remove('hidden');
                        toggleBtn.innerHTML = '<i class="fas fa-sliders-h"></i> Hide Advanced Settings';
                    } else {
                        advancedContent.classList.add('hidden');
                        toggleBtn.innerHTML = '<i class="fas fa-sliders-h"></i> Advanced Glow Settings';
                    }
                });
            }

            // Advanced glow controls
            this.setupAdvancedControls();
            
            // Reset button
            const resetBtn = document.getElementById('resetGlowSettings');
            if (resetBtn) {
                resetBtn.addEventListener('click', () => this.resetGlowSettings());
            }

        }, 1000);
    }

    setupAdvancedControls() {
        // Primary glow control
        const primaryGlow = document.getElementById('primaryGlow');
        if (primaryGlow) {
            primaryGlow.addEventListener('input', (e) => {
                this.updateColorGlow('primary', parseInt(e.target.value));
            });
        }

        // Secondary glow control
        const secondaryGlow = document.getElementById('secondaryGlow');
        if (secondaryGlow) {
            secondaryGlow.addEventListener('input', (e) => {
                this.updateColorGlow('secondary', parseInt(e.target.value));
            });
        }

        // Glow radius control
        const glowRadius = document.getElementById('glowRadius');
        const glowRadiusValue = document.getElementById('glowRadiusValue');
        if (glowRadius && glowRadiusValue) {
            glowRadius.addEventListener('input', (e) => {
                const radius = parseInt(e.target.value);
                glowRadiusValue.textContent = radius + 'px';
                this.updateGlowRadius(radius);
            });
        }

        // Glow speed control
        const glowSpeed = document.getElementById('glowSpeed');
        const glowSpeedValue = document.getElementById('glowSpeedValue');
        if (glowSpeed && glowSpeedValue) {
            glowSpeed.addEventListener('input', (e) => {
                const speed = parseInt(e.target.value);
                const speedLabels = ['Very Slow', 'Slow', 'Medium', 'Fast', 'Very Fast'];
                glowSpeedValue.textContent = speedLabels[Math.min(speed - 1, 4)] || 'Medium';
                this.updateGlowSpeed(speed);
            });
        }
    }

    setIntensity(intensity) {
        this.currentIntensity = Math.max(this.minIntensity, Math.min(this.maxIntensity, intensity));
        
        // Update UI
        const intensityValue = document.getElementById('glowIntensityValue');
        const intensitySlider = document.getElementById('glowIntensity');
        const glowStatus = document.getElementById('glowStatus');
        
        if (intensityValue) intensityValue.textContent = this.currentIntensity + '%';
        if (intensitySlider) intensitySlider.value = this.currentIntensity;
        if (glowStatus) glowStatus.textContent = `ðŸ’¡ Glow Intensity: ${this.currentIntensity}%`;

        // Apply intensity to CSS variables
        this.applyGlowIntensity();
        
        // Save setting
        this.saveIntensity();
        
        // Show feedback
        this.showIntensityFeedback();
    }

    applyGlowIntensity() {
        const root = document.documentElement;
        const intensity = this.currentIntensity / 100;

        // Calculate new values based on intensity
        const shadowOpacity = 0.3 * intensity;
        const glowOpacity = 0.4 * intensity;
        const blurAmount = 40 * intensity;

        // Update CSS variables
        root.style.setProperty('--quantum-glow-primary', `0 0 30px color-mix(in srgb, var(--quantum-layer1) ${glowOpacity * 100}%, transparent)`);
        root.style.setProperty('--quantum-shadow-lg', `0 20px 60px rgba(0, 0, 0, ${0.3 + shadowOpacity})`);
        root.style.setProperty('--quantum-glow', `0 0 ${20 + (blurAmount * 0.5)}px rgba(99, 102, 241, ${glowOpacity})`);

        // Update specific element glows
        this.updateElementGlows(intensity);
    }

    updateElementGlows(intensity) {
        // Update quantum cards
        const cards = document.querySelectorAll('.quantum-card');
        cards.forEach(card => {
            const glowValue = 10 + (15 * intensity);
            card.style.boxShadow = `var(--quantum-shadow-md), 0 0 ${glowValue}px rgba(99, 102, 241, ${0.2 * intensity})`;
        });

        // Update buttons
        const buttons = document.querySelectorAll('.quantum-btn.primary, .quantum-btn.secondary');
        buttons.forEach(btn => {
            const isPrimary = btn.classList.contains('primary');
            const color = isPrimary ? '99, 102, 241' : '139, 92, 246';
            const glowValue = 5 + (10 * intensity);
            btn.style.boxShadow = `0 4px 15px rgba(${color}, ${0.3 * intensity}), 0 0 ${glowValue}px rgba(${color}, ${0.2 * intensity})`;
        });

        // Update neural network background
        const neuralNetwork = document.querySelector('.neural-network');
        if (neuralNetwork) {
            neuralNetwork.style.filter = `blur(${40 + (20 * intensity)}px)`;
            neuralNetwork.style.opacity = `${0.5 + (0.3 * intensity)}`;
        }

        // Update particles
        const particles = document.querySelectorAll('.particle, .quantum-particle');
        particles.forEach(particle => {
            particle.style.boxShadow = `0 0 ${2 + (3 * intensity)}px currentColor`;
        });
    }

    updateColorGlow(colorType, intensity) {
        const root = document.documentElement;
        const intensityValue = intensity / 100;

        if (colorType === 'primary') {
            root.style.setProperty('--primary-glow-intensity', intensityValue.toString());
        } else if (colorType === 'secondary') {
            root.style.setProperty('--secondary-glow-intensity', intensityValue.toString());
        }

        // Re-apply main intensity to incorporate color-specific changes
        this.applyGlowIntensity();
    }

    updateGlowRadius(radius) {
        const root = document.documentElement;
        root.style.setProperty('--glow-radius', radius + 'px');
        this.applyGlowIntensity();
    }

    updateGlowSpeed(speed) {
        const root = document.documentElement;
        // Convert speed (1-10) to animation duration (15s to 1.5s)
        const duration = 16 - (speed * 1.5);
        root.style.setProperty('--particle-animation-duration', duration + 's');
        
        // Update neural pulse speed
        const pulseDuration = 8 - (speed * 0.7);
        root.style.setProperty('--neural-pulse-duration', pulseDuration + 's');
    }

    resetGlowSettings() {
        // Reset to default values
        this.setIntensity(40);
        
        // Reset advanced controls
        const primaryGlow = document.getElementById('primaryGlow');
        const secondaryGlow = document.getElementById('secondaryGlow');
        const glowRadius = document.getElementById('glowRadius');
        const glowSpeed = document.getElementById('glowSpeed');
        const glowRadiusValue = document.getElementById('glowRadiusValue');
        const glowSpeedValue = document.getElementById('glowSpeedValue');

        if (primaryGlow) primaryGlow.value = 80;
        if (secondaryGlow) secondaryGlow.value = 60;
        if (glowRadius) {
            glowRadius.value = 15;
            if (glowRadiusValue) glowRadiusValue.textContent = '15px';
        }
        if (glowSpeed) {
            glowSpeed.value = 3;
            if (glowSpeedValue) glowSpeedValue.textContent = 'Medium';
        }

        // Reset CSS variables
        const root = document.documentElement;
        root.style.removeProperty('--primary-glow-intensity');
        root.style.removeProperty('--secondary-glow-intensity');
        root.style.removeProperty('--glow-radius');
        root.style.removeProperty('--particle-animation-duration');
        root.style.removeProperty('--neural-pulse-duration');

        this.applyGlowIntensity();
        this.showFeedback('ðŸ”„ Glow settings reset to defaults');
    }

    showIntensityFeedback() {
        const messages = {
            10: 'ðŸŒ™ Ultra Soft: Minimal glow for comfortable viewing',
            20: 'ðŸ’« Soft: Subtle glow for extended use',
            30: 'âœ¨ Gentle: Balanced glow for daily use',
            40: 'ðŸ”† Medium: Optimal glow for most users',
            50: 'ðŸŒŸ Bright: Enhanced glow for vibrant experience',
            60: 'ðŸ’¡ Strong: Prominent glow for dramatic effect',
            70: 'ðŸ”¥ Intense: Powerful glow for maximum impact',
            80: 'ðŸš€ Ultra: Extreme glow for special occasions',
            90: 'â˜€ï¸ Maximum: Maximum glow intensity',
            100: 'âš¡ OVERDRIVE: Ultimate glow experience'
        };

        const message = messages[this.currentIntensity] || `Glow intensity set to ${this.currentIntensity}%`;
        this.showFeedback(message);
    }

    showFeedback(message) {
        const glowStatus = document.getElementById('glowStatus');
        if (glowStatus) {
            glowStatus.textContent = message;
            glowStatus.className = 'text-xs text-green-400 bg-green-900/20 rounded p-2 text-center animate-pulse';
            
            setTimeout(() => {
                glowStatus.className = 'text-xs text-blue-400 bg-blue-900/20 rounded p-2 text-center';
                glowStatus.textContent = `ðŸ’¡ Glow Intensity: ${this.currentIntensity}%`;
            }, 2000);
        }

        // Also update Quantum Island
        if (window.quantumEngine) {
            window.quantumEngine.updateQuantumIsland(message, 1500);
        }
    }

    saveIntensity() {
        const settings = {
            intensity: this.currentIntensity,
            timestamp: new Date().toISOString()
        };
        localStorage.setItem('quantum_glow_intensity', JSON.stringify(settings));
    }

    loadSavedIntensity() {
        const saved = localStorage.getItem('quantum_glow_intensity');
        if (saved) {
            try {
                const settings = JSON.parse(saved);
                this.setIntensity(settings.intensity || 40);
            } catch (error) {
                console.error('Error loading glow intensity:', error);
            }
        }
    }
}

// ==================== CYBERPUNK GLOW ENHANCEMENT ====================
function injectCyberpunkGlowEnhancement() {
    const style = document.createElement('style');
    style.textContent = `
        /* Enhanced Cyberpunk Glow System */
        :root {
            --primary-glow-intensity: 0.8;
            --secondary-glow-intensity: 0.6;
            --glow-radius: 15px;
            --particle-animation-duration: 15s;
            --neural-pulse-duration: 8s;
        }

        /* Dynamic Glow Effects */
        .quantum-card {
            transition: box-shadow 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .quantum-btn.primary {
            transition: box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .quantum-btn.secondary {
            transition: box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Enhanced Neural Network with Dynamic Glow */
        .neural-network {
            transition: filter 0.8s ease, opacity 0.8s ease;
        }

        /* Dynamic Particles */
        .particle, .quantum-particle {
            transition: box-shadow 0.5s ease;
        }

        /* Glow Intensity Slider Styles */
        .glow-intensity-slider {
            -webkit-appearance: none;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(90deg, 
                rgba(99, 102, 241, 0.3) 0%, 
                rgba(139, 92, 246, 0.5) 50%, 
                rgba(236, 72, 153, 0.7) 100%);
            outline: none;
        }

        .glow-intensity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--quantum-primary);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.8);
            border: 2px solid white;
            transition: all 0.2s ease;
        }

        .glow-intensity-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(99, 102, 241, 1);
        }

        /* Color Glow Sliders */
        .color-glow-slider {
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: var(--quantum-surface);
            outline: none;
        }

        .color-glow-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: currentColor;
            cursor: pointer;
            border: 2px solid white;
        }

        /* Preset Button Animations */
        .glow-preset {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glow-preset:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* Advanced Controls Animation */
        .advanced-glow-controls {
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* Status Display Animations */
        #glowStatus {
            transition: all 0.3s ease;
        }

        /* Cyberpunk Scan Lines Effect (Optional) */
        .cyberpunk-scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(0, 255, 255, 0.03) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 9999;
            opacity: 0.1;
            mix-blend-mode: overlay;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .glow-controls-section {
                padding: 12px;
            }
            
            .glow-preset {
                padding: 8px 4px;
                font-size: 10px;
            }
        }

        @media (max-width: 480px) {
            .color-glow-controls {
                grid-template-columns: 1fr;
            }
        }

        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            .quantum-card,
            .quantum-btn,
            .neural-network,
            .particle,
            .glow-preset {
                transition: none;
            }
            
            .cyberpunk-scanlines {
                animation: none;
            }
        }
    `;
    document.head.appendChild(style);

    // Add optional scanlines effect
    const scanlines = document.createElement('div');
    scanlines.className = 'cyberpunk-scanlines';
    scanlines.id = 'cyberpunkScanlines';
    document.body.appendChild(scanlines);

    console.log('ðŸ”® Cyberpunk Glow Enhancement Injected');
}

// ==================== INITIALIZE GLOW CONTROL SYSTEM ====================
function initializeGlowControlSystem() {
    console.log('ðŸ’¡ Starting Quantum Neon Glow Control System...');
    
    // Inject cyberpunk glow enhancement styles
    injectCyberpunkGlowEnhancement();
    
    // Initialize glow control system
    window.quantumGlowControl = new QuantumGlowControl();
    
    console.log('âœ… Quantum Neon Glow Control System Activated!');
    
    // Show welcome notification
    setTimeout(() => {
        if (window.quantumEngine) {
            window.quantumEngine.updateQuantumIsland('ðŸ’¡ Neon Glow Control Ready!', 2000);
        }
    }, 1000);
}

// Auto-initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeGlowControlSystem);
} else {
    initializeGlowControlSystem();
}

// Add to global enhancements
if (window.QuantumEnhancements) {
    window.QuantumEnhancements.initializeGlowControlSystem = initializeGlowControlSystem;
}

console.log('ðŸ’¡ Quantum Neon Glow Control Module Loaded - Ready to control glow intensity!');
</script>
<script>
// ==================== QUANTUM HOME PAGE FUSION DESIGN - TOMBOL RATA TENGAH ====================
function injectHomePageFusionDesign() {
    console.log('ðŸŽ¨ Injecting Home Page Fusion Design - Tombol Rata Tengah...');
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', applyHomePageFusion);
    } else {
        applyHomePageFusion();
    }
    
    function applyHomePageFusion() {
        const homeBase = document.getElementById('quantumHomeBase');
        if (!homeBase) {
            setTimeout(applyHomePageFusion, 500);
            return;
        }

        // Inject fusion styles dengan tombol rata tengah
        injectFusionStyles();
        
        // Apply fusion design to home page elements
        applyFusionToElements();
        
        console.log('âœ… Home Page Fusion Design - Tombol Rata Tengah applied successfully');
    }
    
    function injectFusionStyles() {
        const style = document.createElement('style');
        style.textContent = `
            /* ==================== QUANTUM HOME PAGE FUSION STYLES - TOMBOL RATA TENGAH ==================== */
            
            /* Container utama - center everything */
            .quantum-home-base {
                background: transparent !important;
                padding: clamp(20px, 8vh, 80px) clamp(16px, 5vw, 40px) !important;
                min-height: 100vh !important;
                display: flex !important;
                flex-direction: column !important;
                justify-content: center !important;
                align-items: center !important;
                box-sizing: border-box !important;
                overflow: hidden !important;
                text-align: center !important;
            }
            
            /* Logo Brain - Center positioning */
            .quantum-home-logo {
                margin-bottom: clamp(-20px, -2vh, -10px) !important;
                position: relative;
                z-index: 2;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
            }
            
            .quantum-home-logo .w-32.h-32 {
                background: transparent !important;
                box-shadow: none !important;
                border: none !important;
                animation: brainFloatFusion 8s ease-in-out infinite;
                position: relative;
                overflow: hidden;
                width: clamp(80px, 20vw, 128px) !important;
                height: clamp(80px, 20vw, 128px) !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
            }
            
            .quantum-home-logo .w-32.h-32::before {
                content: '';
                position: absolute;
                inset: 0;
                background: radial-gradient(circle at center, 
                    rgba(99, 102, 241, 0.1) 0%, 
                    rgba(139, 92, 246, 0.05) 30%, 
                    transparent 70%);
                border-radius: 50%;
                animation: brainPulseFusion 4s ease-in-out infinite;
            }
            
            .quantum-home-logo .fa-brain {
                color: rgba(255, 255, 255, 0.9);
                text-shadow: 0 0 20px rgba(99, 102, 241, 0.4),
                             0 0 40px rgba(139, 92, 246, 0.2);
                filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.2));
                position: relative;
                z-index: 2;
                font-size: clamp(2rem, 8vw, 3rem) !important;
            }
            
            /* JUDUL - Center aligned */
            .quantum-home-title {
                font-size: clamp(2rem, 10vw, 4.5rem) !important;
                font-weight: 900 !important;
                margin-bottom: clamp(-15px, -1vh, -5px) !important;
                font-family: var(--quantum-font-display) !important;
                background: linear-gradient(135deg, var(--quantum-layer1) 0%, var(--quantum-layer3) 50%, var(--quantum-layer5) 100%) !important;
                -webkit-background-clip: text !important;
                -webkit-text-fill-color: transparent !important;
                background-clip: text !important;
                text-shadow: 0 0 50px rgba(99, 102, 241, 0.5) !important;
                padding: clamp(8px, 2vh, 16px) clamp(16px, 4vw, 32px) !important;
                text-align: center !important;
                line-height: 1.1 !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                max-width: min(90vw, 800px) !important;
                margin-left: auto !important;
                margin-right: auto !important;
            }
            
            /* SUBTITLE - Center aligned */
            .quantum-home-subtitle {
                font-size: clamp(0.9rem, 3vw, 1.2rem) !important;
                margin-bottom: clamp(30px, 8vh, 60px) !important;
                color: var(--quantum-text) !important;
                opacity: 0.9 !important;
                max-width: min(85vw, 600px) !important;
                text-shadow: 0 1px 10px rgba(0, 0, 0, 0.3) !important;
                padding: clamp(6px, 1.5vh, 12px) clamp(12px, 3vw, 24px) !important;
                text-align: center !important;
                line-height: 1.4 !important;
                display: block !important;
                visibility: visible !important;
                margin-left: auto !important;
                margin-right: auto !important;
            }
            
            /* Container tombol - FLEX CENTER dengan wrap yang rapi */
            .quantum-home-buttons {
                background: transparent !important;
                padding: clamp(12px, 3vh, 24px) clamp(16px, 4vw, 32px) !important;
                border-radius: 25px;
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
                border: none !important;
                display: flex !important;
                gap: clamp(12px, 3vw, 20px) !important;
                flex-wrap: wrap !important;
                justify-content: center !important;
                align-items: center !important;
                max-width: min(90vw, 600px) !important;
                margin-left: auto !important;
                margin-right: auto !important;
            }
            
            /* Tombol Fusion - Equal width untuk konsistensi */
            .quantum-home-btn {
                background: transparent !important;
                border: none !important;
                box-shadow: none !important;
                color: rgba(255, 255, 255, 0.9) !important;
                text-shadow: 0 1px 8px rgba(0, 0, 0, 0.2);
                position: relative;
                overflow: visible;
                border-radius: 20px;
                transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
                
                /* Equal sizing untuk kedua tombol */
                padding: clamp(16px, 4vh, 22px) clamp(40px, 10vw, 70px) !important;
                font-size: clamp(1rem, 3vw, 1.2rem) !important;
                font-weight: 700 !important;
                min-width: min(220px, 48vw) !important;
                margin: 0 !important;
                display: inline-flex !important;
                justify-content: center !important;
                align-items: center !important;
                flex: 0 1 auto !important;
            }
            
            /* Efek Hover - sangat subtle */
            .quantum-home-btn:hover {
                transform: translateY(-3px);
                color: rgba(255, 255, 255, 1) !important;
                text-shadow: 0 2px 20px rgba(255, 255, 255, 0.3),
                             0 0 30px rgba(99, 102, 241, 0.5);
            }
            
            /* Animasi iOS26 saat tombol ditekan */
            .quantum-home-btn:active {
                animation: ios26PressHD 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            }
            
            /* Efek ripple transparan */
            .quantum-home-btn::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                border-radius: 50%;
                background: radial-gradient(circle, 
                    rgba(255, 255, 255, 0.1) 0%, 
                    transparent 70%);
                transform: translate(-50%, -50%);
                opacity: 0;
                transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            }
            
            .quantum-home-btn:active::after {
                width: min(180px, 45vw);
                height: min(180px, 45vw);
                opacity: 0.3;
            }
            
            /* Ikon dalam tombol */
            .quantum-home-btn i {
                filter: drop-shadow(0 1px 4px rgba(0, 0, 0, 0.1));
                transition: all 0.3s ease;
                margin-right: clamp(6px, 1.5vw, 10px) !important;
                font-size: clamp(1rem, 3vw, 1.2rem) !important;
            }
            
            .quantum-home-btn:hover i {
                filter: drop-shadow(0 3px 10px rgba(255, 255, 255, 0.3));
                transform: scale(1.1);
            }
            
            /* Animasi Kustom */
            @keyframes ios26PressHD {
                0% {
                    transform: translateY(0) scale(1);
                    color: rgba(255, 255, 255, 0.9);
                }
                25% {
                    transform: translateY(4px) scale(0.96);
                    color: rgba(255, 255, 255, 1);
                    text-shadow: 0 0 25px rgba(255, 255, 255, 0.5);
                }
                50% {
                    transform: translateY(2px) scale(0.98);
                    color: rgba(255, 255, 255, 0.95);
                }
                100% {
                    transform: translateY(0) scale(1);
                    color: rgba(255, 255, 255, 0.9);
                }
            }
            
            @keyframes brainFloatFusion {
                0%, 100% { 
                    transform: translateY(0) scale(1) rotate(0deg);
                    filter: brightness(1) drop-shadow(0 0 10px rgba(99, 102, 241, 0.2));
                }
                33% { 
                    transform: translateY(-15px) scale(1.04) rotate(2deg);
                    filter: brightness(1.08) drop-shadow(0 0 20px rgba(139, 92, 246, 0.4));
                }
                66% { 
                    transform: translateY(-8px) scale(1.02) rotate(-1deg);
                    filter: brightness(1.04) drop-shadow(0 0 15px rgba(168, 85, 247, 0.3));
                }
            }
            
            @keyframes brainPulseFusion {
                0%, 100% { 
                    opacity: 0.3;
                    transform: scale(1);
                }
                50% { 
                    opacity: 0.6;
                    transform: scale(1.08);
                }
            }
            
            /* Efek sangat subtle pada hover tombol */
            .quantum-home-btn::before {
                content: '';
                position: absolute;
                inset: -1px;
                border-radius: 21px;
                background: linear-gradient(135deg, 
                    rgba(99, 102, 241, 0.08) 0%, 
                    rgba(139, 92, 246, 0.04) 50%, 
                    transparent 100%);
                opacity: 0;
                transition: opacity 0.3s ease;
                z-index: -1;
            }
            
            .quantum-home-btn:hover::before {
                opacity: 0.4;
            }
            
            /* Responsive layout untuk berbagai ukuran layar */
            @media (max-width: 768px) {
                .quantum-home-buttons {
                    gap: clamp(10px, 2.5vw, 16px) !important;
                }
                
                .quantum-home-btn {
                    min-width: min(200px, 44vw) !important;
                    padding: clamp(14px, 3.5vh, 18px) clamp(32px, 8vw, 50px) !important;
                }
            }
            
            @media (max-width: 480px) {
                .quantum-home-buttons {
                    flex-direction: column !important;
                    gap: clamp(8px, 2vh, 12px) !important;
                }
                
                .quantum-home-btn {
                    width: 100% !important;
                    min-width: auto !important;
                    max-width: min(280px, 85vw) !important;
                    padding: clamp(12px, 3vh, 16px) clamp(24px, 6vw, 40px) !important;
                }
            }
            
            /* Landscape mode optimization */
            @media (max-height: 500px) and (orientation: landscape) {
                .quantum-home-base {
                    padding-top: 15px !important;
                    padding-bottom: 15px !important;
                    justify-content: flex-start !important;
                }
                
                .quantum-home-logo {
                    margin-bottom: -8px !important;
                }
                
                .quantum-home-logo .w-32.h-32 {
                    width: 60px !important;
                    height: 60px !important;
                }
                
                .quantum-home-logo .fa-brain {
                    font-size: 1.5rem !important;
                }
                
                .quantum-home-title {
                    margin-bottom: -6px !important;
                    font-size: clamp(1.8rem, 7vw, 2.2rem) !important;
                    padding: 6px 18px !important;
                }
                
                .quantum-home-subtitle {
                    margin-bottom: 20px !important;
                    font-size: 0.85rem !important;
                    padding: 4px 14px !important;
                }
                
                .quantum-home-buttons {
                    padding: 10px 20px !important;
                    gap: 8px !important;
                }
                
                .quantum-home-btn {
                    padding: 10px 24px !important;
                    font-size: 0.9rem !important;
                    min-width: 160px !important;
                }
            }
            
            /* Very small screens protection */
            @media (max-width: 320px) {
                .quantum-home-btn {
                    font-size: 0.85rem !important;
                    padding: 10px 20px !important;
                }
            }
            
            /* Safe area untuk notched devices */
            @supports(padding: max(0px)) {
                .quantum-home-base {
                    padding-left: max(clamp(16px, 5vw, 40px), env(safe-area-inset-left)) !important;
                    padding-right: max(clamp(16px, 5vw, 40px), env(safe-area-inset-right)) !important;
                    padding-top: max(clamp(20px, 8vh, 80px), env(safe-area-inset-top)) !important;
                    padding-bottom: max(clamp(20px, 8vh, 80px), env(safe-area-inset-bottom)) !important;
                }
            }
            
            /* Reduced Motion Support */
            @media (prefers-reduced-motion: reduce) {
                .quantum-home-logo .w-32.h-32,
                .quantum-home-btn,
                .quantum-home-btn::after,
                .quantum-home-btn i {
                    animation: none !important;
                    transition: none !important;
                    transform: none !important;
                }
            }
        `;
        document.head.appendChild(style);
        console.log('âœ… Fusion styles dengan tombol rata tengah injected');
    }
    
    function applyFusionToElements() {
        // Apply to logo
        const logo = document.querySelector('.quantum-home-logo .w-32.h-32');
        if (logo) {
            logo.style.background = 'transparent';
            logo.style.boxShadow = 'none';
            logo.style.border = 'none';
            logo.style.display = 'flex';
            logo.style.justifyContent = 'center';
            logo.style.alignItems = 'center';
        }
        
        // Apply to buttons container - CENTER EVERYTHING
        const buttonsContainer = document.querySelector('.quantum-home-buttons');
        if (buttonsContainer) {
            buttonsContainer.style.background = 'transparent';
            buttonsContainer.style.backdropFilter = 'none';
            buttonsContainer.style.border = 'none';
            buttonsContainer.style.display = 'flex';
            buttonsContainer.style.justifyContent = 'center';
            buttonsContainer.style.alignItems = 'center';
            buttonsContainer.style.marginLeft = 'auto';
            buttonsContainer.style.marginRight = 'auto';
            buttonsContainer.style.textAlign = 'center';
        }
        
        // Apply to title - CENTER
        const title = document.querySelector('.quantum-home-title');
        if (title) {
            title.style.display = 'block';
            title.style.visibility = 'visible';
            title.style.opacity = '1';
            title.style.background = 'linear-gradient(135deg, var(--quantum-layer1) 0%, var(--quantum-layer3) 50%, var(--quantum-layer5) 100%)';
            title.style.webkitBackgroundClip = 'text';
            title.style.webkitTextFillColor = 'transparent';
            title.style.backgroundClip = 'text';
            title.style.textAlign = 'center';
            title.style.marginLeft = 'auto';
            title.style.marginRight = 'auto';
        }
        
        // Apply to subtitle - CENTER
        const subtitle = document.querySelector('.quantum-home-subtitle');
        if (subtitle) {
            subtitle.style.display = 'block';
            subtitle.style.visibility = 'visible';
            subtitle.style.opacity = '0.9';
            subtitle.style.color = 'var(--quantum-text)';
            subtitle.style.textAlign = 'center';
            subtitle.style.marginLeft = 'auto';
            subtitle.style.marginRight = 'auto';
        }
        
        // Apply to home base container - CENTER
        const homeBase = document.getElementById('quantumHomeBase');
        if (homeBase) {
            homeBase.style.display = 'flex';
            homeBase.style.flexDirection = 'column';
            homeBase.style.justifyContent = 'center';
            homeBase.style.alignItems = 'center';
            homeBase.style.minHeight = '100vh';
            homeBase.style.boxSizing = 'border-box';
            homeBase.style.textAlign = 'center';
        }
        
        // Apply to buttons - CENTER ALIGNED
        const buttons = document.querySelectorAll('.quantum-home-btn');
        buttons.forEach(btn => {
            btn.style.background = 'transparent';
            btn.style.border = 'none';
            btn.style.boxShadow = 'none';
            btn.style.color = 'rgba(255, 255, 255, 0.9)';
            btn.style.backdropFilter = 'none';
            btn.style.display = 'inline-flex';
            btn.style.justifyContent = 'center';
            btn.style.alignItems = 'center';
            btn.style.visibility = 'visible';
            btn.style.opacity = '1';
            btn.style.margin = '0';
            
            // Add iOS26 press animation
            btn.addEventListener('mousedown', function() {
                this.style.animation = 'none';
                setTimeout(() => {
                    this.style.animation = 'ios26PressHD 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards';
                }, 10);
            });
            
            // Add touch support for mobile
            btn.addEventListener('touchstart', function() {
                this.style.animation = 'none';
                setTimeout(() => {
                    this.style.animation = 'ios26PressHD 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards';
                }, 10);
            });
        });
        
        console.log('âœ… Fusion design dengan tombol rata tengah applied to home page elements');
    }
}

// ==================== ENHANCED TOGGLE BUTTONS PRESERVATION ====================
function preserveToggleButtons() {
    console.log('ðŸ”§ Preserving toggle buttons...');
    
    // Pastikan toggle buttons tetap memiliki border dan style asli
    const toggleButtons = document.querySelectorAll('.toggle-btn, .quantum-home-button');
    
    toggleButtons.forEach(btn => {
        // Pastikan style asli tetap ada
        btn.style.background = 'var(--quantum-gradient-primary)';
        btn.style.border = '2px solid rgba(255, 255, 255, 0.8)';
        btn.style.outline = '1px solid rgba(99, 102, 241, 0.6)';
        btn.style.boxShadow = 'var(--quantum-shadow-md)';
        btn.style.display = 'flex';
        btn.style.visibility = 'visible';
    });
    
    console.log('âœ… Toggle buttons preserved with original styling');
}

// ==================== INITIALIZE HOME PAGE FUSION ====================
function initializeHomePageFusion() {
    console.log('ðŸ  Starting Home Page Fusion Design - Tombol Rata Tengah...');
    
    // Inject fusion design
    injectHomePageFusionDesign();
    
    // Preserve toggle buttons
    preserveToggleButtons();
    
    console.log('âœ… Home Page Fusion Design - Tombol Rata Tengah Activated!');
    
    // Show notification
    setTimeout(() => {
        if (window.quantumEngine) {
            window.quantumEngine.updateQuantumIsland('ðŸŽ¨ Home Page - Tombol Rata Tengah', 2000);
        }
    }, 1000);
}

// ==================== AUTO-INITIALIZE FUSION DESIGN ====================
function waitForEngineAndAddFusion() {
    if (window.quantumEngine) {
        initializeHomePageFusion();
    } else {
        setTimeout(waitForEngineAndAddFusion, 100);
    }
}

// Start the fusion design process
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', waitForEngineAndAddFusion);
} else {
    waitForEngineAndAddFusion();
}

// Add to global enhancements
if (window.QuantumEnhancements) {
    window.QuantumEnhancements.injectHomePageFusionDesign = injectHomePageFusionDesign;
    window.QuantumEnhancements.preserveToggleButtons = preserveToggleButtons;
    window.QuantumEnhancements.initializeHomePageFusion = initializeHomePageFusion;
}

console.log('ðŸŽ¨ Quantum Home Page Fusion Module Loaded - Tombol Rata Tengah Ready!');
</script>
<!-- ====== QUANTUM AI REAL API INJECTION ====== -->
<script>
/*
  Integrasi nyata dengan UI asli STL-UDHIS:
  - Gunakan tombol yang sudah ada di QUANTUM AI API INTEGRATION.
  - Tidak menambah tombol baru.
  - Override fungsi sendMessage(), Save, dan Test Config.
  - Mendukung OpenAI, Anthropic (Claude), Gemini, dan Custom Endpoint.
*/

document.addEventListener("DOMContentLoaded", () => {
  const providerEl = document.getElementById("aiProvider");
  const modelEl = document.getElementById("aiModel");
  const keyEl = document.getElementById("aiApiKey");
  const saveBtn = document.getElementById("saveAiConfig");
  const testBtn = document.getElementById("testAiConfig");
  const sendBtn = document.getElementById("sendQuantumMessage");

  // ============ Local Save Config ============
  function saveConfig() {
    const config = {
      provider: providerEl.value,
      model: modelEl.value,
      apiKey: keyEl.value
    };
    localStorage.setItem("quantum_ai_config", JSON.stringify(config));
  }

  function loadConfig() {
    const cfg = JSON.parse(localStorage.getItem("quantum_ai_config") || "{}");
    if (cfg.provider) providerEl.value = cfg.provider;
    if (cfg.model) modelEl.value = cfg.model;
    if (cfg.apiKey) keyEl.value = cfg.apiKey;
    return cfg;
  }

  // ============ API CALLS ============
  async function callOpenAI(apiKey, model, messages) {
    const resp = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: model,
        messages: messages,
        temperature: 0.7
      })
    });
    const data = await resp.json();
    if (data.error) throw new Error(data.error.message);
    return data.choices[0].message.content;
  }

  async function callClaude(apiKey, model, prompt) {
    const resp = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-api-key": apiKey
      },
      body: JSON.stringify({
        model: model,
        max_tokens: 1000,
        messages: [{ role: "user", content: prompt }]
      })
    });
    const data = await resp.json();
    if (data.error) throw new Error(data.error.message);
    return data.content[0].text;
  }

  async function callGemini(apiKey, model, prompt) {
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
    const resp = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
    });
    const data = await resp.json();
    if (data.error) throw new Error(data.error.message);
    return data.candidates?.[0]?.content?.parts?.[0]?.text || "(no response)";
  }

  async function callCustom(url, apiKey, model, prompt) {
    const resp = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        ...(apiKey && { "Authorization": `Bearer ${apiKey}` })
      },
      body: JSON.stringify({ model, prompt })
    });
    const data = await resp.json();
    return data.reply || data.output || JSON.stringify(data);
  }

  // ============ Test Button ============
  if (testBtn) {
    testBtn.addEventListener("click", async () => {
      const cfg = loadConfig();
      try {
        window.quantumEngine.updateQuantumIsland("ðŸ§ª Testing API...", 2000);
        let result = "";
        if (cfg.provider === "openai")
          result = await callOpenAI(cfg.apiKey, cfg.model, [{ role: "user", content: "Hello test" }]);
        else if (cfg.provider === "anthropic")
          result = await callClaude(cfg.apiKey, cfg.model, "Hello test");
        else if (cfg.provider === "google")
          result = await callGemini(cfg.apiKey, cfg.model, "Hello test");
        else if (cfg.provider === "custom")
          result = await callCustom(prompt("Custom endpoint URL:"), cfg.apiKey, cfg.model, "Hello test");

        window.quantumEngine.addMessageToChat("ai", "ðŸ§© Test OK: " + result);
      } catch (e) {
        window.quantumEngine.addMessageToChat("system", "âŒ Test failed: " + e.message);
      }
    });
  }

  // ============ Save Button ============
  if (saveBtn) saveBtn.addEventListener("click", saveConfig);

  // ============ Override Send Message ============
  QuantumEngine.prototype.sendMessage = async function () {
    const input = document.getElementById("quantumChatInput");
    const msg = input.value.trim();
    if (!msg) return;

    const chatBox = document.getElementById("quantumChatMessages");
    this.addMessageToChat("user", msg);
    input.value = "";

    const cfg = loadConfig();
    if (!cfg.apiKey && cfg.provider !== "custom") {
      this.addMessageToChat("system", "âš ï¸ Please input your API key first.");
      return;
    }

    this.addMessageToChat("ai", "â³ Thinking...");

    try {
      let reply = "";
      const sysPrompt = document.getElementById("aiSystemPrompt")?.value || "You are STL-AI assistant.";
      const messages = [
        { role: "system", content: sysPrompt },
        { role: "user", content: msg }
      ];

      if (cfg.provider === "openai")
        reply = await callOpenAI(cfg.apiKey, cfg.model, messages);
      else if (cfg.provider === "anthropic")
        reply = await callClaude(cfg.apiKey, cfg.model, msg);
      else if (cfg.provider === "google")
        reply = await callGemini(cfg.apiKey, cfg.model, msg);
      else if (cfg.provider === "custom") {
        const url = prompt("Enter custom endpoint URL:");
        reply = await callCustom(url, cfg.apiKey, cfg.model, msg);
      } else reply = "Unknown provider selected.";

      this.addMessageToChat("ai", reply);
    } catch (err) {
      this.addMessageToChat("system", "âŒ API Error: " + err.message);
    }
  };

  // ============ Attach to Send Button ============
  if (sendBtn) {
    sendBtn.removeEventListener("click", window.quantumEngine?.sendMessage);
    sendBtn.addEventListener("click", () => window.quantumEngine.sendMessage());
  }

  // Auto-load config at start
  loadConfig();
});
</script>
<!-- ====== INJEKSI: Template Generator + Proxy Router (no-new-buttons) ====== -->
<script>
(function(){
  // safety: jangan jalankan dua kali
  if (window.__stl_template_injected) return;
  window.__stl_template_injected = true;

  // util kecil
  const $ = (id)=>document.getElementById(id);
  function nowISO(){ return new Date().toISOString(); }
  function saveLocal(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
  function loadLocal(key){ try{return JSON.parse(localStorage.getItem(key));}catch(e){return null;} }

  // Prioritas: jika provider === 'proxy' OR aiCustomUrl contains http => gunakan proxy
  function resolveCallRouting() {
    const provider = $('aiProvider')?.value || (loadLocal('quantum_ai_config')?.provider) || 'openai';
    const customUrl = $('aiCustomUrl')?.value || (loadLocal('quantum_ai_config')?.customUrl) || '';
    const useProxy = provider === 'proxy' || (customUrl && customUrl.startsWith('http'));
    return { provider, customUrl, useProxy };
  }

  // Jika ada handler callOpenAI/callAnthropic/callGemini dideklarasikan oleh injeksi sebelumnya, pakai.
  // Jika tidak ada, buat fallback ringan (OpenAI only minimal).
  async function callOpenAIClient(apiKey, model, messages) {
    if (typeof callOpenAI === 'function') return await callOpenAI(apiKey, model, messages);
    // fallback minimal - direct fetch
    const r = await fetch('https://api.openai.com/v1/chat/completions', {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'Authorization': 'Bearer ' + apiKey },
      body: JSON.stringify({ model, messages, temperature:0.7, max_tokens: 1200 })
    });
    const j = await r.json();
    if (!r.ok) throw new Error(j.error?.message || JSON.stringify(j));
    if (j.choices && j.choices[0]) return j.choices[0].message?.content || j.choices[0].text || JSON.stringify(j);
    return JSON.stringify(j).slice(0,2000);
  }

  async function callProxy(proxyUrl, appSecret, payload) {
    // payload = { provider, model, messages, prompt }
    const r = await fetch(proxyUrl, {
      method: 'POST',
      headers: {
        'Content-Type':'application/json',
        ...(appSecret && {'x-app-key': appSecret})
      },
      body: JSON.stringify(payload)
    });
    const j = await r.json();
    if (!r.ok) throw new Error(j.error || JSON.stringify(j));
    // try openai shape
    if (j.data) return j.data;
    if (j.choices && j.choices[0]) return j.choices[0].message?.content || j.choices[0].text;
    if (j.reply) return j.reply;
    return JSON.stringify(j);
  }

  // Prompt templates (simple, bisa kamu kustom)
  const promptTemplates = {
    rpp: (meta)=>`
Buatkan RPP (Rencana Pelaksanaan Pembelajaran) untuk:
- Kelas: ${meta.kelas || '6'}
- Mata Pelajaran: ${meta.mapel || 'IPA'}
- Tema/Subtema: ${meta.tema || 'Tata Surya'}
- Alokasi Waktu: ${meta.durasi || '2 JP'}
- Indikator: ${meta.indikator || 'menjelaskan anggota tata surya dan fungsi bumi'}
Format: Judul, Kompetensi Dasar, Indikator, Tujuan, Langkah Kegiatan (Pendahuluan, Inti, Penutup), Penilaian (rubrik singkat), Sumber & Media.
Berikan output dalam format HTML terstruktur (heading, ul/ol, table bila perlu).
`.trim(),

    prota: (meta)=>`
Buatkan PROTA (Program Tahunan) untuk:
- Kelas: ${meta.kelas || '6'}
- Mata Pelajaran: ${meta.mapel || 'IPA'}
- Tahun Pelajaran: ${meta.tahun || '2025/2026'}
Format: Tujuan tahunan, Kompetensi Inti per semester, Pemetaan KD per bulan. Output dalam HTML terstruktur.
`.trim(),

    promes: (meta)=>`
Buatkan PROMES (Program Semester) untuk:
- Kelas: ${meta.kelas || '6'}
- Mata Pelajaran: ${meta.mapel || 'IPA'}
- Semester: ${meta.semester || '1'}
Format: Ringkasan per minggu/bulan, alokasi waktu, indikator penilaian. Output HTML.
`.trim(),

    lkpd: (meta)=>`
Buatkan LKPD (Lembar Kerja Peserta Didik) praktis:
- Kelas: ${meta.kelas || '6'}
- Mapel: ${meta.mapel || 'IPA'}
- Topik: ${meta.topik || 'Tata Surya'}
- Tujuan Pembelajaran: ${meta.tujuan || 'Mengenal urutan planet'}
Buat soal interaktif (3 tugas) + petunjuk, rubrik penilaian singkat, dan bagian jawaban contoh. Output dalam HTML yang bisa langsung di-print.
`.trim()
  };

  // Parse inline meta dari string: "kelas:6;mapel:IPA;tema:Tata Surya"
  function parseMetaInline(s) {
    const meta = {};
    (s||'').split(';').forEach(part=>{
      const [k,v] = part.split(':').map(p=>p && p.trim());
      if (k && v) meta[k.toLowerCase()] = v;
    });
    return meta;
  }

  // Create a hidden container for generated HTML so we can render via html2canvas/jspdf
  function ensureGenContainer() {
    let c = document.getElementById('stl_gen_container');
    if (!c) {
      c = document.createElement('div');
      c.id = 'stl_gen_container';
      c.style.position = 'fixed';
      c.style.left = '-9999px';
      c.style.top = '0';
      c.style.width = '1200px';
      c.style.padding = '24px';
      c.style.background = '#fff';
      c.style.color = '#111';
      document.body.appendChild(c);
    }
    return c;
  }

  // Convert HTML -> PDF/JPG/PNG using html2canvas + jsPDF + FileSaver
  async function exportHtmlAsFiles(htmlContent, baseFileName) {
    const container = ensureGenContainer();
    container.innerHTML = htmlContent;

    // small styling to improve print look
    container.style.fontFamily = 'Inter, Arial, sans-serif';
    container.style.boxSizing = 'border-box';

    // Wait a tick for rendering
    await new Promise(r=>setTimeout(r, 250));

    // create PDF via jsPDF/html2canvas
    try {
      const canvas = await html2canvas(container, { scale: 2, useCORS: true, windowWidth: container.scrollWidth });
      const imgData = canvas.toDataURL('image/png');

      // Save PNG
      const blob = await (await fetch(imgData)).blob();
      saveAs(blob, baseFileName + '.png');

      // Save JPG (convert)
      const jpgCanvas = document.createElement('canvas');
      jpgCanvas.width = canvas.width;
      jpgCanvas.height = canvas.height;
      const ctx = jpgCanvas.getContext('2d');
      ctx.drawImage(canvas, 0, 0);
      const jpgData = jpgCanvas.toDataURL('image/jpeg', 0.9);
      const jpgBlob = await (await fetch(jpgData)).blob();
      saveAs(jpgBlob, baseFileName + '.jpg');

      // Save PDF (portrait A4 scaled)
      const pdf = new jsPDF('p', 'pt', 'a4');
      // calculate scale to fit width
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const imgProps = { width: canvas.width, height: canvas.height };
      const ratio = Math.min(pageWidth / imgProps.width, pageHeight / imgProps.height);
      const imgW = imgProps.width * ratio;
      const imgH = imgProps.height * ratio;
      pdf.addImage(imgData, 'PNG', (pageWidth - imgW)/2, 20, imgW, imgH);
      const pdfBlob = pdf.output('blob');
      saveAs(pdfBlob, baseFileName + '.pdf');

      return { ok:true };
    } catch (e) {
      console.error('export error', e);
      return { ok:false, error: e.message };
    }
  }

  // Save template to proxy (if available)
  async function saveTemplateToServer(proxyUrl, appSecret, templateDoc) {
    try {
      const r = await fetch(proxyUrl.replace(/\/api\/?$/, '') + '/api/templates', {
        method: 'POST',
        headers: { 'Content-Type':'application/json', ...(appSecret && {'x-app-key': appSecret}) },
        body: JSON.stringify(templateDoc)
      });
      const j = await r.json();
      if (!r.ok) throw new Error(j.error || JSON.stringify(j));
      return { ok:true, id: j.id || j.insertedId || j.result || null };
    } catch (e) {
      return { ok:false, error: e.message };
    }
  }

  // Core: Generate template by type
  async function generateTemplate(type, inlineMetaStr) {
    const meta = parseMetaInline(inlineMetaStr);
    const tplPrompt = promptTemplates[type];
    if (!tplPrompt) {
      window.quantumEngine.addMessageToChat('system', `âŒ Unknown template type: ${type}`);
      return;
    }

    // build prompt
    const prompt = tplPrompt(meta);
    const { provider, customUrl, useProxy } = resolveCallRouting();
    const model = $('aiModel')?.value || (loadLocal('quantum_ai_config')?.model) || 'gpt-4';
    const apiKey = $('aiApiKey')?.value || (loadLocal('quantum_ai_config')?.apiKey) || '';
    const appSecret = localStorage.getItem('stl_app_secret') || '';

    window.quantumEngine.addMessageToChat('system', `ðŸ”§ Generating ${type.toUpperCase()}...`);

    try {
      let aiReply = '';

      if (useProxy && customUrl) {
        // hit proxy route
        const proxyPayload = { provider: (provider==='custom'?'openai':provider), model, prompt, messages: [{role:'user', content: prompt}] };
        const proxyResult = await callProxy(customUrl, appSecret, proxyPayload);
        // proxy might return openai-like object or plain text
        if (proxyResult.choices && proxyResult.choices[0]) aiReply = proxyResult.choices[0].message?.content || proxyResult.choices[0].text;
        else if (proxyResult.data && proxyResult.data.choices && proxyResult.data.choices[0]) aiReply = proxyResult.data.choices[0].message?.content || proxyResult.data.choices[0].text;
        else if (typeof proxyResult === 'string') aiReply = proxyResult;
        else aiReply = JSON.stringify(proxyResult);
      } else {
        // direct client calls
        if (provider === 'openai' || !provider) {
          aiReply = await callOpenAIClient(apiKey, model, [{role:'user', content: prompt}]);
          if (aiReply && aiReply.data && aiReply.data.choices && aiReply.data.choices[0]) {
            aiReply = aiReply.data.choices[0].message?.content || aiReply.data.choices[0].text;
          }
        } else if (provider === 'anthropic' && typeof callAnthropic === 'function') {
          aiReply = await callAnthropic(apiKey, model, prompt);
        } else if (provider === 'google' && typeof callGemini === 'function') {
          aiReply = await callGemini(apiKey, model, prompt);
        } else if (provider === 'custom' && customUrl) {
          aiReply = await callProxy(customUrl, appSecret, { provider:'custom', model, prompt, messages:[{role:'user', content:prompt}] });
        } else {
          throw new Error('No valid route to AI provider. Set aiCustomUrl to your proxy or choose OpenAI and set key.');
        }
      }

      // if object with content -> extract
      if (typeof aiReply !== 'string') {
        try { aiReply = JSON.stringify(aiReply); } catch(e){}
      }

      // Save locally and show in chat as HTML preview link
      const docId = 'stl_tpl_' + type + '_' + Date.now();
      const doc = { id: docId, type, meta, content: aiReply, generatedAt: nowISO() };
      // save to local storage collection
      const col = loadLocal('stl_templates') || [];
      col.unshift(doc);
      saveLocal('stl_templates', col);

      // create small preview HTML for user to print or download
      const previewHtml = `
        <div style="font-family:Inter,Arial,sans-serif;color:#111;padding:24px;">
          <h1 style="text-align:center;">${type.toUpperCase()} - ${meta.mapel||''} ${meta.kelas?('Kelas '+meta.kelas):''}</h1>
          <hr/>
          <div>${aiReply}</div>
          <hr/>
          <small>Generated: ${doc.generatedAt}</small>
        </div>`;

      // add message with clickable preview (no new UI)
      const previewAnchor = document.createElement('a');
      previewAnchor.href = '#';
      previewAnchor.textContent = `ðŸ“„ ${type.toUpperCase()} generated â€” klik untuk open & download`;
      previewAnchor.onclick = async (e) => {
        e.preventDefault();
        // open preview in new window tab as full HTML so user bisa melihat, print, dan simpan
        const w = window.open('', '_blank');
        if (!w) { window.quantumEngine.addMessageToChat('system','âŒ Popup blocked. Izinkan popup untuk melihat hasil.'); return; }
        w.document.write(previewHtml);
        w.document.close();
      };

      // push a system message with the anchor
      window.quantumEngine.addMessageToChat('system', `âœ… ${type.toUpperCase()} siap. Lihat di tab baru.`);

      // optionally auto-save to server templates if proxy present and user consents
      if (useProxy && customUrl) {
        const saveRes = await saveTemplateToServer(customUrl, appSecret, {
          type, meta, content: aiReply, createdAt: doc.generatedAt
        });
        if (saveRes.ok) {
          window.quantumEngine.addMessageToChat('system', `â˜ï¸ Template tersimpan di server (id: ${saveRes.id || 'â€”'})`);
        } else {
          window.quantumEngine.addMessageToChat('system', `âš ï¸ Gagal simpan ke server: ${saveRes.error}`);
        }
      }

      // Auto-export: convert to pdf/png/jpg and save (non-blocking)
      exportHtmlAsFiles(previewHtml, `${type.toUpperCase()}_${meta.mapel||'mapel'}_${(meta.kelas||'kelas')}_${Date.now()}`)
        .then(r => {
          if (r.ok) window.quantumEngine.addMessageToChat('system','ðŸ’¾ File didownload: PDF/PNG/JPG.');
          else window.quantumEngine.addMessageToChat('system','âš ï¸ Gagal generate files: '+(r.error||'unknown'));
        });

    } catch (err) {
      console.error('gen err', err);
      window.quantumEngine.addMessageToChat('system', 'âŒ Generate failed: ' + (err.message || err));
    }
  }

  // Parse chat input for commands. No UI changes required.
  // Commands:
  //  /gen rpp;kelas:6;mapel:IPA;tema:Tata Surya
  //  /gen prota;kelas:6;mapel:Matematika
  //  /gen promes;kelas:6;mapel:IPA
  //  /gen lkpd;kelas:6;mapel:IPA;topik:Tata Surya
  // Also supports shorthand: /gen rpp
  function handleChatCommand(raw) {
    const trimmed = raw.trim();
    if (!trimmed.startsWith('/gen ')) return false;
    const body = trimmed.slice(5).trim(); // "rpp;kelas:6..."
    let [typePart, ...rest] = body.split(';');
    const type = (typePart || '').trim().toLowerCase();
    const inlineMeta = rest.join(';');
    if (!type) {
      window.quantumEngine.addMessageToChat('system', 'âŒ Format: /gen <type>;key:val;key2:val2');
      return true;
    }
    // launch generation async
    generateTemplate(type, inlineMeta);
    return true;
  }

  // Monkey-patch QuantumEngine.sendMessage to intercept commands first (but do not remove original ability)
  const originalSend = QuantumEngine.prototype.sendMessage;
  QuantumEngine.prototype.sendMessage = async function() {
    const input = $('quantumChatInput');
    if (!input) return;
    const text = input.value.trim();
    if (!text) return;
    // If command detected, handle & prevent normal send
    try {
      const handled = handleChatCommand(text);
      if (handled) {
        // clear input and return (we handled generation)
        input.value = '';
        return;
      }
    } catch (e) {
      console.error('command parse err', e);
    }
    // if not a /gen command, fallback to original behavior (which likely calls AI)
    // if originalSend is async, await it
    try {
      const res = originalSend.apply(this, arguments);
      if (res && typeof res.then === 'function') await res;
    } catch (e) {
      console.error('original send err', e);
    }
  };

  // Helper: add instruction message once
  window.quantumEngine?.addMessageToChat('system', 'â„¹ï¸ Tip: ketik "/gen rpp;kelas:6;mapel:IPA;tema:Tata Surya" di kotak chat untuk generate RPP otomatis. Hasil akan disimpan lokal dan diunduh PDF/JPG/PNG.');
  // If quantumEngine not ready yet, wait a bit
  if (!window.quantumEngine) {
    document.addEventListener('DOMContentLoaded', ()=> {
      setTimeout(()=> {
        window.quantumEngine?.addMessageToChat('system', 'â„¹ï¸ Tip: ketik "/gen rpp;kelas:6;mapel:IPA" di chat untuk generate template RPP langsung.');
      }, 700);
    });
  }

})();
</script>
<!-- ====== END INJEKSI TEMPLATE GENERATOR ====== -->
<!-- ==================== INJECTION: RPP/PROMES/LKPD TOOLKIT ==================== -->
<script>
(function () {
  // Avoid double-injection
  if (window.__quantum_rpp_injected) return;
  window.__quantum_rpp_injected = true;

  /* -------------------------
     Helpers & Config
  --------------------------*/
  const $ = (id) => document.getElementById(id);
  const templates = {
    rpp: `Buatkan RPP Kurikulum Merdeka dengan format profesional untuk guru SD:

Kelas       : {kelas}
Semester    : {semester}
Mata Pelajaran : {mapel}
Topik/Materi: {topik}
Alokasi Waktu : {waktu}
Fase Capaian  : {fase}
Model Pembelajaran: {model}
Metode      : {metode}

Wajib mencakup:
- Capaian Pembelajaran
- Tujuan Pembelajaran (kompetensi spesifik terkait)
- Kegiatan Pembelajaran (Pembuka, Inti, Penutup)
- Asesmen (diagnostik, formatif, sumatif)
- Media & Sumber Belajar
- Refleksi Guru dan Siswa
- Diferensiasi (konten, proses, produk)
- Profil Pelajar Pancasila (minimal 3 elemen)
Susun dalam format rapi siap cetak A4.`,

    promes: `Buatkan Program Semester (PROMES) Kurikulum Merdeka:

Kelas    : {kelas}
Semester : {semester}
Mapel    : {mapel}

Harus berisi tabel:
- Alur Tujuan Pembelajaran (ATP)
- Materi Pokok
- Alokasi Minggu/Bulan
- Jumlah JP
- Bentuk Asesmen
- Keterangan Projek/Profil Pancasila jika ada`,

    lkpd: `Buatkan LKPD berbasis Inkuiri untuk SD:

Kelas    : {kelas}
Mapel    : {mapel}
Topik    : {topik}

Susunan:
1. Tujuan pembelajaran
2. Stimulus masalah (kata pengantar)
3. Prediksi/hipotesis
4. Langkah inkuiri (instruksi)
5. Pengumpulan data (tabel/lembar kerja)
6. Analisis sederhana
7. Kesimpulan
8. Refleksi siswa
9. Rubrik penilaian

Gunakan bahasa ramah anak, sisipkan instruksi dan tabel kerja.`,

    prota: `Buatkan Program Tahunan (PROTA) Kurikulum Merdeka:

Kelas: {kelas}
Mapel: {mapel}

Harus berisi:
- Distribusi KD/CP tiap semester
- Alokasi JP per topik
- Indikator utama per tema`,

    atp: `Buatkan Alur Tujuan Pembelajaran (ATP) untuk:

Kelas: {kelas}
Mapel: {mapel}
Topik: {topik}

Format tabel: KD / Indikator / Kegiatan Pembelajaran / Asesmen / Alat & Sumber`
  };

  // Utility to create element with classes
  function el(tag, opts = {}) {
    const e = document.createElement(tag);
    if (opts.class) e.className = opts.class;
    if (opts.html) e.innerHTML = opts.html;
    if (opts.text) e.textContent = opts.text;
    return e;
  }

  /* -------------------------
     Prompt parsing / matcher
  --------------------------*/
  function detectIntent(text) {
    const t = text.toLowerCase();
    // check keywords
    if (t.includes('rpp') || /buatkan rpp|rpp kelas/.test(t)) return 'rpp';
    if (t.includes('promes') || t.includes('program semester')) return 'promes';
    if (t.includes('lkpd')) return 'lkpd';
    if (t.includes('prota') || t.includes('program tahunan')) return 'prota';
    if (t.includes('atp') || t.includes('alur tujuan pembelajaran')) return 'atp';
    if (t.includes('full paket') || (t.includes('full') && t.includes('paket'))) return 'full';
    return null;
  }

  function extractSimpleParams(text) {
    // Try to get kelas, mapel, topik, waktu, semester using simple heuristics
    const out = { kelas: '', mapel: '', topik: '', waktu: '2 JP', semester: '1', model: 'Inkuiri', metode: 'Diskusi & Eksperimen', fase: 'Awal' };
    // kelas like "kelas 3" or "kelas 2"
    const kelasMatch = text.match(/kelas\s*([1-6])/i);
    if (kelasMatch) out.kelas = 'Kelas ' + kelasMatch[1];
    const semesterMatch = text.match(/semester\s*(1|2)/i);
    if (semesterMatch) out.semester = semesterMatch[1];
    const mapelMatch = text.match(/(mata pelajaran|mapel|matematika|ipa|ips|bahasa indonesia|pkn|sbdp)\s*[:\-]?\s*([a-z0-9\s]+)/i);
    // more general: look for "mata pelajaran X" or "mapel X"
    if (mapelMatch) out.mapel = mapelMatch[2].trim();
    // topik heuristic: after kata "tentang" or "topik"
    const topikMatch = text.match(/(?:tentang|topik|mengenai)\s+([a-z0-9\s\,\-\:]+)/i);
    if (topikMatch) out.topik = topikMatch[1].trim();
    // if none found, try first few words as topik
    if (!out.topik) {
      const fallback = text.split(' ').slice(0, 6).join(' ');
      out.topik = fallback;
    }
    return out;
  }

  function buildPrompt(intent, params, rawText) {
    if (intent === 'full') {
      // Full package: combine templates
      const r = [];
      r.push(templates.rpp.replace(/\{kelas\}/g, params.kelas || '{kelas}').replace(/\{mapel\}/g, params.mapel || '{mapel}').replace(/\{topik\}/g, params.topik || '{topik}'));
      r.push('\n\n---\n\n');
      r.push(templates.promes.replace(/\{kelas\}/g, params.kelas || '{kelas}').replace(/\{mapel\}/g, params.mapel || '{mapel}'));
      r.push('\n\n---\n\n');
      r.push(templates.lkpd.replace(/\{kelas\}/g, params.kelas || '{kelas}').replace(/\{mapel\}/g, params.mapel).replace(/\{topik\}/g, params.topik || '{topik}'));
      r.push('\n\n---\n\n');
      r.push(templates.prota.replace(/\{kelas\}/g, params.kelas || '{kelas}').replace(/\{mapel\}/g, params.mapel || '{mapel}'));
      r.push('\n\n---\n\n');
      r.push(templates.atp.replace(/\{kelas\}/g, params.kelas || '{kelas}').replace(/\{mapel\}/g, params.mapel || '{mapel}').replace(/\{topik\}/g, params.topik || '{topik}'));
      return r.join('');
    }
    const tpl = templates[intent] || templates.rpp;
    // simple replace placeholders
    return tpl.replace(/\{kelas\}/g, params.kelas || '{kelas}')
              .replace(/\{mapel\}/g, params.mapel || '{mapel}')
              .replace(/\{topik\}/g, params.topik || '{topik}')
              .replace(/\{waktu\}/g, params.waktu || '2 JP')
              .replace(/\{semester\}/g, params.semester || '1')
              .replace(/\{model\}/g, params.model || 'Inkuiri')
              .replace(/\{metode\}/g, params.metode || 'Eksperimen')
              .replace(/\{fase\}/g, params.fase || 'Awal');
  }

  /* -------------------------
     AI Caller (minimal OpenAI Chat Completion)
     Uses provider + apiKey from UI (if present)
  --------------------------*/
  async function callAI(prompt, opts = {}) {
    const provider = ( $('aiProvider') && $('aiProvider').value ) || 'openai';
    const apiKey = ( $('aiApiKey') && $('aiApiKey').value ) || '';
    const model = ($('aiModel') && $('aiModel').value) || 'gpt-4';

    // Basic safety: require API key for network call
    if (!apiKey) {
      return { error: 'API key tidak ditemukan. Masukkan API key di Tools â†’ AI Model Configuration.' };
    }

    try {
      if (provider === 'openai') {
        const body = {
          model: model,
          messages: [{ role: 'system', content: ( $('aiSystemPrompt') ? $('aiSystemPrompt').value : 'You are a helpful assistant.' ) },
                     { role: 'user', content: prompt }],
          temperature: parseFloat(($('aiTemperature') && $('aiTemperature').value) || 0.7),
          max_tokens: parseInt(($('aiMaxTokens') && $('aiMaxTokens').value) || 2000, 10)
        };

        const res = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + apiKey
          },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          const text = await res.text();
          return { error: `OpenAI error: ${res.status} ${text}` };
        }
        const data = await res.json();
        // pick text
        const reply = (data?.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) || JSON.stringify(data);
        return { text: reply };
      } else if (provider === 'custom') {
        // custom endpoint field expected in aiCustomUrl input (add check)
        const urlEl = document.getElementById('aiCustomUrl');
        const url = urlEl ? urlEl.value : '';
        if (!url) return { error: 'Custom provider selected but tidak ada URL custom.' };
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey },
          body: JSON.stringify({ prompt, model, temperature: $('aiTemperature') ? $('aiTemperature').value : 0.7 })
        });
        if (!res.ok) return { error: 'Custom API error: ' + res.status };
        const json = await res.json();
        return { text: json.text || json.result || JSON.stringify(json) };
      } else {
        // other providers not implemented â€” fallback message
        return { error: 'Provider belum didukung via injeksi ini. Pilih OpenAI atau Custom.' };
      }
    } catch (err) {
      return { error: 'Network/Fetch error: ' + err.message };
    }
  }

  /* -------------------------
     UI: Preview Modal (A4)
  --------------------------*/
  function createPreviewModal(htmlContent, title = 'Preview Dokumen') {
    // remove existing preview if present
    const exist = $('quantumPreviewModal');
    if (exist) exist.remove();

    const overlay = el('div', { class: 'quantum-sidebar-overlay active' });
    overlay.id = 'quantumPreviewOverlay';
    overlay.style.zIndex = 11000;

    const modal = el('div', { class: 'quantum-card glass p-6' });
    modal.id = 'quantumPreviewModal';
    modal.style.position = 'fixed';
    modal.style.left = '50%';
    modal.style.top = '50%';
    modal.style.transform = 'translate(-50%, -50%)';
    modal.style.width = '80vw';
    modal.style.maxWidth = '900px';
    modal.style.maxHeight = '90vh';
    modal.style.overflow = 'auto';
    modal.style.zIndex = 11001;
    modal.style.borderRadius = '12px';

    const header = el('div', { class: 'flex justify-between items-center mb-4' });
    header.innerHTML = `<h3 style="font-weight:800">${title}</h3>`;
    const closeBtn = el('button', { class: 'quantum-btn danger' });
    closeBtn.style.padding = '6px 10px';
    closeBtn.innerHTML = '<i class="fas fa-times"></i> ';
    closeBtn.addEventListener('click', () => {
      modal.remove();
      overlay.remove();
    });
    header.appendChild(closeBtn);

    const contentWrap = el('div', { class: 'prose', html: htmlContent });
    contentWrap.style.background = 'white';
    contentWrap.style.padding = '20px';
    contentWrap.style.color = '#111';
    contentWrap.style.borderRadius = '6px';
    contentWrap.style.boxShadow = '0 4px 20px rgba(0,0,0,0.08)';

    const actions = el('div', { class: 'flex gap-3 mt-4' });
    const btnPdf = el('button', { class: 'quantum-btn primary' }); btnPdf.textContent = 'Download PDF';
    const btnDoc = el('button', { class: 'quantum-btn secondary' }); btnDoc.textContent = 'Download DOC';
    btnPdf.addEventListener('click', () => printHtmlToPdf(contentWrap, title.replace(/\s+/g,'_')));
    btnDoc.addEventListener('click', () => downloadDocFromHtml(contentWrap.innerHTML, title.replace(/\s+/g,'_')));
    actions.appendChild(btnPdf); actions.appendChild(btnDoc);

    modal.appendChild(header);
    modal.appendChild(contentWrap);
    modal.appendChild(actions);

    document.body.appendChild(overlay);
    document.body.appendChild(modal);
  }

  /* -------------------------
     PDF & DOC generation
  --------------------------*/
  async function printHtmlToPdf(element, filename = 'document') {
    try {
      // Using html2canvas + jsPDF
      const rect = element.getBoundingClientRect();
      const scale = 2;
      const canvas = await html2canvas(element, { scale: scale, useCORS: true, scrollY: -window.scrollY });
      const imgData = canvas.toDataURL('image/png');

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      // calculate image dimensions
      const imgProps = { width: canvas.width / scale, height: canvas.height / scale };
      const ratio = Math.min(pageWidth / imgProps.width * 25.4, pageHeight / imgProps.height * 25.4);
      const w = imgProps.width * (25.4 / 96) * ratio / (imgProps.width * (25.4 / 96) / pageWidth);
      // simpler: use fit to width
      pdf.addImage(imgData, 'PNG', 8, 8, pageWidth - 16, (canvas.height * (pageWidth - 16)) / canvas.width);
      pdf.save(`${filename}.pdf`);
    } catch (err) {
      alert('Gagal membuat PDF: ' + err.message);
    }
  }

  function downloadDocFromHtml(html, filename = 'document') {
    // Create a simple .doc file (MS Word can open)
    const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' " +
      "xmlns:w='urn:schemas-microsoft-com:office:word' " +
      "xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>" + filename + "</title></head><body>";
    const footer = "
<!-- NAJIB OPTIMIZER PATCH v1.0 (Fonts + Particle Optimizer + Cinematic Modes + Child-suite soft-mode) -->
<script id="najib-optimizer-patch">
(function(){
'use strict';
/*** UTIL: capability detection ***/
function detectCapsSafe(){
try{
if(window.__NAJIB_CAPS) return window.__NAJIB_CAPS;
const caps = { cores: navigator.hardwareConcurrency||2, mem: navigator.deviceMemory||2, dpr: window.devicePixelRatio||1, webgl:false, webgl2:false };
try{
const c=document.createElement('canvas');
const g2 = c.getContext && c.getContext('webgl2');
const g = g2 || (c.getContext && (c.getContext('webgl')||c.getContext('experimental-webgl')));
if(g){ caps.webgl = !!g; caps.webgl2 = !!g2; }
}catch(e){}
let score=0;
if(caps.cores>=8) score+=30; else if(caps.cores>=4) score+=18; else score+=8;
if(caps.mem>=8) score+=30; else if(caps.mem>=4) score+=18; else score+=6;
if(caps.webgl2) score+=30; else if(caps.webgl) score+=16;
caps.score = score;
if(caps.cores<=2 || caps.mem<=1 || caps.score<24) caps.profile='low';
else if((caps.cores<=4 && caps.mem<=3) || caps.score<48) caps.profile='mid';
else caps.profile='high';
window.__NAJIB_CAPS = caps;
return caps;
}catch(e){
return { profile:'low', cores:2, mem:1, dpr:1 };
}
}
const CAPS = detectCapsSafe();

/***** 1) FONT LAZY LOADER *****/
(function lazyFonts(){
try{
const heavyLinks = Array.from(document.querySelectorAll('link[href*="fonts.googleapis.com"], link[href*="fonts.gstatic.com"]'));
if(!heavyLinks.length) return;
if(CAPS.profile === 'low' || window.matchMedia('(prefers-reduced-data: reduce)').matches){
heavyLinks.forEach(l => { l.media='print'; l.setAttribute('data-deferred','1'); });
return;
}
function loadHeavyFonts(){
heavyLinks.forEach(l=>{
if(l.getAttribute('data-deferred')) return;
l.rel = 'stylesheet';
l.removeAttribute('media');
l.setAttribute('data-loaded-by','najib-optimizer');
});
}
if('requestIdleCallback' in window){
requestIdleCallback(loadHeavyFonts, {timeout:3000});
} else {
const onFirst = function(){ loadHeavyFonts(); window.removeEventListener('pointerdown', onFirst); window.removeEventListener('touchstart', onFirst); };
window.addEventListener('pointerdown', onFirst, {once:true});
window.addEventListener('touchstart', onFirst, {once:true});
setTimeout(loadHeavyFonts, 6000);
}
}catch(e){ console.warn('[najib-optimizer] lazyFonts failed', e); }
})();

/***** 2) PARTICLE SMART OPTIMIZER *****/
(function particleOptimizer(){
try{
const container = document.getElementById('quantumParticles') || document.querySelector('.quantum-particles');
if(!container) return;
function makeParticle(cls, x, y, size, content){
const el = document.createElement('div');
el.className = 'particle ' + cls;
el.style.left = (x*100).toFixed(2) + 'vw';
el.style.top = (y*100).toFixed(2) + 'vh';
el.style.width = size + 'px';
el.style.height = size + 'px';
if(content) { el.textContent = content; el.classList.add('particle-codeRain'); el.style.fontSize = Math.max(10, size) + 'px'; el.style.width = 'auto'; el.style.height = 'auto'; }
return el;
}
const baseCounts = {
goldenFloat: 28, blackPulse: 20, redSword: 22, shapeShifter: 20,
codeRain: 36, oceanWave: 26, neonPulse: 24, roseFloat: 24
};
const scaleMap = { high:1, mid:0.45, low:0.08 };
const profile = CAPS.profile || 'low';
const scale = scaleMap[profile] || 0.45;
const reduceEffects = (profile === 'low' || window.matchMedia('(prefers-reduced-motion: reduce)').matches);

window.renderParticlesForTheme = function(themeKey){
try{
const t = themeKey || 'goldenFloat';
const mapName = {
goldenFloat:'goldenFloat', blackPulse:'blackPulse', redSword:'redSword',
shapeShifter:'shapeShifter', codeRain:'codeRain', oceanWave:'oceanWave',
neonPulse:'neonPulse', roseFloat:'roseFloat'
}[t] || 'goldenFloat';
const base = baseCounts[mapName] || 18;
const count = Math.max( Math.round(base*scale), (reduceEffects ? 0 : 2) );
container.innerHTML = '';
if(count === 0){
const accent = document.createElement('div');
accent.className = 'particle particle-neonPulse';
accent.style.left = '50%';
accent.style.top = '80%';
accent.style.width = '4px';
accent.style.height = '4px';
accent.style.opacity = '0.6';
accent.style.pointerEvents = 'none';
container.appendChild(accent);
return;
}
const fragment = document.createDocumentFragment();
for(let i=0;i<count;i++){
const x = Math.random(); const y = Math.random();
const size = (mapName==='codeRain' ? Math.max(10, Math.round(Math.random()*14+6)) : Math.round(Math.random()*(reduceEffects?4:8) + (reduceEffects?2:2)));
const p = makeParticle('particle-'+mapName, x, y, size, mapName==='codeRain'? (Math.random()>0.7?String.fromCharCode(0x30A0 + Math.floor(Math.random()*96)) : '') : '');
if(reduceEffects){
p.style.boxShadow = 'none';
p.style.filter = 'none';
p.style.animationDuration = '8s';
}
fragment.appendChild(p);
}
container.appendChild(fragment);
}catch(e){ console.warn('[najib-optimizer] renderParticlesForTheme fail', e); }
};

try{
const saved = (JSON.parse(localStorage.getItem('najib_saved_themes')||'[]') || [])[0];
const initialTheme = saved ? (saved.variables && saved.variables.particleTheme) : 'goldenFloat';
setTimeout(()=>{ try{ window.renderParticlesForTheme(initialTheme); }catch(e){} }, 300);
}catch(e){}

window.__najib_particle_optimizer = { profile: CAPS.profile, reducedEffects: reduceEffects };

}catch(e){ console.warn('[najib-optimizer] particleOptimizer top fail', e); }
})();

/***** 3) CINEMATIC MODULAR MODE *****/
(function cinematicModular(){
try{
const ROOT = document.getElementById('stl-open');
if(!ROOT) return;
const mode = CAPS.profile || 'low';
ROOT.setAttribute('data-cinematic-mode', mode);

function applyMode(){
if(mode === 'low'){
const chrom = document.querySelector('.stl-chromatic');
if(chrom) chrom.style.display = 'none';
const scan = document.getElementById('stl-scan');
if(scan) { scan.style.animationDuration = '12s'; scan.style.opacity='0.12'; }
const TITLE = document.getElementById('stl-title');
const TAG = document.getElementById('stl-tag');
if(TITLE) TITLE.style.transition='opacity .6s ease';
if(TAG) TAG.style.transition='opacity .6s ease';
setTimeout(()=>{ try{ ROOT.style.opacity='0'; setTimeout(()=>{ try{ ROOT.remove(); }catch(e){ ROOT.style.display='none'; } }, 550); }catch(e){} }, 900);
}
else if(mode === 'mid'){
const scan = document.getElementById('stl-scan'); if(scan) scan.style.opacity='0.22';
const fract = document.querySelector('.stl-fractal'); if(fract) fract.style.opacity='0.7';
setTimeout(()=>{ try{ ROOT.style.opacity='0'; setTimeout(()=>{ try{ ROOT.remove(); }catch(e){ ROOT.style.display='none'; } }, 900); }catch(e){} }, 4000);
}
}
applyMode();
window.__najib_cinematic_force = function(lvl){
try{ if(!lvl) return; ROOT.setAttribute('data-cinematic-mode', lvl); location.reload(); }catch(e){}
};
}catch(e){ console.warn('[najib-optimizer] cinematicModular fail', e); }
})();

/***** 4) CHILD-SUITE SOFT MODE *****/
(function softenChildSuite(){
try{
(function installSoftObserver(){
let throttleAt = 0;
let backoffMs = 1000;
const whitelist = ['#stl-open','#quantumParticles','#quantumIsland','.quantum-sidebar','.quantum-tools-sidebar'];
const safeCheck = (node)=>{
try{
if(!node || node.nodeType !== 1) return true;
for(const s of whitelist){
try{ if(node.matches && node.matches(s) || (node.closest && node.closest(s))) return true; }catch(e){}
}
const tag = (node.tagName||'').toLowerCase();
if(['div','span','script','style','link','meta','img','svg'].indexOf(tag) !== -1) return true;
return false;
}catch(e){ return true; }
};
const mo = new MutationObserver((mutations)=>{
const now = Date.now();
if(now - throttleAt < backoffMs) return;
throttleAt = now;
let flagged = false;
for(const m of mutations){
for(const n of (m.addedNodes||[])){
if(!safeCheck(n)) flagged = true;
}
}
if(flagged){
console.info('[najib-softObserver] suspicious DOM additions detected');
setTimeout(()=>{ try{ if(window.DEV_mg && typeof window.DEV_mg.auditProtections === 'function') window.DEV_mg.auditProtections({soft:true}); }catch(e){} }, 1200);
backoffMs = Math.min(60000, Math.max(2000, backoffMs * 1.5));
} else {
backoffMs = Math.max(1000, Math.floor(backoffMs*0.9));
}
});
try{
mo.observe(document.documentElement || document.body, { childList:true, subtree:true });
window.__najib_soft_mo = mo;
}catch(e){}
})();
}catch(e){ console.warn('[najib-optimizer] softenChildSuite fail', e); }
})();

/***** 5) REPORT SUMMARY *****/
try{
console.info('[najib-optimizer] applied. profile=%s', CAPS.profile);
}catch(e){}
})();
</script>
<!-- END NAJIB OPTIMIZER PATCH -->
</body>
</html>";
    const sourceHTML = header + html + footer;
    const blob = new Blob(['\ufeff', sourceHTML], { type: 'application/msword' });
    // Use FileSaver.js if available
    if (window.saveAs) {
      saveAs(blob, `${filename}.doc`);
    } else {
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${filename}.doc`;
      document.body.appendChild(link);
      link.click();
      link.remove();
    }
  }

  /* -------------------------
     QR Code generator (Google Chart API)
  --------------------------*/
  function generateQrImageUrl(text, size = 200) {
    const encoded = encodeURIComponent(text);
    return `https://chart.googleapis.com/chart?cht=qr&chs=${size}x${size}&chl=${encoded}&chld=L|1`;
  }

  /* -------------------------
     Append AI Response to Chat + Inline Actions
  --------------------------*/
  function appendAiResponseToChat(contentHtml, rawTextForQr = '', filenameBase = 'RPP_Document') {
    const messagesContainer = $('quantumChatMessages');
    if (!messagesContainer) return;

    const msgWrap = el('div', { class: 'quantum-message ai' });
    // content can be HTML
    const inner = el('div');
    inner.innerHTML = contentHtml;
    msgWrap.appendChild(inner);

    // action buttons container (inline) â€” not global UI
    const actions = el('div', { class: 'mt-3 flex gap-2' });

    const previewBtn = el('button', { class: 'quantum-btn primary' });
    previewBtn.style.padding = '6px 10px';
    previewBtn.innerHTML = '<i class="fas fa-eye"></i> Preview';
    previewBtn.addEventListener('click', () => createPreviewModal(contentHtml, filenameBase));

    const pdfBtn = el('button', { class: 'quantum-btn secondary' });
    pdfBtn.style.padding = '6px 10px';
    pdfBtn.innerHTML = '<i class="fas fa-file-pdf"></i> PDF';
    pdfBtn.addEventListener('click', async () => {
      // create temporary element for rendering hidden
      const tmp = el('div'); tmp.style.padding = '20px'; tmp.style.background='white'; tmp.innerHTML = contentHtml;
      tmp.style.position = 'fixed'; tmp.style.left='-9999px'; document.body.appendChild(tmp);
      await printHtmlToPdf(tmp, filenameBase);
      tmp.remove();
    });

    const docBtn = el('button', { class: 'quantum-btn success' });
    docBtn.style.padding = '6px 10px';
    docBtn.innerHTML = '<i class="fas fa-file-word"></i> DOC';
    docBtn.addEventListener('click', () => downloadDocFromHtml(contentHtml, filenameBase));

    const qrBtn = el('button', { class: 'quantum-btn warning' });
    qrBtn.style.padding = '6px 10px';
    qrBtn.innerHTML = '<i class="fas fa-qrcode"></i> QR';
    qrBtn.addEventListener('click', () => {
      const url = generateQrImageUrl(rawTextForQr || contentHtml);
      // show small modal with QR
      const qrHtml = `<div style="text-align:center"><h4>QR untuk dokumen</h4><img src="${url}" style="max-width:220px"/><p style="font-size:12px;margin-top:8px">Scan untuk membuka/menyimpan</p></div>`;
      createPreviewModal(qrHtml, 'QR Kode');
    });

    actions.appendChild(previewBtn);
    actions.appendChild(pdfBtn);
    actions.appendChild(docBtn);
    actions.appendChild(qrBtn);

    msgWrap.appendChild(actions);
    messagesContainer.appendChild(msgWrap);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  /* -------------------------
     Integration: Hook send button & Enter
  --------------------------*/
  async function processInputAndMaybeCallAI(rawText) {
    const intent = detectIntent(rawText);
    // if no intent, just send as usual (let engine simulated or normal path)
    if (!intent) {
      // fallback: normal send (existing behavior)
      if (window.quantumEngine && typeof window.quantumEngine.addMessageToChat === 'function') {
        window.quantumEngine.addMessageToChat('user', rawText);
      } else {
        // directly append user message in chat
        const messagesContainer = $('quantumChatMessages');
        if (messagesContainer) {
          const m = el('div', { class: 'quantum-message user', text: rawText });
          messagesContainer.appendChild(m);
        }
      }
      // no AI call from this injector
      return;
    }

    // build params & prompt
    const params = extractSimpleParams(rawText);
    const prompt = buildPrompt(intent, params, rawText);

    // show interim system message
    const loadingMessage = el('div', { class: 'quantum-message system' });
    loadingMessage.innerHTML = '<p>ðŸ”Ž Memproses permintaan... Menghubungkan ke provider AI.</p>';
    $('quantumChatMessages').appendChild(loadingMessage);
    $('quantumChatMessages').scrollTop = $('quantumChatMessages').scrollHeight;

    // call AI
    const res = await callAI(prompt);
    loadingMessage.remove();

    if (res.error) {
      // append error system + allow fallback simulated text
      const errMsg = el('div', { class: 'quantum-message system' });
      errMsg.innerHTML = `<p>âš ï¸ ${res.error}</p><p class="text-sm opacity-80">Jika kamu ingin, saya bisa menyimulasikan output RPP sementara (offline).</p>`;
      $('quantumChatMessages').appendChild(errMsg);
      // optionally simulate quick template
      const sim = `<h3>Simulated ${intent.toUpperCase()}</h3><pre>${prompt}</pre>`;
      appendAiResponseToChat(sim, prompt, `SIMULATED_${intent.toUpperCase()}`);
      return;
    }

    const text = res.text || '';
    // Render AI response as HTML â€” we try to convert newlines to <p>
    const safeHtml = text
      .split('\n\n')
      .map(p => `<p style="margin:8px 0; white-space:pre-wrap;">${escapeHtml(p)}</p>`)
      .join('');

    const filenameBase = `${(params.kelas || 'Kelas')}_${intent.toUpperCase()}_${(params.topik || 'Topik').replace(/\s+/g,'_').slice(0,40)}`;
    appendAiResponseToChat(safeHtml, text, filenameBase);
  }

  function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/[&<>"']/g, (m) => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]);
  }

  // Ensure we don't add multiple handlers
  function attachHandlers() {
    const sendBtn = $('sendQuantumMessage');
    const inputEl = $('quantumChatInput');

    if (!sendBtn || !inputEl) return;

    // remove old injected handler if exists
    if (sendBtn.__rpp_attached) {
      // nothing
    } else {
      sendBtn.__rpp_attached = true;
      sendBtn.addEventListener('click', async (e) => {
        const val = (inputEl.value || '').trim();
        if (!val) return;
        inputEl.value = ''; // clear input early
        // add user message to chat
        if (window.quantumEngine && typeof window.quantumEngine.addMessageToChat === 'function') {
          window.quantumEngine.addMessageToChat('user', val);
        } else {
          const messagesContainer = $('quantumChatMessages');
          if (messagesContainer) {
            const m = el('div', { class: 'quantum-message user' });
            m.textContent = val;
            messagesContainer.appendChild(m);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          }
        }
        await processInputAndMaybeCallAI(val);
      });
    }

    // Enter key
    if (!inputEl.__rpp_key_attached) {
      inputEl.__rpp_key_attached = true;
      inputEl.addEventListener('keypress', async (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          const val = (inputEl.value || '').trim();
          if (!val) return;
          inputEl.value = '';
          if (window.quantumEngine && typeof window.quantumEngine.addMessageToChat === 'function') {
            window.quantumEngine.addMessageToChat('user', val);
          }
          await processInputAndMaybeCallAI(val);
        }
      });
    }
  }

  /* -------------------------
     Save/Load AI Config Secure (optional)
  --------------------------*/
  function saveConfigEncrypted(passphrase) {
    const cfg = {
      provider: $('aiProvider') ? $('aiProvider').value : '',
      model: $('aiModel') ? $('aiModel').value : '',
      apiKey: $('aiApiKey') ? $('aiApiKey').value : '',
      temperature: $('aiTemperature') ? $('aiTemperature').value : '',
      maxTokens: $('aiMaxTokens') ? $('aiMaxTokens').value : ''
    };
    if (!window.CryptoJS) {
      alert('CryptoJS tidak tersedia. Konfigurasi tidak disimpan terenkripsi.');
      return;
    }
    const cipher = CryptoJS.AES.encrypt(JSON.stringify(cfg), passphrase).toString();
    localStorage.setItem('quantum_ai_config_enc', cipher);
    alert('Config tersimpan terenkripsi di localStorage.');
  }
  function loadConfigEncrypted(passphrase) {
    try {
      const cipher = localStorage.getItem('quantum_ai_config_enc');
      if (!cipher) return null;
      const bytes = CryptoJS.AES.decrypt(cipher, passphrase);
      const txt = bytes.toString(CryptoJS.enc.Utf8);
      return JSON.parse(txt || '{}');
    } catch (err) {
      return null;
    }
  }

  // Expose small API to window for developer convenience
  window.quantumRppToolkit = {
    attachHandlers,
    buildPrompt,
    callAI,
    saveConfigEncrypted,
    loadConfigEncrypted,
    generateQrImageUrl
  };

  // run attach handlers when DOM ready / engine ready
  function tryInit() {
    attachHandlers();
  }
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(tryInit, 200);
  } else {
    document.addEventListener('DOMContentLoaded', tryInit);
  }

  // Also try re-attach when quantumEngine is present (in case it initializes later)
  const checkEngineInterval = setInterval(() => {
    if (window.quantumEngine) {
      tryInit();
      clearInterval(checkEngineInterval);
    }
  }, 500);

  // Small UX note appended to tools sidebar (non-intrusive)
  (function noticeInToolsSidebar(){
    const tools = $('quantumToolsSidebar');
    if (!tools) return;
    const noteId = 'quantumRppNotice';
    if (document.getElementById(noteId)) return;
    const card = el('div', { class: 'quantum-card glass p-4', html: `
      <h4 class="font-black mb-2">RPP / PROMES / LKPD Toolkit</h4>
      <p class="text-sm opacity-80">Ketik perintah di kotak chat: contoh <em>"Buatkan RPP kelas 2 tentang pecahan"</em>. Gunakan API key di konfigurasi.</p>
      <div class="flex gap-2 mt-3">
        <button id="quantumSaveConfigEnc" class="quantum-btn primary">Simpan Config Aman</button>
      </div>
    `});
    card.id = noteId;
    
// ==== FORCE INSERT after "stl-AIchat Tools" header ====
try {
  (function(){
    const sidebarEl = (typeof sidebar !== 'undefined' ? sidebar : (typeof tools !== 'undefined' ? tools : document.getElementById('quantumToolsSidebar')));
    if (!sidebarEl) {
      // fallback: try to find by id
      sidebarEl = document.getElementById('quantumToolsSidebar') || document.querySelector('.quantum-tools-sidebar') || document.querySelector('.tools-sidebar');
    }
    if (sidebarEl && card) {
      const headers = Array.from(sidebarEl.querySelectorAll('h3'));
      let header = headers.find(h => h.innerText && h.innerText.toLowerCase().includes('stl-aichat tools'));
      if (!header) {
        // try alternative text match
        header = headers.find(h => h.innerText && h.innerText.toLowerCase().includes('stl-aichat'));
      }
      if (header) {
        const parentCard = header.closest('.quantum-card') || header.parentElement;
        if (parentCard) {
          parentCard.insertAdjacentElement('afterend', card);
          console.log('âœ… Card inserted after stl-AIchat Tools header');
        } else {
          sidebarEl.appendChild(card);
          console.warn('âš  parentCard not found; appended to sidebar');
        }
      } else {
        // try to find Export Data card and insert after it
        const exportCard = sidebarEl.querySelector('.quantum-card .fa-download') ? sidebarEl.querySelector('.quantum-card .fa-download').closest('.quantum-card') : null;
        if (exportCard) {
          exportCard.insertAdjacentElement('afterend', card);
          console.log('âœ… Card inserted after Export Data');
        } else {
          sidebarEl.appendChild(card);
          console.warn('âš  Header not found; appended to sidebar');
        }
      }
    }
  })();
} catch(e){
  try { sidebar.appendChild(card); } catch(err){ console.warn('final fallback append failed', err); }
}

    const saveBtn = document.getElementById('quantumSaveConfigEnc');
    if (saveBtn) {
      saveBtn.addEventListener('click', () => {
        const pass = prompt('Masukkan passphrase untuk enkripsi config (ingat passphrase ini):');
        if (!pass) return alert('Dibatalkan.');
        saveConfigEncrypted(pass);
      });
    }
  })();

})();
</script>
<!-- ==================== END INJECTION ==================== -->
<!-- ==================== INJECTION: RPP/PROMES/LKPD TOOLKIT v2 (Modal + Multi-provider + Proxy Fallback) ==================== -->
<script>
(function(){
  if (window.__quantum_rpp_v2_injected) return;
  window.__quantum_rpp_v2_injected = true;

  /* ----------------- Utilities ----------------- */
  const $ = id => document.getElementById(id);
  function el(tag, opts={}){ const e=document.createElement(tag); if(opts.class) e.className=opts.class; if(opts.html) e.innerHTML=opts.html; if(opts.text) e.textContent=opts.text; return e; }
  function safeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]); }

  /* ----------------- Templates (same as earlier) ----------------- */
  const templates = {
    rpp: `Buatkan RPP Kurikulum Merdeka dengan format profesional untuk guru SD:

Kelas       : {kelas}
Semester    : {semester}
Mata Pelajaran : {mapel}
Topik/Materi: {topik}
Alokasi Waktu : {waktu}
Fase Capaian  : {fase}
Model Pembelajaran: {model}
Metode      : {metode}

Wajib mencakup:
- Capaian Pembelajaran
- Tujuan Pembelajaran (kompetensi spesifik terkait)
- Kegiatan Pembelajaran (Pembuka, Inti, Penutup)
- Asesmen (diagnostik, formatif, sumatif)
- Media & Sumber Belajar
- Refleksi Guru dan Siswa
- Diferensiasi (konten, proses, produk)
- Profil Pelajar Pancasila (minimal 3 elemen)
Susun dalam format rapi siap cetak A4.`,

    promes: `Buatkan Program Semester (PROMES) Kurikulum Merdeka:

Kelas    : {kelas}
Semester : {semester}
Mapel    : {mapel}

Harus berisi tabel:
- Alur Tujuan Pembelajaran (ATP)
- Materi Pokok
- Alokasi Minggu/Bulan
- Jumlah JP
- Bentuk Asesmen
- Keterangan Projek/Profil Pancasila jika ada`,

    lkpd: `Buatkan LKPD berbasis Inkuiri untuk SD:

Kelas    : {kelas}
Mapel    : {mapel}
Topik    : {topik}

Susunan:
1. Tujuan pembelajaran
2. Stimulus masalah (kata pengantar)
3. Prediksi/hipotesis
4. Langkah inkuiri (instruksi)
5. Pengumpulan data (tabel/lembar kerja)
6. Analisis sederhana
7. Kesimpulan
8. Refleksi siswa
9. Rubrik penilaian

Gunakan bahasa ramah anak, sisipkan instruksi dan tabel kerja.`,

    prota: `Buatkan Program Tahunan (PROTA) Kurikulum Merdeka:

Kelas: {kelas}
Mapel: {mapel}

Harus berisi:
- Distribusi KD/CP tiap semester
- Alokasi JP per topik
- Indikator utama per tema`,

    atp: `Buatkan Alur Tujuan Pembelajaran (ATP) untuk:

Kelas: {kelas}
Mapel: {mapel}
Topik: {topik}

Format tabel: KD / Indikator / Kegiatan Pembelajaran / Asesmen / Alat & Sumber`
  };

  /* ----------------- Prompt builder & param extractor ----------------- */
  function detectIntent(text){
    const t = (text||'').toLowerCase();
    if(t.includes('rpp') || /buatkan rpp|rpp kelas/.test(t)) return 'rpp';
    if(t.includes('promes') || t.includes('program semester')) return 'promes';
    if(t.includes('lkpd')) return 'lkpd';
    if(t.includes('prota') || t.includes('program tahunan')) return 'prota';
    if(t.includes('atp') || t.includes('alur tujuan pembelajaran')) return 'atp';
    if(t.includes('full paket') || (t.includes('full') && t.includes('paket'))) return 'full';
    return null;
  }
  function extractSimpleParams(text){
    const out = { kelas:'{kelas}', mapel:'{mapel}', topik:'{topik}', waktu:'2 JP', semester:'1', model:'Inkuiri', metode:'Diskusi & Eksperimen', fase:'Awal' };
    const kelasMatch = text.match(/kelas\s*([1-6])/i);
    if(kelasMatch) out.kelas = 'Kelas '+kelasMatch[1];
    const sem = text.match(/semester\s*(1|2)/i);
    if(sem) out.semester = sem[1];
    const top = text.match(/(?:tentang|topik|mengenai)\s+([a-z0-9\s\,\-\:]+)/i);
    if(top) out.topik = top[1].trim();
    const mapelMatch = text.match(/(mata pelajaran|mapel)\s*[:\-]?\s*([a-z0-9\s]+)/i);
    if(mapelMatch) out.mapel = mapelMatch[2].trim();
    return out;
  }
  function buildPrompt(intent, params){
    if(intent === 'full'){
      return templates.rpp.replace(/\{kelas\}/g, params.kelas).replace(/\{mapel\}/g, params.mapel).replace(/\{topik\}/g, params.topik)
        + '\n\n---\n\n' + templates.promes.replace(/\{kelas\}/g, params.kelas).replace(/\{mapel\}/g, params.mapel)
        + '\n\n---\n\n' + templates.lkpd.replace(/\{kelas\}/g, params.kelas).replace(/\{mapel\}/g, params.mapel).replace(/\{topik\}/g, params.topik)
        + '\n\n---\n\n' + templates.prota.replace(/\{kelas\}/g, params.kelas).replace(/\{mapel\}/g, params.mapel)
        + '\n\n---\n\n' + templates.atp.replace(/\{kelas\}/g, params.kelas).replace(/\{mapel\}/g, params.mapel).replace(/\{topik\}/g, params.topik);
    }
    const tpl = templates[intent] || templates.rpp;
    return tpl.replace(/\{kelas\}/g, params.kelas).replace(/\{mapel\}/g, params.mapel).replace(/\{topik\}/g, params.topik)
              .replace(/\{waktu\}/g, params.waktu).replace(/\{semester\}/g, params.semester)
              .replace(/\{model\}/g, params.model).replace(/\{metode\}/g, params.metode).replace(/\{fase\}/g, params.fase);
  }

  /* ----------------- Multi-provider AI caller with proxy fallback ----------------- */
  async function aiCallWithFallback({ provider, model, apiKey, prompt, temperature=0.7, maxTokens=2000 }) {
    // Try direct provider call, if fails try proxy/custom endpoint
    try {
      const direct = await callProvider(provider, model, apiKey, prompt, temperature, maxTokens);
      if(direct && direct.text) return { text: direct.text };
      if(direct && direct.error) throw new Error(direct.error);
      // else fallback below
    } catch(err){
      console.warn('Direct provider error:', err && err.message);
    }

    // Try proxy endpoints (first look for aiCustomUrl or aiProxyUrl)
    const proxyUrls = [];
    const v1 = $('aiCustomUrl') ? $('aiCustomUrl').value : null;
    const v2 = $('aiProxyUrl') ? $('aiProxyUrl').value : null;
    if(v1) proxyUrls.push(v1);
    if(v2) proxyUrls.push(v2);
    // default fallback path (you can implement server-side handler at this path)
    proxyUrls.push('/ai-proxy');

    for(const url of proxyUrls){
      if(!url) continue;
      try{
        const res = await fetch(url, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ provider, model, apiKey, prompt, temperature, maxTokens })
        });
        if(!res.ok) {
          const t = await res.text().catch(()=>null);
          console.warn('proxy',url,'error',res.status,t);
          continue;
        }
        const json = await res.json().catch(()=>null);
        const text = (json && (json.text || json.result || json.output)) || null;
        if(text) return { text };
      } catch(e){
        console.warn('Proxy call failed', url, e && e.message);
      }
    }

    return { error: 'Gagal menghubungi provider AI atau proxy. Periksa API key dan konfigurasi proxy (Tools â†’ AI Model Configuration).' };
  }

  async function callProvider(provider, model, apiKey, prompt, temperature, maxTokens){
    if(!apiKey) return { error: 'API key kosong' };

    if(provider === 'openai'){
      // OpenAI Chat Completions v1
      try{
        const body = { model, messages:[ { role:'system', content: ($('aiSystemPrompt') ? $('aiSystemPrompt').value : 'You are a helpful assistant.') }, { role:'user', content: prompt } ], temperature, max_tokens: maxTokens };
        const res = await fetch('https://api.openai.com/v1/chat/completions', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+apiKey }, body: JSON.stringify(body) });
        if(!res.ok) {
          const txt = await res.text().catch(()=>null);
          return { error: `OpenAI error ${res.status}: ${txt}` };
        }
        const j = await res.json();
        const reply = (j?.choices && j.choices[0] && j.choices[0].message && j.choices[0].message.content) || JSON.stringify(j);
        return { text: reply };
      }catch(e){ return { error: e.message }; }
    }

    if(provider === 'anthropic'){
      // Note: Anthropics prefer server-side calls. This is a best-effort client call.
      try{
        // anthropic v1/complete: send prompt in 'prompt' field. Use 'x-api-key' header
        const body = { model: model || 'claude-3', prompt: prompt, max_tokens_to_sample: maxTokens, temperature: temperature };
        const res = await fetch('https://api.anthropic.com/v1/complete', { method:'POST', headers:{ 'Content-Type':'application/json', 'x-api-key': apiKey }, body: JSON.stringify(body) });
        if(!res.ok) {
          const txt = await res.text().catch(()=>null);
          return { error: `Anthropic error ${res.status}: ${txt}` };
        }
        const j = await res.json();
        // anthopic uses 'completion'
        const reply = j?.completion || JSON.stringify(j);
        return { text: reply };
      }catch(e){ return { error: e.message }; }
    }

    if(provider === 'google' || provider === 'gemini'){
      // Google Gemini typically requires OAuth and is not suitable for direct browser calls.
      // We intentionally fail and let fallback proxy take over (see aiCallWithFallback)
      return { error: 'Provider Google/Gemini memerlukan proxy server-side. Configure aiCustomUrl or aiProxyUrl.' };
    }

    if(provider === 'custom'){
      const url = $('aiCustomUrl') ? $('aiCustomUrl').value : null;
      if(!url) return { error: 'Custom provider dipilih namun aiCustomUrl tidak diisi.' };
      try{
        const res = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json', 'x-api-key': apiKey }, body: JSON.stringify({ prompt, model, temperature, maxTokens }) });
        if(!res.ok) {
          const t = await res.text().catch(()=>null);
          return { error: 'Custom provider error: '+res.status+' '+t };
        }
        const j = await res.json();
        return { text: j.text || j.output || JSON.stringify(j) };
      } catch(e){ return { error: e.message }; }
    }

    return { error: 'Provider tidak dikenali.' };
  }

  /* ----------------- UI: tiny trigger button inside input row (non-intrusive) ----------------- */
  function createTinyTrigger(){
    const inputRow = document.querySelector('.quantum-chat-input-row') || null;
    if(!inputRow) return;
    if(document.getElementById('quantumCreateDocTrigger')) return;

    // create wrapper positioned absolute inside input row, right before send button
    const trigger = el('button',{ class:'quantum-btn primary' });
    trigger.id = 'quantumCreateDocTrigger';
    trigger.style.padding = '8px';
    trigger.style.minWidth = '40px';
    trigger.style.width = '40px';
    trigger.style.height = '40px';
    trigger.style.borderRadius = '10px';
    trigger.style.fontSize = '14px';
    trigger.style.display = 'flex';
    trigger.style.alignItems = 'center';
    trigger.style.justifyContent = 'center';
    trigger.style.boxShadow = 'none';
    trigger.style.opacity = '0.9';
    trigger.title = 'Buka form pembuatan RPP / PROMES / LKPD';
    trigger.innerHTML = '<i class="fas fa-book-open"></i>';

    // place it just before send button
    const sendBtn = $('sendQuantumMessage');
    if(sendBtn && sendBtn.parentNode) {
      sendBtn.parentNode.insertBefore(trigger, sendBtn);
    } else {
      inputRow.appendChild(trigger);
    }

    trigger.addEventListener('click', (e) => {
      e.preventDefault();
      openDocModal();
    });
  }

  /* ----------------- Modal Form (adaptive glass + theme aware) ----------------- */
  function openDocModal(){
    if($('quantumDocModal')) return;
    // overlay
    const overlay = el('div',{ class:'quantum-sidebar-overlay active' });
    overlay.id = 'quantumDocOverlay';
    overlay.style.zIndex = 12000;

    // modal
    const modal = el('div',{ class:'quantum-card glass p-6' });
    modal.id = 'quantumDocModal';
    modal.style.position = 'fixed';
    modal.style.left = '50%';
    modal.style.top = '50%';
    modal.style.transform = 'translate(-50%,-50%)';
    modal.style.width = '86vw';
    modal.style.maxWidth = '760px';
    modal.style.maxHeight = '88vh';
    modal.style.overflow = 'auto';
    modal.style.zIndex = 12001;
    modal.style.borderRadius = '14px';

    // header
    const header = el('div',{ class:'flex justify-between items-center mb-4' });
    header.innerHTML = `<h3 style="font-weight:800">Buat Dokumen Pembelajaran (RPP/PROMES/LKPD/PROTA/ATP)</h3>`;
    const closeBtn = el('button',{ class:'quantum-btn danger' });
    closeBtn.style.padding='6px 10px';
    closeBtn.innerHTML = '<i class="fas fa-times"></i> x';
    closeBtn.addEventListener('click', () => { modal.remove(); overlay.remove(); });
    header.appendChild(closeBtn);

    // form
    const form = el('div',{ class:'space-y-3' });
    form.innerHTML = `
      <div class="grid grid-cols-2 gap-3">
        <div><label class="text-sm">Jenis Dokumen</label>
          <select id="docType" class="quantum-input glass">
            <option value="rpp">RPP</option>
            <option value="promes">PROMES (Program Semester)</option>
            <option value="prota">PROTA (Program Tahunan)</option>
            <option value="atp">ATP (Alur Tujuan Pembelajaran)</option>
            <option value="lkpd">LKPD (Inkuiri)</option>
            <option value="full">Full Paket (RPP + PROMES + PROTA + ATP + LKPD)</option>
          </select>
        </div>
        <div><label class="text-sm">Kelas</label>
          <select id="docKelas" class="quantum-input glass">
            <option value="Kelas 1">Kelas 1</option>
            <option value="Kelas 2">Kelas 2</option>
            <option value="Kelas 3">Kelas 3</option>
            <option value="Kelas 4">Kelas 4</option>
            <option value="Kelas 5">Kelas 5</option>
            <option value="Kelas 6">Kelas 6</option>
          </select>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div><label class="text-sm">Semester</label>
          <select id="docSemester" class="quantum-input glass"><option value="1">1</option><option value="2">2</option></select>
        </div>
        <div><label class="text-sm">Alokasi Waktu (contoh: 2 JP)</label>
          <input id="docWaktu" class="quantum-input glass" placeholder="2 JP" value="2 JP"/>
        </div>
      </div>

      <div><label class="text-sm">Mata Pelajaran / Mapel</label>
        <input id="docMapel" class="quantum-input glass" placeholder="Mis: Matematika / Bahasa Indonesia / IPA"/>
      </div>

      <div><label class="text-sm">Topik / Materi (opsional)</label>
        <input id="docTopik" class="quantum-input glass" placeholder="Mis: Pecahan, Perkalian, Energi"/>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div><label class="text-sm">Model Pembelajaran</label>
          <input id="docModel" class="quantum-input glass" placeholder="Inkuiri / Projek / Eksperimen" value="Inkuiri"/>
        </div>
        <div><label class="text-sm">Metode</label>
          <input id="docMetode" class="quantum-input glass" placeholder="Diskusi, Eksperimen" value="Diskusi & Eksperimen"/>
        </div>
      </div>

      <div><label class="text-sm">Catatan tambahan (opsional)</label>
        <textarea id="docNote" class="quantum-input glass" rows="3" placeholder="Tambahkan catatan khusus untuk penyusunan dokumen..."></textarea>
      </div>

      <div class="flex gap-2 mt-3">
        <button id="docGenerateBtn" class="quantum-btn primary">Generate & Tampilkan</button>
        <button id="docGenerateSimBtn" class="quantum-btn secondary">Generate Simulasi (Offline)</button>
        <div style="flex:1"></div>
        <button id="docCloseBtn" class="quantum-btn danger">Batal</button>
      </div>
    `;

    modal.appendChild(header);
    modal.appendChild(form);
    document.body.appendChild(overlay);
    document.body.appendChild(modal);

    // handlers
    $('docCloseBtn').addEventListener('click', ()=> { modal.remove(); overlay.remove(); });
    $('docGenerateSimBtn').addEventListener('click', async ()=>{
      const params = collectFormParams();
      const prompt = buildPrompt(params.docType, params);
      modal.remove(); overlay.remove();
      // produce simulated response quickly and append
      const simHtml = `<h3>Simulated ${params.docType.toUpperCase()}</h3><pre style="white-space:pre-wrap;">${safeHtml(prompt)}</pre>`;
      appendAiResponseToChat(simHtml, prompt, `${params.kelas || 'Kelas'}_${params.docType.toUpperCase()}_SIM`);
    });
    $('docGenerateBtn').addEventListener('click', async ()=>{
      const params = collectFormParams();
      modal.remove(); overlay.remove();
      // show loading system msg
      const lm = el('div',{ class:'quantum-message system' }); lm.innerHTML = '<p>ðŸ”Ž Memproses... Menghubungkan ke provider AI.</p>';
      const msgs = $('quantumChatMessages'); if(msgs) msgs.appendChild(lm); if(msgs) msgs.scrollTop = msgs.scrollHeight;
      // build prompt & call AI
      const prompt = buildPrompt(params.docType, params);
      // read provider config from Tools Sidebar (global)
      const provider = ($('aiProvider') ? $('aiProvider').value : 'openai') || 'openai';
      const apiKey = ($('aiApiKey') ? $('aiApiKey').value : '') || '';
      const model = ($('aiModel') ? $('aiModel').value : '') || '';
      const temperature = parseFloat(($('aiTemperature') && $('aiTemperature').value) || 0.7);
      const maxTokens = parseInt(($('aiMaxTokens') && $('aiMaxTokens').value) || 2000,10);

      const result = await aiCallWithFallback({ provider, model, apiKey, prompt, temperature, maxTokens });
      lm.remove();
      if(result.error){
        const err = el('div',{ class:'quantum-message system' }); err.innerHTML = `<p>âš ï¸ ${safeHtml(result.error)}</p>`; msgs.appendChild(err);
        // simulated fallback offer
        const simHtml = `<h3>Simulated ${params.docType.toUpperCase()}</h3><pre style="white-space:pre-wrap;">${safeHtml(prompt)}</pre>`;
        appendAiResponseToChat(simHtml, prompt, `${params.kelas || 'Kelas'}_${params.docType.toUpperCase()}_SIM`);
        return;
      }
      const text = result.text || '';
      // render as HTML paragraphs
      const safe = text.split('\n\n').map(p=>`<p style="margin:8px 0; white-space:pre-wrap;">${safeHtml(p)}</p>`).join('');
      const filenameBase = `${params.kelas.replace(/\s+/g,'_')}_${params.docType.toUpperCase()}_${(params.topik||'Topik').replace(/\s+/g,'_').slice(0,40)}`;
      appendAiResponseToChat(safe, text, filenameBase);
    });

    // helper to collect
    function collectFormParams(){
      return {
        docType: $('docType').value,
        kelas: $('docKelas').value,
        semester: $('docSemester').value,
        waktu: $('docWaktu').value,
        mapel: $('docMapel').value || '{mapel}',
        topik: $('docTopik').value || '{topik}',
        model: $('docModel').value || 'Inkuiri',
        metode: $('docMetode').value || 'Diskusi & Eksperimen',
        note: $('docNote').value || ''
      };
    }
  }

  /* ----------------- Append AI response & inline actions (preview/pdf/doc/qr) ----------------- */
  function appendAiResponseToChat(contentHtml, rawTextForQr='', filenameBase='Document'){
    const messagesContainer = $('quantumChatMessages');
    if(!messagesContainer) return;
    const msgWrap = el('div',{ class:'quantum-message ai' });
    const inner = el('div'); inner.innerHTML = contentHtml;
    msgWrap.appendChild(inner);

    const actions = el('div'); actions.className = 'mt-3 flex gap-2';

    const previewBtn = el('button',{ class:'quantum-btn primary' }); previewBtn.style.padding='6px 10px'; previewBtn.innerHTML = '<i class="fas fa-eye"></i> Preview';
    previewBtn.addEventListener('click', ()=> createPreviewModal(contentHtml, filenameBase));
    const pdfBtn = el('button',{ class:'quantum-btn secondary' }); pdfBtn.style.padding='6px 10px'; pdfBtn.innerHTML = '<i class="fas fa-file-pdf"></i> PDF';
    pdfBtn.addEventListener('click', async ()=> { const tmp = el('div'); tmp.style.padding='20px'; tmp.style.background='white'; tmp.innerHTML = contentHtml; tmp.style.position='fixed'; tmp.style.left='-9999px'; document.body.appendChild(tmp); await printHtmlToPdf(tmp, filenameBase); tmp.remove(); });
    const docBtn = el('button',{ class:'quantum-btn success' }); docBtn.style.padding='6px 10px'; docBtn.innerHTML = '<i class="fas fa-file-word"></i> DOC';
    docBtn.addEventListener('click', ()=> downloadDocFromHtml(contentHtml, filenameBase));
    const qrBtn = el('button',{ class:'quantum-btn warning' }); qrBtn.style.padding='6px 10px'; qrBtn.innerHTML = '<i class="fas fa-qrcode"></i> QR';
    qrBtn.addEventListener('click', ()=> { const url = generateQrImageUrl(rawTextForQr || contentHtml); const qrHtml = `<div style="text-align:center"><h4>QR untuk dokumen</h4><img src="${url}" style="max-width:220px"/><p style="font-size:12px;margin-top:8px">Scan untuk membuka/menyimpan</p></div>`; createPreviewModal(qrHtml,'QR Kode'); });

    actions.appendChild(previewBtn); actions.appendChild(pdfBtn); actions.appendChild(docBtn); actions.appendChild(qrBtn);
    msgWrap.appendChild(actions);
    messagesContainer.appendChild(msgWrap);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  /* ----------------- Preview Modal + PDF/DOC utilities (reused) ----------------- */
  function createPreviewModal(htmlContent, title='Preview Dokumen'){
    const exist = $('quantumPreviewModal'); if(exist) exist.remove();
    const overlay = el('div',{ class:'quantum-sidebar-overlay active' }); overlay.id='quantumPreviewOverlay'; overlay.style.zIndex=13000;
    const modal = el('div',{ class:'quantum-card glass p-6' }); modal.id='quantumPreviewModal';
    modal.style.position='fixed'; modal.style.left='50%'; modal.style.top='50%'; modal.style.transform='translate(-50%,-50%)';
    modal.style.width='80vw'; modal.style.maxWidth='900px'; modal.style.maxHeight='90vh'; modal.style.overflow='auto'; modal.style.zIndex=13001; modal.style.borderRadius='12px';
    const header = el('div',{ class:'flex justify-between items-center mb-4' }); header.innerHTML=`<h3 style="font-weight:800">${title}</h3>`;
    const closeBtn = el('button',{ class:'quantum-btn danger' }); closeBtn.style.padding='6px 10px'; closeBtn.innerHTML='<i class="fas fa-times"></i> x'; closeBtn.addEventListener('click', ()=>{ modal.remove(); overlay.remove(); });
    header.appendChild(closeBtn);
    const contentWrap = el('div',{ class:'prose', html: htmlContent }); contentWrap.style.background='white'; contentWrap.style.padding='20px'; contentWrap.style.color='#111'; contentWrap.style.borderRadius='6px'; contentWrap.style.boxShadow='0 4px 20px rgba(0,0,0,0.08)';
    const actions = el('div',{ class:'flex gap-3 mt-4' });
    const btnPdf = el('button',{ class:'quantum-btn primary' }); btnPdf.textContent='Download PDF'; btnPdf.addEventListener('click', ()=> printHtmlToPdf(contentWrap,title.replace(/\s+/g,'_')));
    const btnDoc = el('button',{ class:'quantum-btn secondary' }); btnDoc.textContent='Download DOC'; btnDoc.addEventListener('click', ()=> downloadDocFromHtml(contentWrap.innerHTML, title.replace(/\s+/g,'_')));
    actions.appendChild(btnPdf); actions.appendChild(btnDoc);
    modal.appendChild(header); modal.appendChild(contentWrap); modal.appendChild(actions);
    document.body.appendChild(overlay); document.body.appendChild(modal);
  }

  async function printHtmlToPdf(element, filename='document'){
    try{
      const canvas = await html2canvas(element, { scale:2, useCORS:true, scrollY: -window.scrollY });
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p','mm','a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      pdf.addImage(imgData,'PNG',8,8,pageWidth-16, (canvas.height * (pageWidth-16))/canvas.width);
      pdf.save(`${filename}.pdf`);
    }catch(err){ alert('Gagal membuat PDF: '+err.message); }
  }

  function downloadDocFromHtml(html, filename='document'){
    const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>"+filename+"</title></head><body>";
    const footer="
<!-- NAJIB OPTIMIZER PATCH v1.0 (Fonts + Particle Optimizer + Cinematic Modes + Child-suite soft-mode) -->
<script id="najib-optimizer-patch">
(function(){
'use strict';
/*** UTIL: capability detection ***/
function detectCapsSafe(){
try{
if(window.__NAJIB_CAPS) return window.__NAJIB_CAPS;
const caps = { cores: navigator.hardwareConcurrency||2, mem: navigator.deviceMemory||2, dpr: window.devicePixelRatio||1, webgl:false, webgl2:false };
try{
const c=document.createElement('canvas');
const g2 = c.getContext && c.getContext('webgl2');
const g = g2 || (c.getContext && (c.getContext('webgl')||c.getContext('experimental-webgl')));
if(g){ caps.webgl = !!g; caps.webgl2 = !!g2; }
}catch(e){}
let score=0;
if(caps.cores>=8) score+=30; else if(caps.cores>=4) score+=18; else score+=8;
if(caps.mem>=8) score+=30; else if(caps.mem>=4) score+=18; else score+=6;
if(caps.webgl2) score+=30; else if(caps.webgl) score+=16;
caps.score = score;
if(caps.cores<=2 || caps.mem<=1 || caps.score<24) caps.profile='low';
else if((caps.cores<=4 && caps.mem<=3) || caps.score<48) caps.profile='mid';
else caps.profile='high';
window.__NAJIB_CAPS = caps;
return caps;
}catch(e){
return { profile:'low', cores:2, mem:1, dpr:1 };
}
}
const CAPS = detectCapsSafe();

/***** 1) FONT LAZY LOADER *****/
(function lazyFonts(){
try{
const heavyLinks = Array.from(document.querySelectorAll('link[href*="fonts.googleapis.com"], link[href*="fonts.gstatic.com"]'));
if(!heavyLinks.length) return;
if(CAPS.profile === 'low' || window.matchMedia('(prefers-reduced-data: reduce)').matches){
heavyLinks.forEach(l => { l.media='print'; l.setAttribute('data-deferred','1'); });
return;
}
function loadHeavyFonts(){
heavyLinks.forEach(l=>{
if(l.getAttribute('data-deferred')) return;
l.rel = 'stylesheet';
l.removeAttribute('media');
l.setAttribute('data-loaded-by','najib-optimizer');
});
}
if('requestIdleCallback' in window){
requestIdleCallback(loadHeavyFonts, {timeout:3000});
} else {
const onFirst = function(){ loadHeavyFonts(); window.removeEventListener('pointerdown', onFirst); window.removeEventListener('touchstart', onFirst); };
window.addEventListener('pointerdown', onFirst, {once:true});
window.addEventListener('touchstart', onFirst, {once:true});
setTimeout(loadHeavyFonts, 6000);
}
}catch(e){ console.warn('[najib-optimizer] lazyFonts failed', e); }
})();

/***** 2) PARTICLE SMART OPTIMIZER *****/
(function particleOptimizer(){
try{
const container = document.getElementById('quantumParticles') || document.querySelector('.quantum-particles');
if(!container) return;
function makeParticle(cls, x, y, size, content){
const el = document.createElement('div');
el.className = 'particle ' + cls;
el.style.left = (x*100).toFixed(2) + 'vw';
el.style.top = (y*100).toFixed(2) + 'vh';
el.style.width = size + 'px';
el.style.height = size + 'px';
if(content) { el.textContent = content; el.classList.add('particle-codeRain'); el.style.fontSize = Math.max(10, size) + 'px'; el.style.width = 'auto'; el.style.height = 'auto'; }
return el;
}
const baseCounts = {
goldenFloat: 28, blackPulse: 20, redSword: 22, shapeShifter: 20,
codeRain: 36, oceanWave: 26, neonPulse: 24, roseFloat: 24
};
const scaleMap = { high:1, mid:0.45, low:0.08 };
const profile = CAPS.profile || 'low';
const scale = scaleMap[profile] || 0.45;
const reduceEffects = (profile === 'low' || window.matchMedia('(prefers-reduced-motion: reduce)').matches);

window.renderParticlesForTheme = function(themeKey){
try{
const t = themeKey || 'goldenFloat';
const mapName = {
goldenFloat:'goldenFloat', blackPulse:'blackPulse', redSword:'redSword',
shapeShifter:'shapeShifter', codeRain:'codeRain', oceanWave:'oceanWave',
neonPulse:'neonPulse', roseFloat:'roseFloat'
}[t] || 'goldenFloat';
const base = baseCounts[mapName] || 18;
const count = Math.max( Math.round(base*scale), (reduceEffects ? 0 : 2) );
container.innerHTML = '';
if(count === 0){
const accent = document.createElement('div');
accent.className = 'particle particle-neonPulse';
accent.style.left = '50%';
accent.style.top = '80%';
accent.style.width = '4px';
accent.style.height = '4px';
accent.style.opacity = '0.6';
accent.style.pointerEvents = 'none';
container.appendChild(accent);
return;
}
const fragment = document.createDocumentFragment();
for(let i=0;i<count;i++){
const x = Math.random(); const y = Math.random();
const size = (mapName==='codeRain' ? Math.max(10, Math.round(Math.random()*14+6)) : Math.round(Math.random()*(reduceEffects?4:8) + (reduceEffects?2:2)));
const p = makeParticle('particle-'+mapName, x, y, size, mapName==='codeRain'? (Math.random()>0.7?String.fromCharCode(0x30A0 + Math.floor(Math.random()*96)) : '') : '');
if(reduceEffects){
p.style.boxShadow = 'none';
p.style.filter = 'none';
p.style.animationDuration = '8s';
}
fragment.appendChild(p);
}
container.appendChild(fragment);
}catch(e){ console.warn('[najib-optimizer] renderParticlesForTheme fail', e); }
};

try{
const saved = (JSON.parse(localStorage.getItem('najib_saved_themes')||'[]') || [])[0];
const initialTheme = saved ? (saved.variables && saved.variables.particleTheme) : 'goldenFloat';
setTimeout(()=>{ try{ window.renderParticlesForTheme(initialTheme); }catch(e){} }, 300);
}catch(e){}

window.__najib_particle_optimizer = { profile: CAPS.profile, reducedEffects: reduceEffects };

}catch(e){ console.warn('[najib-optimizer] particleOptimizer top fail', e); }
})();

/***** 3) CINEMATIC MODULAR MODE *****/
(function cinematicModular(){
try{
const ROOT = document.getElementById('stl-open');
if(!ROOT) return;
const mode = CAPS.profile || 'low';
ROOT.setAttribute('data-cinematic-mode', mode);

function applyMode(){
if(mode === 'low'){
const chrom = document.querySelector('.stl-chromatic');
if(chrom) chrom.style.display = 'none';
const scan = document.getElementById('stl-scan');
if(scan) { scan.style.animationDuration = '12s'; scan.style.opacity='0.12'; }
const TITLE = document.getElementById('stl-title');
const TAG = document.getElementById('stl-tag');
if(TITLE) TITLE.style.transition='opacity .6s ease';
if(TAG) TAG.style.transition='opacity .6s ease';
setTimeout(()=>{ try{ ROOT.style.opacity='0'; setTimeout(()=>{ try{ ROOT.remove(); }catch(e){ ROOT.style.display='none'; } }, 550); }catch(e){} }, 900);
}
else if(mode === 'mid'){
const scan = document.getElementById('stl-scan'); if(scan) scan.style.opacity='0.22';
const fract = document.querySelector('.stl-fractal'); if(fract) fract.style.opacity='0.7';
setTimeout(()=>{ try{ ROOT.style.opacity='0'; setTimeout(()=>{ try{ ROOT.remove(); }catch(e){ ROOT.style.display='none'; } }, 900); }catch(e){} }, 4000);
}
}
applyMode();
window.__najib_cinematic_force = function(lvl){
try{ if(!lvl) return; ROOT.setAttribute('data-cinematic-mode', lvl); location.reload(); }catch(e){}
};
}catch(e){ console.warn('[najib-optimizer] cinematicModular fail', e); }
})();

/***** 4) CHILD-SUITE SOFT MODE *****/
(function softenChildSuite(){
try{
(function installSoftObserver(){
let throttleAt = 0;
let backoffMs = 1000;
const whitelist = ['#stl-open','#quantumParticles','#quantumIsland','.quantum-sidebar','.quantum-tools-sidebar'];
const safeCheck = (node)=>{
try{
if(!node || node.nodeType !== 1) return true;
for(const s of whitelist){
try{ if(node.matches && node.matches(s) || (node.closest && node.closest(s))) return true; }catch(e){}
}
const tag = (node.tagName||'').toLowerCase();
if(['div','span','script','style','link','meta','img','svg'].indexOf(tag) !== -1) return true;
return false;
}catch(e){ return true; }
};
const mo = new MutationObserver((mutations)=>{
const now = Date.now();
if(now - throttleAt < backoffMs) return;
throttleAt = now;
let flagged = false;
for(const m of mutations){
for(const n of (m.addedNodes||[])){
if(!safeCheck(n)) flagged = true;
}
}
if(flagged){
console.info('[najib-softObserver] suspicious DOM additions detected');
setTimeout(()=>{ try{ if(window.DEV_mg && typeof window.DEV_mg.auditProtections === 'function') window.DEV_mg.auditProtections({soft:true}); }catch(e){} }, 1200);
backoffMs = Math.min(60000, Math.max(2000, backoffMs * 1.5));
} else {
backoffMs = Math.max(1000, Math.floor(backoffMs*0.9));
}
});
try{
mo.observe(document.documentElement || document.body, { childList:true, subtree:true });
window.__najib_soft_mo = mo;
}catch(e){}
})();
}catch(e){ console.warn('[najib-optimizer] softenChildSuite fail', e); }
})();

/***** 5) REPORT SUMMARY *****/
try{
console.info('[najib-optimizer] applied. profile=%s', CAPS.profile);
}catch(e){}
})();
</script>
<!-- END NAJIB OPTIMIZER PATCH -->
</body>
</html>";
    const sourceHTML = header + html + footer;
    const blob = new Blob(['\ufeff', sourceHTML], { type: 'application/msword' });
    if(window.saveAs) saveAs(blob, `${filename}.doc`);
    else { const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `${filename}.doc`; document.body.appendChild(link); link.click(); link.remove(); }
  }

  function generateQrImageUrl(text, size=200){ const encoded = encodeURIComponent(text); return `https://chart.googleapis.com/chart?cht=qr&chs=${size}x${size}&chl=${encoded}&chld=L|1`; }

  /* ----------------- attach behavior: integrate with input send flow (non-intrusive) ----------------- */
  function attachIntegration(){
    // create tiny trigger
    createTinyTrigger();

    // intercept Enter/send only to optionally open modal when command like "/buat" present â€” keep original behavior unchanged otherwise
    const inputEl = $('quantumChatInput');
    const sendBtn = $('sendQuantumMessage');
    if(!inputEl || !sendBtn) return;

    // Ensure single listener
    if(!sendBtn.__rpp_v2_attached){
      sendBtn.__rpp_v2_attached = true;
      sendBtn.addEventListener('click', async (e)=>{
        const val = (inputEl.value || '').trim();
        if(!val) return;
        // If user used slash command /buat or /rpp or /generate -> open modal prefilled
        if(val.startsWith('/buat') || val.startsWith('/rpp') || val.startsWith('/generate') || val.startsWith('/create')){
          // prefill modal with simple parse
          const params = extractSimpleParams(val);
          openDocModal();
          // prefill fields after small delay (modal creation)
          setTimeout(()=> {
            if($('docKelas')) $('docKelas').value = params.kelas || 'Kelas 2';
            if($('docMapel')) $('docMapel').value = params.mapel && params.mapel!=='{mapel}' ? params.mapel : '';
            if($('docTopik')) $('docTopik').value = params.topik && params.topik!=='{topik}' ? params.topik : '';
          }, 250);
          inputEl.value = ''; // clear command
          return;
        }

        // Otherwise preserve original behavior: add message and let quantumEngine handle (if exists)
        if(window.quantumEngine && typeof window.quantumEngine.addMessageToChat === 'function'){
          window.quantumEngine.addMessageToChat('user', val);
        } else {
          const m = el('div',{ class:'quantum-message user', text: val });
          const msgs = $('quantumChatMessages'); if(msgs) msgs.appendChild(m);
        }
        inputEl.value = '';
        // Additionally: if natural language contains RPP/PROMES keywords, open modal auto-fill (non-blocking)
        const intent = detectIntent(val);
        if(intent){
          // auto open modal with prefilled values (but don't prevent normal send)
          setTimeout(()=> {
            openDocModal();
            setTimeout(()=> {
              const params = extractSimpleParams(val);
              if($('docKelas')) $('docKelas').value = params.kelas || 'Kelas 2';
              if($('docMapel')) $('docMapel').value = params.mapel && params.mapel!=='{mapel}' ? params.mapel : '';
              if($('docTopik')) $('docTopik').value = params.topik && params.topik!=='{topik}' ? params.topik : '';
            }, 250);
          }, 200);
        }
      });
    }

    // Enter key - keep as existing but provide slash command support
    if(!inputEl.__rpp_v2_key_attached){
      inputEl.__rpp_v2_key_attached = true;
      inputEl.addEventListener('keypress', async (e)=>{
        if(e.key === 'Enter' && !e.shiftKey){
          e.preventDefault();
          const val = (inputEl.value || '').trim();
          if(!val) return;
          // same logic as sendBtn
          if(val.startsWith('/buat') || val.startsWith('/rpp') || val.startsWith('/generate') || val.startsWith('/create')){
            const params = extractSimpleParams(val);
            openDocModal();
            setTimeout(()=> {
              if($('docKelas')) $('docKelas').value = params.kelas || 'Kelas 2';
              if($('docMapel')) $('docMapel').value = params.mapel && params.mapel!=='{mapel}' ? params.mapel : '';
              if($('docTopik')) $('docTopik').value = params.topik && params.topik!=='{topik}' ? params.topik : '';
            }, 250);
            inputEl.value = '';
            return;
          }
          if(window.quantumEngine && typeof window.quantumEngine.addMessageToChat === 'function'){
            window.quantumEngine.addMessageToChat('user', val);
          } else {
            const m = el('div',{ class:'quantum-message user', text: val });
            const msgs = $('quantumChatMessages'); if(msgs) msgs.appendChild(m);
          }
          inputEl.value = '';
        }
      });
    }
  }

  /* ----------------- Init & watch for engine DOM readiness ----------------- */
  function initWhenReady(){
    attachIntegration();
    // observe DOM for input row changes (in case SPA re-render)
    const container = document.body;
    const obs = new MutationObserver(()=> { attachIntegration(); });
    obs.observe(container, { childList:true, subtree:true });
  }
  if(document.readyState==='complete' || document.readyState==='interactive') setTimeout(initWhenReady,200);
  else document.addEventListener('DOMContentLoaded', ()=> setTimeout(initWhenReady,200));

  // Expose for debugging
  window.quantumRppV2 = { openDocModal, aiCallWithFallback, buildPrompt };

})();
</script>
<!-- ==================== END INJECTION v2 ==================== -->
<!-- ==================== INJECTION: RPP/PROMES/LKPD TOOLKIT ALL-IN (FINAL) ==================== -->
<script>
(function(){
  if (window.__quantum_rpp_allin_injected) return;
  window.__quantum_rpp_allin_injected = true;

  /* ================== Helpers ================== */
  const $ = id => document.getElementById(id);
  function el(tag, opts = {}) {
    const e = document.createElement(tag);
    if (opts.class) e.className = opts.class;
    if (opts.html) e.innerHTML = opts.html;
    if (opts.text) e.textContent = opts.text;
    if (opts.styles) Object.assign(e.style, opts.styles);
    return e;
  }
  function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]); }

  /* ================== Config: A4 Times New Roman margin C ================== */
  const PRINT_STYLE = `
    @page { size: A4; margin: 3cm 2cm 2cm 2.5cm; }
    .quantum-print-sheet { box-sizing: border-box; width:210mm; min-height:297mm; padding: 0; margin:0 auto; font-family: "Times New Roman", Times, serif; color:#111; }
    .q-header { text-align:center; margin-bottom:12px; font-weight:700; font-size:18px; }
    .q-footer { position: absolute; bottom: 2cm; width:100%; text-align:center; font-size:11px; color:#444 }
    .q-content { font-size:12pt; line-height:1.5; }
  `;

  /* ================== Templates (RPP, PROMES, PROTA, ATP, LKPD) ================== */
  const templates = {
    rpp: `Buatkan RPP Kurikulum Merdeka dengan format profesional untuk guru SD:

Kelas       : {kelas}
Semester    : {semester}
Mata Pelajaran : {mapel}
Topik/Materi: {topik}
Alokasi Waktu : {waktu}
Fase Capaian  : {fase}
Model Pembelajaran: {model}
Metode      : {metode}

Wajib mencakup:
- Capaian Pembelajaran
- Tujuan Pembelajaran (kompetensi spesifik terkait)
- Kegiatan Pembelajaran (Pembuka, Inti, Penutup)
- Asesmen (diagnostik, formatif, sumatif)
- Media & Sumber Belajar
- Refleksi Guru dan Siswa
- Diferensiasi (konten, proses, produk)
- Profil Pelajar Pancasila (minimal 3 elemen)
Susun dalam format rapi siap cetak A4.`,
    promes: `Buatkan Program Semester (PROMES) Kurikulum Merdeka:

Kelas    : {kelas}
Semester : {semester}
Mapel    : {mapel}

Harus berisi tabel:
- Alur Tujuan Pembelajaran (ATP)
- Materi Pokok
- Alokasi Minggu/Bulan
- Jumlah JP
- Bentuk Asesmen
- Keterangan Projek/Profil Pancasila jika ada`,
    prota: `Buatkan Program Tahunan (PROTA) Kurikulum Merdeka:

Kelas: {kelas}
Mapel: {mapel}

Harus berisi:
- Distribusi KD/CP tiap semester
- Alokasi JP per topik
- Indikator utama per tema`,
    atp: `Buatkan Alur Tujuan Pembelajaran (ATP) untuk:

Kelas: {kelas}
Mapel: {mapel}
Topik: {topik}

Format tabel: KD / Indikator / Kegiatan Pembelajaran / Asesmen / Alat & Sumber`,
    lkpd: `Buatkan LKPD berbasis Inkuiri untuk SD:

Kelas    : {kelas}
Mapel    : {mapel}
Topik    : {topik}

Susunan:
1. Tujuan pembelajaran
2. Stimulus masalah (kata pengantar)
3. Prediksi/hipotesis
4. Langkah inkuiri (instruksi)
5. Pengumpulan data (tabel/lembar kerja)
6. Analisis sederhana
7. Kesimpulan
8. Refleksi siswa
9. Rubrik penilaian

Gunakan bahasa ramah anak, sisipkan instruksi dan tabel kerja.`
  };

  /* ================== Prompt builder & param extractor ================== */
  function detectIntent(text){
    if(!text) return null;
    const t = text.toLowerCase();
    if(t.includes('full paket') || (t.includes('full') && t.includes('paket'))) return 'full';
    if(t.includes('rpp') || /buatkan rpp|rpp kelas/.test(t)) return 'rpp';
    if(t.includes('promes') || t.includes('program semester')) return 'promes';
    if(t.includes('prota') || t.includes('program tahunan')) return 'prota';
    if(t.includes('lkpd')) return 'lkpd';
    if(t.includes('atp') || t.includes('alur tujuan pembelajaran')) return 'atp';
    return null;
  }

  function extractSimpleParams(text){
    const out = { kelas:'Kelas 2', mapel:'{mapel}', topik:'{topik}', waktu:'2 JP', semester:'1', model:'Inkuiri', metode:'Diskusi & Eksperimen', fase:'Awal' };
    if(!text) return out;
    const kelasMatch = text.match(/kelas\s*([1-6])/i);
    if(kelasMatch) out.kelas = 'Kelas '+kelasMatch[1];
    const sem = text.match(/semester\s*(1|2)/i);
    if(sem) out.semester = sem[1];
    const top = text.match(/(?:tentang|topik|mengenai)\s+([a-z0-9\s\,\-\:]+)/i);
    if(top) out.topik = top[1].trim();
    const mapel = text.match(/(mata pelajaran|mapel)\s*[:\-]?\s*([a-z0-9\s]+)/i);
    if(mapel) out.mapel = mapel[2].trim();
    return out;
  }

  function buildPrompt(intent, params){
    if(intent === 'full'){
      return templates.rpp.replace(/\{kelas\}/g, params.kelas).replace(/\{mapel\}/g, params.mapel).replace(/\{topik\}/g, params.topik)
        + '\n\n---\n\n' + templates.promes.replace(/\{kelas\}/g, params.kelas).replace(/\{mapel\}/g, params.mapel)
        + '\n\n---\n\n' + templates.lkpd.replace(/\{kelas\}/g, params.kelas).replace(/\{mapel\}/g, params.mapel).replace(/\{topik\}/g, params.topik)
        + '\n\n---\n\n' + templates.prota.replace(/\{kelas\}/g, params.kelas).replace(/\{mapel\}/g, params.mapel)
        + '\n\n---\n\n' + templates.atp.replace(/\{kelas\}/g, params.kelas).replace(/\{mapel\}/g, params.mapel).replace(/\{topik\}/g, params.topik);
    }
    const tpl = templates[intent] || templates.rpp;
    return tpl.replace(/\{kelas\}/g, params.kelas).replace(/\{mapel\}/g, params.mapel).replace(/\{topik\}/g, params.topik)
              .replace(/\{waktu\}/g, params.waktu).replace(/\{semester\}/g, params.semester)
              .replace(/\{model\}/g, params.model).replace(/\{metode\}/g, params.metode).replace(/\{fase\}/g, params.fase);
  }

  /* ================== Multi-provider caller with robust fallback & retries ================== */
  async function aiCallWithFallback({ provider='openai', model='gpt-4', apiKey='', prompt='', temperature=0.7, maxTokens=2000 }) {
    const providersOrder = [provider, 'openai', 'anthropic', 'google', 'custom'];
    // Deduplicate preserving order
    const seen = new Set();
    const order = providersOrder.filter(p => { if(seen.has(p)) return false; seen.add(p); return true; });
    // Try direct calls first (max 1 attempt per provider), then try proxies (aiCustomUrl/aiProxyUrl), then '/ai-proxy'
    for (const p of order) {
      try {
        const res = await callProvider(p, model, apiKey, prompt, temperature, maxTokens);
        if(res && res.text) return { text: res.text, provider: p };
        if(res && res.error) console.warn('provider',p,'error',res.error);
      } catch(err){ console.warn('provider error',p, err && err.message); }
    }

    // Proxy urls: use fields in Tools Sidebar if present
    const proxyCandidates = [];
    if($('aiCustomUrl') && $('aiCustomUrl').value) proxyCandidates.push($('aiCustomUrl').value);
    if($('aiProxyUrl') && $('aiProxyUrl').value) proxyCandidates.push($('aiProxyUrl').value);
    proxyCandidates.push('/ai-proxy'); // default server-side route if available

    for(const url of proxyCandidates){
      for(let attempt=0; attempt<2; attempt++){
        try{
          const r = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ provider, model, apiKey, prompt, temperature, maxTokens })
          });
          if(!r.ok) { const t = await r.text().catch(()=>null); console.warn('proxy',url,'status',r.status,t); continue; }
          const j = await r.json().catch(()=>null);
          if(j && (j.text || j.result || j.output)) return { text: j.text || j.result || j.output, provider: url };
        } catch(err){ console.warn('proxy call failed', url, err && err.message); }
      }
    }

    return { error: 'Gagal menghubungi provider atau proxy. Periksa API key & pengaturan proxy.' };
  }

  async function callProvider(provider, model, apiKey, prompt, temperature, maxTokens){
    if(!apiKey) return { error: 'API key kosong' };
    try {
      if(provider === 'openai'){
        const body = { model, messages:[{role:'system', content:( $('aiSystemPrompt') ? $('aiSystemPrompt').value : 'You are a helpful assistant.' )}, {role:'user', content: prompt}], temperature, max_tokens: maxTokens };
        const r = await fetch('https://api.openai.com/v1/chat/completions', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+apiKey }, body: JSON.stringify(body) });
        if(!r.ok) { const t = await r.text().catch(()=>null); return { error: `OpenAI ${r.status}: ${t}` }; }
        const j = await r.json(); const reply = j?.choices?.[0]?.message?.content || JSON.stringify(j);
        return { text: reply };
      }

      if(provider === 'anthropic'){
        // client-side call is best-effort; prefer proxy server for Claude
        const body = { model: model || 'claude-3', prompt: prompt, max_tokens_to_sample: maxTokens, temperature };
        const r = await fetch('https://api.anthropic.com/v1/complete', { method:'POST', headers:{ 'Content-Type':'application/json', 'x-api-key': apiKey }, body: JSON.stringify(body) });
        if(!r.ok) { const t = await r.text().catch(()=>null); return { error: `Anthropic ${r.status}: ${t}` }; }
        const j = await r.json(); return { text: j?.completion || JSON.stringify(j) };
      }

      if(provider === 'google' || provider === 'gemini'){
        // Not supported directly from browser (OAuth required). Let fallback proxy handle it.
        return { error: 'Google Gemini memerlukan proxy server-side. Configure aiCustomUrl or aiProxyUrl.' };
      }

      if(provider === 'custom'){
        const url = $('aiCustomUrl') ? $('aiCustomUrl').value : null;
        if(!url) return { error: 'Custom provider dipilih namun aiCustomUrl kosong.' };
        const r = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json', 'x-api-key': apiKey }, body: JSON.stringify({ prompt, model, temperature, maxTokens }) });
        if(!r.ok) { const t = await r.text().catch(()=>null); return { error: `Custom ${r.status}: ${t}` }; }
        const j = await r.json(); return { text: j.text || j.result || JSON.stringify(j) };
      }

      return { error: 'Provider tidak dikenali.' };
    } catch(err){
      return { error: err.message || 'Provider call failed' };
    }
  }

  /* ================== Tiny trigger inside input row (non-intrusive) ================== */
  function createTinyTrigger(){
    // prefer to place before send button
    if(document.getElementById('quantumCreateDocTrigger')) return;
    const inputRow = document.querySelector('.quantum-chat-input-row') || null;
    if(!inputRow) return;

    const sendBtn = $('sendQuantumMessage');
    const trigger = el('button', { class: 'quantum-btn', html: '<i class="fas fa-book-open"></i>' });
    trigger.id = 'quantumCreateDocTrigger';
    // tiny style
    Object.assign(trigger.style, {
      width: '40px', height: '40px', padding: '6px', minWidth: '40px', borderRadius: '10px',
      marginRight: '8px', opacity: '0.75', fontSize: '14px', display: 'inline-flex', alignItems: 'center', justifyContent: 'center'
    });
    trigger.title = 'Buka form RPP / PROMES / LKPD';

    if(sendBtn && sendBtn.parentNode) sendBtn.parentNode.insertBefore(trigger, sendBtn);
    else inputRow.appendChild(trigger);

    trigger.addEventListener('click', (e) => { e.preventDefault(); openDocModal(); });
  }

  /* ================== Modal: adaptive glass + theme-aware ================== */
  function openDocModal(prefill = {}) {
    if($('quantumDocModalAll')) return;
    const overlay = el('div', { class: 'quantum-sidebar-overlay active' }); overlay.id = 'quantumDocOverlay'; overlay.style.zIndex = 16000;
    const modal = el('div', { class: 'quantum-card glass p-6' }); modal.id = 'quantumDocModalAll';
    Object.assign(modal.style, { position: 'fixed', left: '50%', top: '50%', transform: 'translate(-50%,-50%)', width: '86vw', maxWidth: '820px', maxHeight: '88vh', overflow: 'auto', zIndex: 16001, borderRadius: '14px' });

    const header = el('div', { class: 'flex justify-between items-center mb-4' });
    header.innerHTML = `<h3 style="font-weight:800">Buat Dokumen Pembelajaran (RPP / PROMES / PROTA / ATP / LKPD)</h3>`;
    const closeBtn = el('button', { class: 'quantum-btn danger', html: '<i class="fas fa-times"></i> X' });
    closeBtn.style.padding = '6px 10px';
    closeBtn.addEventListener('click', ()=> { modal.remove(); overlay.remove(); });
    header.appendChild(closeBtn);

    const form = el('div', { class: 'space-y-3' });
    form.innerHTML = `
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="text-sm">Jenis Dokumen</label>
          <select id="docTypeAll" class="quantum-input glass">
            <option value="rpp">RPP</option>
            <option value="promes">PROMES (Program Semester)</option>
            <option value="prota">PROTA (Program Tahunan)</option>
            <option value="atp">ATP (Alur Tujuan Pembelajaran)</option>
            <option value="lkpd">LKPD (Inkuiri)</option>
            <option value="full">Full Paket (RPP + PROMES + PROTA + ATP + LKPD)</option>
          </select>
        </div>
        <div>
          <label class="text-sm">Kelas</label>
          <select id="docKelasAll" class="quantum-input glass">
            <option>Kelas 1</option><option>Kelas 2</option><option>Kelas 3</option><option>Kelas 4</option><option>Kelas 5</option><option>Kelas 6</option>
          </select>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="text-sm">Semester</label>
          <select id="docSemesterAll" class="quantum-input glass"><option value="1">1</option><option value="2">2</option></select>
        </div>
        <div>
          <label class="text-sm">Alokasi Waktu</label>
          <input id="docWaktuAll" class="quantum-input glass" value="2 JP" />
        </div>
      </div>

      <div>
        <label class="text-sm">Mata Pelajaran / Mapel</label>
        <input id="docMapelAll" class="quantum-input glass" placeholder="Mis: Matematika / Bahasa Indonesia / IPA" />
      </div>

      <div>
        <label class="text-sm">Topik / Materi (opsional)</label>
        <input id="docTopikAll" class="quantum-input glass" placeholder="Mis: Pecahan, Perkalian, Energi" />
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="text-sm">Model Pembelajaran</label>
          <input id="docModelAll" class="quantum-input glass" value="Inkuiri" />
        </div>
        <div>
          <label class="text-sm">Metode</label>
          <input id="docMetodeAll" class="quantum-input glass" value="Diskusi & Eksperimen" />
        </div>
      </div>

      <div>
        <label class="text-sm">Catatan Tambahan</label>
        <textarea id="docNoteAll" class="quantum-input glass" rows="3" placeholder="Catatan khusus (opsional)"></textarea>
      </div>

      <div class="flex gap-2 mt-3">
        <button id="docGenerateAll" class="quantum-btn primary">Generate & Tampilkan</button>
        <button id="docSimulateAll" class="quantum-btn secondary">Simulate Offline</button>
        <div style="flex:1"></div>
        <button id="docCancelAll" class="quantum-btn danger">Batal</button>
      </div>
    `;

    modal.appendChild(header);
    modal.appendChild(form);
    document.body.appendChild(overlay);
    document.body.appendChild(modal);

    // prefill if provided
    if(prefill.kelas && $('docKelasAll')) $('docKelasAll').value = prefill.kelas;
    if(prefill.mapel && $('docMapelAll')) $('docMapelAll').value = prefill.mapel;
    if(prefill.topik && $('docTopikAll')) $('docTopikAll').value = prefill.topik;

    // handlers
    $('docCancelAll').addEventListener('click', ()=> { modal.remove(); overlay.remove(); });
    $('docSimulateAll').addEventListener('click', ()=> {
      const params = collectForm();
      modal.remove(); overlay.remove();
      const prompt = buildPrompt(params.docType, params);
      const simHtml = `<div class="quantum-print-sheet"><div class="q-header">SIMULATED ${params.docType.toUpperCase()} - ${escapeHtml(params.kelas)}</div><div class="q-content"><pre style="white-space:pre-wrap;">${escapeHtml(prompt)}</pre></div></div>`;
      appendAiResponseToChat(simHtml, prompt, `${params.kelas}_${params.docType}_SIM`);
    });

    $('docGenerateAll').addEventListener('click', async ()=> {
      const params = collectForm();
      modal.remove(); overlay.remove();
      const msgs = $('quantumChatMessages');
      if(msgs){
        const lm = el('div',{ class:'quantum-message system', html: '<p>ðŸ”Ž Memproses permintaan... Menghubungkan ke provider AI.</p>' });
        msgs.appendChild(lm);
        msgs.scrollTop = msgs.scrollHeight;
        const prompt = buildPrompt(params.docType, params);
        const provider = ($('aiProvider') ? $('aiProvider').value : 'openai') || 'openai';
        const apiKey = ($('aiApiKey') ? $('aiApiKey').value : '') || '';
        const model = ($('aiModel') ? $('aiModel').value : '') || '';
        const temperature = parseFloat(($('aiTemperature') && $('aiTemperature').value) || 0.7);
        const maxTokens = parseInt(($('aiMaxTokens') && $('aiMaxTokens').value) || 2000, 10);

        const res = await aiCallWithFallback({ provider, model, apiKey, prompt, temperature, maxTokens });
        lm.remove();
        if(res.error){
          const err = el('div',{ class:'quantum-message system', html: `<p>âš ï¸ ${escapeHtml(res.error)}</p>` });
          msgs.appendChild(err);
          msgs.scrollTop = msgs.scrollHeight;
          // fallback simulate
          const simHtml = `<div class="quantum-print-sheet"><div class="q-header">SIMULATED ${params.docType.toUpperCase()} - ${escapeHtml(params.kelas)}</div><div class="q-content"><pre style="white-space:pre-wrap;">${escapeHtml(prompt)}</pre></div></div>`;
          appendAiResponseToChat(simHtml, prompt, `${params.kelas}_${params.docType}_SIM`);
          return;
        }
        const text = res.text || '';
        // convert to HTML for preview using Times New Roman sheet wrapper
        const html = `<div class="quantum-print-sheet"><div class="q-header">${escapeHtml(params.kelas)} - ${escapeHtml(params.docType.toUpperCase())}</div><div class="q-content">${escapeHtml(text).replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br/>')}</div><div class="q-footer">${escapeHtml(params.mapel || '')}</div></div>`;
        const fname = `${params.kelas.replace(/\s+/g,'_')}_${params.docType.toUpperCase()}_${(params.topik||'Topik').replace(/\s+/g,'_').slice(0,40)}`;
        appendAiResponseToChat(html, text, fname);
      }
    });

    function collectForm(){
      return {
        docType: $('docTypeAll').value,
        kelas: $('docKelasAll').value,
        semester: $('docSemesterAll').value,
        waktu: $('docWaktuAll').value,
        mapel: $('docMapelAll').value || '{mapel}',
        topik: $('docTopikAll').value || '{topik}',
        model: $('docModelAll').value || 'Inkuiri',
        metode: $('docMetodeAll').value || 'Diskusi & Eksperimen',
        note: $('docNoteAll').value || ''
      };
    }
  }

  /* ================== Append AI response to chat with inline action buttons ================== */
  function appendAiResponseToChat(contentHtml, rawText='', filenameBase='Document'){
    const messagesContainer = $('quantumChatMessages');
    if(!messagesContainer) return;
    const msgWrap = el('div', { class: 'quantum-message ai' });
    const inner = el('div');
    inner.innerHTML = contentHtml;
    msgWrap.appendChild(inner);

    // actions
    const actions = el('div'); actions.className = 'mt-3 flex gap-2';
    const previewBtn = el('button', { class: 'quantum-btn primary', html: '<i class="fas fa-eye"></i> Preview' }); previewBtn.style.padding='6px 10px';
    previewBtn.addEventListener('click', ()=> createPreviewModal(contentHtml, filenameBase));

    const pdfBtn = el('button', { class: 'quantum-btn secondary', html: '<i class="fas fa-file-pdf"></i> PDF' }); pdfBtn.style.padding='6px 10px';
    pdfBtn.addEventListener('click', async ()=> {
      const tmp = el('div'); tmp.style.padding='20px'; tmp.style.background='white'; tmp.innerHTML = contentHtml; tmp.style.position='fixed'; tmp.style.left='-9999px'; document.body.appendChild(tmp);
      await printHtmlToPdf(tmp, filenameBase); tmp.remove();
    });

    const docBtn = el('button', { class: 'quantum-btn success', html: '<i class="fas fa-file-word"></i> DOC' }); docBtn.style.padding='6px 10px';
    docBtn.addEventListener('click', ()=> downloadDocFromHtml(contentHtml, filenameBase));

    const qrBtn = el('button', { class: 'quantum-btn warning', html: '<i class="fas fa-qrcode"></i> QR' }); qrBtn.style.padding='6px 10px';
    qrBtn.addEventListener('click', ()=> { const url = generateQrImageUrl(rawText || contentHtml); const qrHtml = `<div style="text-align:center"><h4>QR untuk dokumen</h4><img src="${url}" style="max-width:220px"/><p style="font-size:12px;margin-top:8px">Scan untuk membuka/menyimpan</p></div>`; createPreviewModal(qrHtml, 'QR Kode'); });

    actions.appendChild(previewBtn); actions.appendChild(pdfBtn); actions.appendChild(docBtn); actions.appendChild(qrBtn);
    msgWrap.appendChild(actions);

    messagesContainer.appendChild(msgWrap);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  /* ================== Preview Modal & PDF/DOC utils ================== */
  function createPreviewModal(htmlContent, title='Preview Dokumen'){
    const exist = $('quantumPreviewModalAll'); if(exist) exist.remove();
    const overlay = el('div', { class: 'quantum-sidebar-overlay active' }); overlay.id='quantumPreviewOverlayAll'; overlay.style.zIndex = 17000;
    const modal = el('div', { class: 'quantum-card glass p-6' }); modal.id = 'quantumPreviewModalAll';
    Object.assign(modal.style, { position:'fixed', left:'50%', top:'50%', transform:'translate(-50%,-50%)', width:'84vw', maxWidth:'940px', maxHeight:'92vh', overflow:'auto', zIndex:17001, borderRadius:'12px' });

    const header = el('div',{ class: 'flex justify-between items-center mb-4' }); header.innerHTML = `<h3 style="font-weight:800">${escapeHtml(title)}</h3>`;
    const closeBtn = el('button',{ class:'quantum-btn danger', html:'<i class="fas fa-times"></i> x' }); closeBtn.style.padding='6px 10px'; closeBtn.addEventListener('click', ()=> { modal.remove(); overlay.remove(); });
    header.appendChild(closeBtn);

    const contentWrap = el('div',{ class:'prose', html: htmlContent });
    contentWrap.style.background = 'white';
    contentWrap.style.padding = '20px';
    contentWrap.style.color = '#111';
    contentWrap.style.borderRadius = '6px';
    contentWrap.style.boxShadow = '0 4px 20px rgba(0,0,0,0.08)';
    contentWrap.style.fontFamily = '"Times New Roman", Times, serif';

    const actions = el('div',{ class:'flex gap-3 mt-4' });
    const btnPdf = el('button',{ class:'quantum-btn primary', text: 'Download PDF' }); btnPdf.addEventListener('click', ()=> printHtmlToPdf(contentWrap, title.replace(/\s+/g,'_')));
    const btnDoc = el('button',{ class:'quantum-btn secondary', text: 'Download DOC' }); btnDoc.addEventListener('click', ()=> downloadDocFromHtml(contentWrap.innerHTML, title.replace(/\s+/g,'_')));
    actions.appendChild(btnPdf); actions.appendChild(btnDoc);

    modal.appendChild(header); modal.appendChild(contentWrap); modal.appendChild(actions);
    document.body.appendChild(overlay); document.body.appendChild(modal);
  }

  async function printHtmlToPdf(element, filename='document'){
    try{
      // inject print styles for Times New Roman A4
      const styleTag = document.createElement('style'); styleTag.id='quantumPrintStyleAll'; styleTag.innerHTML = PRINT_STYLE; document.head.appendChild(styleTag);
      const canvas = await html2canvas(element, { scale:2, useCORS:true, scrollY:-window.scrollY });
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p','mm','a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      pdf.addImage(imgData,'PNG',8,8,pageWidth-16, (canvas.height*(pageWidth-16))/canvas.width);
      pdf.save(`${filename}.pdf`);
      // cleanup style
      const s = document.getElementById('quantumPrintStyleAll'); if(s) s.remove();
    }catch(err){ alert('Gagal membuat PDF: '+err.message); }
  }

  function downloadDocFromHtml(html, filename='document'){
    const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>"+filename+"</title>";
    const style = `<style>body{font-family: 'Times New Roman', Times, serif; font-size:12pt;}</style></head><body>`;
    const footer="
<!-- NAJIB OPTIMIZER PATCH v1.0 (Fonts + Particle Optimizer + Cinematic Modes + Child-suite soft-mode) -->
<script id="najib-optimizer-patch">
(function(){
'use strict';
/*** UTIL: capability detection ***/
function detectCapsSafe(){
try{
if(window.__NAJIB_CAPS) return window.__NAJIB_CAPS;
const caps = { cores: navigator.hardwareConcurrency||2, mem: navigator.deviceMemory||2, dpr: window.devicePixelRatio||1, webgl:false, webgl2:false };
try{
const c=document.createElement('canvas');
const g2 = c.getContext && c.getContext('webgl2');
const g = g2 || (c.getContext && (c.getContext('webgl')||c.getContext('experimental-webgl')));
if(g){ caps.webgl = !!g; caps.webgl2 = !!g2; }
}catch(e){}
let score=0;
if(caps.cores>=8) score+=30; else if(caps.cores>=4) score+=18; else score+=8;
if(caps.mem>=8) score+=30; else if(caps.mem>=4) score+=18; else score+=6;
if(caps.webgl2) score+=30; else if(caps.webgl) score+=16;
caps.score = score;
if(caps.cores<=2 || caps.mem<=1 || caps.score<24) caps.profile='low';
else if((caps.cores<=4 && caps.mem<=3) || caps.score<48) caps.profile='mid';
else caps.profile='high';
window.__NAJIB_CAPS = caps;
return caps;
}catch(e){
return { profile:'low', cores:2, mem:1, dpr:1 };
}
}
const CAPS = detectCapsSafe();

/***** 1) FONT LAZY LOADER *****/
(function lazyFonts(){
try{
const heavyLinks = Array.from(document.querySelectorAll('link[href*="fonts.googleapis.com"], link[href*="fonts.gstatic.com"]'));
if(!heavyLinks.length) return;
if(CAPS.profile === 'low' || window.matchMedia('(prefers-reduced-data: reduce)').matches){
heavyLinks.forEach(l => { l.media='print'; l.setAttribute('data-deferred','1'); });
return;
}
function loadHeavyFonts(){
heavyLinks.forEach(l=>{
if(l.getAttribute('data-deferred')) return;
l.rel = 'stylesheet';
l.removeAttribute('media');
l.setAttribute('data-loaded-by','najib-optimizer');
});
}
if('requestIdleCallback' in window){
requestIdleCallback(loadHeavyFonts, {timeout:3000});
} else {
const onFirst = function(){ loadHeavyFonts(); window.removeEventListener('pointerdown', onFirst); window.removeEventListener('touchstart', onFirst); };
window.addEventListener('pointerdown', onFirst, {once:true});
window.addEventListener('touchstart', onFirst, {once:true});
setTimeout(loadHeavyFonts, 6000);
}
}catch(e){ console.warn('[najib-optimizer] lazyFonts failed', e); }
})();

/***** 2) PARTICLE SMART OPTIMIZER *****/
(function particleOptimizer(){
try{
const container = document.getElementById('quantumParticles') || document.querySelector('.quantum-particles');
if(!container) return;
function makeParticle(cls, x, y, size, content){
const el = document.createElement('div');
el.className = 'particle ' + cls;
el.style.left = (x*100).toFixed(2) + 'vw';
el.style.top = (y*100).toFixed(2) + 'vh';
el.style.width = size + 'px';
el.style.height = size + 'px';
if(content) { el.textContent = content; el.classList.add('particle-codeRain'); el.style.fontSize = Math.max(10, size) + 'px'; el.style.width = 'auto'; el.style.height = 'auto'; }
return el;
}
const baseCounts = {
goldenFloat: 28, blackPulse: 20, redSword: 22, shapeShifter: 20,
codeRain: 36, oceanWave: 26, neonPulse: 24, roseFloat: 24
};
const scaleMap = { high:1, mid:0.45, low:0.08 };
const profile = CAPS.profile || 'low';
const scale = scaleMap[profile] || 0.45;
const reduceEffects = (profile === 'low' || window.matchMedia('(prefers-reduced-motion: reduce)').matches);

window.renderParticlesForTheme = function(themeKey){
try{
const t = themeKey || 'goldenFloat';
const mapName = {
goldenFloat:'goldenFloat', blackPulse:'blackPulse', redSword:'redSword',
shapeShifter:'shapeShifter', codeRain:'codeRain', oceanWave:'oceanWave',
neonPulse:'neonPulse', roseFloat:'roseFloat'
}[t] || 'goldenFloat';
const base = baseCounts[mapName] || 18;
const count = Math.max( Math.round(base*scale), (reduceEffects ? 0 : 2) );
container.innerHTML = '';
if(count === 0){
const accent = document.createElement('div');
accent.className = 'particle particle-neonPulse';
accent.style.left = '50%';
accent.style.top = '80%';
accent.style.width = '4px';
accent.style.height = '4px';
accent.style.opacity = '0.6';
accent.style.pointerEvents = 'none';
container.appendChild(accent);
return;
}
const fragment = document.createDocumentFragment();
for(let i=0;i<count;i++){
const x = Math.random(); const y = Math.random();
const size = (mapName==='codeRain' ? Math.max(10, Math.round(Math.random()*14+6)) : Math.round(Math.random()*(reduceEffects?4:8) + (reduceEffects?2:2)));
const p = makeParticle('particle-'+mapName, x, y, size, mapName==='codeRain'? (Math.random()>0.7?String.fromCharCode(0x30A0 + Math.floor(Math.random()*96)) : '') : '');
if(reduceEffects){
p.style.boxShadow = 'none';
p.style.filter = 'none';
p.style.animationDuration = '8s';
}
fragment.appendChild(p);
}
container.appendChild(fragment);
}catch(e){ console.warn('[najib-optimizer] renderParticlesForTheme fail', e); }
};

try{
const saved = (JSON.parse(localStorage.getItem('najib_saved_themes')||'[]') || [])[0];
const initialTheme = saved ? (saved.variables && saved.variables.particleTheme) : 'goldenFloat';
setTimeout(()=>{ try{ window.renderParticlesForTheme(initialTheme); }catch(e){} }, 300);
}catch(e){}

window.__najib_particle_optimizer = { profile: CAPS.profile, reducedEffects: reduceEffects };

}catch(e){ console.warn('[najib-optimizer] particleOptimizer top fail', e); }
})();

/***** 3) CINEMATIC MODULAR MODE *****/
(function cinematicModular(){
try{
const ROOT = document.getElementById('stl-open');
if(!ROOT) return;
const mode = CAPS.profile || 'low';
ROOT.setAttribute('data-cinematic-mode', mode);

function applyMode(){
if(mode === 'low'){
const chrom = document.querySelector('.stl-chromatic');
if(chrom) chrom.style.display = 'none';
const scan = document.getElementById('stl-scan');
if(scan) { scan.style.animationDuration = '12s'; scan.style.opacity='0.12'; }
const TITLE = document.getElementById('stl-title');
const TAG = document.getElementById('stl-tag');
if(TITLE) TITLE.style.transition='opacity .6s ease';
if(TAG) TAG.style.transition='opacity .6s ease';
setTimeout(()=>{ try{ ROOT.style.opacity='0'; setTimeout(()=>{ try{ ROOT.remove(); }catch(e){ ROOT.style.display='none'; } }, 550); }catch(e){} }, 900);
}
else if(mode === 'mid'){
const scan = document.getElementById('stl-scan'); if(scan) scan.style.opacity='0.22';
const fract = document.querySelector('.stl-fractal'); if(fract) fract.style.opacity='0.7';
setTimeout(()=>{ try{ ROOT.style.opacity='0'; setTimeout(()=>{ try{ ROOT.remove(); }catch(e){ ROOT.style.display='none'; } }, 900); }catch(e){} }, 4000);
}
}
applyMode();
window.__najib_cinematic_force = function(lvl){
try{ if(!lvl) return; ROOT.setAttribute('data-cinematic-mode', lvl); location.reload(); }catch(e){}
};
}catch(e){ console.warn('[najib-optimizer] cinematicModular fail', e); }
})();

/***** 4) CHILD-SUITE SOFT MODE *****/
(function softenChildSuite(){
try{
(function installSoftObserver(){
let throttleAt = 0;
let backoffMs = 1000;
const whitelist = ['#stl-open','#quantumParticles','#quantumIsland','.quantum-sidebar','.quantum-tools-sidebar'];
const safeCheck = (node)=>{
try{
if(!node || node.nodeType !== 1) return true;
for(const s of whitelist){
try{ if(node.matches && node.matches(s) || (node.closest && node.closest(s))) return true; }catch(e){}
}
const tag = (node.tagName||'').toLowerCase();
if(['div','span','script','style','link','meta','img','svg'].indexOf(tag) !== -1) return true;
return false;
}catch(e){ return true; }
};
const mo = new MutationObserver((mutations)=>{
const now = Date.now();
if(now - throttleAt < backoffMs) return;
throttleAt = now;
let flagged = false;
for(const m of mutations){
for(const n of (m.addedNodes||[])){
if(!safeCheck(n)) flagged = true;
}
}
if(flagged){
console.info('[najib-softObserver] suspicious DOM additions detected');
setTimeout(()=>{ try{ if(window.DEV_mg && typeof window.DEV_mg.auditProtections === 'function') window.DEV_mg.auditProtections({soft:true}); }catch(e){} }, 1200);
backoffMs = Math.min(60000, Math.max(2000, backoffMs * 1.5));
} else {
backoffMs = Math.max(1000, Math.floor(backoffMs*0.9));
}
});
try{
mo.observe(document.documentElement || document.body, { childList:true, subtree:true });
window.__najib_soft_mo = mo;
}catch(e){}
})();
}catch(e){ console.warn('[najib-optimizer] softenChildSuite fail', e); }
})();

/***** 5) REPORT SUMMARY *****/
try{
console.info('[najib-optimizer] applied. profile=%s', CAPS.profile);
}catch(e){}
})();
</script>
<!-- END NAJIB OPTIMIZER PATCH -->
</body>
</html>";
    const sourceHTML = header + style + html + footer;
    const blob = new Blob(['\ufeff', sourceHTML], { type: 'application/msword' });
    if(window.saveAs) saveAs(blob, `${filename}.doc`);
    else { const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `${filename}.doc`; document.body.appendChild(link); link.click(); link.remove(); }
  }

  function generateQrImageUrl(text, size=240){ const enc = encodeURIComponent(text); return `https://chart.googleapis.com/chart?cht=qr&chs=${size}x${size}&chl=${enc}&chld=L|1`; }

  /* ================== Suppress visible "chat history saved" notif & background autosave ================== */
  (function overrideAutoSaveNotif(){
    // If the app triggers a function like showNotification('chat history saved'), try to intercept common patterns.
    // 1) Override window-level function if exists
    const suppressedTexts = ['chat history saved','history saved','chat saved','saved chat'];
    // override common show/hide notification functions if present
    ['showNotification','notify','toast','showToast','showAlert'].forEach(fn=>{
      try {
        if(window[fn] && typeof window[fn] === 'function'){
          const orig = window[fn];
          window[fn] = function(title, message, opts){
            // if message contains suppressed pattern, swallow; otherwise call original
            const m = (message||'').toString().toLowerCase();
            if(suppressedTexts.some(t => m.includes(t))) {
              // perform silent save behaviour if needed (no UI)
              console.debug('[suppressed notif]', message);
              return; // swallow
            }
            return orig.apply(this, arguments);
          };
        }
      } catch(e){}
    });

    // 2) Observe DOM for elements containing these texts and hide them immediately
    const observer = new MutationObserver(muts => {
      muts.forEach(m => {
        (m.addedNodes || []).forEach(node => {
          try {
            if(node.nodeType === 1){
              const txt = node.innerText && node.innerText.toLowerCase();
              if(txt && suppressedTexts.some(t => txt.includes(t))){
                node.style.display = 'none';
                console.debug('[suppressed DOM notif]', txt);
              }
            }
          } catch(e){}
        });
      });
    });
    observer.observe(document.body, { childList:true, subtree:true });
    // 3) If app uses local autosave timer, we won't remove saving logic; we only hide visual indicators.
  })();

  /* ================== Attach integration to input send flow & slash command support ================== */
  function attachIntegration(){
    createTinyTrigger();
    const inputEl = $('quantumChatInput');
    const sendBtn = $('sendQuantumMessage');
    if(!inputEl || !sendBtn) return;

    // send button listener for slash commands (non-intrusive)
    if(!sendBtn.__rpp_allin_attached){
      sendBtn.__rpp_allin_attached = true;
      sendBtn.addEventListener('click', async (e) => {
        const val = (inputEl.value || '').trim();
        if(!val) return;
        // support: /buat, /rpp, /generate triggers modal prefill
        const triggers = ['/buat','/rpp','/generate','/create'];
        const lower = val.toLowerCase();
        if(triggers.some(t => lower.startsWith(t))){
          // prefill with extraction and open modal
          const pre = extractSimpleParams(val);
          openDocModal({ kelas: pre.kelas, mapel: pre.mapel !== '{mapel}' ? pre.mapel : '', topik: pre.topik !== '{topik}' ? pre.topik : '' });
          inputEl.value = '';
          return;
        }
        // otherwise send as normal (preserve engine behavior)
        if(window.quantumEngine && typeof window.quantumEngine.addMessageToChat === 'function'){
          window.quantumEngine.addMessageToChat('user', val);
        } else {
          // fallback: append
          const m = el('div',{ class:'quantum-message user', text: val }); const msgs = $('quantumChatMessages'); if(msgs) msgs.appendChild(m);
        }
        inputEl.value = '';
        // if message contains keywords, auto open modal (non-blocking)
        const intent = detectIntent(val);
        if(intent) {
          setTimeout(()=> openDocModal(extractSimpleParams(val)), 200);
        }
      });
    }

    // Enter key
    if(!inputEl.__rpp_allin_key){
      inputEl.__rpp_allin_key = true;
      inputEl.addEventListener('keypress', (e) => {
        if(e.key === 'Enter' && !e.shiftKey){
          e.preventDefault();
          const val = (inputEl.value || '').trim();
          if(!val) return;
          const triggers = ['/buat','/rpp','/generate','/create'];
          const lower = val.toLowerCase();
          if(triggers.some(t => lower.startsWith(t))){
            const pre = extractSimpleParams(val);
            openDocModal({ kelas: pre.kelas, mapel: pre.mapel !== '{mapel}' ? pre.mapel : '', topik: pre.topik !== '{topik}' ? pre.topik : '' });
            inputEl.value = '';
            return;
          }
          if(window.quantumEngine && typeof window.quantumEngine.addMessageToChat === 'function'){
            window.quantumEngine.addMessageToChat('user', val);
          } else {
            const m = el('div',{ class:'quantum-message user', text: val }); const msgs = $('quantumChatMessages'); if(msgs) msgs.appendChild(m);
          }
          inputEl.value = '';
          const intent = detectIntent(val);
          if(intent) setTimeout(()=> openDocModal(extractSimpleParams(val)), 200);
        }
      });
    }
  }

  /* ================== Observe DOM readiness and init ================== */
  function initWhenReady(){
    attachIntegration();
    // ensure trigger present after SPA re-renders
    const bodyObs = new MutationObserver(()=> { createTinyTrigger(); });
    bodyObs.observe(document.body, { childList:true, subtree:true });
  }
  if(document.readyState === 'complete' || document.readyState === 'interactive') setTimeout(initWhenReady, 200);
  else document.addEventListener('DOMContentLoaded', ()=> setTimeout(initWhenReady,200));

  /* ================== Expose small API for devs/testing ================== */
  window.quantumRppAllIn = {
    openDocModal, createTinyTrigger, aiCallWithFallback, buildPrompt
  };

  /* ================== End injection ================== */
})();
</script>
<!-- ==================== INJECTION PATCH: Silent-save + Compact + Queue + Mongo UI ==================== -->
<script>
(function(){
  if(window.__quantum_patch_allin) return; window.__quantum_patch_allin = true;

  const $ = id => document.getElementById(id);
  const el = (t,opts={}) => { const e=document.createElement(t); if(opts.class) e.className=opts.class; if(opts.html) e.innerHTML=opts.html; if(opts.text) e.textContent=opts.text; if(opts.styles) Object.assign(e.style, opts.styles); return e; };

  /* ===================== 1) STRONG SUPPRESS "chat history saved" ===================== */
  (function suppressSavedNotif(){
    // common notification function names
    const suppressedTexts = ['chat history saved','history saved','chat saved','saved chat','saved'];
    const overrideIfExists = (name) => {
      try {
        if(window[name] && typeof window[name] === 'function') {
          const orig = window[name];
          window[name] = function(...args){
            // check args for suppressed text
            try {
              const combined = args.join(' ').toString().toLowerCase();
              if(suppressedTexts.some(t => combined.includes(t))){
                // swallow silently
                console.debug('[suppressed notif via func]', name, combined);
                return;
              }
            } catch(e){}
            return orig.apply(this,args);
          };
        }
      } catch(e){}
    };

    ['showNotification','notify','toast','showToast','showAlert','emitToast','showStatus'].forEach(overrideIfExists);

    // Hide DOM nodes that contain the text (CSS + observer)
    const style = document.createElement('style');
    style.id = 'quantum_suppress_saved_css';
    style.innerHTML = `
      .quantum-suppressed-toast { display:none !important; visibility:hidden !important; opacity:0 !important; }
    `;
    document.head.appendChild(style);

    // MutationObserver to hide elements that include suppressed texts
    const obs = new MutationObserver(muts => {
      muts.forEach(m => {
        (m.addedNodes || []).forEach(node => {
          try {
            if(node.nodeType === 1){
              const txt = (node.innerText || '').toLowerCase();
              if(txt && suppressedTexts.some(t => txt.includes(t))){
                node.classList.add('quantum-suppressed-toast');
                node.style.display = 'none';
              }
              // also inspect children
              node.querySelectorAll && node.querySelectorAll('*').forEach(ch => {
                const ctxt = (ch.innerText||'').toLowerCase();
                if(ctxt && suppressedTexts.some(t => ctxt.includes(t))){
                  ch.classList.add('quantum-suppressed-toast');
                  ch.style.display = 'none';
                }
              });
            }
          } catch(e){}
        });
      });
    });
    obs.observe(document.body, { childList:true, subtree:true });

    // If the app exposes quantumEngine.saveChatHistory, wrap it to silent mode
    try {
      if(window.quantumEngine && typeof window.quantumEngine.saveChatHistory === 'function'){
        const origSave = window.quantumEngine.saveChatHistory.bind(window.quantumEngine);
        window.quantumEngine.saveChatHistory = function(...args){
          // call original but suppress any UI side effects by preventing emission
          try {
            // If original returns a Promise, don't show any UI notifications even if they try to call them later
            const res = origSave(...args);
            return res;
          } catch(e){
            console.warn('saveChatHistory error (suppressed UI)', e);
          }
        };
      }
    } catch(e){ console.warn('wrap saveChatHistory failed', e); }
  })();

  /* ===================== 2) AUTO-COMPACT localStorage: B + C ===================== */
  (function autoCompactStorage(){
    const KEY_PREFIX = 'quantum_chat_history_'; // adapt if needed
    const MAX_ITEMS = 200;
    const MAX_BYTES = 5 * 1024 * 1024; // 5MB
    const INDEX_KEY = '__quantum_chat_index_list';

    // helper: estimate byte size of string
    function sizeOfString(s){ return new Blob([s]).size; }

    function getIndex(){
      try { return JSON.parse(localStorage.getItem(INDEX_KEY) || '[]'); } catch(e){ return []; }
    }
    function setIndex(idx){ localStorage.setItem(INDEX_KEY, JSON.stringify(idx)); }

    function compactIfNeeded(){
      try {
        const index = getIndex(); // array of keys in chronological order oldest->newest
        // 1) If count > MAX_ITEMS, drop oldest
        while(index.length > MAX_ITEMS){
          const k = index.shift();
          try { localStorage.removeItem(k); } catch(e){}
        }
        // 2) If total bytes > MAX_BYTES, remove oldest until under limit
        let total = 0;
        for(const k of index){
          const v = localStorage.getItem(k) || '';
          total += sizeOfString(v) + sizeOfString(k);
        }
        while(total > MAX_BYTES && index.length){
          const k = index.shift();
          const v = localStorage.getItem(k) || '';
          total -= (sizeOfString(v) + sizeOfString(k));
          try { localStorage.removeItem(k); } catch(e){}
        }
        setIndex(index);
      } catch(e){
        console.warn('compactIfNeeded error', e);
      }
    }

    // Hook: when chat is saved to localStorage, ensure index is updated
    function registerSaveHook(){
      // We'll override localStorage.setItem to detect saved chat keys (best-effort)
      try {
        const origSet = Storage.prototype.setItem;
        Storage.prototype.setItem = function(k, v){
          try {
            // if key looks like chat history or starts with prefix, add to index
            if(k && (k.startsWith(KEY_PREFIX) || k.toLowerCase().includes('chat') || k.toLowerCase().includes('history'))){
              const index = getIndex();
              // if key already exists, move to end
              const existIdx = index.indexOf(k);
              if(existIdx !== -1) index.splice(existIdx, 1);
              index.push(k);
              setIndex(index);
            }
          } catch(e){}
          // call original
          return origSet.apply(this, [k, v]);
        };
      } catch(e){ console.warn('override localStorage.setItem failed', e); }

      // Periodic compaction (every 5 minutes default, adjustable)
      const COMPACT_INTERVAL_MS = 5 * 60 * 1000; // 5 minutes
      setInterval(compactIfNeeded, COMPACT_INTERVAL_MS);

      // Also run at load
      setTimeout(compactIfNeeded, 1000);
    }

    registerSaveHook();
  })();

  /* ===================== 3) API QUEUE + THROTTLE (1.5s) ===================== */
  (function apiQueueThrottle(){
    const QUEUE_DELAY_MS = 1500; // 1.5s between tasks
    const queue = [];
    let running = false;

    async function processQueue(){
      if(running) return;
      running = true;
      while(queue.length){
        const job = queue.shift();
        try {
          await job.fn(...(job.args||[]));
        } catch(e){
          console.warn('queued job error', e);
        }
        // throttle
        await new Promise(resolve => setTimeout(resolve, QUEUE_DELAY_MS));
      }
      running = false;
    }

    // Wrap existing aiCallWithFallback if exists (from previous injects)
    const wrapIfExists = (obj, name) => {
      try {
        const orig = obj && obj[name];
        if(orig && typeof orig === 'function' && !orig.__wrapped_by_queue){
          const wrapped = function(...args){
            return new Promise((resolve, reject) => {
              queue.push({ fn: async () => {
                try {
                  const res = await orig.apply(obj, args);
                  resolve(res);
                } catch(err){ reject(err); }
              }, args: [] });
              processQueue();
            });
          };
          wrapped.__wrapped_by_queue = true;
          obj[name] = wrapped;
        }
      } catch(e){}
    };

    // Try several known namespaces
    try { wrapIfExists(window, 'aiCallWithFallback'); } catch(e){}
    try { if(window.quantumRppV2) wrapIfExists(window.quantumRppV2, 'aiCallWithFallback'); } catch(e){}
    try { if(window.quantumRppAllIn) wrapIfExists(window.quantumRppAllIn, 'aiCallWithFallback'); } catch(e){}
    try { if(window.quantumRpp) wrapIfExists(window.quantumRpp, 'callAI'); } catch(e){}

    // Fallback: provide a global queuedCaller that other scripts can call
    window.__quantumQueuedCall = async function(fn, ...args){
      return new Promise((resolve,reject) => {
        queue.push({ fn: async ()=> { try { const r = await fn(...args); resolve(r); } catch(e){ reject(e); } } });
        processQueue();
      });
    };
  })();

  /* ===================== 4) Tools Sidebar: MongoDB UI (URI input + Save button + suggested password) ===================== */
  (function injectMongoUi(){
    // find tools sidebar
    const sidebar = document.getElementById('quantumToolsSidebar') || document.querySelector('.quantum-tools-sidebar') || document.querySelector('.tools-sidebar') || null;
    if(!sidebar) return;

    // Avoid duplicate
    if(document.getElementById('quantumMongoCard')) return;

    // create card
    const card = el('div', { class: 'quantum-card glass p-4' });
    card.id = 'quantumMongoCard';
    card.style.marginBottom = '12px';
    card.innerHTML = `
      <h4 style="font-weight:800; margin-bottom:6px;">Simpan Chat ke MongoDB Pribadi</h4>
      <label class="text-sm">MongoDB URI (mongodb+srv://...)</label>
      <input id="mongoUriInput" class="quantum-input glass" placeholder="mongodb+srv://user:pass@cluster.mongodb.net/dbname" />
      <label class="text-sm" style="margin-top:6px">Collection (opsional)</label>
      <input id="mongoCollInput" class="quantum-input glass" placeholder="collection_name (default: user_chats)" />
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button id="mongoSaveBtn" class="quantum-btn primary">Simpan ke Mongo</button>
        <button id="mongoTestBtn" class="quantum-btn secondary">Test Koneksi</button>
      </div>
      <div style="margin-top:8px;">
        <small class="text-sm opacity-70">Password encryption suggestion:</small>
        <div style="display:flex; align-items:center; gap:8px; margin-top:6px;">
          <input id="mongoPassSuggest" class="quantum-input glass" readonly style="flex:1" />
          <button id="mongoCopyPass" class="quantum-btn">Copy</button>
        </div>
        <div style="margin-top:6px;"><small class="text-sm opacity-60">(Password digunakan untuk enkripsi payload sebelum disimpan. Kamu bisa ganti.)</small></div>
      </div>
      <div id="mongoStatus" style="margin-top:8px; font-size:13px; color:#666"></div>
    `;
    // prepend for visibility
    
// ==== FORCE INSERT after "stl-AIchat Tools" header ====
try {
  (function(){
    const sidebarEl = (typeof sidebar !== 'undefined' ? sidebar : (typeof tools !== 'undefined' ? tools : document.getElementById('quantumToolsSidebar')));
    if (!sidebarEl) {
      // fallback: try to find by id
      sidebarEl = document.getElementById('quantumToolsSidebar') || document.querySelector('.quantum-tools-sidebar') || document.querySelector('.tools-sidebar');
    }
    if (sidebarEl && card) {
      const headers = Array.from(sidebarEl.querySelectorAll('h3'));
      let header = headers.find(h => h.innerText && h.innerText.toLowerCase().includes('stl-aichat tools'));
      if (!header) {
        // try alternative text match
        header = headers.find(h => h.innerText && h.innerText.toLowerCase().includes('stl-aichat'));
      }
      if (header) {
        const parentCard = header.closest('.quantum-card') || header.parentElement;
        if (parentCard) {
          parentCard.insertAdjacentElement('afterend', card);
          console.log('âœ… Card inserted after stl-AIchat Tools header');
        } else {
          sidebarEl.appendChild(card);
          console.warn('âš  parentCard not found; appended to sidebar');
        }
      } else {
        // try to find Export Data card and insert after it
        const exportCard = sidebarEl.querySelector('.quantum-card .fa-download') ? sidebarEl.querySelector('.quantum-card .fa-download').closest('.quantum-card') : null;
        if (exportCard) {
          exportCard.insertAdjacentElement('afterend', card);
          console.log('âœ… Card inserted after Export Data');
        } else {
          sidebarEl.appendChild(card);
          console.warn('âš  Header not found; appended to sidebar');
        }
      }
    }
  })();
} catch(e){
  try { sidebar.appendChild(card); } catch(err){ console.warn('final fallback append failed', err); }
}

    // Suggest password derived from words (apply substitution A->4, S->5, I->1)
    function makeCreativePassword(){
      const words = ['najib','27','09','1996','sidoarjo','salam','wahidus'];
      // combine and apply substitution A,S,I -> 4,5,1 (case-insensitive)
      const base = words.join('-');
      const subst = { 'a':'4','A':'4','s':'5','S':'5','i':'1','I':'1' };
      let out = '';
      for(const ch of base){
        out += (subst[ch] !== undefined ? subst[ch] : ch);
      }
      // shuffle a bit and append random chars
      const rand = Math.random().toString(36).slice(2,8);
      out = out + '-' + rand;
      return out;
    }

    const passEl = document.getElementById('mongoPassSuggest');
    if(passEl) passEl.value = makeCreativePassword();
    const copyBtn = document.getElementById('mongoCopyPass');
    if(copyBtn && passEl){
      copyBtn.addEventListener('click', ()=> {
        navigator.clipboard && navigator.clipboard.writeText(passEl.value);
        copyBtn.textContent = 'Copied';
        setTimeout(()=> copyBtn.textContent = 'Copy', 1500);
      });
    }

    // Test connection (calls backend proxy '/user/testMongo' which tries to connect using the provided URI)
    const testBtn = document.getElementById('mongoTestBtn');
    const saveBtn = document.getElementById('mongoSaveBtn');
    const status = document.getElementById('mongoStatus');

    testBtn && testBtn.addEventListener('click', async ()=>{
      const uri = document.getElementById('mongoUriInput').value.trim();
      if(!uri){ status.textContent = 'Masukkan MongoDB URI dulu.'; return; }
      status.textContent = 'Menghubungi proxy server...';
      try {
        const r = await fetch('/user/testMongo', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ uri }) });
        const j = await r.json();
        if(r.ok) { status.style.color = 'green'; status.textContent = 'Koneksi OK: ' + (j.message || 'connected'); }
        else { status.style.color = 'crimson'; status.textContent = 'Error: ' + (j.error || 'failed'); }
      } catch(e){ status.style.color = 'crimson'; status.textContent = 'Gagal kontak proxy: '+ e.message; }
    });

    // Save: get latest chat from app and send to backend encrypt/stored under user's provided URI
    saveBtn && saveBtn.addEventListener('click', async ()=>{
      const uri = document.getElementById('mongoUriInput').value.trim();
      const coll = document.getElementById('mongoCollInput').value.trim() || 'user_chats';
      const pass = document.getElementById('mongoPassSuggest').value.trim();
      if(!uri){ status.style.color='crimson'; status.textContent='Masukkan MongoDB URI dulu.'; return; }
      status.style.color='#666'; status.textContent='Mengambil chat terakhir...';
      // collect chat messages from DOM if possible
      let chatPayload = null;
      try {
        // try quantumEngine.history if exists
        if(window.quantumEngine && typeof window.quantumEngine.getChatHistory === 'function'){
          chatPayload = await window.quantumEngine.getChatHistory();
        } else {
          // fallback: parse DOM bubbles (best-effort)
          const msgs = document.querySelectorAll('.quantum-message');
          const arr = [];
          msgs.forEach(m => {
            const role = m.classList.contains('user') ? 'user' : (m.classList.contains('ai') ? 'assistant' : 'system');
            arr.push({ role, text: m.innerText || m.textContent || '' });
          });
          chatPayload = { messages: arr, title: document.title || 'Chat Export', createdAt: Date.now() };
        }
      } catch(e){ chatPayload = { messages:[], error:'failed to read chat' }; }

      status.textContent = 'Mengirim ke proxy untuk disimpan...';
      try {
        const r = await fetch('/user/saveChat', {
          method: 'POST', headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ uri, collection: coll, password: pass, payload: chatPayload })
        });
        const j = await r.json();
        if(r.ok){ status.style.color='green'; status.textContent = 'Sukses: ' + (j.message || 'saved'); }
        else { status.style.color='crimson'; status.textContent = 'Gagal: ' + (j.error || 'error'); }
      } catch(e){ status.style.color='crimson'; status.textContent = 'Gagal kontak proxy: '+ e.message; }
    });

  })();

  /* ===================== END PATCH ===================== */

})();
</script>
<!-- === FRONTEND: Encrypted URI/API-key + Backup UI (PASTE BEFORE 
<!-- NAJIB OPTIMIZER PATCH v1.0 (Fonts + Particle Optimizer + Cinematic Modes + Child-suite soft-mode) -->
<script id="najib-optimizer-patch">
(function(){
'use strict';
/*** UTIL: capability detection ***/
function detectCapsSafe(){
try{
if(window.__NAJIB_CAPS) return window.__NAJIB_CAPS;
const caps = { cores: navigator.hardwareConcurrency||2, mem: navigator.deviceMemory||2, dpr: window.devicePixelRatio||1, webgl:false, webgl2:false };
try{
const c=document.createElement('canvas');
const g2 = c.getContext && c.getContext('webgl2');
const g = g2 || (c.getContext && (c.getContext('webgl')||c.getContext('experimental-webgl')));
if(g){ caps.webgl = !!g; caps.webgl2 = !!g2; }
}catch(e){}
let score=0;
if(caps.cores>=8) score+=30; else if(caps.cores>=4) score+=18; else score+=8;
if(caps.mem>=8) score+=30; else if(caps.mem>=4) score+=18; else score+=6;
if(caps.webgl2) score+=30; else if(caps.webgl) score+=16;
caps.score = score;
if(caps.cores<=2 || caps.mem<=1 || caps.score<24) caps.profile='low';
else if((caps.cores<=4 && caps.mem<=3) || caps.score<48) caps.profile='mid';
else caps.profile='high';
window.__NAJIB_CAPS = caps;
return caps;
}catch(e){
return { profile:'low', cores:2, mem:1, dpr:1 };
}
}
const CAPS = detectCapsSafe();

/***** 1) FONT LAZY LOADER *****/
(function lazyFonts(){
try{
const heavyLinks = Array.from(document.querySelectorAll('link[href*="fonts.googleapis.com"], link[href*="fonts.gstatic.com"]'));
if(!heavyLinks.length) return;
if(CAPS.profile === 'low' || window.matchMedia('(prefers-reduced-data: reduce)').matches){
heavyLinks.forEach(l => { l.media='print'; l.setAttribute('data-deferred','1'); });
return;
}
function loadHeavyFonts(){
heavyLinks.forEach(l=>{
if(l.getAttribute('data-deferred')) return;
l.rel = 'stylesheet';
l.removeAttribute('media');
l.setAttribute('data-loaded-by','najib-optimizer');
});
}
if('requestIdleCallback' in window){
requestIdleCallback(loadHeavyFonts, {timeout:3000});
} else {
const onFirst = function(){ loadHeavyFonts(); window.removeEventListener('pointerdown', onFirst); window.removeEventListener('touchstart', onFirst); };
window.addEventListener('pointerdown', onFirst, {once:true});
window.addEventListener('touchstart', onFirst, {once:true});
setTimeout(loadHeavyFonts, 6000);
}
}catch(e){ console.warn('[najib-optimizer] lazyFonts failed', e); }
})();

/***** 2) PARTICLE SMART OPTIMIZER *****/
(function particleOptimizer(){
try{
const container = document.getElementById('quantumParticles') || document.querySelector('.quantum-particles');
if(!container) return;
function makeParticle(cls, x, y, size, content){
const el = document.createElement('div');
el.className = 'particle ' + cls;
el.style.left = (x*100).toFixed(2) + 'vw';
el.style.top = (y*100).toFixed(2) + 'vh';
el.style.width = size + 'px';
el.style.height = size + 'px';
if(content) { el.textContent = content; el.classList.add('particle-codeRain'); el.style.fontSize = Math.max(10, size) + 'px'; el.style.width = 'auto'; el.style.height = 'auto'; }
return el;
}
const baseCounts = {
goldenFloat: 28, blackPulse: 20, redSword: 22, shapeShifter: 20,
codeRain: 36, oceanWave: 26, neonPulse: 24, roseFloat: 24
};
const scaleMap = { high:1, mid:0.45, low:0.08 };
const profile = CAPS.profile || 'low';
const scale = scaleMap[profile] || 0.45;
const reduceEffects = (profile === 'low' || window.matchMedia('(prefers-reduced-motion: reduce)').matches);

window.renderParticlesForTheme = function(themeKey){
try{
const t = themeKey || 'goldenFloat';
const mapName = {
goldenFloat:'goldenFloat', blackPulse:'blackPulse', redSword:'redSword',
shapeShifter:'shapeShifter', codeRain:'codeRain', oceanWave:'oceanWave',
neonPulse:'neonPulse', roseFloat:'roseFloat'
}[t] || 'goldenFloat';
const base = baseCounts[mapName] || 18;
const count = Math.max( Math.round(base*scale), (reduceEffects ? 0 : 2) );
container.innerHTML = '';
if(count === 0){
const accent = document.createElement('div');
accent.className = 'particle particle-neonPulse';
accent.style.left = '50%';
accent.style.top = '80%';
accent.style.width = '4px';
accent.style.height = '4px';
accent.style.opacity = '0.6';
accent.style.pointerEvents = 'none';
container.appendChild(accent);
return;
}
const fragment = document.createDocumentFragment();
for(let i=0;i<count;i++){
const x = Math.random(); const y = Math.random();
const size = (mapName==='codeRain' ? Math.max(10, Math.round(Math.random()*14+6)) : Math.round(Math.random()*(reduceEffects?4:8) + (reduceEffects?2:2)));
const p = makeParticle('particle-'+mapName, x, y, size, mapName==='codeRain'? (Math.random()>0.7?String.fromCharCode(0x30A0 + Math.floor(Math.random()*96)) : '') : '');
if(reduceEffects){
p.style.boxShadow = 'none';
p.style.filter = 'none';
p.style.animationDuration = '8s';
}
fragment.appendChild(p);
}
container.appendChild(fragment);
}catch(e){ console.warn('[najib-optimizer] renderParticlesForTheme fail', e); }
};

try{
const saved = (JSON.parse(localStorage.getItem('najib_saved_themes')||'[]') || [])[0];
const initialTheme = saved ? (saved.variables && saved.variables.particleTheme) : 'goldenFloat';
setTimeout(()=>{ try{ window.renderParticlesForTheme(initialTheme); }catch(e){} }, 300);
}catch(e){}

window.__najib_particle_optimizer = { profile: CAPS.profile, reducedEffects: reduceEffects };

}catch(e){ console.warn('[najib-optimizer] particleOptimizer top fail', e); }
})();

/***** 3) CINEMATIC MODULAR MODE *****/
(function cinematicModular(){
try{
const ROOT = document.getElementById('stl-open');
if(!ROOT) return;
const mode = CAPS.profile || 'low';
ROOT.setAttribute('data-cinematic-mode', mode);

function applyMode(){
if(mode === 'low'){
const chrom = document.querySelector('.stl-chromatic');
if(chrom) chrom.style.display = 'none';
const scan = document.getElementById('stl-scan');
if(scan) { scan.style.animationDuration = '12s'; scan.style.opacity='0.12'; }
const TITLE = document.getElementById('stl-title');
const TAG = document.getElementById('stl-tag');
if(TITLE) TITLE.style.transition='opacity .6s ease';
if(TAG) TAG.style.transition='opacity .6s ease';
setTimeout(()=>{ try{ ROOT.style.opacity='0'; setTimeout(()=>{ try{ ROOT.remove(); }catch(e){ ROOT.style.display='none'; } }, 550); }catch(e){} }, 900);
}
else if(mode === 'mid'){
const scan = document.getElementById('stl-scan'); if(scan) scan.style.opacity='0.22';
const fract = document.querySelector('.stl-fractal'); if(fract) fract.style.opacity='0.7';
setTimeout(()=>{ try{ ROOT.style.opacity='0'; setTimeout(()=>{ try{ ROOT.remove(); }catch(e){ ROOT.style.display='none'; } }, 900); }catch(e){} }, 4000);
}
}
applyMode();
window.__najib_cinematic_force = function(lvl){
try{ if(!lvl) return; ROOT.setAttribute('data-cinematic-mode', lvl); location.reload(); }catch(e){}
};
}catch(e){ console.warn('[najib-optimizer] cinematicModular fail', e); }
})();

/***** 4) CHILD-SUITE SOFT MODE *****/
(function softenChildSuite(){
try{
(function installSoftObserver(){
let throttleAt = 0;
let backoffMs = 1000;
const whitelist = ['#stl-open','#quantumParticles','#quantumIsland','.quantum-sidebar','.quantum-tools-sidebar'];
const safeCheck = (node)=>{
try{
if(!node || node.nodeType !== 1) return true;
for(const s of whitelist){
try{ if(node.matches && node.matches(s) || (node.closest && node.closest(s))) return true; }catch(e){}
}
const tag = (node.tagName||'').toLowerCase();
if(['div','span','script','style','link','meta','img','svg'].indexOf(tag) !== -1) return true;
return false;
}catch(e){ return true; }
};
const mo = new MutationObserver((mutations)=>{
const now = Date.now();
if(now - throttleAt < backoffMs) return;
throttleAt = now;
let flagged = false;
for(const m of mutations){
for(const n of (m.addedNodes||[])){
if(!safeCheck(n)) flagged = true;
}
}
if(flagged){
console.info('[najib-softObserver] suspicious DOM additions detected');
setTimeout(()=>{ try{ if(window.DEV_mg && typeof window.DEV_mg.auditProtections === 'function') window.DEV_mg.auditProtections({soft:true}); }catch(e){} }, 1200);
backoffMs = Math.min(60000, Math.max(2000, backoffMs * 1.5));
} else {
backoffMs = Math.max(1000, Math.floor(backoffMs*0.9));
}
});
try{
mo.observe(document.documentElement || document.body, { childList:true, subtree:true });
window.__najib_soft_mo = mo;
}catch(e){}
})();
}catch(e){ console.warn('[najib-optimizer] softenChildSuite fail', e); }
})();

/***** 5) REPORT SUMMARY *****/
try{
console.info('[najib-optimizer] applied. profile=%s', CAPS.profile);
}catch(e){}
})();
</script>
<!-- END NAJIB OPTIMIZER PATCH -->
</body>
) === -->
<script>
(function(){
  if(window.__quantum_frontend_secure) return; window.__quantum_frontend_secure = true;
  const $ = id => document.getElementById(id);

  // ===== UI injection (opt-in, non intrusive) =====
  const tools = document.getElementById('quantumToolsSidebar');
  if(!tools) return;
  if(document.getElementById('quantumSecureCard')) return;

  const card = document.createElement('div');
  card.className = 'quantum-card glass p-4';
  card.id = 'quantumSecureCard';
  card.style.marginBottom = '12px';
  card.innerHTML = `
    <h4 style="font-weight:800; margin-bottom:6px;">Keamanan & Backup (Opsional)</h4>
    <label class="text-sm">Simpan Mongo URI / API Key?</label>
    <div style="display:flex;gap:8px;margin-top:6px">
      <input id="saveEncryptedToggle" type="checkbox" /> <small style="margin-left:6px">Simpan terenkripsi (opsional)</small>
    </div>
    <div style="margin-top:8px;">
      <label class="text-sm">(Opsional) Simpan API key terenkripsi untuk provider</label>
      <input id="saveApiKeyToggle" type="checkbox" /> <small style="margin-left:6px">Save API key (opt-in)</small>
    </div>
    <div style="margin-top:8px;">
      <label class="text-sm">Backup schedule</label>
      <select id="backupSchedule" class="quantum-input glass">
        <option value="">Manual only</option>
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
      </select>
    </div>
    <div style="display:flex;gap:8px;margin-top:10px;">
      <button id="saveSecureBtn" class="quantum-btn primary">Save Encrypted</button>
      <button id="backupNowBtn" class="quantum-btn secondary">Backup Now</button>
      <button id="testBackupBtn" class="quantum-btn warning">Test Backup</button>
    </div>
    <div id="secureStatus" style="margin-top:8px;font-size:13px;color:#666"></div>
  `;
  
// ==== FORCE INSERT after "stl-AIchat Tools" header ====
try {
  (function(){
    const sidebarEl = (typeof sidebar !== 'undefined' ? sidebar : (typeof tools !== 'undefined' ? tools : document.getElementById('quantumToolsSidebar')));
    if (!sidebarEl) {
      // fallback: try to find by id
      sidebarEl = document.getElementById('quantumToolsSidebar') || document.querySelector('.quantum-tools-sidebar') || document.querySelector('.tools-sidebar');
    }
    if (sidebarEl && card) {
      const headers = Array.from(sidebarEl.querySelectorAll('h3'));
      let header = headers.find(h => h.innerText && h.innerText.toLowerCase().includes('stl-aichat tools'));
      if (!header) {
        // try alternative text match
        header = headers.find(h => h.innerText && h.innerText.toLowerCase().includes('stl-aichat'));
      }
      if (header) {
        const parentCard = header.closest('.quantum-card') || header.parentElement;
        if (parentCard) {
          parentCard.insertAdjacentElement('afterend', card);
          console.log('âœ… Card inserted after stl-AIchat Tools header');
        } else {
          sidebarEl.appendChild(card);
          console.warn('âš  parentCard not found; appended to sidebar');
        }
      } else {
        // try to find Export Data card and insert after it
        const exportCard = sidebarEl.querySelector('.quantum-card .fa-download') ? sidebarEl.querySelector('.quantum-card .fa-download').closest('.quantum-card') : null;
        if (exportCard) {
          exportCard.insertAdjacentElement('afterend', card);
          console.log('âœ… Card inserted after Export Data');
        } else {
          sidebarEl.appendChild(card);
          console.warn('âš  Header not found; appended to sidebar');
        }
      }
    }
  })();
} catch(e){
  try { sidebar.appendChild(card); } catch(err){ console.warn('final fallback append failed', err); }
}

  // ===== helpers: crypto (AES-GCM via Web Crypto) =====
  async function deriveKeyFromPass(pass, saltBuf){
    const enc = new TextEncoder();
    const passKey = await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, ['deriveKey']);
    const key = await crypto.subtle.deriveKey({name:'PBKDF2', salt: saltBuf, iterations: 150_000, hash:'SHA-256'}, passKey, { name:'AES-GCM', length: 256 }, true, ['encrypt','decrypt']);
    return key;
  }
  async function encryptJSON(obj, pass){
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const key = await deriveKeyFromPass(pass, salt);
    const data = new TextEncoder().encode(JSON.stringify(obj));
    const cipher = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, data);
    return { iv: btoa(String.fromCharCode(...iv)), salt: btoa(String.fromCharCode(...salt)), data: btoa(String.fromCharCode(...new Uint8Array(cipher))) };
  }
  async function decryptJSON(encObj, pass){
    const iv = Uint8Array.from(atob(encObj.iv), c=>c.charCodeAt(0));
    const salt = Uint8Array.from(atob(encObj.salt), c=>c.charCodeAt(0));
    const data = Uint8Array.from(atob(encObj.data), c=>c.charCodeAt(0));
    const key = await deriveKeyFromPass(pass, salt);
    const plain = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, data);
    return JSON.parse(new TextDecoder().decode(plain));
  }

  // ===== password generation helper (reuse pattern you asked earlier) =====
  function makeCreativePassword(){
    const words = ['najib','27','09','1996','sidoarjo','salam','wahidus'];
    const subst = { 'a':'4','A':'4','s':'5','S':'5','i':'1','I':'1' };
    let base = words.join('-');
    let out = '';
    for(const ch of base) out += (subst[ch] !== undefined ? subst[ch] : ch);
    const rand = Math.random().toString(36).slice(2,8);
    return out + '-' + rand;
  }

  // ===== UI actions =====
  const status = document.getElementById('secureStatus');
  document.getElementById('saveSecureBtn').addEventListener('click', async ()=>{
    try{
      const saveEncrypted = document.getElementById('saveEncryptedToggle').checked;
      const saveApiKey = document.getElementById('saveApiKeyToggle').checked;
      // collect values (if present)
      const uriInput = document.getElementById('mongoUriInput') ? document.getElementById('mongoUriInput').value.trim() : '';
      const coll = document.getElementById('mongoCollInput') ? document.getElementById('mongoCollInput').value.trim() : 'user_chats';
      const apiKey = (document.getElementById('aiApiKey') && saveApiKey) ? document.getElementById('aiApiKey').value.trim() : '';

      if(!uriInput && !apiKey){ status.style.color='crimson'; status.textContent='Tidak ada URI atau API key untuk disimpan.'; return; }

      // prompt user a passphrase (we suggest one)
      const pass = makeCreativePassword();
      // you could prompt the user to change; here we automatically provide suggestion and use it
      const payload = { uri: uriInput, collection: coll, apiKey: apiKey || null, savedAt: Date.now() };

      const enc = await encryptJSON(payload, pass);

      if(saveEncrypted){
        // save encrypted to localStorage (opt-in)
        localStorage.setItem('__quantum_secure_blob', JSON.stringify(enc));
        localStorage.setItem('__quantum_secure_pass_suggest', pass);
        status.style.color='green';
        status.textContent = 'Disimpan terenkripsi di perangkat. Simpan password dengan aman (ditampilkan di localStorage key __quantum_secure_pass_suggest).';
      } else {
        // send to server for storing encrypted (server stores enc blob, not plaintext)
        status.style.color='#666'; status.textContent = 'Mengirim blob terenkripsi ke proxy...';
        const res = await fetch('/user/saveUri', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ encrypted: enc, meta:{source:'frontend'} }) });
        const j = await res.json().catch(()=>({ error:'no-json' }));
        if(res.ok){ status.style.color='green'; status.textContent = 'Sukses tersimpan di server (encrypted).'; }
        else { status.style.color='crimson'; status.textContent = 'Gagal simpan ke server: '+(j.error||res.status); }
      }
    } catch(err){
      status.style.color='crimson'; status.textContent = 'Error: '+ (err && err.message ? err.message : String(err));
    }
  });

  document.getElementById('backupNowBtn').addEventListener('click', async ()=>{
    try{
      status.style.color='#666'; status.textContent = 'Meminta server membuat backup...';
      const res = await fetch('/user/backupNow', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ reason:'manual' }) });
      const j = await res.json().catch(()=>({ error:'no-json' }));
      if(res.ok){ status.style.color='green'; status.textContent = 'Backup dijalankan: '+(j.message||'ok'); }
      else { status.style.color='crimson'; status.textContent = 'Backup gagal: '+(j.error||res.status); }
    } catch(err){
      status.style.color='crimson'; status.textContent = 'Gagal konek ke server: '+err.message;
    }
  });

  document.getElementById('testBackupBtn').addEventListener('click', async ()=>{
    // test connectivity (server will validate S3/GDrive if configured)
    status.style.color='#666'; status.textContent = 'Menguji backup config di server...';
    try{
      const res = await fetch('/user/testBackup', { method:'GET' });
      const j = await res.json().catch(()=>({ error:'no-json' }));
      if(res.ok){ status.style.color='green'; status.textContent = 'Test OK: '+(j.message||'ok'); }
      else { status.style.color='crimson'; status.textContent = 'Test gagal: '+(j.error||res.status); }
    } catch(e){ status.style.color='crimson'; status.textContent = 'Gagal: '+e.message; }
  });

  // Auto-schedule UI: when user selects daily/weekly, send to server to register schedule
  document.getElementById('backupSchedule').addEventListener('change', async (e)=>{
    const val = e.target.value;
    if(!val){ await fetch('/user/clearBackupSchedule',{method:'POST'}); return; }
    await fetch('/user/setBackupSchedule',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ schedule: val }) });
    status.style.color='green';
    status.textContent = 'Jadwal backup diset ke: '+val;
  });
})();
</script>
<!-- === END FRONTEND SECURE/BACKUP UI === -->
<script>
  // === BACKUP & SECURE URI endpoints (add to server.js) ===
const AWS = require('aws-sdk');
const { google } = require('googleapis');
const cron = require('node-cron');

// load env
const S3_BUCKET = process.env.S3_BUCKET || '';
const AWS_REGION = process.env.AWS_REGION || '';
const AWS_ACCESS_KEY = process.env.AWS_ACCESS_KEY || '';
const AWS_SECRET_KEY = process.env.AWS_SECRET_KEY || '';
const GDRIVE_ENABLED = process.env.GDRIVE_ENABLED === 'true';
const GDRIVE_FOLDER_ID = process.env.GDRIVE_FOLDER_ID || '';

// configure AWS if provided
if(S3_BUCKET && AWS_ACCESS_KEY && AWS_SECRET_KEY){
  AWS.config.update({ region: AWS_REGION, accessKeyId: AWS_ACCESS_KEY, secretAccessKey: AWS_SECRET_KEY });
  var s3 = new AWS.S3();
}

// Helper: store encrypted blob doc
app.post('/user/saveUri', async (req, res) => {
  try {
    const { encrypted, meta } = req.body || {};
    if(!encrypted) return res.status(400).json({ error: 'missing encrypted' });
    // store into server DB (proxy DB) collection user_secure
    const client = new MongoClient(process.env.PROXY_DB_URI || 'mongodb://localhost:27017/quantum_proxy', { useUnifiedTopology:true });
    await client.connect();
    const db = client.db();
    await db.collection('user_secure').insertOne({ encrypted, meta, createdAt: new Date() });
    await client.close();
    return res.json({ message: 'saved' });
  } catch(err){
    return res.status(500).json({ error: err.message });
  }
});

// schedule storage per user (naive implementation: store in server collection)
app.post('/user/setBackupSchedule', async (req,res) => {
  const { schedule } = req.body || {};
  if(!schedule) return res.status(400).json({ error:'missing schedule' });
  // save schedule for system (here naive global)
  await (async ()=>{
    const client = new MongoClient(process.env.PROXY_DB_URI||'mongodb://localhost:27017/quantum_proxy', { useUnifiedTopology:true });
    await client.connect();
    const db = client.db();
    await db.collection('system_settings').updateOne({ key: 'backup_schedule' }, { $set:{ value: schedule, updatedAt:new Date() } }, { upsert:true });
    await client.close();
  })();
  // register cron (simple; you may want persistent scheduling)
  if(schedule === 'daily') {
    cron.schedule('0 2 * * *', () => runBackupTask());
  } else if(schedule === 'weekly') {
    cron.schedule('0 3 * * 0', () => runBackupTask());
  }
  return res.json({ message:'scheduled' });
});

app.post('/user/clearBackupSchedule', async (req,res) => {
  // naive: clear setting
  const client = new MongoClient(process.env.PROXY_DB_URI||'mongodb://localhost:27017/quantum_proxy', { useUnifiedTopology:true });
  await client.connect();
  const db = client.db();
  await db.collection('system_settings').deleteOne({ key: 'backup_schedule' });
  await client.close();
  return res.json({ message:'cleared' });
});

app.post('/user/backupNow', async (req,res) => {
  try {
    await runBackupTask();
    return res.json({ message:'backup_started' });
  } catch(err){ return res.status(500).json({ error: err.message }); }
});

app.get('/user/testBackup', async (req,res) => {
  try {
    // test S3
    if(S3_BUCKET && s3){
      await s3.headBucket({ Bucket: S3_BUCKET }).promise();
    }
    // test GDrive (if enabled)
    if(GDRIVE_ENABLED){
      // assumes service account credentials are available in env as JSON
      // simple check omitted here for brevity
    }
    return res.json({ message:'backup endpoints OK' });
  } catch(err){ return res.status(500).json({ error: err.message }); }
});

// ===== runBackupTask implementation =====
async function runBackupTask(){
  // 1) Collect data to backup - adjust to your actual DB & collections
  const client = new MongoClient(process.env.PROXY_DB_URI||'mongodb://localhost:27017/quantum_proxy', { useUnifiedTopology:true });
  await client.connect();
  const db = client.db();
  const data = {};
  // backup user_secure & stl_templates & user chats (adjust names)
  data.user_secure = await db.collection('user_secure').find({}).limit(1000).toArray();
  data.stl_templates = await db.collection('stl_templates').find({}).limit(1000).toArray();
  // optionally export other collections...
  await client.close();

  const content = JSON.stringify({ exportedAt:new Date(), data }, null, 2);
  const buffer = Buffer.from(content, 'utf8');

  // 2) Upload S3 if configured
  if(S3_BUCKET && s3){
    const key = `backups/quantum-backup-${Date.now()}.json`;
    await s3.putObject({ Bucket: S3_BUCKET, Key: key, Body: buffer, ContentType:'application/json' }).promise();
    console.log('uploaded to s3', key);
  }

  // 3) Upload to Google Drive if configured (example omitted; implement via googleapis with service account)
  if(GDRIVE_ENABLED){
    // implement Drive upload using google.auth.JWT and drive.files.create
    // for brevity, consider using helper lib to auth and upload
  }
}
</script>
<!-- ==================== PATCH: UX/Validation/Lock/Cleanup Enhancements (PASTE BEFORE 
<!-- NAJIB OPTIMIZER PATCH v1.0 (Fonts + Particle Optimizer + Cinematic Modes + Child-suite soft-mode) -->
<script id="najib-optimizer-patch">
(function(){
'use strict';
/*** UTIL: capability detection ***/
function detectCapsSafe(){
try{
if(window.__NAJIB_CAPS) return window.__NAJIB_CAPS;
const caps = { cores: navigator.hardwareConcurrency||2, mem: navigator.deviceMemory||2, dpr: window.devicePixelRatio||1, webgl:false, webgl2:false };
try{
const c=document.createElement('canvas');
const g2 = c.getContext && c.getContext('webgl2');
const g = g2 || (c.getContext && (c.getContext('webgl')||c.getContext('experimental-webgl')));
if(g){ caps.webgl = !!g; caps.webgl2 = !!g2; }
}catch(e){}
let score=0;
if(caps.cores>=8) score+=30; else if(caps.cores>=4) score+=18; else score+=8;
if(caps.mem>=8) score+=30; else if(caps.mem>=4) score+=18; else score+=6;
if(caps.webgl2) score+=30; else if(caps.webgl) score+=16;
caps.score = score;
if(caps.cores<=2 || caps.mem<=1 || caps.score<24) caps.profile='low';
else if((caps.cores<=4 && caps.mem<=3) || caps.score<48) caps.profile='mid';
else caps.profile='high';
window.__NAJIB_CAPS = caps;
return caps;
}catch(e){
return { profile:'low', cores:2, mem:1, dpr:1 };
}
}
const CAPS = detectCapsSafe();

/***** 1) FONT LAZY LOADER *****/
(function lazyFonts(){
try{
const heavyLinks = Array.from(document.querySelectorAll('link[href*="fonts.googleapis.com"], link[href*="fonts.gstatic.com"]'));
if(!heavyLinks.length) return;
if(CAPS.profile === 'low' || window.matchMedia('(prefers-reduced-data: reduce)').matches){
heavyLinks.forEach(l => { l.media='print'; l.setAttribute('data-deferred','1'); });
return;
}
function loadHeavyFonts(){
heavyLinks.forEach(l=>{
if(l.getAttribute('data-deferred')) return;
l.rel = 'stylesheet';
l.removeAttribute('media');
l.setAttribute('data-loaded-by','najib-optimizer');
});
}
if('requestIdleCallback' in window){
requestIdleCallback(loadHeavyFonts, {timeout:3000});
} else {
const onFirst = function(){ loadHeavyFonts(); window.removeEventListener('pointerdown', onFirst); window.removeEventListener('touchstart', onFirst); };
window.addEventListener('pointerdown', onFirst, {once:true});
window.addEventListener('touchstart', onFirst, {once:true});
setTimeout(loadHeavyFonts, 6000);
}
}catch(e){ console.warn('[najib-optimizer] lazyFonts failed', e); }
})();

/***** 2) PARTICLE SMART OPTIMIZER *****/
(function particleOptimizer(){
try{
const container = document.getElementById('quantumParticles') || document.querySelector('.quantum-particles');
if(!container) return;
function makeParticle(cls, x, y, size, content){
const el = document.createElement('div');
el.className = 'particle ' + cls;
el.style.left = (x*100).toFixed(2) + 'vw';
el.style.top = (y*100).toFixed(2) + 'vh';
el.style.width = size + 'px';
el.style.height = size + 'px';
if(content) { el.textContent = content; el.classList.add('particle-codeRain'); el.style.fontSize = Math.max(10, size) + 'px'; el.style.width = 'auto'; el.style.height = 'auto'; }
return el;
}
const baseCounts = {
goldenFloat: 28, blackPulse: 20, redSword: 22, shapeShifter: 20,
codeRain: 36, oceanWave: 26, neonPulse: 24, roseFloat: 24
};
const scaleMap = { high:1, mid:0.45, low:0.08 };
const profile = CAPS.profile || 'low';
const scale = scaleMap[profile] || 0.45;
const reduceEffects = (profile === 'low' || window.matchMedia('(prefers-reduced-motion: reduce)').matches);

window.renderParticlesForTheme = function(themeKey){
try{
const t = themeKey || 'goldenFloat';
const mapName = {
goldenFloat:'goldenFloat', blackPulse:'blackPulse', redSword:'redSword',
shapeShifter:'shapeShifter', codeRain:'codeRain', oceanWave:'oceanWave',
neonPulse:'neonPulse', roseFloat:'roseFloat'
}[t] || 'goldenFloat';
const base = baseCounts[mapName] || 18;
const count = Math.max( Math.round(base*scale), (reduceEffects ? 0 : 2) );
container.innerHTML = '';
if(count === 0){
const accent = document.createElement('div');
accent.className = 'particle particle-neonPulse';
accent.style.left = '50%';
accent.style.top = '80%';
accent.style.width = '4px';
accent.style.height = '4px';
accent.style.opacity = '0.6';
accent.style.pointerEvents = 'none';
container.appendChild(accent);
return;
}
const fragment = document.createDocumentFragment();
for(let i=0;i<count;i++){
const x = Math.random(); const y = Math.random();
const size = (mapName==='codeRain' ? Math.max(10, Math.round(Math.random()*14+6)) : Math.round(Math.random()*(reduceEffects?4:8) + (reduceEffects?2:2)));
const p = makeParticle('particle-'+mapName, x, y, size, mapName==='codeRain'? (Math.random()>0.7?String.fromCharCode(0x30A0 + Math.floor(Math.random()*96)) : '') : '');
if(reduceEffects){
p.style.boxShadow = 'none';
p.style.filter = 'none';
p.style.animationDuration = '8s';
}
fragment.appendChild(p);
}
container.appendChild(fragment);
}catch(e){ console.warn('[najib-optimizer] renderParticlesForTheme fail', e); }
};

try{
const saved = (JSON.parse(localStorage.getItem('najib_saved_themes')||'[]') || [])[0];
const initialTheme = saved ? (saved.variables && saved.variables.particleTheme) : 'goldenFloat';
setTimeout(()=>{ try{ window.renderParticlesForTheme(initialTheme); }catch(e){} }, 300);
}catch(e){}

window.__najib_particle_optimizer = { profile: CAPS.profile, reducedEffects: reduceEffects };

}catch(e){ console.warn('[najib-optimizer] particleOptimizer top fail', e); }
})();

/***** 3) CINEMATIC MODULAR MODE *****/
(function cinematicModular(){
try{
const ROOT = document.getElementById('stl-open');
if(!ROOT) return;
const mode = CAPS.profile || 'low';
ROOT.setAttribute('data-cinematic-mode', mode);

function applyMode(){
if(mode === 'low'){
const chrom = document.querySelector('.stl-chromatic');
if(chrom) chrom.style.display = 'none';
const scan = document.getElementById('stl-scan');
if(scan) { scan.style.animationDuration = '12s'; scan.style.opacity='0.12'; }
const TITLE = document.getElementById('stl-title');
const TAG = document.getElementById('stl-tag');
if(TITLE) TITLE.style.transition='opacity .6s ease';
if(TAG) TAG.style.transition='opacity .6s ease';
setTimeout(()=>{ try{ ROOT.style.opacity='0'; setTimeout(()=>{ try{ ROOT.remove(); }catch(e){ ROOT.style.display='none'; } }, 550); }catch(e){} }, 900);
}
else if(mode === 'mid'){
const scan = document.getElementById('stl-scan'); if(scan) scan.style.opacity='0.22';
const fract = document.querySelector('.stl-fractal'); if(fract) fract.style.opacity='0.7';
setTimeout(()=>{ try{ ROOT.style.opacity='0'; setTimeout(()=>{ try{ ROOT.remove(); }catch(e){ ROOT.style.display='none'; } }, 900); }catch(e){} }, 4000);
}
}
applyMode();
window.__najib_cinematic_force = function(lvl){
try{ if(!lvl) return; ROOT.setAttribute('data-cinematic-mode', lvl); location.reload(); }catch(e){}
};
}catch(e){ console.warn('[najib-optimizer] cinematicModular fail', e); }
})();

/***** 4) CHILD-SUITE SOFT MODE *****/
(function softenChildSuite(){
try{
(function installSoftObserver(){
let throttleAt = 0;
let backoffMs = 1000;
const whitelist = ['#stl-open','#quantumParticles','#quantumIsland','.quantum-sidebar','.quantum-tools-sidebar'];
const safeCheck = (node)=>{
try{
if(!node || node.nodeType !== 1) return true;
for(const s of whitelist){
try{ if(node.matches && node.matches(s) || (node.closest && node.closest(s))) return true; }catch(e){}
}
const tag = (node.tagName||'').toLowerCase();
if(['div','span','script','style','link','meta','img','svg'].indexOf(tag) !== -1) return true;
return false;
}catch(e){ return true; }
};
const mo = new MutationObserver((mutations)=>{
const now = Date.now();
if(now - throttleAt < backoffMs) return;
throttleAt = now;
let flagged = false;
for(const m of mutations){
for(const n of (m.addedNodes||[])){
if(!safeCheck(n)) flagged = true;
}
}
if(flagged){
console.info('[najib-softObserver] suspicious DOM additions detected');
setTimeout(()=>{ try{ if(window.DEV_mg && typeof window.DEV_mg.auditProtections === 'function') window.DEV_mg.auditProtections({soft:true}); }catch(e){} }, 1200);
backoffMs = Math.min(60000, Math.max(2000, backoffMs * 1.5));
} else {
backoffMs = Math.max(1000, Math.floor(backoffMs*0.9));
}
});
try{
mo.observe(document.documentElement || document.body, { childList:true, subtree:true });
window.__najib_soft_mo = mo;
}catch(e){}
})();
}catch(e){ console.warn('[najib-optimizer] softenChildSuite fail', e); }
})();

/***** 5) REPORT SUMMARY *****/
try{
console.info('[najib-optimizer] applied. profile=%s', CAPS.profile);
}catch(e){}
})();
</script>
<!-- END NAJIB OPTIMIZER PATCH -->
</body>
) ==================== -->
<script>
(function(){
  if(window.__quantum_patch_vfinal) return; window.__quantum_patch_vfinal = true;

  const $ = id => document.getElementById(id);
  function el(tag, props={}){ const e=document.createElement(tag); if(props.id) e.id = props.id; if(props.class) e.className = props.class; if(props.html) e.innerHTML = props.html; if(props.text) e.textContent = props.text; if(props.styles) Object.assign(e.style, props.styles); return e; }

  /* ------------------ Helpers ------------------ */
  function safeFetch(url, opts={}) {
    return fetch(url, opts).then(async r => {
      let json = null;
      try { json = await r.json(); } catch(e){}
      if (!r.ok) throw { status: r.status, body: json || await r.text().catch(()=>null) };
      return json || { ok:true };
    });
  }

  function showSpinnerOn(elem){
    if(!elem) return;
    if(elem.querySelector('.q-busy-overlay')) return;
    const overlay = el('div',{ class:'q-busy-overlay', styles:{ position:'absolute', inset:'0', display:'flex', alignItems:'center', justifyContent:'center', background:'rgba(255,255,255,0.6)', zIndex:9999 } });
    overlay.innerHTML = `<div style="display:flex;flex-direction:column;align-items:center;gap:8px">
      <div class="spinner" style="width:36px;height:36px;border:4px solid rgba(0,0,0,0.12);border-top:4px solid rgba(0,0,0,0.6);border-radius:50%;animation:spin 1s linear infinite"></div>
      <div class="q-busy-text" style="font-size:13px;color:#222">Processing...</div>
    </div>`;
    overlay.querySelector('.spinner').style.animation = 'spin 1s linear infinite';
    overlay.style.pointerEvents = 'auto';
    // ensure parent has position
    const parent = elem;
    const prevPos = window.getComputedStyle(parent).position;
    if(prevPos === 'static' || !prevPos) parent.style.position = 'relative';
    parent.appendChild(overlay);
  }
  function hideSpinnerOn(elem){
    if(!elem) return;
    const ov = elem.querySelector('.q-busy-overlay');
    if(ov) ov.remove();
  }
  // spinner CSS
  (function addSpinnerCss(){
    if(document.getElementById('q-busy-css')) return;
    const s = document.createElement('style'); s.id='q-busy-css';
    s.innerHTML = `@keyframes spin{ from{transform:rotate(0)} to{transform:rotate(360deg)} } .q-status-ok{color:green}.q-status-err{color:crimson}`;
    document.head.appendChild(s);
  })();

  /* ------------------ Validation ------------------ */
  function validateMongoUri(uri){
    if(!uri || typeof uri !== 'string') return { ok:false, err:'Empty' };
    // rough but practical checks
    const srvRegex = /^mongodb(\+srv)?:\/\/[^\s:@\/]+(:[^@\s\/]+)?@[^\/\s]+(\/[^\s?]+)?(\?.*)?$/i;
    const simpleRegex = /^mongodb:\/\/[^\s]+$/i;
    if(srvRegex.test(uri) || simpleRegex.test(uri)) return { ok:true };
    return { ok:false, err:'Format MongoDB URI tidak valid' };
  }
  function validateApiKey(key){
    if(!key || typeof key !== 'string') return { ok:false, err:'Empty' };
    // provider keys vary â€” just sanity checks: length & no spaces
    if(key.length < 20 || /\s/.test(key)) return { ok:false, err:'API key tampak pendek atau mengandung spasi' };
    return { ok:true };
  }

  /* ------------------ Clipboard wipe ------------------ */
  function wipeClipboardAfterDelay(textElOrValue, delayMs=15000){
    let val = typeof textElOrValue === 'string' ? textElOrValue : (textElOrValue && textElOrValue.value ? textElOrValue.value : '');
    // try to clear clipboard after delay
    setTimeout(async ()=> {
      try {
        // attempt to clear clipboard if permission available
        if(navigator.clipboard && navigator.clipboard.writeText){
          await navigator.clipboard.writeText('');
        }
      } catch(e){}
      try {
        // also clear input field if element passed
        if(typeof textElOrValue !== 'string' && textElOrValue && textElOrValue.value !== undefined){
          textElOrValue.value = '';
        }
      } catch(e){}
    }, delayMs);
  }

  /* ------------------ Double-inject prevention ------------------ */
  // already covered by global flag; further check for duplicate UI elements by id
  if(document.getElementById('quantumSecureCard_enhanced_v1')) {
    console.debug('quantumSecureCard_enhanced_v1 already present, abort patch');
    return;
  }

  /* ------------------ Attach enhancements if UI exists ------------------ */
  function enhanceMongoCard(){
    // find the existing card by id variants
    let card = document.getElementById('quantumMongoCard') || document.getElementById('quantumSecureCard') || document.getElementById('quantumSecureCard_v2') || null;
    // if not found, try the RPP notice card id (quantumRppNotice) and add enhancements below it
    const toolsSidebar = $('quantumToolsSidebar') || document.querySelector('.quantum-tools-sidebar') || document.querySelector('.tools-sidebar');
    if(!card && toolsSidebar){
      // search for Mongo section by label text heuristics
      card = Array.from(toolsSidebar.querySelectorAll('.quantum-card')).find(c => (c.innerText||'').toLowerCase().includes('mongodb') || (c.innerText||'').toLowerCase().includes('simpan chat ke mongodb'));
    }
    if(!card) {
      console.warn('enhanceMongoCard: card not found, aborting enhancement');
      return;
    }

    // mark card so we don't re-run
    card.id = card.id || 'quantumMongoCard';
    if(document.getElementById('quantumSecureCard_enhanced_v1')) return; // double safe

    // Add container for enhanced UI elements (spinner area and status line)
    let statusLine = card.querySelector('#mongoStatus') || el('div',{ id:'mongoStatus', styles:{ marginTop:'8px', fontSize:'13px', color:'#666' }});
    if(!card.querySelector('#mongoStatus')) card.appendChild(statusLine);

    // Ensure buttons exist and wire behavior
    const testBtn = card.querySelector('#mongoTestBtn') || card.querySelector('#testAdvancedMongo') || card.querySelector('#testEasyMongo');
    const saveBtn = card.querySelector('#mongoSaveBtn') || card.querySelector('#saveAdvancedMongo') || card.querySelector('#saveEasyMongo');
    const copyBtn = card.querySelector('#mongoCopyPass') || card.querySelector('#copyPassBtn');

    // Inputs
    const uriInput = card.querySelector('#mongoUriInput') || card.querySelector('#mongoConnectionString') || card.querySelector('#mongoRestUrl') || null;
    const collInput = card.querySelector('#mongoCollInput') || card.querySelector('#mongoCollectionName') || null;
    const passSuggest = card.querySelector('#mongoPassSuggest') || card.querySelector('#mongoPassSuggestInput') || null;
    const aiApiKeyInput = $('aiApiKey') || document.querySelector('#aiApiKey') || null;

    // helper to update status
    function setStatus(text, type='info'){ if(statusLine){ statusLine.textContent = text; statusLine.className = type==='ok' ? 'q-status-ok' : (type==='err' ? 'q-status-err' : ''); } }

    // Attach Test Koneksi
    if(testBtn && !testBtn.__enhanced){
      testBtn.__enhanced = true;
      testBtn.addEventListener('click', async ()=>{
        const uri = uriInput ? uriInput.value.trim() : '';
        const apiKey = aiApiKeyInput ? aiApiKeyInput.value.trim() : '';
        // validate
        const v = validateMongoUri(uri);
        if(!v.ok){ setStatus('Error: '+v.err,'err'); return; }
        setStatus('Menguji koneksi...', 'info');
        showSpinnerOn(card);
        try {
          const res = await safeFetch('/user/testMongo', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ uri }) });
          setStatus('Koneksi OK. ' + (res.message || ''), 'ok');
        } catch(err){
          console.warn(err);
          setStatus('Koneksi Gagal: '+(err && err.body && err.body.error ? err.body.error : (err && err.message ? err.message : 'unknown')), 'err');
        } finally { hideSpinnerOn(card); }
      });
    }

    // Attach Save to Mongo
    if(saveBtn && !saveBtn.__enhanced){
      saveBtn.__enhanced = true;
      saveBtn.addEventListener('click', async ()=>{
        const uri = uriInput ? uriInput.value.trim() : '';
        const coll = collInput ? (collInput.value.trim() || 'user_chats') : 'user_chats';
        const pass = passSuggest ? passSuggest.value.trim() : '';
        if(!uri){ setStatus('Isi MongoDB URI dulu','err'); return; }
        const v = validateMongoUri(uri);
        if(!v.ok){ setStatus('Error: '+v.err,'err'); return; }
        // optional api key validation if used
        const apiKeyVal = aiApiKeyInput ? aiApiKeyInput.value.trim() : '';
        if(apiKeyVal){ const v2 = validateApiKey(apiKeyVal); if(!v2.ok){ setStatus('API key: '+v2.err,'err'); return; } }
        setStatus('Menyimpan (encrypted) via proxy...', 'info');
        showSpinnerOn(card);
        try {
          // For safety, prefer front-end encryption already in your flow â€” here we call backend that expects { uri, collection, password, payload }
          // Collect last chat
          let payload = null;
          try {
            if(window.quantumEngine && typeof window.quantumEngine.getChatHistory === 'function'){
              payload = await window.quantumEngine.getChatHistory();
            } else {
              // fallback: parse message nodes
              const msgs = Array.from(document.querySelectorAll('.quantum-message'));
              payload = msgs.map(m => ({ role: m.classList.contains('user') ? 'user' : (m.classList.contains('ai') ? 'assistant' : 'system'), text: m.innerText || m.textContent || '' }));
            }
          } catch(e){ payload = []; }
          const res = await safeFetch('/user/saveChat', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ uri, collection: coll, password: pass || (passSuggest && passSuggest.value) || '', payload }) });
          setStatus('Sukses tersimpan di Mongo (via proxy).', 'ok');
        } catch(err){
          console.warn(err);
          setStatus('Gagal simpan: '+ (err && err.body && err.body.error ? err.body.error : (err && err.message ? err.message : 'unknown')), 'err');
        } finally { hideSpinnerOn(card); }
      });
    }

    // Attach copy password with auto wipe
    if(copyBtn && !copyBtn.__enhanced){
      copyBtn.__enhanced = true;
      copyBtn.addEventListener('click', async ()=>{
        const pass = passSuggest ? passSuggest.value : '';
        if(!pass) return;
        try {
          if(navigator.clipboard && navigator.clipboard.writeText) await navigator.clipboard.writeText(pass);
          // visual feedback
          copyBtn.textContent = 'Copied';
          setTimeout(()=> copyBtn.textContent = 'Copy', 1500);
          // wipe clipboard after 12-18s (randomize a bit)
          const delay = 10000 + Math.floor(Math.random()*10000);
          wipeClipboardAfterDelay(passSuggest || pass, delay);
        } catch(e){
          console.warn('copy fail', e);
        }
      });
    }

    // Backup Now button (if present)
    const backupBtn = card.querySelector('#backupNowBtn') || card.querySelector('#backupNow');
    if(backupBtn && !backupBtn.__enhanced){
      backupBtn.__enhanced = true;
      backupBtn.addEventListener('click', async ()=>{
        setStatus('Memulai backup...', 'info');
        showSpinnerOn(card);
        try {
          const res = await safeFetch('/user/backupNow', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ reason:'manual' }) });
          setStatus('Backup dijalankan: ' + (res.message || 'ok'), 'ok');
        } catch(err){
          console.warn(err);
          setStatus('Backup gagal: '+ (err && err.body && err.body.error ? err.body.error : (err && err.message ? err.message : 'unknown')), 'err');
        } finally { hideSpinnerOn(card); }
      });
    }

    // ensure card has unique id so patch doesn't re-run
    card.id = 'quantumMongoCard_enhanced';
    // small ARIA hint for screen readers
    card.setAttribute('aria-live', 'polite');
  }

  /* ------------------ Insert enhancements when DOM ready / sidebar open ------------------ */
  function tryEnhance(){
    tryEnhance._tries = (tryEnhance._tries||0) + 1;
    const tools = $('quantumToolsSidebar') || document.querySelector('.quantum-tools-sidebar') || document.querySelector('.tools-sidebar');
    if(!tools){
      if(tryEnhance._tries < 10) setTimeout(tryEnhance, 500);
      return;
    }
    enhanceMongoCard();
  }
  // run now and also after slight delay for SPA render
  tryEnhance();
  setTimeout(tryEnhance, 1000);
  setTimeout(tryEnhance, 3000);

  /* ------------------ Extra: prevent double binding on RPP notice Save button ------------------ */
  (function lockRppSave(){
    const saveBtn = document.getElementById('quantumSaveConfigEnc') || null;
    if(!saveBtn) return;
    if(saveBtn.__locked) return;
    saveBtn.__locked = true;
    saveBtn.addEventListener('click', async (e)=>{
      // small guard to prevent double-click
      if(saveBtn.disabled) return;
      saveBtn.disabled = true;
      try {
        // call existing flow if any
        const pass = prompt('Masukkan passphrase untuk enkripsi config (ingat passphrase ini):');
        if(!pass){ setTimeout(()=> saveBtn.disabled = false, 600); return; }
        if(typeof window.saveConfigEncrypted === 'function'){
          window.saveConfigEncrypted(pass);
          alert('Config disimpan (encrypted).');
        } else {
          alert('Fungsi saveConfigEncrypted tidak tersedia pada saat ini.');
        }
      } catch(e){ console.warn(e); }
      setTimeout(()=> saveBtn.disabled = false, 800);
    });
  })();

  /* ------------------ Final: expose small API for debug ------------------ */
  window.__quantum_patch_vfinal_info = { enhancedAt: Date.now() };

})();
</script>
<script>
// ==================== QUANTUM CUSTOM THEMES WITH UNIQUE PARTICLE SYSTEMS ====================
function injectQuantumThemesWithCustomParticles() {
    console.log('ðŸŽ¨ Injecting 8 Quantum Custom Themes with Unique Particle Systems...');
    
    // Definisikan 8 tema kustom lengkap dengan sistem partikel unik
    const customThemes = {
        'golden-xray': {
            name: 'Golden Xray',
            colors: {
                '--quantum-layer1': '#ffd700',
                '--quantum-layer2': '#ffed4e',
                '--quantum-layer3': '#fff9ae',
                '--quantum-layer4': '#fffce6',
                '--quantum-layer5': '#ff6b35',
                '--quantum-layer6': '#ff8e53',
                '--quantum-layer7': '#ffb38a',
                '--quantum-layer8': '#fffaf0',
                '--quantum-primary': '#ffd700',
                '--quantum-secondary': '#ff6b35',
                '--quantum-accent': '#ffed4e',
                '--quantum-bg': '#0a0a0a',
                '--quantum-card': '#1a1a1a',
                '--quantum-surface': '#2a2a2a',
                '--quantum-border': 'rgba(255, 215, 0, 0.4)',
                '--quantum-text': '#ffffff',
                '--quantum-aurora-1': '#ffd700',
                '--quantum-aurora-2': '#ffed4e',
                '--quantum-aurora-3': '#fff9ae',
                '--quantum-aurora-4': '#ff6b35'
            },
            fonts: {
                primary: 'Rajdhani, sans-serif',
                display: 'Audiowide, cursive',
                code: 'Fira Code, monospace'
            },
            effects: {
                glow: '0 0 40px rgba(255, 215, 0, 0.6)',
                transition: 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)',
                particleType: 'goldenFloat'
            }
        },
        'darkest-thanos': {
            name: 'Darkest Thanos',
            colors: {
                '--quantum-layer1': '#6a0dad',
                '--quantum-layer2': '#8a2be2',
                '--quantum-layer3': '#9370db',
                '--quantum-layer4': '#ba55d3',
                '--quantum-layer5': '#4b0082',
                '--quantum-layer6': '#483d8b',
                '--quantum-layer7': '#663399',
                '--quantum-layer8': '#2d2d2d',
                '--quantum-primary': '#6a0dad',
                '--quantum-secondary': '#4b0082',
                '--quantum-accent': '#8a2be2',
                '--quantum-bg': '#0a0a0a',
                '--quantum-card': '#1a1a1a',
                '--quantum-surface': '#2d2d2d',
                '--quantum-border': 'rgba(106, 13, 173, 0.5)',
                '--quantum-text': '#e6e6fa',
                '--quantum-aurora-1': '#6a0dad',
                '--quantum-aurora-2': '#8a2be2',
                '--quantum-aurora-3': '#9370db',
                '--quantum-aurora-4': '#4b0082'
            },
            fonts: {
                primary: 'Exo 2, sans-serif',
                display: 'Orbitron, monospace',
                code: 'JetBrains Mono, monospace'
            },
            effects: {
                glow: '0 0 50px rgba(106, 13, 173, 0.7)',
                transition: 'all 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94)',
                particleType: 'blackPulse'
            }
        },
        'glorious-spartan': {
            name: 'Glorious Spartan',
            colors: {
                '--quantum-layer1': '#c41e3a',
                '--quantum-layer2': '#dc143c',
                '--quantum-layer3': '#b22222',
                '--quantum-layer4': '#8b0000',
                '--quantum-layer5': '#ffd700',
                '--quantum-layer6': '#daa520',
                '--quantum-layer7': '#cd853f',
                '--quantum-layer8': '#2f2f2f',
                '--quantum-primary': '#c41e3a',
                '--quantum-secondary': '#ffd700',
                '--quantum-accent': '#dc143c',
                '--quantum-bg': '#1a1a1a',
                '--quantum-card': '#2a2a2a',
                '--quantum-surface': '#3a3a3a',
                '--quantum-border': 'rgba(196, 30, 58, 0.5)',
                '--quantum-text': '#ffffff',
                '--quantum-aurora-1': '#c41e3a',
                '--quantum-aurora-2': '#dc143c',
                '--quantum-aurora-3': '#ffd700',
                '--quantum-aurora-4': '#8b0000'
            },
            fonts: {
                primary: 'Montserrat, sans-serif',
                display: 'Audiowide, cursive',
                code: 'Fira Code, monospace'
            },
            effects: {
                glow: '0 0 45px rgba(196, 30, 58, 0.6)',
                transition: 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)',
                particleType: 'redSword'
            }
        },
        'cartoon-cyber': {
            name: 'Cartoon Cyber',
            colors: {
                '--quantum-layer1': '#00ff88',
                '--quantum-layer2': '#00ccff',
                '--quantum-layer3': '#ff00ff',
                '--quantum-layer4': '#ffaa00',
                '--quantum-layer5': '#ff0066',
                '--quantum-layer6': '#7700ff',
                '--quantum-layer7': '#00ffff',
                '--quantum-layer8': '#f0f0f0',
                '--quantum-primary': '#00ff88',
                '--quantum-secondary': '#00ccff',
                '--quantum-accent': '#ff00ff',
                '--quantum-bg': '#0f0f23',
                '--quantum-card': '#1e1e3f',
                '--quantum-surface': '#2d2d5a',
                '--quantum-border': 'rgba(0, 255, 136, 0.6)',
                '--quantum-text': '#ffffff',
                '--quantum-aurora-1': '#00ff88',
                '--quantum-aurora-2': '#00ccff',
                '--quantum-aurora-3': '#ff00ff',
                '--quantum-aurora-4': '#ffaa00'
            },
            fonts: {
                primary: 'Comic Neue, cursive',
                display: 'Audiowide, cursive',
                code: 'Fira Code, monospace'
            },
            effects: {
                glow: '0 0 60px rgba(0, 255, 136, 0.8)',
                transition: 'all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55)',
                particleType: 'shapeShifter'
            }
        },
        'matrix-neo': {
            name: 'Matrix Neo',
            colors: {
                '--quantum-layer1': '#00ff41',
                '--quantum-layer2': '#008f11',
                '--quantum-layer3': '#003b00',
                '--quantum-layer4': '#00ff41',
                '--quantum-layer5': '#00cc33',
                '--quantum-layer6': '#009900',
                '--quantum-layer7': '#006600',
                '--quantum-layer8': '#0a0a0a',
                '--quantum-primary': '#00ff41',
                '--quantum-secondary': '#008f11',
                '--quantum-accent': '#003b00',
                '--quantum-bg': '#000000',
                '--quantum-card': '#0a0a0a',
                '--quantum-surface': '#1a1a1a',
                '--quantum-border': 'rgba(0, 255, 65, 0.7)',
                '--quantum-text': '#00ff41',
                '--quantum-aurora-1': '#00ff41',
                '--quantum-aurora-2': '#008f11',
                '--quantum-aurora-3': '#003b00',
                '--quantum-aurora-4': '#00cc33'
            },
            fonts: {
                primary: 'JetBrains Mono, monospace',
                display: 'Orbitron, monospace',
                code: 'Fira Code, monospace'
            },
            effects: {
                glow: '0 0 50px rgba(0, 255, 65, 0.9)',
                transition: 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)',
                particleType: 'codeRain'
            }
        },
        'deepest-aquaman': {
            name: 'Deepest Aquaman',
            colors: {
                '--quantum-layer1': '#00a8ff',
                '--quantum-layer2': '#0097e6',
                '--quantum-layer3': '#0077b6',
                '--quantum-layer4': '#005885',
                '--quantum-layer5': '#003f5c',
                '--quantum-layer6': '#00d2ff',
                '--quantum-layer7': '#4facfe',
                '--quantum-layer8': '#e6f7ff',
                '--quantum-primary': '#00a8ff',
                '--quantum-secondary': '#0077b6',
                '--quantum-accent': '#00d2ff',
                '--quantum-bg': '#001f3f',
                '--quantum-card': '#003366',
                '--quantum-surface': '#004080',
                '--quantum-border': 'rgba(0, 168, 255, 0.5)',
                '--quantum-text': '#e6f7ff',
                '--quantum-aurora-1': '#00a8ff',
                '--quantum-aurora-2': '#0097e6',
                '--quantum-aurora-3': '#0077b6',
                '--quantum-aurora-4': '#00d2ff'
            },
            fonts: {
                primary: 'Raleway, sans-serif',
                display: 'Exo 2, sans-serif',
                code: 'Fira Code, monospace'
            },
            effects: {
                glow: '0 0 45px rgba(0, 168, 255, 0.6)',
                transition: 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)',
                particleType: 'oceanWave'
            }
        },
        'cyberpunk-city': {
            name: 'Cyberpunk City',
            colors: {
                '--quantum-layer1': '#ff073a',
                '--quantum-layer2': '#ff2a6d',
                '--quantum-layer3': '#05d9e6',
                '--quantum-layer4': '#005678',
                '--quantum-layer5': '#0c1821',
                '--quantum-layer6': '#1b2cc1',
                '--quantum-layer7': '#ff3864',
                '--quantum-layer8': '#1a1b2f',
                '--quantum-primary': '#ff073a',
                '--quantum-secondary': '#05d9e6',
                '--quantum-accent': '#ff2a6d',
                '--quantum-bg': '#0c1821',
                '--quantum-card': '#1a1b2f',
                '--quantum-surface': '#252641',
                '--quantum-border': 'rgba(255, 7, 58, 0.6)',
                '--quantum-text': '#ffffff',
                '--quantum-aurora-1': '#ff073a',
                '--quantum-aurora-2': '#ff2a6d',
                '--quantum-aurora-3': '#05d9e6',
                '--quantum-aurora-4': '#1b2cc1'
            },
            fonts: {
                primary: 'Urbanist, sans-serif',
                display: 'Audiowide, cursive',
                code: 'JetBrains Mono, monospace'
            },
            effects: {
                glow: '0 0 55px rgba(255, 7, 58, 0.7)',
                transition: 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)',
                particleType: 'neonPulse'
            }
        },
        'rose-madonna': {
            name: 'Rose Madonna',
            colors: {
                '--quantum-layer1': '#e91e63',
                '--quantum-layer2': '#ad1457',
                '--quantum-layer3': '#880e4f',
                '--quantum-layer4': '#ec407a',
                '--quantum-layer5': '#f48fb1',
                '--quantum-layer6': '#f8bbd9',
                '--quantum-layer7': '#fce4ec',
                '--quantum-layer8': '#fafafa',
                '--quantum-primary': '#e91e63',
                '--quantum-secondary': '#ad1457',
                '--quantum-accent': '#ec407a',
                '--quantum-bg': '#1a1a2e',
                '--quantum-card': '#2a2a3e',
                '--quantum-surface': '#3a3a4e',
                '--quantum-border': 'rgba(233, 30, 99, 0.5)',
                '--quantum-text': '#ffffff',
                '--quantum-aurora-1': '#e91e63',
                '--quantum-aurora-2': '#ad1457',
                '--quantum-aurora-3': '#880e4f',
                '--quantum-aurora-4': '#ec407a'
            },
            fonts: {
                primary: 'Playfair Display, serif',
                display: 'Raleway, sans-serif',
                code: 'Source Sans Pro, sans-serif'
            },
            effects: {
                glow: '0 0 40px rgba(233, 30, 99, 0.6)',
                transition: 'all 0.7s cubic-bezier(0.4, 0, 0.2, 1)',
                particleType: 'roseFloat'
            }
        }
    };

    // Inject tema ke dalam sistem tema global
    if (!window.quantumThemes) {
        window.quantumThemes = {};
    }

    // Tambahkan semua tema kustom
    Object.assign(window.quantumThemes, customThemes);

    // Inject styles untuk sistem partikel kustom
    injectCustomParticleSystems();

    // Update theme grid dengan tema baru
    updateThemeGridWithCustomThemes();

    console.log('âœ… 8 Custom Themes with Unique Particle Systems injected successfully!');
}

function injectCustomParticleSystems() {
    const style = document.createElement('style');
    style.textContent = `
        /* ==================== CUSTOM PARTICLE SYSTEMS ==================== */
        
        /* Golden Xray - Floating particles dengan efek sinar-X */
        .particle-goldenFloat {
            background: radial-gradient(circle, #ffd700, #ffed4e, transparent);
            box-shadow: 0 0 15px #ffd700, 0 0 30px #ffed4e;
            animation: goldenFloat 20s linear infinite;
            border-radius: 50%;
        }
        
        @keyframes goldenFloat {
            0% {
                transform: translateY(100vh) translateX(0) rotate(0deg) scale(0.5);
                opacity: 0;
            }
            10% {
                opacity: 0.8;
                transform: translateY(80vh) translateX(20px) rotate(90deg) scale(1);
            }
            50% {
                transform: translateY(40vh) translateX(-15px) rotate(180deg) scale(1.2);
            }
            90% {
                opacity: 0.7;
                transform: translateY(10vh) translateX(10px) rotate(270deg) scale(0.8);
            }
            100% {
                transform: translateY(-100px) translateX(30px) rotate(360deg) scale(0.5);
                opacity: 0;
            }
        }
        
        /* Darkest Thanos - Black hole pulse particles */
        .particle-blackPulse {
            background: radial-gradient(circle, #6a0dad, #4b0082, #000000);
            animation: blackPulse 8s ease-in-out infinite;
            border-radius: 50%;
            box-shadow: 
                0 0 20px #6a0dad,
                0 0 40px #4b0082,
                inset 0 0 20px #000000;
        }
        
        @keyframes blackPulse {
            0%, 100% {
                transform: scale(0.8);
                opacity: 0.7;
            }
            50% {
                transform: scale(1.5);
                opacity: 0.9;
            }
        }
        
        /* Glorious Spartan - Sword-like red particles */
        .particle-redSword {
            background: linear-gradient(45deg, #c41e3a, #dc143c, #8b0000);
            animation: redSword 12s ease-in-out infinite;
            width: 4px !important;
            height: 20px !important;
            border-radius: 2px;
            box-shadow: 0 0 10px #c41e3a, 0 0 20px #dc143c;
        }
        
        @keyframes redSword {
            0% {
                transform: translateY(100vh) translateX(0) rotate(0deg);
                opacity: 0;
            }
            15% {
                opacity: 1;
                transform: translateY(80vh) translateX(30px) rotate(45deg);
            }
            30% {
                transform: translateY(60vh) translateX(-20px) rotate(90deg);
            }
            45% {
                transform: translateY(40vh) translateX(25px) rotate(135deg);
            }
            60% {
                transform: translateY(20vh) translateX(-15px) rotate(180deg);
            }
            75% {
                opacity: 0.8;
                transform: translateY(10vh) translateX(20px) rotate(225deg);
            }
            100% {
                transform: translateY(-100px) translateX(-25px) rotate(270deg);
                opacity: 0;
            }
        }
        
        /* Cartoon Cyber - Shape-shifting particles */
        .particle-shapeShifter {
            background: #00ff88;
            animation: shapeShifter 15s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
            box-shadow: 
                0 0 10px #00ff88,
                0 0 20px #00ccff,
                0 0 30px #ff00ff;
        }
        
        @keyframes shapeShifter {
            0% {
                transform: translateY(100vh) translateX(0) scale(1);
                border-radius: 50%;
                opacity: 0;
                background: #00ff88;
            }
            10% {
                opacity: 1;
                transform: translateY(80vh) translateX(20px) scale(1.2);
                border-radius: 50%;
                background: #00ff88;
            }
            25% {
                transform: translateY(60vh) translateX(-15px) scale(0.8);
                border-radius: 0%;
                background: #00ccff;
            }
            40% {
                transform: translateY(45vh) translateX(25px) scale(1.1);
                border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
                background: #ff00ff;
            }
            55% {
                transform: translateY(30vh) translateX(-10px) scale(0.9);
                border-radius: 50%;
                background: #ffaa00;
            }
            70% {
                transform: translateY(15vh) translateX(20px) scale(1.05);
                border-radius: 20%;
                background: #ff0066;
            }
            85% {
                opacity: 0.8;
                transform: translateY(5vh) translateX(-5px) scale(1);
                border-radius: 50%;
                background: #7700ff;
            }
            100% {
                transform: translateY(-100px) translateX(30px) scale(0.8);
                opacity: 0;
                border-radius: 50%;
                background: #00ffff;
            }
        }
        
        /* Matrix Neo - Code rain particles */
        .particle-codeRain {
            background: transparent;
            color: #00ff41;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: codeRain 8s linear infinite;
            text-shadow: 0 0 5px #00ff41;
            width: 20px !important;
            height: 20px !important;
        }
        
        @keyframes codeRain {
            0% {
                transform: translateY(-100px) translateX(0);
                opacity: 0;
            }
            5% {
                opacity: 1;
                transform: translateY(0) translateX(0);
            }
            10% {
                transform: translateY(20vh) translateX(5px);
            }
            20% {
                transform: translateY(40vh) translateX(-3px);
            }
            30% {
                transform: translateY(60vh) translateX(2px);
            }
            40% {
                transform: translateY(80vh) translateX(-1px);
            }
            50% {
                opacity: 1;
                transform: translateY(100vh) translateX(0);
            }
            100% {
                transform: translateY(120vh) translateX(0);
                opacity: 0;
            }
        }
        
        /* Deepest Aquaman - Ocean wave particles */
        .particle-oceanWave {
            background: radial-gradient(circle, #00a8ff, #0097e6, #0077b6);
            animation: oceanWave 18s ease-in-out infinite;
            border-radius: 50% 50% 0 0;
            box-shadow: 
                0 0 10px #00a8ff,
                0 0 20px #0097e6,
                inset 0 5px 10px rgba(0, 168, 255, 0.5);
        }
        
        @keyframes oceanWave {
            0% {
                transform: translateY(100vh) translateX(0) rotate(0deg);
                opacity: 0;
            }
            15% {
                opacity: 0.8;
                transform: translateY(80vh) translateX(20px) rotate(10deg);
            }
            30% {
                transform: translateY(70vh) translateX(-15px) rotate(-5deg);
            }
            45% {
                transform: translateY(55vh) translateX(25px) rotate(8deg);
            }
            60% {
                transform: translateY(45vh) translateX(-10px) rotate(-3deg);
            }
            75% {
                opacity: 0.7;
                transform: translateY(30vh) translateX(15px) rotate(6deg);
            }
            90% {
                transform: translateY(15vh) translateX(-5px) rotate(-2deg);
            }
            100% {
                transform: translateY(-100px) translateX(10px) rotate(0deg);
                opacity: 0;
            }
        }
        
        /* Cyberpunk City - Neon pulse particles */
        .particle-neonPulse {
            background: radial-gradient(circle, #ff073a, #ff2a6d, #05d9e6);
            animation: neonPulse 10s ease-in-out infinite;
            border-radius: 50%;
            box-shadow: 
                0 0 15px #ff073a,
                0 0 30px #ff2a6d,
                0 0 45px #05d9e6;
        }
        
        @keyframes neonPulse {
            0%, 100% {
                transform: scale(1) translateY(100vh) translateX(0);
                opacity: 0;
                filter: brightness(1);
            }
            10% {
                opacity: 0.9;
                transform: scale(1.2) translateY(80vh) translateX(30px);
                filter: brightness(1.5);
            }
            30% {
                transform: scale(0.8) translateY(60vh) translateX(-20px);
                filter: brightness(1);
            }
            50% {
                transform: scale(1.3) translateY(40vh) translateX(25px);
                filter: brightness(1.8);
            }
            70% {
                transform: scale(0.9) translateY(20vh) translateX(-15px);
                filter: brightness(1.2);
            }
            90% {
                opacity: 0.8;
                transform: scale(1.1) translateY(10vh) translateX(20px);
                filter: brightness(1.6);
            }
        }
        
        /* Rose Madonna - Floating rose petal particles */
        .particle-roseFloat {
            background: radial-gradient(ellipse at center, #e91e63, #ad1457, #880e4f);
            animation: roseFloat 25s ease-in-out infinite;
            border-radius: 50% 50% 50% 0;
            transform: rotate(45deg);
            box-shadow: 
                0 0 10px #e91e63,
                0 0 20px #ad1457,
                inset 0 0 10px rgba(233, 30, 99, 0.5);
        }
        
        @keyframes roseFloat {
            0% {
                transform: translateY(100vh) translateX(0) rotate(45deg) scale(0.8);
                opacity: 0;
            }
            20% {
                opacity: 0.7;
                transform: translateY(80vh) translateX(15px) rotate(90deg) scale(1);
            }
            40% {
                transform: translateY(60vh) translateX(-10px) rotate(135deg) scale(1.1);
            }
            60% {
                transform: translateY(40vh) translateX(8px) rotate(180deg) scale(0.9);
            }
            80% {
                opacity: 0.6;
                transform: translateY(20vh) translateX(-5px) rotate(225deg) scale(1);
            }
            100% {
                transform: translateY(-100px) translateX(12px) rotate(270deg) scale(0.8);
                opacity: 0;
            }
        }
        
        /* Enhanced particle container */
        .quantum-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1; /* Pastikan di background */
        }
        
        /* Pastikan neural background tetap di belakang */
        .quantum-neural-background {
            z-index: -2;
        }
        
        /* Responsive particle adjustments */
        @media (max-width: 768px) {
            .particle-codeRain {
                font-size: 10px;
                width: 15px !important;
                height: 15px !important;
            }
            
            .particle-redSword {
                width: 3px !important;
                height: 15px !important;
            }
        }
        
        @media (max-width: 480px) {
            .quantum-particles {
                display: none; /* Hide particles on very small screens for performance */
            }
        }
    `;
    document.head.appendChild(style);
    console.log('âœ… Custom particle system styles injected');
}

function updateThemeGridWithCustomThemes() {
    const themeGrid = document.getElementById('quantumThemeGrid');
    if (!themeGrid) {
        console.log('âŒ Theme grid not found, retrying...');
        setTimeout(updateThemeGridWithCustomThemes, 500);
        return;
    }

    // Clear existing content
    themeGrid.innerHTML = '';

    // Tambahkan setiap tema ke grid
    Object.entries(window.quantumThemes).forEach(([key, theme]) => {
        const themeCard = document.createElement('div');
        themeCard.className = 'quantum-theme-card cursor-pointer p-3 rounded-lg transition-all duration-300 hover:bg-purple-500/10 border border-transparent hover:border-purple-500/30';
        themeCard.innerHTML = `
            <div class="theme-preview w-full h-16 rounded-lg mb-2 border-2 overflow-hidden relative" 
                 style="background: ${theme.colors['--quantum-bg'] || '#0f0f23'}; border-color: ${theme.colors['--quantum-primary'] || '#6366f1'};">
                <div class="absolute inset-0 flex flex-col p-1">
                    <div class="h-2 w-3/4 rounded" style="background: ${theme.colors['--quantum-primary'] || '#6366f1'}; margin-bottom: 2px;"></div>
                    <div class="h-2 w-1/2 rounded" style="background: ${theme.colors['--quantum-secondary'] || '#8b5cf6'}; margin-bottom: 2px;"></div>
                    <div class="h-2 w-5/6 rounded" style="background: ${theme.colors['--quantum-accent'] || '#a855f7'};"></div>
                </div>
                <div class="absolute bottom-1 right-1 text-xs" style="color: ${theme.colors['--quantum-text'] || '#e2e8f0'}">${theme.effects.particleType.replace(/([A-Z])/g, ' $1').trim()}</div>
            </div>
            <span class="theme-name text-xs font-semibold text-white text-center block">${theme.name}</span>
        `;
        
        themeCard.addEventListener('click', () => applyCustomThemeWithParticles(key, theme));
        themeGrid.appendChild(themeCard);
    });

    console.log('âœ… Theme grid updated with custom themes');
}

function applyCustomThemeWithParticles(themeKey, theme) {
    const root = document.documentElement;
    
    // Terapkan semua variabel warna
    Object.entries(theme.colors).forEach(([property, value]) => {
        root.style.setProperty(property, value);
    });

    // Terapkan font
    if (theme.fonts) {
        root.style.setProperty('--quantum-font-primary', theme.fonts.primary);
        root.style.setProperty('--quantum-font-display', theme.fonts.display);
        root.style.setProperty('--quantum-font-code', theme.fonts.code);
    }

    // Terapkan efek khusus
    if (theme.effects) {
        root.style.setProperty('--quantum-glow-primary', theme.effects.glow);
        root.style.setProperty('--ios-transition', theme.effects.transition);
        
        // Update partikel dengan sistem khusus
        updateParticleSystemForTheme(theme);
    }

    // Simpan tema yang dipilih
    localStorage.setItem('quantum_theme', themeKey);
    
    // Update Quantum Island
    if (window.quantumEngine) {
        window.quantumEngine.updateQuantumIsland(`ðŸŽ¨ ${theme.name} Theme Applied`, 2000);
    }

    console.log(`âœ… ${theme.name} theme with custom particle system applied successfully`);
}

function updateParticleSystemForTheme(theme) {
    // Cari container partikel yang benar - di dalam quantum-neural-background
    const neuralBackground = document.querySelector('.quantum-neural-background');
    let particleContainer = document.getElementById('quantumParticles');
    
    // Jika container partikel tidak ada, buat yang baru
    if (!particleContainer) {
        particleContainer = document.createElement('div');
        particleContainer.id = 'quantumParticles';
        particleContainer.className = 'quantum-particles';
        
        // Tempatkan di dalam neural background
        if (neuralBackground) {
            neuralBackground.appendChild(particleContainer);
        } else {
            // Fallback: tempatkan langsung di body
            document.body.appendChild(particleContainer);
        }
    }

    // Hapus semua partikel lama
    particleContainer.innerHTML = '';

    // Theme based particle system
    const particleCountMap = {
        goldenFloat: 50,
        blackPulse: 30,
        redSword: 40,
        shapeShifter: 35,
        codeRain: 60,
        oceanWave: 45,
        neonPulse: 40,
        roseFloat: 55
    };
    
    const particleCount = particleCountMap[theme.effects.particleType] || 45;
    
    for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = `particle-${theme.effects.particleType}`;
        
        const size = getParticleSizeForTheme(theme.effects.particleType);
        const duration = 15 + Math.random() * 15;
        const delay = Math.random() * 15;
        
        particle.style.cssText = `
            width: ${size}px;
            height: ${size}px;
            animation-duration: ${duration}s;
            animation-delay: ${delay}s;
            left: ${Math.random() * 100}%;
            top: ${Math.random() * 100}%;
            position: absolute;
        `;

        if (theme.effects.particleType === 'codeRain') {
            const characters = '01ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½';
            particle.textContent = characters.charAt(Math.floor(Math.random() * characters.length));
        }

        particleContainer.appendChild(particle);
    }

    // Update neural network background
    const neuralNetwork = document.querySelector('.neural-network');
    if (neuralNetwork && theme.colors) {
        neuralNetwork.style.background = `
            radial-gradient(circle at 20% 80%, ${theme.colors['--quantum-aurora-1']} 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, ${theme.colors['--quantum-aurora-2']} 0%, transparent 50%),
            radial-gradient(circle at 40% 40%, ${theme.colors['--quantum-aurora-3']} 0%, transparent 50%)
        `;
    }

    console.log(`âœ… Particle system updated for ${theme.name} with ${particleCount} particles`);
}

function getParticleSizeForTheme(particleType) {
    const sizes = {
        'goldenFloat': Math.random() * 4 + 2,
        'blackPulse': Math.random() * 8 + 4,
        'redSword': 4, // Fixed size for swords
        'shapeShifter': Math.random() * 6 + 3,
        'codeRain': 20, // Fixed size for code characters
        'oceanWave': Math.random() * 5 + 3,
        'neonPulse': Math.random() * 7 + 3,
        'roseFloat': Math.random() * 5 + 2
    };
    
    return sizes[particleType] || 4;
}

// ==================== INITIALIZE ENHANCED THEME SYSTEM ====================
function initializeEnhancedThemeSystem() {
    console.log('ðŸŽ¨ Starting Enhanced Quantum Theme System with Custom Particles...');
    
    // Inject custom themes with unique particle systems
    injectQuantumThemesWithCustomParticles();
    
    // Load saved theme
    const savedTheme = localStorage.getItem('quantum_theme');
    if (savedTheme && window.quantumThemes && window.quantumThemes[savedTheme]) {
        setTimeout(() => {
            applyCustomThemeWithParticles(savedTheme, window.quantumThemes[savedTheme]);
        }, 1000);
    }
    
    console.log('âœ… Enhanced Quantum Theme System with Custom Particles Activated!');
}

// ==================== AUTO-INITIALIZE ENHANCED THEME SYSTEM ====================
function waitForEngineAndAddEnhancedThemes() {
    // Tunggu hingga DOM sepenuhnya dimuat
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeEnhancedThemeSystem);
    } else {
        initializeEnhancedThemeSystem();
    }
}

// Start the enhanced theme system
waitForEngineAndAddEnhancedThemes();

// Update global enhancements
if (window.QuantumEnhancements) {
    window.QuantumEnhancements.injectQuantumThemesWithCustomParticles = injectQuantumThemesWithCustomParticles;
    window.QuantumEnhancements.initializeEnhancedThemeSystem = initializeEnhancedThemeSystem;
}

console.log('ðŸŽ¨ Enhanced Quantum Theme System Module Loaded - Ready for 8 custom themes with unique particle systems!');
</script>
<!-- Ultra-Lite Loader: lazy-load heavy libs on-demand -->
<script>
window.__ULTRALITE_LOADER__ = (function(){
  const libs = {
    jspdf: "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.u
<!-- Ultra-Lite generated: lazy-loaded heavy libs, subset fonts, dedupe, minify. Generated: 2025-11-14T01:33:06.015605Z -->
md.min.js",
html2canvas: "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js",
xlsx: "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js",
tfjs: "https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"
};
const cache = {};
function loadScript(url){
if(cache[url]) return Promise.resolve(cache[url]);
return new Promise((res,rej)=>{
const s = document.createElement('script');
s.src = url; s.async=true;
s.onload = ()=>{ cache[url]=true; res(true); };
s.onerror = (e)=> rej(e);
document.head.appendChild(s);
});
}
return {
loadJsPDF: async function(){ if(window.jspdf || window.jspdfjs || window.jspdf){ return window.jspdf||window.jspdfjs||window.jspdf; } await loadScript(libs.jspdf); return window.jspdf||window.jspdfjs||window.jspdf; },
loadHtml2Canvas: async function(){ if(window.html2canvas) return window.html2canvas; await loadScript(libs.html2canvas); return window.html2canvas; },
loadXLSX: async function(){ if(window.XLSX) return window.XLSX; await loadScript(libs.xlsx); return window.XLSX; },
loadTF: async function(){ if(window.tf) return window.tf; await loadScript(libs.tfjs); return window.tf; }
};
})();
</script>
<script>
}
}
}
return result;
};
try { Object.defineProperty(fused, 'name', { value: (coreFn.name || 'fusionFn'), configurable:true }); } catch(e){}
return fused;
}
// build fusion for a set of textual implementations or functions
function fusionForName(name, occurrences){
// occurrences: array of {index, node, text, src, length, fnObj(optional)}
if(!occurrences || occurrences.length === 0) return null;
// If any occurrence already has runnable function object available, capture them
const runnableImpls = occurrences.map(o => o.fnObj).filter(Boolean);
// choose core: prefer window[name] if substantial
if(window[name] && typeof window[name] === 'function' && window[name].toString().length > 120){
// take window impl as core
const core = window[name];
// pick other runnable ones as augmenters
const aug = runnableImpls.filter(fn => fn !== core);
return createFusionFunction(core, aug);
}
// else choose largest textual occurrence and attempt to eval
occurrences.sort((a,b)=> (b.length||0) - (a.length||0));
const best = occurrences[0];
let coreImpl = best.fnObj || null;
if(!coreImpl && best.text){
// try to extract snippet and eval
const snippet = extractSnippetAroundName(best.text, name) || best.text;
const evaled = safeEvalSnippetReturnSymbol(snippet, name);
if(evaled) coreImpl = evaled;
}
// collect augmenters from others
const augImpls = [];
for(let i=1;i<occurrences.length;i++){
const o = occurrences[i];
let fn = o.fnObj || null;
if(!fn && o.text){
const s = extractSnippetAroundName(o.text, name) || o.text;
fn = safeEvalSnippetReturnSymbol(s, name);
}
if(fn) augImpls.push(fn);
else {
// store raw text as reference on DEV_lg for manual review
}
}
if(coreImpl && (isFunctionLike(coreImpl) || isClassString(coreImpl.toString && coreImpl.toString())) ){
// if core is a class string, eval returns class; handle class mixing
if(isFunctionLike(coreImpl) && isClassString(coreImpl.toString && coreImpl.toString())){
// it's a class; mix in prototype methods from augmenters that are class-like
for(const a of augImpls){
if(a && a.prototype) try { mixinClassPrototype(coreImpl, a); } catch(e){}
}
return coreImpl; // class as-is
} else {
return createFusionFunction(coreImpl, augImpls);
}
}
// fallback: if no runnable impls, try to create noop that logs
return function(){ safeLog('DEV_mg: fused placeholder for', name); };
}
// ========== Scanning & collection ==========
function collectOccurrencesForProtectedNames(){
const occMap = {}; // name -> occurrences[]
const scripts = scriptsArray();
for(let i=0;i<scripts.length;i++){
const s = scripts[i];
const text = (s.textContent || '') + '\n';
for(const name of PROTECTED_NAMES){
if(text.indexOf(name) !== -1){
occMap[name] = occMap[name] || [];
occMap[name].push({ index:i, node:s, text: text, src: s.src || null, length: text.length });
}
}
}
// attach any runnable implementations from window if present
for(const name of PROTECTED_NAMES){
if(window[name] && typeof window[name] === 'function'){
occMap[name] = occMap[name] || [];
occMap[name].unshift({ index:-1, node:null, text: (window[name] && window[name].toString && window[name].toString()) || '', src: 'window', length: (window[name] && window[name].toString && window[name].toString().length) || 0, fnObj: window[name] });
}
}
return occMap;
}
// ========== DEV_lg creation (promote & fusion) ==========
if(!window.DEV_lg){
try { Object.defineProperty(window, 'DEV_lg', { configurable:true, writable:true, value: { __createdAt: nowISO(), chosen: {} } }); }
catch(e){ window.DEV_lg = { __createdAt: nowISO(), chosen: {} }; }
}
// initial snapshots
window.DEV_lg.__styleSnapshot = window.DEV_lg.__styleSnapshot || { inline: snapshotInlineStyles(), sheets: snapshotStyleSheets(), takenAt: nowISO() };
window.DEV_lg.__functionSnapshot = window.DEV_lg.__functionSnapshot || { takenAt: nowISO(), data:{} };
// Run scan
function scanPromoteAndFuse(){
try{
safeLog('scanPromoteAndFuse start');
const occ = collectOccurrencesForProtectedNames();
for(const name of PROTECTED_NAMES){
const occurrences = occ[name] || [];
if(occurrences.length === 0){
safeLog('no occurrences for', name);
continue;
}
// attempt to evaluate runnable impls for occurrences to increase quality
for(const o of occurrences){
if(!o.fnObj && o.text){
const snippet = extractSnippetAroundName(o.text, name);
if(snippet){
try{
const evaled = safeEvalSnippetReturnSymbol(snippet, name);
if(evaled) o.fnObj = evaled;
}catch(e){}
}
}
}
// fusion
const fused = fusionForName(name, occurrences);
if(fused){
try{
// For classes (function that string starts with class), store as-is; for functions store fused wrapper
window.DEV_lg[name] = fused;
window.DEV_lg.chosen[name] = { promotedAt: nowISO(), sourceCount: occurrences.length, canonicalFrom: occurrences[0] && (occurrences[0].src || ('script#'+occurrences[0].index)) || 'unknown' };
try {
// set to window as canonical (we'll lock later)
window[name] = fused;
} catch(e){}
// snapshot textual form if available
window.DEV_lg.__functionSnapshot.data[name] = { chosenSource: window.DEV_lg.chosen[name].canonicalFrom, occurrenceCount: occurrences.length, note:'fused' };
safeLog('Fused & promoted', name);
}catch(e){ safeErr('failed to assign fused for', name, e); }
}
}
window.DEV_lg.__functionSnapshot.takenAt = nowISO();
safeLog('scanPromoteAndFuse complete');
}catch(e){ safeErr('scanPromoteAndFuse error', e); }
}
// ========== Enforcement (lock & restore) ==========
function lockCanonical(){
try{
if(!window.DEV_lg) return;
for(const name of Object.keys(window.DEV_lg.chosen || {})){
try{
const impl = window.DEV_lg[name];
if(typeof impl !== 'undefined'){
try {
Object.defineProperty(window, name, { value: impl, writable: false, configurable: false });
safeLog('Locked', name);
} catch(e){
try{ window[name] = impl; safeLog('Assigned canonical (no lock) for', name); }catch(e){}
}
}
}catch(e){ safeErr('lockCanonical error for', name, e); }
}
}catch(e){ safeErr('lockCanonical outer error', e); }
}
function restoreIfTampered(){
try{
if(!window.DEV_lg) return;
for(const name of Object.keys(window.DEV_lg.chosen || {})){
try{
const canonical = window.DEV_lg[name];
if(typeof canonical !== 'undefined' && window[name] !== canonical){
safeLog('Detected tamper on', name, '-> restoring canonical');
try{ window[name] = canonical; }catch(e){}
}
}catch(e){}
}
}catch(e){ safeErr('restoreIfTampered error', e); }
}
// Neutralize rogue script node (best-effort non-destructive)
function neutralizeScriptNode(node){
try{
if(!node || node.tagName !== 'SCRIPT') return;
try { node.type = 'javascript/disabled.dev-mg'; } catch(e){}
try { node.setAttribute('data-dev-mg-neutralized', '1'); } catch(e){}
safeLog('Neutralized script node at index', idxOfNode(node), 'src', node.src || '(inline)');
}catch(e){ safeErr('neutralizeScriptNode failed', e); }
}
// ========== Style audit & restore ==========
function auditStylesAndRestore(){
try{
const snapshot = window.DEV_lg && window.DEV_lg.__styleSnapshot;
if(!snapshot) return;
// gather current CSS text
let current = '';
for(const ss of Array.from(document.styleSheets || [])){
try {
if(ss.cssRules){
for(const r of Array.from(ss.cssRules)) current += r.cssText + '\n';
} else if(ss.ownerNode && ss.ownerNode.textContent) current += ss.ownerNode.textContent + '\n';
} catch(e){  }
}
for(const sel of CRITICAL_SELECTORS){
if(sel && current.indexOf(sel) === -1){
safeLog('Critical selector missing:', sel, '-> injecting snapshot fallback');
// inject whole snapshot sheets as fallback style (non-destructive)
const combined = (snapshot.sheets || []).map(s=>s.text||'').join('\n');
if(combined){
const st = document.createElement('style');
st.setAttribute('data-dev-mg-restore','1');
st.textContent = combined;
try { document.head.appendChild(st); safeLog('Injected snapshot style fallback'); } catch(e){}
} else {
// fallback: restore inline body style
try{ if(snapshot.inline && snapshot.inline.body) document.body.setAttribute('style', snapshot.inline.body); }catch(e){}
}
}
}
}catch(e){ safeErr('auditStylesAndRestore error', e); }
}
// ========== Promotion (DEV_kt handshake) ==========
const pendingOffers = {};
const DEV_kt = { installedAt: nowISO(), addons: {}, metadata: {} };
function genOfferId(){ return 'dev_offer_' + Math.random().toString(36).slice(2,12); }
function requestPromotion(meta){
const id = genOfferId();
pendingOffers[id] = { id, meta: cloneJSON(meta), state:'pending', createdAt: nowISO() };
safeLog('Promotion requested id=', id, 'name=', meta && meta.name);
// Return offer requiring developer acceptance via DEV_iy code
return { id, message: 'DEV_mg: developer approval required. To accept call DEV_mg.acceptPromotion(id, \"DEV_iy\")', offer: pendingOffers[id] };
}
function acceptPromotion(id, code){
if(!pendingOffers[id]) return { ok:false, reason:'unknown_offer' };
if(code !== ACCEPT_CODE) return { ok:false, reason:'invalid_accept_code' };
const offer = pendingOffers[id];
const name = offer.meta && offer.meta.name ? offer.meta.name : 'addon_' + id;
// promote to DEV_kt but do not override protected names automatically
DEV_kt.addons[name] = offer.meta;
DEV_kt.metadata[name] = { promotedAt: nowISO(), offerId: id };
safeLog('Promotion accepted for', name);
// If addon defines functions overlapping PROTECTED_NAMES, keep them as augmentation only
if(offer.meta && offer.meta.codeText){
for(const nm of PROTECTED_NAMES){
if(offer.meta.codeText.indexOf(nm) !== -1){
safeLog('Addon requests protected name', nm, '- will be registered as augmentation only (no override).');
}
}
}
delete pendingOffers[id];
return { ok:true, name };
}
// ========== Mutation Observation (Watcher) ==========
const MO = new MutationObserver((mutations)=>{
for(const m of mutations){
try{
if(m.type === 'childList' && m.addedNodes && m.addedNodes.length){
for(const n of Array.from(m.addedNodes)){
if(n.tagName === 'SCRIPT'){
const idx = idxOfNode(n);
// only act on scripts added below guardian index
if(GUARD_INDEX !== -1 && idx > GUARD_INDEX){
const txt = (n.textContent || '') + ' ' + (n.src || '');
let touchesProtected = false;
for(const nm of PROTECTED_NAMES){
if(txt.indexOf(nm) !== -1){
touchesProtected = true; break;
}
}
if(touchesProtected){
safeLog('Script below guardian touches protected names -> neutralize and restore canonical');
neutralizeScriptNode(n);
setTimeout(restoreIfTampered, 30);
} else {
// benign script: schedule light restore check
setTimeout(restoreIfTampered, 200);
}
} else {
// scripts above guardian - still schedule audit
setTimeout(restoreIfTampered, 300);
}
}
if(n.tagName === 'STYLE' || (n.tagName === 'LINK' && (n.rel==='stylesheet' || n.rel==='StyleSheet'))){
// new styles added below guardian - audit critical selectors
setTimeout(auditStylesAndRestore, 120);
}
}
}
if(m.type === 'attributes' && m.target){
// monitor body style changes that might break viewport
if(m.target === document.body || m.target === document.documentElement){
try{
const bodyStyle = document.body && document.body.getAttribute && document.body.getAttribute('style') || '';
if(bodyStyle && bodyStyle.indexOf('position: fixed') !== -1){
safeLog('Detected body forced fixed style - restoring snapshot');
try { if(window.DEV_lg && window.DEV_lg.__styleSnapshot && window.DEV_lg.__styleSnapshot.inline && window.DEV_lg.__styleSnapshot.inline.body) document.body.setAttribute('style', window.DEV_lg.__styleSnapshot.inline.body); } catch(e){}
}
}catch(e){}
setTimeout(restoreIfTampered, 100);
}
}
}catch(e){ safeErr('MO handler error', e); }
}
});
try { MO.observe(document.documentElement || document, { childList:true, subtree:true, attributes:true, attributeFilter:['style'] }); } catch(e){ safeErr('MO install failed', e); }
// ========== Initial Run: scan/promotion/fusion/lock ==========
try{
scanPromoteAndFuse();
lockCanonical();
auditStylesAndRestore();
safeLog('DEV_mg full fusion: initial scan,promote,fusion & lock complete.');
}catch(e){ safeErr('Initial run error', e); }
// periodic integrity checks (light)
const INTERVAL = setInterval(()=>{
try { restoreIfTampered(); if(Math.random() < 0.2) auditStylesAndRestore(); } catch(e) {}
}, 3000);
// ========== Public API ==========
const API = {
__installed: true,
__token: GUARD_TOKEN,
installedAt: nowISO(),
protectList: PROTECTED_NAMES.slice(),
criticalSelectors: CRITICAL_SELECTORS.slice(),
requestPromotion,
acceptPromotion,
listOffers: () => cloneJSON(pendingOffers),
listKits: () => cloneJSON(DEV_kt.addons),
auditProtections: function(){
const out = { functions:{}, styles:{ snapshot: (window.DEV_lg && window.DEV_lg.__styleSnapshot) || null } };
for(const nm of PROTECTED_NAMES){
try{ out.functions[nm] = { present: typeof window[nm] !== 'undefined', matchesDEVlg: window.DEV_lg && window.DEV_lg[nm] === window[nm] }; }catch(e){ out.functions[nm] = { error:true }; }
}
return out;
},
restoreCanonical: function(){ setTimeout(restoreIfTampered, 10); },
promoteNow: function(){ try{ scanPromoteAndFuse(); lockCanonical(); safeLog('Manual promoteNow done'); return true;}catch(e){ safeErr('promoteNow error', e); return false; } },
auditStylesAndRestore,
neutralizeScriptNode,
getSnapshot: function(){ return { styleSnapshot: window.DEV_lg && window.DEV_lg.__styleSnapshot, functionSnapshot: window.DEV_lg && window.DEV_lg.__functionSnapshot }; },
uninstall: function(confirmCode){
if(confirmCode !== ACCEPT_CODE) return { ok:false, reason:'invalid_confirm' };
try{ MO.disconnect && MO.disconnect(); }catch(e){}
try{ clearInterval(INTERVAL); }catch(e){}
try{ delete window.DEV_mg; }catch(e){}
safeLog('DEV_mg uninstalled by developer.');
return { ok:true };
}
};
// expose DEV_kt and DEV_mg as globals
try{ Object.defineProperty(window, 'DEV_kt', { configurable:false, writable:false, value: DEV_kt }); }catch(e){ window.DEV_kt = DEV_kt; }
  try{ Object.defineProperty(window, 'DEV_mg', { configurable:false, writable:false, value: API }); }catch(e){ window.DEV_mg = API; }

  // metadata
  try{ window.DEV_mg.__meta = { fusionInstalledAt: nowISO(), guardIndex: GUARD_INDEX, guardNodePresent: !!GUARD_NODE }; }catch(e){}
  safeLog('DEV_mg full fusion installed. Use DEV_mg.requestPromotion(meta) and accept with DEV_mg.acceptPromotion(id, \"DEV_iy\").');
})();
</script>
<script>
// ==================== QUANTUM MOBILE VIEWPORT ENHANCEMENTS ====================
function injectMobileViewportEnhancements() {
    console.log('ðŸ“± Injecting Mobile Viewport Quantum Enhancements...');
    
    // Inject styles khusus untuk mobile
    const mobileStyles = document.createElement('style');
    mobileStyles.textContent = `
        /* ==================== MOBILE QUANTUM ENHANCEMENTS ==================== */
        
        /* Z-Index Correction for Mobile - PRIORITAS PARTIKEL DI ATAS AURORA */
        @media (max-width: 768px) {
            /* Hierarchy khusus homepage mobile */
            .quantum-neural-background {
                z-index: -1 !important; /* Paling belakang */
            }
            
            .neural-network {
                z-index: 1 !important; /* Aurora network */
            }
            
            .quantum-particles {
                z-index: 10 !important; /* PARTIKEL DI ATAS AURORA */
                opacity: 0.9 !important;
                pointer-events: none;
            }
            
            .quantum-home-base {
                z-index: 20 !important; /* Homebase di atas partikel */
                position: relative;
            }
            
            /* Konten homebase harus di atas semua */
            .quantum-home-title {
                z-index: 30 !important;
                position: relative;
                text-shadow: 0 2px 15px rgba(0,0,0,0.8);
            }
            
            .quantum-home-subtitle {
                z-index: 30 !important;
                position: relative;
                text-shadow: 0 2px 10px rgba(0,0,0,0.7);
            }
            
            .quantum-home-buttons {
                z-index: 30 !important;
                position: relative;
            }
            
            .quantum-home-btn {
                z-index: 30 !important;
                position: relative;
                backdrop-filter: blur(20px);
                background: rgba(255,255,255,0.15) !important;
                border: 1px solid rgba(255,255,255,0.3) !important;
                text-shadow: 0 1px 5px rgba(0,0,0,0.5);
            }
        }
        
        /* Rose Madonna - Emoji Mawar Gradient */
        .theme-rose-madonna .quantum-home-base::before {
content: 'ðŸŒ¹';
position: absolute;
font-size: 120px;
opacity: 0.5;
background: linear-gradient(45deg, #e91e63, #ad1457, #ec407a);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
animation: roseFloatMobile 8s ease-in-out infinite;
z-index: 15 !important;
top: 20%;
left: 10%;
pointer-events: none;
}
.theme-rose-madonna .quantum-home-base::after {
content: 'ðŸ’®';
position: absolute;
font-size: 80px;
opacity: 0.4;
background: linear-gradient(45deg, #ad1457, #880e4f, #e91e63);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
animation: roseFloatMobile 6s ease-in-out infinite reverse;
z-index: 15 !important;
bottom: 30%;
right: 10%;
pointer-events: none;
}
@keyframes roseFloatMobile {
0%, 100% {
transform: translateY(0px) rotate(0deg) scale(1);
}
25% {
transform: translateY(-20px) rotate(5deg) scale(1.1);
}
50% {
transform: translateY(10px) rotate(-3deg) scale(0.9);
}
75% {
transform: translateY(-15px) rotate(2deg) scale(1.05);
}
}
.theme-darkest-thanos .quantum-home-base {
position: relative;
overflow: visible !important;
}
.theme-darkest-thanos .quantum-home-base::before {
content: '';
position: absolute;
top: 50%;
left: 50%;
width: 200px;
height: 200px;
background: radial-gradient(circle,
transparent 0%,
rgba(106, 13, 173, 0.3) 30%,
rgba(74, 0, 130, 0.5) 50%,
rgba(0, 0, 0, 0.7) 70%,
transparent 100%);
border-radius: 50%;
transform: translate(-50%, -50%);
animation: blackHoleMobile 6s ease-in-out infinite;
z-index: 15 !important;
pointer-events: none;
}
.theme-darkest-thanos .quantum-home-title,
.theme-darkest-thanos .quantum-home-subtitle {
position: relative;
z-index: 30 !important;
animation: textAntiGravity 6s ease-in-out infinite;
}
@keyframes blackHoleMobile {
0%, 100% {
transform: translate(-50%, -50%) scale(1) rotate(0deg);
opacity: 0.7;
}
50% {
transform: translate(-50%, -50%) scale(1.3) rotate(180deg);
opacity: 0.9;
}
}
@keyframes textAntiGravity {
0%, 100% {
transform: translateY(0) scale(1);
}
50% {
transform: translateY(-10px) scale(1.02);
}
}
.theme-deepest-aquaman .quantum-home-base {
position: relative;
overflow: visible !important;
}
.theme-deepest-aquaman .quantum-home-base::before {
content: '';
position: absolute;
bottom: -50px;
left: 0;
width: 100%;
height: 150px;
background:
linear-gradient(transparent 0%, rgba(0, 168, 255, 0.5) 20%, rgba(0, 119, 182, 0.8) 100%),
repeating-linear-gradient(90deg,
transparent 0px,
transparent 20px,
rgba(0, 210, 255, 0.4) 20px,
rgba(0, 210, 255, 0.4) 40px
);
border-radius: 50% 50% 0 0;
animation: oceanWave3D 8s ease-in-out infinite;
z-index: 15 !important;
pointer-events: none;
}
.theme-deepest-aquaman .quantum-home-base::after {
content: 'ðŸŒŠðŸ ðŸ¬';
position: absolute;
bottom: 20px;
left: 0;
width: 100%;
text-align: center;
font-size: 24px;
opacity: 0.8;
animation: oceanLife 10s ease-in-out infinite;
z-index: 16 !important;
pointer-events: none;
}
@keyframes oceanWave3D {
0%, 100% {
transform: translateY(0px) scaleY(1);
border-radius: 50% 50% 0 0;
}
25% {
transform: translateY(-10px) scaleY(1.1);
border-radius: 40% 40% 0 0;
}
50% {
transform: translateY(5px) scaleY(0.9);
border-radius: 60% 60% 0 0;
}
75% {
transform: translateY(-8px) scaleY(1.05);
border-radius: 45% 45% 0 0;
}
}
@keyframes oceanLife {
0%, 100% {
transform: translateX(0px);
opacity: 0.7;
}
25% {
transform: translateX(20px);
opacity: 1;
}
50% {
transform: translateX(-15px);
opacity: 0.8;
}
75% {
transform: translateX(10px);
opacity: 0.9;
}
}
.theme-cartoon-cyber .quantum-home-base {
position: relative;
overflow: visible !important;
}
.theme-cartoon-cyber .quantum-home-base::before {
content: 'âœ¨ðŸŽ®ðŸ¤–ðŸ¦„ðŸš€ðŸŽ¯ðŸŽ¨ðŸ¦‹ðŸŒŸðŸŽ­';
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
font-size: 30px;
opacity: 0.6;
animation: emojiRainbow 15s linear infinite;
z-index: 15 !important;
pointer-events: none;
}
.theme-cartoon-cyber .emoji-float {
position: absolute;
font-size: 24px;
animation: emojiFloat 8s ease-in-out infinite;
opacity: 0.8;
z-index: 15 !important;
pointer-events: none;
}
@keyframes emojiRainbow {
0% {
background: linear-gradient(45deg, #00ff88, #00ccff, #ff00ff);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
transform: translateY(-100px) rotate(0deg);
}
100% {
background: linear-gradient(45deg, #ff00ff, #ffaa00, #00ff88);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
transform: translateY(100vh) rotate(360deg);
}
}
@keyframes emojiFloat {
0%, 100% {
transform: translate(0, 0) scale(1) rotate(0deg);
}
25% {
transform: translate(20px, -15px) scale(1.2) rotate(90deg);
}
50% {
transform: translate(-15px, 10px) scale(0.8) rotate(180deg);
}
75% {
transform: translate(10px, -20px) scale(1.1) rotate(270deg);
}
}
.theme-cyberpunk-city .quantum-home-base {
position: relative;
overflow: visible !important;
}
.theme-cyberpunk-city .laser-beam {
position: absolute;
height: 2px;
background: linear-gradient(90deg,
transparent 0%,
#ff073a 20%,
#05d9e6 50%,
#ff073a 80%,
transparent 100%);
box-shadow: 0 0 15px #ff073a, 0 0 25px #05d9e6;
animation: laserScan 4s linear infinite;
z-index: 15 !important;
pointer-events: none;
}
.theme-cyberpunk-city .laser-grid {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
background:
linear-gradient(90deg, transparent 49%, rgba(255, 7, 58, 0.3) 50%, transparent 51%),
linear-gradient(0deg, transparent 49%, rgba(5, 217, 230, 0.3) 50%, transparent 51%);
background-size: 50px 50px;
animation: gridPulse 3s ease-in-out infinite;
z-index: 15 !important;
pointer-events: none;
}
@keyframes laserScan {
0% {
transform: translateX(-100%) rotate(0deg);
opacity: 0;
}
10% {
opacity: 1;
}
90% {
opacity: 1;
}
100% {
transform: translateX(200%) rotate(360deg);
opacity: 0;
}
}
@keyframes gridPulse {
0%, 100% {
opacity: 0.5;
transform: scale(1);
}
50% {
opacity: 0.8;
transform: scale(1.05);
}
}
@media (max-width: 768px) {
.quantum-particles {
opacity: 0.95 !important;
}
.theme-rose-madonna .quantum-home-base::before {
font-size: 80px;
top: 15%;
left: 5%;
opacity: 0.6;
}
.theme-rose-madonna .quantum-home-base::after {
font-size: 60px;
bottom: 25%;
right: 5%;
opacity: 0.5;
}
.theme-darkest-thanos .quantum-home-base::before {
width: 150px;
height: 150px;
opacity: 0.8;
}
.theme-deepest-aquaman .quantum-home-base::before {
height: 120px;
bottom: -40px;
opacity: 0.9;
}
.theme-deepest-aquaman .quantum-home-base::after {
font-size: 20px;
bottom: 15px;
opacity: 0.9;
}
.theme-cartoon-cyber .quantum-home-base::before {
font-size: 20px;
opacity: 0.7;
}
.emoji-float {
                font-size: 18px;
                opacity: 0.9;
            }
            
            /* Cyberpunk City Mobile */
            .laser-beam {
                height: 1px;
                opacity: 0.9;
            }
            
            .laser-grid {
                background-size: 30px 30px;
                opacity: 0.6;
            }
            
            /* Quantum Home Base Mobile Optimization */
            .quantum-home-title {
                font-size: 2.5rem !important;
            }
            
            .quantum-home-subtitle {
                font-size: 1rem !important;
                padding: 0 20px;
            }
            
            .quantum-home-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .quantum-home-btn {
                min-width: 250px;
                padding: 16px 24px;
            }
        }
        
        @media (max-width: 480px) {
            /* Ultra Mobile Optimizations */
            .theme-rose-madonna .quantum-home-base::before {
                font-size: 60px;
                opacity: 0.7;
            }
            
            .theme-rose-madonna .quantum-home-base::after {
                font-size: 40px;
                opacity: 0.6;
            }
            
            .theme-darkest-thanos .quantum-home-base::before {
                width: 120px;
                height: 120px;
                opacity: 0.9;
            }
            
            .quantum-home-title {
                font-size: 2rem !important;
            }
            
            .quantum-home-subtitle {
                font-size: 0.9rem !important;
            }
            
            .quantum-home-btn {
                min-width: 200px;
                padding: 14px 20px;
                font-size: 0.9rem;
            }
            
            /* Maximum particle visibility on small screens */
            .quantum-particles {
                opacity: 1 !important; /* Full visibility */
            }
        }
    `;
    document.head.appendChild(mobileStyles);
    
    // Inject dynamic elements untuk setiap tema
    injectDynamicMobileElements();
    
    console.log('âœ… Mobile Viewport Quantum Enhancements injected!');
}

function injectDynamicMobileElements() {
    // Function untuk menambahkan elemen dinamis berdasarkan tema aktif
    function applyMobileThemeEnhancements() {
        const homeBase = document.querySelector('.quantum-home-base');
        if (!homeBase) return;
        
        // Hapus elemen enhancement sebelumnya
        document.querySelectorAll('.emoji-float, .laser-beam, .laser-grid').forEach(el => el.remove());
        
        const currentTheme = localStorage.getItem('quantum_theme') || 'quantum-dark';
        
        // Cartoon Cyber - Tambahkan emoji floating
if (currentTheme === 'cartoon-cyber') {
const emojis = [];
for (let i = 0; i < 8; i++) {
const emoji = document.createElement('div');
emoji.className = 'emoji-float';
emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
emoji.style.cssText = `
top: ${Math.random() * 80 + 10}%;
left: ${Math.random() * 80 + 10}%;
animation-delay: ${Math.random() * 5}s;
`;
homeBase.appendChild(emoji);
}
}
// Cyberpunk City - Tambahkan laser beams dan grid
if (currentTheme === 'cyberpunk-city') {
// Laser grid
const grid = document.createElement('div');
grid.className = 'laser-grid';
homeBase.appendChild(grid);
// Multiple laser beams
for (let i = 0; i < 3; i++) {
const laser = document.createElement('div');
laser.className = 'laser-beam';
laser.style.cssText = `
top: ${Math.random() * 100}%;
width: ${Math.random() * 100 + 50}%;
animation-delay: ${Math.random() * 4}s;
transform: rotate(${Math.random() * 360}deg);
`;
homeBase.appendChild(laser);
}
}
}
// Terapkan enhancements saat tema berubah
const originalApplyTheme = window.QuantumEngineExpansion?.prototype.applyTheme;
if (originalApplyTheme) {
window.QuantumEngineExpansion.prototype.applyTheme = function(themeKey) {
originalApplyTheme.call(this, themeKey);
setTimeout(applyMobileThemeEnhancements, 100);
};
}
// Terapkan enhancements saat halaman dimuat
setTimeout(applyMobileThemeEnhancements, 1000);
// Terapkan enhancements saat resize (untuk responsive)
window.addEventListener('resize', applyMobileThemeEnhancements);
}
// ==================== FORCE PARTICLE VISIBILITY ====================
function forceParticleVisibility() {
console.log('ðŸ”§ Forcing particle visibility on mobile...');
// Inject gaya yang memaksa partikel terlihat
const forceStyle = document.createElement('style');
forceStyle.textContent = `
@media (max-width: 768px) {
.quantum-particles {
z-index: 10 !important;
opacity: 1 !important;
display: block !important;
visibility: visible !important;
pointer-events: none !important;
}
.neural-network {
z-index: 1 !important;
opacity: 0.7 !important;
}
.quantum-home-base {
z-index: 20 !important;
background: transparent !important;
}
@media (prefers-reduced-motion: reduce) {
.quantum-home-btn.text-only,
.quantum-home-btn.text-only::before {
transition: none !important;
}
}
</style>
<script id="quantum-textonly-buttons-script">
(function(){
// Cari tombol yang sudah ada (kamu punya: openAIChat & openDeveloper). (found in file). :contentReference[oaicite:1]{index=1}
const btnIds = ['openAIChat','openDeveloper'];
function applyTextOnlyStyle(btn){
if(!btn) return;
btn.classList.add('text-only');
// remove icon spacing for pure-text look but keep icon if you want â€” hide icons on small screens if desired
const icons = btn.querySelectorAll('i');
icons.forEach(i => {
i.style.display = 'none';
});
// touch/mouse interaction state flags
let isInteracted = false;
let touchStartPoint = null;
let moved = false;
// Desktop: pointerenter = treat as "cursor passed"
btn.addEventListener('pointerenter', (ev) => {
// only treat if pointer is not touch (touch devices fire pointerenter too sometimes)
if (ev.pointerType === 'mouse' || ev.pointerType === 'pen') {
btn.classList.add('interacted');
isInteracted = true;
}
});
btn.addEventListener('pointerleave', (ev) => {
if (ev.pointerType === 'mouse' || ev.pointerType === 'pen') {
btn.classList.remove('interacted');
isInteracted = false;
}
});
// Mobile: detect touchstart then require a small movement to avoid accidental tap-only triggers.
btn.addEventListener('touchstart', function(ev){
moved = false;
const t = ev.touches && ev.touches[0];
if (t) touchStartPoint = { x: t.clientX, y: t.clientY };
// we don't immediately add 'interacted' so mere tap won't show illusion until movement
}, {passive:true});
btn.addEventListener('touchmove', function(ev){
const t = ev.touches && ev.touches[0];
if (!t || !touchStartPoint) return;
const dx = Math.abs(t.clientX - touchStartPoint.x);
const dy = Math.abs(t.clientY - touchStartPoint.y);
const dist = Math.sqrt(dx*dx + dy*dy);
// threshold: 8px movement required (human swipe/gesture)
if (dist > 8 && !moved) {
moved = true;
btn.classList.add('interacted');
}
}, {passive:true});
// On touchend or touchcancel, remove interact after short delay to allow click.
btn.addEventListener('touchend', function(ev){
// keep interacted for a brief moment to show feedback on tap
setTimeout(()=> btn.classList.remove('interacted'), 260);
touchStartPoint = null;
moved = false;
}, {passive:true});
btn.addEventListener('touchcancel', function(){ btn.classList.remove('interacted'); touchStartPoint = null; moved=false; }, {passive:true});
// Also ensure keyboard users have focus outline (accessibility)
btn.addEventListener('keydown', function(e){
if (e.key === 'Tab' || e.key === 'Enter' || e.key === ' ') {
btn.classList.add('keyboard-focus');
}
});
btn.addEventListener('blur', function(){ btn.classList.remove('keyboard-focus'); });
// Prevent extra visual padding from child nodes
btn.style.padding = '0';
btn.style.margin = '8px 6px'; // keep spacing between buttons, adjust as needed
    btn.style.background = 'transparent';
    btn.style.border = 'none';
    btn.style.cursor = 'pointer';
  }

  // Apply to existing buttons; if buttons created later, use observer
  function init() {
    btnIds.forEach(id => {
      const el = document.getElementById(id);
      if (el) applyTextOnlyStyle(el);
    });

    // observe additions to home buttons container
    const cont = document.querySelector('.quantum-home-buttons');
    if (cont) {
      const obs = new MutationObserver(muts => {
        muts.forEach(m => {
          m.addedNodes.forEach(n => {
            if (n.id && btnIds.includes(n.id)) applyTextOnlyStyle(n);
          });
        });
      });
      obs.observe(cont, { childList: true, subtree: true });
    }
  }

  // Run once DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

})();
</script>
<!-- ===== INJEKSI: Hybrid Proxy Hook (paste before 
<!-- NAJIB OPTIMIZER PATCH v1.0 (Fonts + Particle Optimizer + Cinematic Modes + Child-suite soft-mode) -->
<script id="najib-optimizer-patch">
(function(){
'use strict';
/*** UTIL: capability detection ***/
function detectCapsSafe(){
try{
if(window.__NAJIB_CAPS) return window.__NAJIB_CAPS;
const caps = { cores: navigator.hardwareConcurrency||2, mem: navigator.deviceMemory||2, dpr: window.devicePixelRatio||1, webgl:false, webgl2:false };
try{
const c=document.createElement('canvas');
const g2 = c.getContext && c.getContext('webgl2');
const g = g2 || (c.getContext && (c.getContext('webgl')||c.getContext('experimental-webgl')));
if(g){ caps.webgl = !!g; caps.webgl2 = !!g2; }
}catch(e){}
let score=0;
if(caps.cores>=8) score+=30; else if(caps.cores>=4) score+=18; else score+=8;
if(caps.mem>=8) score+=30; else if(caps.mem>=4) score+=18; else score+=6;
if(caps.webgl2) score+=30; else if(caps.webgl) score+=16;
caps.score = score;
if(caps.cores<=2 || caps.mem<=1 || caps.score<24) caps.profile='low';
else if((caps.cores<=4 && caps.mem<=3) || caps.score<48) caps.profile='mid';
else caps.profile='high';
window.__NAJIB_CAPS = caps;
return caps;
}catch(e){
return { profile:'low', cores:2, mem:1, dpr:1 };
}
}
const CAPS = detectCapsSafe();

/***** 1) FONT LAZY LOADER *****/
(function lazyFonts(){
try{
const heavyLinks = Array.from(document.querySelectorAll('link[href*="fonts.googleapis.com"], link[href*="fonts.gstatic.com"]'));
if(!heavyLinks.length) return;
if(CAPS.profile === 'low' || window.matchMedia('(prefers-reduced-data: reduce)').matches){
heavyLinks.forEach(l => { l.media='print'; l.setAttribute('data-deferred','1'); });
return;
}
function loadHeavyFonts(){
heavyLinks.forEach(l=>{
if(l.getAttribute('data-deferred')) return;
l.rel = 'stylesheet';
l.removeAttribute('media');
l.setAttribute('data-loaded-by','najib-optimizer');
});
}
if('requestIdleCallback' in window){
requestIdleCallback(loadHeavyFonts, {timeout:3000});
} else {
const onFirst = function(){ loadHeavyFonts(); window.removeEventListener('pointerdown', onFirst); window.removeEventListener('touchstart', onFirst); };
window.addEventListener('pointerdown', onFirst, {once:true});
window.addEventListener('touchstart', onFirst, {once:true});
setTimeout(loadHeavyFonts, 6000);
}
}catch(e){ console.warn('[najib-optimizer] lazyFonts failed', e); }
})();

/***** 2) PARTICLE SMART OPTIMIZER *****/
(function particleOptimizer(){
try{
const container = document.getElementById('quantumParticles') || document.querySelector('.quantum-particles');
if(!container) return;
function makeParticle(cls, x, y, size, content){
const el = document.createElement('div');
el.className = 'particle ' + cls;
el.style.left = (x*100).toFixed(2) + 'vw';
el.style.top = (y*100).toFixed(2) + 'vh';
el.style.width = size + 'px';
el.style.height = size + 'px';
if(content) { el.textContent = content; el.classList.add('particle-codeRain'); el.style.fontSize = Math.max(10, size) + 'px'; el.style.width = 'auto'; el.style.height = 'auto'; }
return el;
}
const baseCounts = {
goldenFloat: 28, blackPulse: 20, redSword: 22, shapeShifter: 20,
codeRain: 36, oceanWave: 26, neonPulse: 24, roseFloat: 24
};
const scaleMap = { high:1, mid:0.45, low:0.08 };
const profile = CAPS.profile || 'low';
const scale = scaleMap[profile] || 0.45;
const reduceEffects = (profile === 'low' || window.matchMedia('(prefers-reduced-motion: reduce)').matches);

window.renderParticlesForTheme = function(themeKey){
try{
const t = themeKey || 'goldenFloat';
const mapName = {
goldenFloat:'goldenFloat', blackPulse:'blackPulse', redSword:'redSword',
shapeShifter:'shapeShifter', codeRain:'codeRain', oceanWave:'oceanWave',
neonPulse:'neonPulse', roseFloat:'roseFloat'
}[t] || 'goldenFloat';
const base = baseCounts[mapName] || 18;
const count = Math.max( Math.round(base*scale), (reduceEffects ? 0 : 2) );
container.innerHTML = '';
if(count === 0){
const accent = document.createElement('div');
accent.className = 'particle particle-neonPulse';
accent.style.left = '50%';
accent.style.top = '80%';
accent.style.width = '4px';
accent.style.height = '4px';
accent.style.opacity = '0.6';
accent.style.pointerEvents = 'none';
container.appendChild(accent);
return;
}
const fragment = document.createDocumentFragment();
for(let i=0;i<count;i++){
const x = Math.random(); const y = Math.random();
const size = (mapName==='codeRain' ? Math.max(10, Math.round(Math.random()*14+6)) : Math.round(Math.random()*(reduceEffects?4:8) + (reduceEffects?2:2)));
const p = makeParticle('particle-'+mapName, x, y, size, mapName==='codeRain'? (Math.random()>0.7?String.fromCharCode(0x30A0 + Math.floor(Math.random()*96)) : '') : '');
if(reduceEffects){
p.style.boxShadow = 'none';
p.style.filter = 'none';
p.style.animationDuration = '8s';
}
fragment.appendChild(p);
}
container.appendChild(fragment);
}catch(e){ console.warn('[najib-optimizer] renderParticlesForTheme fail', e); }
};

try{
const saved = (JSON.parse(localStorage.getItem('najib_saved_themes')||'[]') || [])[0];
const initialTheme = saved ? (saved.variables && saved.variables.particleTheme) : 'goldenFloat';
setTimeout(()=>{ try{ window.renderParticlesForTheme(initialTheme); }catch(e){} }, 300);
}catch(e){}

window.__najib_particle_optimizer = { profile: CAPS.profile, reducedEffects: reduceEffects };

}catch(e){ console.warn('[najib-optimizer] particleOptimizer top fail', e); }
})();

/***** 3) CINEMATIC MODULAR MODE *****/
(function cinematicModular(){
try{
const ROOT = document.getElementById('stl-open');
if(!ROOT) return;
const mode = CAPS.profile || 'low';
ROOT.setAttribute('data-cinematic-mode', mode);

function applyMode(){
if(mode === 'low'){
const chrom = document.querySelector('.stl-chromatic');
if(chrom) chrom.style.display = 'none';
const scan = document.getElementById('stl-scan');
if(scan) { scan.style.animationDuration = '12s'; scan.style.opacity='0.12'; }
const TITLE = document.getElementById('stl-title');
const TAG = document.getElementById('stl-tag');
if(TITLE) TITLE.style.transition='opacity .6s ease';
if(TAG) TAG.style.transition='opacity .6s ease';
setTimeout(()=>{ try{ ROOT.style.opacity='0'; setTimeout(()=>{ try{ ROOT.remove(); }catch(e){ ROOT.style.display='none'; } }, 550); }catch(e){} }, 900);
}
else if(mode === 'mid'){
const scan = document.getElementById('stl-scan'); if(scan) scan.style.opacity='0.22';
const fract = document.querySelector('.stl-fractal'); if(fract) fract.style.opacity='0.7';
setTimeout(()=>{ try{ ROOT.style.opacity='0'; setTimeout(()=>{ try{ ROOT.remove(); }catch(e){ ROOT.style.display='none'; } }, 900); }catch(e){} }, 4000);
}
}
applyMode();
window.__najib_cinematic_force = function(lvl){
try{ if(!lvl) return; ROOT.setAttribute('data-cinematic-mode', lvl); location.reload(); }catch(e){}
};
}catch(e){ console.warn('[najib-optimizer] cinematicModular fail', e); }
})();

/***** 4) CHILD-SUITE SOFT MODE *****/
(function softenChildSuite(){
try{
(function installSoftObserver(){
let throttleAt = 0;
let backoffMs = 1000;
const whitelist = ['#stl-open','#quantumParticles','#quantumIsland','.quantum-sidebar','.quantum-tools-sidebar'];
const safeCheck = (node)=>{
try{
if(!node || node.nodeType !== 1) return true;
for(const s of whitelist){
try{ if(node.matches && node.matches(s) || (node.closest && node.closest(s))) return true; }catch(e){}
}
const tag = (node.tagName||'').toLowerCase();
if(['div','span','script','style','link','meta','img','svg'].indexOf(tag) !== -1) return true;
return false;
}catch(e){ return true; }
};
const mo = new MutationObserver((mutations)=>{
const now = Date.now();
if(now - throttleAt < backoffMs) return;
throttleAt = now;
let flagged = false;
for(const m of mutations){
for(const n of (m.addedNodes||[])){
if(!safeCheck(n)) flagged = true;
}
}
if(flagged){
console.info('[najib-softObserver] suspicious DOM additions detected');
setTimeout(()=>{ try{ if(window.DEV_mg && typeof window.DEV_mg.auditProtections === 'function') window.DEV_mg.auditProtections({soft:true}); }catch(e){} }, 1200);
backoffMs = Math.min(60000, Math.max(2000, backoffMs * 1.5));
} else {
backoffMs = Math.max(1000, Math.floor(backoffMs*0.9));
}
});
try{
mo.observe(document.documentElement || document.body, { childList:true, subtree:true });
window.__najib_soft_mo = mo;
}catch(e){}
})();
}catch(e){ console.warn('[najib-optimizer] softenChildSuite fail', e); }
})();

/***** 5) REPORT SUMMARY *****/
try{
console.info('[najib-optimizer] applied. profile=%s', CAPS.profile);
}catch(e){}
})();
</script>
<!-- END NAJIB OPTIMIZER PATCH -->
</body>
) ===== -->
<style id="quantum-proxy-style">
  /* simpel styling untuk input proxy di panel developer */
  #quantumProxyRow{display:flex;gap:8px;align-items:center;margin-top:8px}
  #quantumProxyUrl{flex:1;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:rgba(0,0,0,0.12);color:var(--quantum-text)}
  #quantumProxyToggle{padding:8px 12px;border-radius:10px;border:none;cursor:pointer}
  #quantumProxyNote{font-size:12px;opacity:0.85;margin-top:6px}
</style>

<script id="quantum-proxy-inject">
(function(){
  // CONFIG
  const STORAGE_KEY = 'quantum_proxy_cfg_v1'; // local storage for proxy config (only stores URL + enabled flag)
  const DEFAULT_PROXY = '/api/proxy'; // default expected endpoint (can be absolute URL)

  // create UI in Developer Panel
  
function ensureProxyUI(){
  const toolsSidebar = document.getElementById('quantumToolsSidebar')
      || document.querySelector('.quantum-tools-sidebar')
      || document.querySelector('.tools-sidebar');

  if(!toolsSidebar){
      setTimeout(ensureProxyUI, 500);
      return;
  }
  if(document.getElementById('quantumProxyRow')) return;

  const row = document.createElement('div');
  row.id = 'quantumProxyRow';
  row.innerHTML = `
    <input id="quantumProxyUrl" placeholder="Proxy endpoint (e.g. https://yourdomain.com/api/proxy)" />
    <button id="quantumProxyToggle" class="quantum-btn secondary">Enable Proxy</button>
    <div id="quantumProxyNote">Optional: Use server-side proxy to keep API keys secure.</div>
  `;
  toolsSidebar.appendChild(row);

  try {
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    document.getElementById('quantumProxyUrl').value = saved.url || DEFAULT_PROX___PROTECT_1___ = loadCfg();
      // get message from textarea if exists
      const inputEl = document.getElementById('quantumChatInput');
const message = inputEl ? inputEl.value.trim() : '';
if(cfg && cfg.enabled && cfg.url){
// prepare payload depending on provider schema your proxy expects.
// Generic shape: { type: 'chat.completions', model: 'gpt-4', messages: [...] }
// Here we send a simple { prompt } by default.
const payload = {
type: 'chat.completions',
model: (window.quantumEngine && window.quantumEngine.aiModel) || 'gpt-4',
prompt: message,
meta: { from: 'quantum-frontend' }
};
// Show user message locally like usual
if(message) {
// originalAddMessage if exists, else fallback to engine method
try { window.quantumEngine.addMessageToChat && window.quantumEngine.addMessageToChat('user', message); }
catch(e){  }
if(inputEl) inputEl.value = '';
}
try {
const json = await callProxy(cfg.url, payload);
// Expect proxy to return something like { reply: "..." } or full provider response
const reply = (json && (json.reply || (json.choices && json.choices[0] && (json.choices[0].message?.content || json.choices[0].text)))) || JSON.stringify(json);
          // Append AI response
          window.quantumEngine.addMessageToChat && window.quantumEngine.addMessageToChat('ai', String(reply));
        } catch(err){
          // on proxy error show fallback simulated response
          window.quantumEngine.addMessageToChat && window.quantumEngine.addMessageToChat('ai', 'Proxy error: ' + (err.message||'unknown'));
        }
        return;
      }

      // fallback: no proxy, call original (simulated) implementation
      return originalSend();
    };

    window.quantumEngine.__proxyPatched = true;
    return true;
  }

  // Poll for engine and developer panel readiness
  const POLL = setInterval(()=>{
    ensureProxyUI();
    if(tryPatchEngine()){
      clearInterval(POLL);
    }
  }, 350);

  // Expose helper for manual testing
  window.quantumProxy = {
    callProxy,
    loadCfg,
    saveCfg
  };

})();
</script>
<!-- ===== END INJECTION ===== -->
<!-- ===== INJEKSI: DOMPurify XSS Protector (paste before 
<!-- NAJIB OPTIMIZER PATCH v1.0 (Fonts + Particle Optimizer + Cinematic Modes + Child-suite soft-mode) -->
<script id="najib-optimizer-patch">
(function(){
'use strict';
/*** UTIL: capability detection ***/
function detectCapsSafe(){
try{
if(window.__NAJIB_CAPS) return window.__NAJIB_CAPS;
const caps = { cores: navigator.hardwareConcurrency||2, mem: navigator.deviceMemory||2, dpr: window.devicePixelRatio||1, webgl:false, webgl2:false };
try{
const c=document.createElement('canvas');
const g2 = c.getContext && c.getContext('webgl2');
const g = g2 || (c.getContext && (c.getContext('webgl')||c.getContext('experimental-webgl')));
if(g){ caps.webgl = !!g; caps.webgl2 = !!g2; }
}catch(e){}
let score=0;
if(caps.cores>=8) score+=30; else if(caps.cores>=4) score+=18; else score+=8;
if(caps.mem>=8) score+=30; else if(caps.mem>=4) score+=18; else score+=6;
if(caps.webgl2) score+=30; else if(caps.webgl) score+=16;
caps.score = score;
if(caps.cores<=2 || caps.mem<=1 || caps.score<24) caps.profile='low';
else if((caps.cores<=4 && caps.mem<=3) || caps.score<48) caps.profile='mid';
else caps.profile='high';
window.__NAJIB_CAPS = caps;
return caps;
}catch(e){
return { profile:'low', cores:2, mem:1, dpr:1 };
}
}
const CAPS = detectCapsSafe();

/***** 1) FONT LAZY LOADER *****/
(function lazyFonts(){
try{
const heavyLinks = Array.from(document.querySelectorAll('link[href*="fonts.googleapis.com"], link[href*="fonts.gstatic.com"]'));
if(!heavyLinks.length) return;
if(CAPS.profile === 'low' || window.matchMedia('(prefers-reduced-data: reduce)').matches){
heavyLinks.forEach(l => { l.media='print'; l.setAttribute('data-deferred','1'); });
return;
}
function loadHeavyFonts(){
heavyLinks.forEach(l=>{
if(l.getAttribute('data-deferred')) return;
l.rel = 'stylesheet';
l.removeAttribute('media');
l.setAttribute('data-loaded-by','najib-optimizer');
});
}
if('requestIdleCallback' in window){
requestIdleCallback(loadHeavyFonts, {timeout:3000});
} else {
const onFirst = function(){ loadHeavyFonts(); window.removeEventListener('pointerdown', onFirst); window.removeEventListener('touchstart', onFirst); };
window.addEventListener('pointerdown', onFirst, {once:true});
window.addEventListener('touchstart', onFirst, {once:true});
setTimeout(loadHeavyFonts, 6000);
}
}catch(e){ console.warn('[najib-optimizer] lazyFonts failed', e); }
})();

/***** 2) PARTICLE SMART OPTIMIZER *****/
(function particleOptimizer(){
try{
const container = document.getElementById('quantumParticles') || document.querySelector('.quantum-particles');
if(!container) return;
function makeParticle(cls, x, y, size, content){
const el = document.createElement('div');
el.className = 'particle ' + cls;
el.style.left = (x*100).toFixed(2) + 'vw';
el.style.top = (y*100).toFixed(2) + 'vh';
el.style.width = size + 'px';
el.style.height = size + 'px';
if(content) { el.textContent = content; el.classList.add('particle-codeRain'); el.style.fontSize = Math.max(10, size) + 'px'; el.style.width = 'auto'; el.style.height = 'auto'; }
return el;
}
const baseCounts = {
goldenFloat: 28, blackPulse: 20, redSword: 22, shapeShifter: 20,
codeRain: 36, oceanWave: 26, neonPulse: 24, roseFloat: 24
};
const scaleMap = { high:1, mid:0.45, low:0.08 };
const profile = CAPS.profile || 'low';
const scale = scaleMap[profile] || 0.45;
const reduceEffects = (profile === 'low' || window.matchMedia('(prefers-reduced-motion: reduce)').matches);

window.renderParticlesForTheme = function(themeKey){
try{
const t = themeKey || 'goldenFloat';
const mapName = {
goldenFloat:'goldenFloat', blackPulse:'blackPulse', redSword:'redSword',
shapeShifter:'shapeShifter', codeRain:'codeRain', oceanWave:'oceanWave',
neonPulse:'neonPulse', roseFloat:'roseFloat'
}[t] || 'goldenFloat';
const base = baseCounts[mapName] || 18;
const count = Math.max( Math.round(base*scale), (reduceEffects ? 0 : 2) );
container.innerHTML = '';
if(count === 0){
const accent = document.createElement('div');
accent.className = 'particle particle-neonPulse';
accent.style.left = '50%';
accent.style.top = '80%';
accent.style.width = '4px';
accent.style.height = '4px';
accent.style.opacity = '0.6';
accent.style.pointerEvents = 'none';
container.appendChild(accent);
return;
}
const fragment = document.createDocumentFragment();
for(let i=0;i<count;i++){
const x = Math.random(); const y = Math.random();
const size = (mapName==='codeRain' ? Math.max(10, Math.round(Math.random()*14+6)) : Math.round(Math.random()*(reduceEffects?4:8) + (reduceEffects?2:2)));
const p = makeParticle('particle-'+mapName, x, y, size, mapName==='codeRain'? (Math.random()>0.7?String.fromCharCode(0x30A0 + Math.floor(Math.random()*96)) : '') : '');
if(reduceEffects){
p.style.boxShadow = 'none';
p.style.filter = 'none';
p.style.animationDuration = '8s';
}
fragment.appendChild(p);
}
container.appendChild(fragment);
}catch(e){ console.warn('[najib-optimizer] renderParticlesForTheme fail', e); }
};

try{
const saved = (JSON.parse(localStorage.getItem('najib_saved_themes')||'[]') || [])[0];
const initialTheme = saved ? (saved.variables && saved.variables.particleTheme) : 'goldenFloat';
setTimeout(()=>{ try{ window.renderParticlesForTheme(initialTheme); }catch(e){} }, 300);
}catch(e){}

window.__najib_particle_optimizer = { profile: CAPS.profile, reducedEffects: reduceEffects };

}catch(e){ console.warn('[najib-optimizer] particleOptimizer top fail', e); }
})();

/***** 3) CINEMATIC MODULAR MODE *****/
(function cinematicModular(){
try{
const ROOT = document.getElementById('stl-open');
if(!ROOT) return;
const mode = CAPS.profile || 'low';
ROOT.setAttribute('data-cinematic-mode', mode);

function applyMode(){
if(mode === 'low'){
const chrom = document.querySelector('.stl-chromatic');
if(chrom) chrom.style.display = 'none';
const scan = document.getElementById('stl-scan');
if(scan) { scan.style.animationDuration = '12s'; scan.style.opacity='0.12'; }
const TITLE = document.getElementById('stl-title');
const TAG = document.getElementById('stl-tag');
if(TITLE) TITLE.style.transition='opacity .6s ease';
if(TAG) TAG.style.transition='opacity .6s ease';
setTimeout(()=>{ try{ ROOT.style.opacity='0'; setTimeout(()=>{ try{ ROOT.remove(); }catch(e){ ROOT.style.display='none'; } }, 550); }catch(e){} }, 900);
}
else if(mode === 'mid'){
const scan = document.getElementById('stl-scan'); if(scan) scan.style.opacity='0.22';
const fract = document.querySelector('.stl-fractal'); if(fract) fract.style.opacity='0.7';
setTimeout(()=>{ try{ ROOT.style.opacity='0'; setTimeout(()=>{ try{ ROOT.remove(); }catch(e){ ROOT.style.display='none'; } }, 900); }catch(e){} }, 4000);
}
}
applyMode();
window.__najib_cinematic_force = function(lvl){
try{ if(!lvl) return; ROOT.setAttribute('data-cinematic-mode', lvl); location.reload(); }catch(e){}
};
}catch(e){ console.warn('[najib-optimizer] cinematicModular fail', e); }
})();

/***** 4) CHILD-SUITE SOFT MODE *****/
(function softenChildSuite(){
try{
(function installSoftObserver(){
let throttleAt = 0;
let backoffMs = 1000;
const whitelist = ['#stl-open','#quantumParticles','#quantumIsland','.quantum-sidebar','.quantum-tools-sidebar'];
const safeCheck = (node)=>{
try{
if(!node || node.nodeType !== 1) return true;
for(const s of whitelist){
try{ if(node.matches && node.matches(s) || (node.closest && node.closest(s))) return true; }catch(e){}
}
const tag = (node.tagName||'').toLowerCase();
if(['div','span','script','style','link','meta','img','svg'].indexOf(tag) !== -1) return true;
return false;
}catch(e){ return true; }
};
const mo = new MutationObserver((mutations)=>{
const now = Date.now();
if(now - throttleAt < backoffMs) return;
throttleAt = now;
let flagged = false;
for(const m of mutations){
for(const n of (m.addedNodes||[])){
if(!safeCheck(n)) flagged = true;
}
}
if(flagged){
console.info('[najib-softObserver] suspicious DOM additions detected');
setTimeout(()=>{ try{ if(window.DEV_mg && typeof window.DEV_mg.auditProtections === 'function') window.DEV_mg.auditProtections({soft:true}); }catch(e){} }, 1200);
backoffMs = Math.min(60000, Math.max(2000, backoffMs * 1.5));
} else {
backoffMs = Math.max(1000, Math.floor(backoffMs*0.9));
}
});
try{
mo.observe(document.documentElement || document.body, { childList:true, subtree:true });
window.__najib_soft_mo = mo;
}catch(e){}
})();
}catch(e){ console.warn('[najib-optimizer] softenChildSuite fail', e); }
})();

/***** 5) REPORT SUMMARY *****/
try{
console.info('[najib-optimizer] applied. profile=%s', CAPS.profile);
}catch(e){}
})();
</script>
<!-- END NAJIB OPTIMIZER PATCH -->
</body>
) ===== -->
<script id="quantum-dompurify-xss">
(function(){
  'use strict';

  const CONFIG = {
    dompurifyCdn: 'https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js',
    autoPatchInnerHTML: true,   // patch innerHTML & insertAdjacentHTML
    localStorageKeysToSanitize: [
      'quantum_theme','quantum_custom_theme','quantum_proxy_cfg_v1','stl_saved_chat','stl_user_import'
    ],
    maxFileSizeToScan: 2_000_000, // 2MB
    sanitizeLog: false // set true untuk debug
  };

  function log(){ if(CONFIG.sanitizeLog) console.log.apply(console, ['[XSS-DOMPURIFY]'].concat(Array.from(arguments))); }

  // Load DOMPurify if not present
  function ensureDOMPurify(cb){
    if (window.DOMPurify && typeof window.DOMPurify.sanitize === 'function') {
      return cb(null, window.DOMPurify);
    }
    // try to load script
    const existing = document.querySelector('script[data-quantum-dompurify]');
    if (existing) {
      existing.addEventListener('load', () => cb(null, window.DOMPurify));
      existing.addEventListener('error', (e) => cb(new Error('DOMPurify load failed')));
      return;
    }
    const s = document.createElement('script');
    s.src = CONFIG.dompurifyCdn;
    s.setAttribute('data-quantum-dompurify','1');
    s.async = true;
    s.onload = () => {
      if (window.DOMPurify && typeof window.DOMPurify.sanitize === 'function') {
        log('DOMPurify loaded');
        cb(null, window.DOMPurify);
      } else {
        cb(new Error('DOMPurify loaded but not found'));
      }
    };
    s.onerror = () => cb(new Error('Failed to load DOMPurify'));
    document.head.appendChild(s);
  }

  // Wrapper sanitize with safe options
  function domSanitize(DOMPurify, dirty){
    if (!dirty || typeof dirty !== 'string') return '';
    try{
      // Strict sanitize: remove scripts, event handlers, dangerous URIs
// ALLOWED_URI_REGEXP allows http(s), mailto, tel, and relative paths
const cfg = {
ALLOWED_URI_REGEXP: /^(?:(?:https?|mailto|tel):|\/|#)/i,
// keep as conservative defaults; do not allow style attributes that may contain expression/javascript
FORBID_ATTR: ['onerror','onload','onclick','onmouseover','onfocus','onmouseenter','onmouseleave'],
FORBID_TAGS: ['script','iframe','object','embed','link','meta','base'],
SAFE_FOR_JQUERY: true
};
return DOMPurify.sanitize(dirty, cfg);
}catch(e){
console.warn('[XSS-DOMPURIFY] sanitize error', e);
try { return DOMPurify.sanitize(dirty); } catch(_) { return ''; }
}
}
// Safe helpers (will be bound after DOMPurify ready)
function installHelpers(DOMPurify){
window.safeSetInnerHTML = function(el, html){
if(!el) return false;
try{
const clean = domSanitize(DOMPurify, String(html));
el.innerHTML = clean;
return true;
}catch(e){
console.error('[safeSetInnerHTML] failed', e);
return false;
}
};
window.safeInsertAdjacentHTML = function(el, position, html){
if(!el) return false;
try{
const clean = domSanitize(DOMPurify, String(html));
el.insertAdjacentHTML(position, clean);
return true;
}catch(e){
console.error('[safeInsertAdjacentHTML] failed', e);
return false;
}
};
// Patch Element.prototype.innerHTML and insertAdjacentHTML
if (CONFIG.autoPatchInnerHTML) {
try {
const proto = Element.prototype;
const desc = Object.getOwnPropertyDescriptor(proto, 'innerHTML');
if (desc && desc.set && !proto.__quantum_innerHTML_patched) {
const originalSetter = desc.set;
const originalGetter = desc.get;
Object.defineProperty(proto, 'innerHTML', {
configurable: true,
enumerable: true,
get: function(){
return originalGetter.call(this);
},
set: function(v){
try {
if (typeof v === 'string') {
const clean = domSanitize(DOMPurify, v);
originalSetter.call(this, clean);
log('patched innerHTML on', this.tagName);
return;
}
} catch(e) {
console.warn('[XSS-PATCH] innerHTML sanitizer error', e);
}
originalSetter.call(this, v);
}
});
proto.__quantum_innerHTML_patched = true;
log('innerHTML patched');
}
// patch insertAdjacentHTML
if (!proto.__quantum_insertAdjacentHTML_patched) {
const origInsert = proto.insertAdjacentHTML;
proto.insertAdjacentHTML = function(position, html){
try {
if (typeof html === 'string') {
const clean = domSanitize(DOMPurify, html);
return origInsert.call(this, position, clean);
}
} catch(e) {
console.warn('[XSS-PATCH] insertAdjacentHTML sanitizer error', e);
}
return origInsert.call(this, position, html);
};
proto.__quantum_insertAdjacentHTML_patched = true;
log('insertAdjacentHTML patched');
}
} catch(e){
console.warn('[XSS-PATCH] failed to patch core methods', e);
}
}
// Paste sanitization for editable inputs
document.addEventListener('paste', function(e){
try{
const clipboard = (e.clipboardData || window.clipboardData);
if (!clipboard) return;
const html = clipboard.getData('text/html') || clipboard.getData('text/plain');
if (!html) return;
const target = e.target;
// If target is editable or textarea/input, insert sanitized text
if (target && (target.isContentEditable || /textarea|input/i.test(target.tagName))) {
e.preventDefault();
const clean = domSanitize(DOMPurify, html);
if (document.queryCommandSupported && document.queryCommandSupported('insertText')) {
document.execCommand('insertText', false, clean);
} else if (target.value !== undefined) {
// insert at caret
const start = target.selectionStart || 0;
const val = target.value || '';
target.value = val.slice(0,start) + clean + val.slice(start);
} else {
// fallback for contenteditable
document.execCommand('insertHTML', false, clean);
}
}
}catch(e){  }
}, true);
// File input sanitizer (for imports)
document.addEventListener('change', function(e){
try{
const t = e.target;
if (!t || t.tagName !== 'INPUT' || t.type !== 'file') return;
Array.from(t.files || []).forEach(f => {
if (f.size > CONFIG.maxFileSizeToScan) {
console.warn('[XSS-DOMPURIFY] file too large to auto-scan:', f.name);
return;
}
const reader = new FileReader();
reader.onload = function(ev){
try{
const txt = ev.target.result;
const clean = domSanitize(DOMPurify, txt);
t.dataset.sanitizedContent = clean;
log('file sanitized for input', t.id || t.name || '(unknown)');
// optional: auto-fill target textarea if data-target exists
const tgt = t.dataset.targetTextarea;
if (tgt) {
const ta = document.getElementById(tgt);
if (ta) ta.value = clean;
}
}catch(err){ console.error('[XSS-DOMPURIFY] file sanitize error', err); }
};
reader.readAsText(f, 'utf-8');
});
}catch(err){}
}, true);
// Sanitize configured localStorage keys
function sanitizeLocalStorageKeys(){
CONFIG.localStorageKeysToSanitize.forEach(k => {
try{
const v = localStorage.getItem(k);
if (!v) return;
// if JSON parseable, sanitize string values within
try{
const parsed = JSON.parse(v);
const walk = (o) => {
if (typeof o === 'string') return domSanitize(DOMPurify, o);
if (Array.isArray(o)) return o.map(walk);
if (o && typeof o === 'object') {
Object.keys(o).forEach(kk => { o[kk] = walk(o[kk]); });
return o;
}
return o;
};
const clean = walk(parsed);
localStorage.setItem(k, JSON.stringify(clean));
log('cleaned localStorage key', k);
}catch(_e){
// treat as raw string
const clean = domSanitize(DOMPurify, v);
if (clean !== v) localStorage.setItem(k, clean);
log('cleaned raw localStorage key', k);
}
}catch(err){
console.warn('[XSS-DOMPURIFY] sanitize localStorage failed for', k, err);
}
});
}
// Public API
window.__quantumXSS = {
dompurifyVersion: DOMPurify && DOMPurify.version ? DOMPurify.version : 'loaded',
sanitize: (html) => domSanitize(DOMPurify, html),
safeSetInnerHTML: window.safeSetInnerHTML,
safeInsertAdjacentHTML: window.safeInsertAdjacentHTML,
sanitizeLocalStorageKeys
};
// Run initial sanitize pass
try{ sanitizeLocalStorageKeys(); }catch(e){}
log('DOMPurify XSS protector installed');
}
// Initialize - ensure DOMPurify then install
ensureDOMPurify(function(err, DOMPurify){
if (err || !DOMPurify) {
console.warn('[XSS-DOMPURIFY] DOMPurify not available:', err);
// fallback: try to use a minimal sanitizer (strip script tags & on* attrs) - conservative
// But recommend including DOMPurify; the safer approach is to abort heavy patches.
try {
// Minimal fallback sanitizer (very conservative)
window.safeSetInnerHTML = function(el, html){
if(!el) return false;
try{
let clean = String(html).replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, '');
clean = clean.replace(/\son\w+\s*=\s*(['"])[\s\S]*?\1/gi, '');
el.innerHTML = clean;
return true;
}catch(e){ return false; }
};
log('fallback sanitizer installed (limited)');
} catch(e){}
return;
}
installHelpers(DOMPurify);
});
})();
</script>
<!-- ===== END DOMPurify XSS PROTECTOR ===== -->
<!-- ===== INJECTION: Lazy-loader + Particle Optimiser (paste before 
<!-- NAJIB OPTIMIZER PATCH v1.0 (Fonts + Particle Optimizer + Cinematic Modes + Child-suite soft-mode) -->
<script id="najib-optimizer-patch">
(function(){
'use strict';
/*** UTIL: capability detection ***/
function detectCapsSafe(){
try{
if(window.__NAJIB_CAPS) return window.__NAJIB_CAPS;
const caps = { cores: navigator.hardwareConcurrency||2, mem: navigator.deviceMemory||2, dpr: window.devicePixelRatio||1, webgl:false, webgl2:false };
try{
const c=document.createElement('canvas');
const g2 = c.getContext && c.getContext('webgl2');
const g = g2 || (c.getContext && (c.getContext('webgl')||c.getContext('experimental-webgl')));
if(g){ caps.webgl = !!g; caps.webgl2 = !!g2; }
}catch(e){}
let score=0;
if(caps.cores>=8) score+=30; else if(caps.cores>=4) score+=18; else score+=8;
if(caps.mem>=8) score+=30; else if(caps.mem>=4) score+=18; else score+=6;
if(caps.webgl2) score+=30; else if(caps.webgl) score+=16;
caps.score = score;
if(caps.cores<=2 || caps.mem<=1 || caps.score<24) caps.profile='low';
else if((caps.cores<=4 && caps.mem<=3) || caps.score<48) caps.profile='mid';
else caps.profile='high';
window.__NAJIB_CAPS = caps;
return caps;
}catch(e){
return { profile:'low', cores:2, mem:1, dpr:1 };
}
}
const CAPS = detectCapsSafe();

/***** 1) FONT LAZY LOADER *****/
(function lazyFonts(){
try{
const heavyLinks = Array.from(document.querySelectorAll('link[href*="fonts.googleapis.com"], link[href*="fonts.gstatic.com"]'));
if(!heavyLinks.length) return;
if(CAPS.profile === 'low' || window.matchMedia('(prefers-reduced-data: reduce)').matches){
heavyLinks.forEach(l => { l.media='print'; l.setAttribute('data-deferred','1'); });
return;
}
function loadHeavyFonts(){
heavyLinks.forEach(l=>{
if(l.getAttribute('data-deferred')) return;
l.rel = 'stylesheet';
l.removeAttribute('media');
l.setAttribute('data-loaded-by','najib-optimizer');
});
}
if('requestIdleCallback' in window){
requestIdleCallback(loadHeavyFonts, {timeout:3000});
} else {
const onFirst = function(){ loadHeavyFonts(); window.removeEventListener('pointerdown', onFirst); window.removeEventListener('touchstart', onFirst); };
window.addEventListener('pointerdown', onFirst, {once:true});
window.addEventListener('touchstart', onFirst, {once:true});
setTimeout(loadHeavyFonts, 6000);
}
}catch(e){ console.warn('[najib-optimizer] lazyFonts failed', e); }
})();

/***** 2) PARTICLE SMART OPTIMIZER *****/
(function particleOptimizer(){
try{
const container = document.getElementById('quantumParticles') || document.querySelector('.quantum-particles');
if(!container) return;
function makeParticle(cls, x, y, size, content){
const el = document.createElement('div');
el.className = 'particle ' + cls;
el.style.left = (x*100).toFixed(2) + 'vw';
el.style.top = (y*100).toFixed(2) + 'vh';
el.style.width = size + 'px';
el.style.height = size + 'px';
if(content) { el.textContent = content; el.classList.add('particle-codeRain'); el.style.fontSize = Math.max(10, size) + 'px'; el.style.width = 'auto'; el.style.height = 'auto'; }
return el;
}
const baseCounts = {
goldenFloat: 28, blackPulse: 20, redSword: 22, shapeShifter: 20,
codeRain: 36, oceanWave: 26, neonPulse: 24, roseFloat: 24
};
const scaleMap = { high:1, mid:0.45, low:0.08 };
const profile = CAPS.profile || 'low';
const scale = scaleMap[profile] || 0.45;
const reduceEffects = (profile === 'low' || window.matchMedia('(prefers-reduced-motion: reduce)').matches);

window.renderParticlesForTheme = function(themeKey){
try{
const t = themeKey || 'goldenFloat';
const mapName = {
goldenFloat:'goldenFloat', blackPulse:'blackPulse', redSword:'redSword',
shapeShifter:'shapeShifter', codeRain:'codeRain', oceanWave:'oceanWave',
neonPulse:'neonPulse', roseFloat:'roseFloat'
}[t] || 'goldenFloat';
const base = baseCounts[mapName] || 18;
const count = Math.max( Math.round(base*scale), (reduceEffects ? 0 : 2) );
container.innerHTML = '';
if(count === 0){
const accent = document.createElement('div');
accent.className = 'particle particle-neonPulse';
accent.style.left = '50%';
accent.style.top = '80%';
accent.style.width = '4px';
accent.style.height = '4px';
accent.style.opacity = '0.6';
accent.style.pointerEvents = 'none';
container.appendChild(accent);
return;
}
const fragment = document.createDocumentFragment();
for(let i=0;i<count;i++){
const x = Math.random(); const y = Math.random();
const size = (mapName==='codeRain' ? Math.max(10, Math.round(Math.random()*14+6)) : Math.round(Math.random()*(reduceEffects?4:8) + (reduceEffects?2:2)));
const p = makeParticle('particle-'+mapName, x, y, size, mapName==='codeRain'? (Math.random()>0.7?String.fromCharCode(0x30A0 + Math.floor(Math.random()*96)) : '') : '');
if(reduceEffects){
p.style.boxShadow = 'none';
p.style.filter = 'none';
p.style.animationDuration = '8s';
}
fragment.appendChild(p);
}
container.appendChild(fragment);
}catch(e){ console.warn('[najib-optimizer] renderParticlesForTheme fail', e); }
};

try{
const saved = (JSON.parse(localStorage.getItem('najib_saved_themes')||'[]') || [])[0];
const initialTheme = saved ? (saved.variables && saved.variables.particleTheme) : 'goldenFloat';
setTimeout(()=>{ try{ window.renderParticlesForTheme(initialTheme); }catch(e){} }, 300);
}catch(e){}

window.__najib_particle_optimizer = { profile: CAPS.profile, reducedEffects: reduceEffects };

}catch(e){ console.warn('[najib-optimizer] particleOptimizer top fail', e); }
})();

/***** 3) CINEMATIC MODULAR MODE *****/
(function cinematicModular(){
try{
const ROOT = document.getElementById('stl-open');
if(!ROOT) return;
const mode = CAPS.profile || 'low';
ROOT.setAttribute('data-cinematic-mode', mode);

function applyMode(){
if(mode === 'low'){
const chrom = document.querySelector('.stl-chromatic');
if(chrom) chrom.style.display = 'none';
const scan = document.getElementById('stl-scan');
if(scan) { scan.style.animationDuration = '12s'; scan.style.opacity='0.12'; }
const TITLE = document.getElementById('stl-title');
const TAG = document.getElementById('stl-tag');
if(TITLE) TITLE.style.transition='opacity .6s ease';
if(TAG) TAG.style.transition='opacity .6s ease';
setTimeout(()=>{ try{ ROOT.style.opacity='0'; setTimeout(()=>{ try{ ROOT.remove(); }catch(e){ ROOT.style.display='none'; } }, 550); }catch(e){} }, 900);
}
else if(mode === 'mid'){
const scan = document.getElementById('stl-scan'); if(scan) scan.style.opacity='0.22';
const fract = document.querySelector('.stl-fractal'); if(fract) fract.style.opacity='0.7';
setTimeout(()=>{ try{ ROOT.style.opacity='0'; setTimeout(()=>{ try{ ROOT.remove(); }catch(e){ ROOT.style.display='none'; } }, 900); }catch(e){} }, 4000);
}
}
applyMode();
window.__najib_cinematic_force = function(lvl){
try{ if(!lvl) return; ROOT.setAttribute('data-cinematic-mode', lvl); location.reload(); }catch(e){}
};
}catch(e){ console.warn('[najib-optimizer] cinematicModular fail', e); }
})();

/***** 4) CHILD-SUITE SOFT MODE *****/
(function softenChildSuite(){
try{
(function installSoftObserver(){
let throttleAt = 0;
let backoffMs = 1000;
const whitelist = ['#stl-open','#quantumParticles','#quantumIsland','.quantum-sidebar','.quantum-tools-sidebar'];
const safeCheck = (node)=>{
try{
if(!node || node.nodeType !== 1) return true;
for(const s of whitelist){
try{ if(node.matches && node.matches(s) || (node.closest && node.closest(s))) return true; }catch(e){}
}
const tag = (node.tagName||'').toLowerCase();
if(['div','span','script','style','link','meta','img','svg'].indexOf(tag) !== -1) return true;
return false;
}catch(e){ return true; }
};
const mo = new MutationObserver((mutations)=>{
const now = Date.now();
if(now - throttleAt < backoffMs) return;
throttleAt = now;
let flagged = false;
for(const m of mutations){
for(const n of (m.addedNodes||[])){
if(!safeCheck(n)) flagged = true;
}
}
if(flagged){
console.info('[najib-softObserver] suspicious DOM additions detected');
setTimeout(()=>{ try{ if(window.DEV_mg && typeof window.DEV_mg.auditProtections === 'function') window.DEV_mg.auditProtections({soft:true}); }catch(e){} }, 1200);
backoffMs = Math.min(60000, Math.max(2000, backoffMs * 1.5));
} else {
backoffMs = Math.max(1000, Math.floor(backoffMs*0.9));
}
});
try{
mo.observe(document.documentElement || document.body, { childList:true, subtree:true });
window.__najib_soft_mo = mo;
}catch(e){}
})();
}catch(e){ console.warn('[najib-optimizer] softenChildSuite fail', e); }
})();

/***** 5) REPORT SUMMARY *****/
try{
console.info('[najib-optimizer] applied. profile=%s', CAPS.profile);
}catch(e){}
})();
</script>
<!-- END NAJIB OPTIMIZER PATCH -->
</body>
) ===== -->
<script id="quantum-lazy-particles">
(function(){
'use strict';
const CONFIG = {
heavyLibs: [
{name:'tfjs', url:'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js'},
{name:'html2canvas', url:'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js'},
{name:'jspdf', url:'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'},
{name:'xlsx', url:'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js'},
{name:'axios', url:'https://unpkg.com/axios/dist/axios.min.js'}
],
fontSafeList: ['Inter','Poppins','Roboto'], // load these first; rest lazy
additionalFonts: [  ],
particleDomThreshold: 30, // <= => DOM particles; > => use canvas
particleMaxDom: 35, // if DOM mode, cap to this
defaultParticleCount: 45
};
function loadScript(url, attrs){
return new Promise((res, rej) => {
if(document.querySelector(`script[src="${url}"]`)){ return res(); }
const s = document.createElement('script');
s.src = url;
s.async = true;
if(attrs) Object.entries(attrs).forEach(([k,v])=> s.setAttribute(k,v));
s.onload = () => res();
s.onerror = (e) => rej(new Error(`Failed to load ${url}`));
document.head.appendChild(s);
});
}
function lazyLoadFonts(){
try{
// Ensure the safe list fonts are present via preload (if not already)
CONFIG.fontSafeList.forEach(f=>{
if(!document.querySelector(`link[data-quantum-font="${f}"]`)){
const l = document.createElement('link');
l.rel = 'preload';
l.as = 'style';
l.href = `https://fonts.googleapis.com/css2?family=${encodeURIComponent(f)}&display=swap`;
l.setAttribute('data-quantum-font', f);
l.onload = function(){ this.rel='stylesheet'; };
document.head.appendChild(l);
}
});
// schedule lazy load of other fonts on idle
if('requestIdleCallback' in window){
requestIdleCallback(()=> {
CONFIG.additionalFonts.forEach(fn=>{
if(!document.querySelector(`link[data-quantum-font="${fn}"]`)){
const l = document.createElement('link');
l.rel = 'stylesheet';
l.href = `https://fonts.googleapis.com/css2?family=${encodeURIComponent(fn)}&display=swap`;
l.setAttribute('data-quantum-font', fn);
document.head.appendChild(l);
}
});
}, {timeout:2000});
} else {
setTimeout(()=> {
CONFIG.additionalFonts.forEach(fn=>{
if(!document.querySelector(`link[data-quantum-font="${fn}"]`)){
const l = document.createElement('link');
l.rel = 'stylesheet';
l.href = `https://fonts.googleapis.com/css2?family=${encodeURIComponent(fn)}&display=swap`;
l.setAttribute('data-quantum-font', fn);
document.head.appendChild(l);
}
});
}, 1500);
}
}catch(e){ console.warn('font lazy load err', e); }
}
async function detectLowPower(){
const nav = navigator;
let low = false;
try{
if(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) low = true;
if('deviceMemory' in nav && nav.deviceMemory && nav.deviceMemory <= 1) low = true;
if(navigator.connection && navigator.connection.saveData) low = true;
// battery API (optional)
if(navigator.getBattery){
const bat = await navigator.getBattery();
if(bat && (bat.level < 0.25 || bat.charging === false && bat.level < 0.5)) low = true;
}
}catch(e){}
return low;
}
function createCanvasParticleRenderer(container, particleType, count){
// create canvas overlay
const canvas = document.createElement('canvas');
canvas.style.position = 'absolute';
canvas.style.inset = '0';
canvas.style.width = '100%';
canvas.style.height = '100%';
canvas.style.pointerEvents = 'none';
canvas.className = 'quantum-particles-canvas';
container.appendChild(canvas);
// size
function resize(){ canvas.width = container.clientWidth * devicePixelRatio; canvas.height = container.clientHeight * devicePixelRatio; ctx.scale(devicePixelRatio, devicePixelRatio); }
const ctx = canvas.getContext('2d');
resize();
window.addEventListener('resize', ()=> { resize(); });
// generate particles
const particles = [];
for(let i=0;i<count;i++){
particles.push({
x: Math.random()*container.clientWidth,
y: Math.random()*container.clientHeight,
vx: (Math.random()-0.5)*1.2,
vy: - (0.2 + Math.random()*1.2),
size: 2 + Math.random()*6,
life: 100 + Math.random()*200,
char: particleType === 'codeRain' ? '01ã‚ã‚¤ã‚¦'[Math.floor(Math.random()*4)] : null,
color: getComputedStyle(document.documentElement).getPropertyValue('--particle-code-rain') || '#00ff00'
});
}
let raf;
function step(){
ctx.clearRect(0,0,canvas.width,canvas.height);
// draw particles (scaled down because of devicePixelRatio)
particles.forEach(p=>{
p.x += p.vx; p.y += p.vy; p.life--;
if(p.y < -20 || p.life <= 0){ p.y = container.clientHeight + 10; p.x = Math.random()*container.clientWidth; p.life = 100 + Math.random()*200; }
ctx.fillStyle = p.color || 'rgba(200,200,200,0.8)';
if(p.char){
ctx.font = `${p.size*2}px monospace`;
ctx.fillText(p.char, p.x, p.y);
} else {
ctx.beginPath();
ctx.arc(p.x, p.y, p.size/2, 0, Math.PI*2);
ctx.fill();
}
});
raf = requestAnimationFrame(step);
}
// pause when not visible
document.addEventListener('visibilitychange', ()=> {
if(document.hidden) { cancelAnimationFrame(raf); } else { step(); }
});
step();
return {
destroy(){ cancelAnimationFrame(raf); canvas.remove(); }
};
}
async function adaptiveSetupParticles(){
const container = document.getElementById('quantumParticles');
if(!container) return;
// clear existing
Array.from(container.children).forEach(c => c.remove());
const saved = localStorage.getItem('quantum_theme');
const theme = window.quantumThemes?.[saved];
const particleType = theme?.effects?.particleType || 'goldenFloat';
const particleCountMap = { goldenFloat:50, blackPulse:30, redSword:40, shapeShifter:35, codeRain:60, oceanWave:45, neonPulse:40, roseFloat:55 };
let total = particleCountMap[particleType] || CONFIG.defaultParticleCount;
const low = await detectLowPower();
if(low) total = Math.max(8, Math.floor(total * 0.25)); // reduce if low-power
if(total > CONFIG.particleDomThreshold){
// canvas-based rendering
createCanvasParticleRenderer(container, particleType, total);
container.dataset.quantumRenderer = 'canvas';
}else{
// DOM-based (but limited)
const domCount = Math.min(total, CONFIG.particleMaxDom);
for(let i=0;i<domCount;i++){
const p = document.createElement('div');
p.className = `particle-${particleType}`;
const size = Math.random()*4 + 2;
const duration = 12 + Math.random()*13;
const delay = Math.random()*15;
p.style.cssText = `width:${size}px;height:${size}px;left:${Math.random()*100}%;top:${Math.random()*100}%;animation-duration:${duration}s;animation-delay:${delay}s;position:absolute;`;
if(particleType === 'codeRain') {
const chars = '01ã‚¢ã‚¤ã‚¦ã‚¨ã‚ª';
p.textContent = chars[Math.floor(Math.random()*chars.length)];
}
container.appendChild(p);
      }
      container.dataset.quantumRenderer = 'dom';
    }
  }

  /* install: lazy load heavy libs only when user opens developer/tools or triggers heavy action */
  function setupLazyTriggers(){
    // if user opens tools sidebar -> load libs used by tools
    const openTools = document.getElementById('openToolsSidebar');
    if(openTools){
      openTools.addEventListener('click', async ()=>{
        // load libs non-blocking
        CONFIG.heavyLibs.forEach(lib => loadScript(lib.url).catch(()=>{}));
        lazyLoadFonts();
      });
    }
    // if user opens ai chat -> load networking libs (axios)
    const openChat = document.getElementById('openAIChat');
    if(openChat){
      openChat.addEventListener('click', ()=>{ loadScript('https://unpkg.com/axios/dist/axios.min.js').catch(()=>{}); });
    }
    // explicit heavy action: export chat (loads jspdf/html2canvas)
    const exportBtn = document.getElementById('exportChat');
    if(exportBtn){
      exportBtn.addEventListener('click', async ()=>{
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js').catch(()=>{});
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js').catch(()=>{});
      });
    }
  }

  /* Initialize adaptive particle system and triggers */
  (function init(){
    // populate additionalFonts from head (gather available font link hrefs as fallback)
    document.querySelectorAll('link[rel="stylesheet"][href*="fonts.googleapis.com"]').forEach(l=>{
      const m = /family=([^&]+)/.exec(l.href);
      if(m && m[1]){
        const name = decodeURIComponent(m[1]).split(':')[0].split('&')[0];
        if(name && !CONFIG.fontSafeList.includes(name)) CONFIG.additionalFonts.push(name);
      }
    });

    // run adaptive particles
    adaptiveSetupParticles().catch(e=>console.warn('adaptiveParticles', e));
    // set up triggers to lazy-load heavy libs later
    setupLazyTriggers();
    // on theme change (listen to localStorage events)
    window.addEventListener('storage', (e)=> { if(e.key === 'quantum_theme') adaptiveSetupParticles(); });

    // re-run on resize after idle
    let t; window.addEventListener('resize', ()=>{ clearTimeout(t); t=setTimeout(()=>adaptiveSetupParticles(), 350); });

  })();

  // Expose for debug
  window.__quantum_lazy = { adaptiveSetupParticles, lazyLoadFonts, loadScript };

})();
</script>
<!-- ===== END Lazy-loader + Particle Optimiser ===== -->
<!-- ===== INJECTION: Device Scan Consent Wrapper ===== -->
<script id="quantum-device-consent">
(function(){
  const scanBtn = document.getElementById('scanDevice');
  if(!scanBtn) return;
  const orig = scanBtn.onclick || null;
  scanBtn.addEventListener('click', async (e)=>{
    // ask consent
    const ok = confirm('Full Device Scan akan membaca data perangkat (RAM, cores, browser, dll). Data akan tetap di browser dan hanya di-download ke file jika Anda setuju. Lanjutkan?');
if(!ok) return;
// optionally show details or allow local-only
const exportAllowed = confirm('Izinkan export data ke file? (Tekan OK untuk izinkan, Cancel untuk scan-only)');
// call existing scan logic (QuantumDeviceDetection.scanDevice)
try{
if(window.quantumDeviceDetection && typeof window.quantumDeviceDetection.scanDevice === 'function'){
window.quantumDeviceDetection.scanDevice();
} else {
alert('Fungsi scan tidak tersedia saat ini.');
}
if(!exportAllowed){
// disable export button if any
const exp = document.getElementById('exportDeviceInfo');
if(exp) exp.style.display = 'none';
}
}catch(err){ console.warn(err); }
});
})();
</script>
<!-- ===== END Device Scan Consent Wrapper ===== -->
<script id="quantum-dedupe-secure-save">
(function(){
"use strict";
const cryptoAPI = window.crypto?.subtle;
if(!cryptoAPI) return console.error("[ENC] WebCrypto tidak tersedia");
const ENC = {
async deriveKey(pass, salt){
const base = await cryptoAPI.importKey(
"raw", new TextEncoder().encode(pass), "PBKDF2", false, ["deriveKey"]
);
return cryptoAPI.deriveKey(
{name:"PBKDF2", hash:"SHA-256", salt, iterations:180000},
base,
{name:"AES-GCM", length:256},
false,
["encrypt","decrypt"]
);
},
async encrypt(obj, pass){
const salt = crypto.getRandomValues(new Uint8Array(16));
const iv   = crypto.getRandomValues(new Uint8Array(12));
const key  = await this.deriveKey(pass, salt);
const cipher = await cryptoAPI.encrypt(
{name:"AES-GCM", iv},
key,
new TextEncoder().encode(JSON.stringify(obj))
);
return {
salt:  btoa(String.fromCharCode(...salt)),
iv:    btoa(String.fromCharCode(...iv)),
data:  btoa(String.fromCharCode(...new Uint8Array(cipher)))
};
},
async decrypt(pkg, pass){
const salt = Uint8Array.from(atob(pkg.salt), c=>c.charCodeAt(0));
const iv   = Uint8Array.from(atob(pkg.iv), c=>c.charCodeAt(0));
const key  = await this.deriveKey(pass, salt);
const raw  = await cryptoAPI.decrypt(
{name:"AES-GCM", iv},
key,
Uint8Array.from(atob(pkg.data), c=>c.charCodeAt(0))
);
return JSON.parse(new TextDecoder().decode(raw));
}
};
function modalPass(title, confirm=false){
return new Promise((ok,fail)=>{
const ui = document.createElement("div");
ui.innerHTML = `
<div style="
position:fixed;inset:0;background:rgba(0,0,0,0.6);
display:flex;align-items:center;justify-content:center;z-index:999999
">
<div style="background:#0a0f18;padding:20px;border-radius:12px;width:90%;max-width:320px;color:#fff;font-family:sans-serif">
<div style="font-size:15px;font-weight:700;margin-bottom:8px">${title}</div>
<input id="p1" type="password" placeholder="Passphrase" style="width:100%;padding:10px;border:1px solid rgba(255,255,255,0.2);background:#000;color:#0ff;border-radius:8px;margin-bottom:8px"/>
${ confirm ? `<input id="p2" type="password" placeholder="Ulangi passphrase" style="width:100%;padding:10px;border:1px solid rgba(255,255,255,0.2);background:#000;color:#0ff;border-radius:8px;margin-bottom:12px"/>` : "" }
<div style="display:flex;gap:8px;justify-content:end">
<button id="c">Batal</button>
<button id="s" style="background:#6366f1;border:none;padding:6px 12px;border-radius:6px;color:white">OK</button>
</div>
</div>
</div>`;
document.body.appendChild(ui);
ui.querySelector("#c").onclick = ()=>{ ui.remove(); fail("cancel"); }
ui.querySelector("#s").onclick = ()=>{
const a = ui.querySelector("#p1").value;
const b = confirm ? ui.querySelector("#p2").value : a;
if(a.length < 6) return alert("Minimal 6 karakter");
if(a !== b)   return alert("Tidak sama!");
ui.remove(); ok(a);
}
});
}
window.quantumSecure = {
async save(key, obj){
const pass = await modalPass("Encrypt & Save", true);
const pack = await ENC.encrypt(obj, pass);
localStorage.setItem(key, JSON.stringify(pack));
alert("âœ… Tersimpan terenkripsi!");
},
async load(key){
const raw = localStorage.getItem(key);
if(!raw) return alert("âŒ Tidak ada data");
const pass = await modalPass("Decrypt", false);
try{
const dec = await ENC.decrypt(JSON.parse(raw), pass);
alert("âœ… Berhasil decrypt!");
return dec;
}catch(e){
alert("âŒ Passphrase salah / rusak");
}
}
};
console.log("âœ… Dedupe tema atas & Secure Save aktif");
})();
</script>
<!-- ===== INJECT: Theme Encrypted Save/Load + Backup/Restore (PBKDF2 + AES-GCM) ===== -->
<script id="quantum-theme-secure-tools">
(function(){
'use strict';
function $(sel, root=document){ return root.querySelector(sel); }
function createEl(tag, attrs={}, html=''){ const e=document.createElement(tag); Object.entries(attrs||{}).forEach(([k,v])=> e.setAttribute(k,v)); if(html) e.innerHTML=html; return e; }
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
const cryptoSubtle = window.crypto && window.crypto.subtle;
if(!cryptoSubtle) { console.warn('WebCrypto not available â€” theme secure tools disabled'); return; }
const ENC = (function(){
const ITER = 150000;
const SALT_BYTES = 16;
const IV_BYTES = 12;
async function derive(pass, salt){
const base = await cryptoSubtle.importKey('raw', new TextEncoder().encode(pass), 'PBKDF2', false, ['deriveKey']);
return cryptoSubtle.deriveKey(
{ name: 'PBKDF2', hash: 'SHA-256', salt, iterations: ITER },
base,
{ name: 'AES-GCM', length: 256 },
false,
['encrypt','decrypt']
);
}
function rand(n){ const b=new Uint8Array(n); crypto.getRandomValues(b); return b; }
function toB64(buf){ return btoa(String.fromCharCode(...new Uint8Array(buf))); }
function fromB64(b64){ const bin = atob(b64); const arr = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i); return arr.buffer; }
return {
async encrypt(obj, pass){
const salt = rand(SALT_BYTES);
const iv = rand(IV_BYTES);
const key = await derive(pass, salt);
const plain = new TextEncoder().encode(JSON.stringify(obj));
const cipher = await cryptoSubtle.encrypt({name:'AES-GCM', iv}, key, plain);
return { version:1, salt: toB64(salt.buffer), iv: toB64(iv.buffer), data: toB64(cipher) };
},
async decrypt(pkg, pass){
if(!pkg || !pkg.data) throw new Error('Invalid package');
const salt = new Uint8Array(fromB64(pkg.salt));
const iv = new Uint8Array(fromB64(pkg.iv));
const key = await derive(pass, salt);
const plainBuf = await cryptoSubtle.decrypt({name:'AES-GCM', iv}, key, fromB64(pkg.data));
return JSON.parse(new TextDecoder().decode(plainBuf));
}
};
})();
</script>
<!-- ===== END THEME SECURE TOOLS ===== -->
<script>
(function(){
const LOG_KEY = 'stl_silent_log_v3';
// logging helper
function pushSilentLog(type, msg, extra){
try{
const raw = localStorage.getItem(LOG_KEY);
const arr = raw ? JSON.parse(raw) : [];
arr.push({
time: new Date().toISOString(),
type: type || 'info',
msg: msg || '',
extra: extra || null
});
if(arr.length > 300) arr.shift(); // limit
localStorage.setItem(LOG_KEY, JSON.stringify(arr));
}catch(e){ console.warn('SilentLogError', e); }
}
// fungsi pembungkam notifikasi spam
function silentWrap(fnName, label){
if(!window[fnName]) return;
if(window[fnName].__silenced) return;
const orig = window[fnName];
window[fnName] = function(...args){
try{
const text = args[0] && args[0].toString ? args[0].toString() : '';
// filter pesan yang berpotensi spam
const spamLike = /config|saved|ready|voice|aktif|respon/i.test(text);
        if(spamLike){
          pushSilentLog('silent-block', label + ': ' + text);
          return; // blokir tampilannya
        } else {
          // biarkan notif penting dari HTML asli tetap lewat
          return orig.apply(this, args);
        }
      }catch(err){
        pushSilentLog('error', 'wrap failed: '+label, err.message||err);
        return orig.apply(this, args);
      }
    };
    window[fnName].__silenced = true;
    pushSilentLog('patch', label + ' wrapped silently');
  }

  // patch fungsi-fungsi umum injeksi
  silentWrap('updateQuantumIsland', 'QuantumIsland');
  silentWrap('islandNotify', 'IslandNotify');
  silentWrap('showToast', 'Toast');

  // patch juga kalau ada di namespace engine
  if(window.quantumEngine && typeof window.quantumEngine.updateQuantumIsland === 'function'){
    const origQE = window.quantumEngine.updateQuantumIsland.bind(window.quantumEngine);
    window.quantumEngine.updateQuantumIsland = function(msg, dur){
      try{
        const spamLike = /config|saved|ready|aktif|voice|respon/i.test(msg);
        if(spamLike){
          pushSilentLog('silent-qe', msg);
          return;
        } else {
          return origQE(msg, dur);
        }
      }catch(e){
        pushSilentLog('error','quantumEngine wrap fail', e.message||e);
      }
    };
    pushSilentLog('patch','quantumEngine silent-wrapped');
  }

  // expose helper
  window.__stlSilentLog = {
    getLogs: ()=>{ 
      try{ return JSON.parse(localStorage.getItem(LOG_KEY)||'[]'); }
      catch(e){ return []; }
    },
    clear: ()=>{ localStorage.removeItem(LOG_KEY); pushSilentLog('clear','Silent logs cleared'); },
    push: pushSilentLog
  };

  pushSilentLog('init','Deep Silent Mode aktif');
})();
</script>

<!-- ===== QUANTUM BOOT MANAGER (AUTO-INJECTED) ===== -->
<script id="quantum-boot-manager-injection">
/*
QuantumBootManager + Particle Mode Selector + LZString-enabled LocalStorage Compression
Non-destructive injection. Provides:
- queue/dependency boot manager
- selectParticleMode() heuristics
- smart particle init (canvas fallback & lightweight DOM fallback)
- LZString auto-load and quantaSaveCompressed/quantaLoadCompressed helpers
- wrappers for known heavy init functions to avoid race conditions
- exposes window.QuantumBootManager and window.QuantumBootAPI
*/
(function(){
  'use strict';
  const DEFAULT_CONFIG = {
    taskTimeout: 8000,
    taskRetries: 1,
    lowMemoryThresholdGB: 2,
    lowCpuThreshold: 2,
    defaultParticleCount: 45,
    lowEndParticleCount: 8,
    mobileBreakpoint: 768,
    lzStringCdn: 'https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js'
  };

  function log(...a){ try{ console.log('[QBM]',...a);}catch(e){} }
  function loadScriptOnce(src, id){
    return new Promise((resolve, reject)=>{
if(id && document.getElementById(id)) return resolve();
const existing = Array.from(document.scripts).find(s=>s.src && s.src.indexOf(src)!==-1);
if(existing) {
if(existing.readyState==='complete' || existing.readyState==='loaded') return resolve();
existing.addEventListener && existing.addEventListener('load', ()=>resolve());
return;
}
const s = document.createElement('script'); s.src = src; if(id) s.id = id; s.async = true;
s.onload = ()=>resolve(); s.onerror = (e)=>reject(e);
document.head.appendChild(s);
});
}
async function ensureLZString(){
if(window.LZString) return window.LZString;
try{
await loadScriptOnce(DEFAULT_CONFIG.lzStringCdn, 'qbm-lz');
if(window.LZString) return window.LZString;
}catch(e){ log('failed to load LZString', e); }
return null;
}
async function quantaSaveCompressed(key, obj){
try{
const lz = await ensureLZString();
const raw = JSON.stringify(obj);
if(lz){
const compressed = lz.compressToUTF16(raw);
localStorage.setItem(key, 'lz:' + compressed);
} else {
localStorage.setItem(key, 'raw:' + raw);
}
return true;
}catch(e){ log('saveCompressed failed', e); return false; }
}
async function quantaLoadCompressed(key){
try{
const v = localStorage.getItem(key);
if(!v) return null;
if(v.startsWith('lz:')){
const lz = await ensureLZString();
if(!lz) return null;
return JSON.parse(lz.decompressFromUTF16(v.slice(3)));
}
if(v.startsWith('raw:')) return JSON.parse(v.slice(4));
try{ return JSON.parse(v); }catch(e){ return v; }
}catch(e){ log('loadCompressed failed', e); return null; }
}
window.quantaSaveCompressed = quantaSaveCompressed;
window.quantaLoadCompressed = quantaLoadCompressed;
function selectParticleMode() {
try{
const ua = navigator.userAgent || '';
const mem = navigator.deviceMemory || null;
const cores = navigator.hardwareConcurrency || 1;
const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(ua) || window.innerWidth <= DEFAULT_CONFIG.mobileBreakpoint;
if(mem !== null){
if(mem <= DEFAULT_CONFIG.lowMemoryThresholdGB) return {mode:'canvas', reason:`low-memory ${mem}GB`};
}
if(cores <= DEFAULT_CONFIG.lowCpuThreshold) return {mode:'canvas', reason:`low-cores ${cores}`};
if(isMobile && (cores <= 4 || (mem !== null && mem <= 3))) return {mode:'canvas', reason:'mobile-conservative'};
if(/Android\s+[0-6]/i.test(ua) || /Windows Phone/i.test(ua)) return {mode:'canvas', reason:'legacy-ua'};
return {mode:'dom', reason:'modern-device'};
}catch(e){
return {mode:'canvas', reason:'error-fallback'};
}
}
window.selectParticleMode = selectParticleMode;
class QuantumBootManager {
constructor(){
this.tasks = new Map();
this.order = [];
this.started = false;
this._autoStartTimer = setTimeout(()=>{ if(!this.started) this.start(); }, 1200);
}
queue(name, fn, opts={}){
if(!name || typeof fn !== 'function') throw new Error('invalid task');
if(this.tasks.has(name)){ log('task exists, skipping queue', name); return; }
const deps = Array.isArray(opts.deps) ? opts.deps.slice() : [];
this.tasks.set(name, { name, fn, deps, status:'idle', retries:0, timeout: opts.timeout || DEFAULT_CONFIG.taskTimeout, opts:opts });
this.order.push(name);
log('queued', name, deps);
}
async runTask(task){
if(!task || task.status === 'done') return true;
task.status = 'running';
let timedOut = false;
try{
const p = new Promise((resolve, reject)=>{
const t = setTimeout(()=>{ timedOut = true; reject(new Error('task timeout')); }, task.timeout);
Promise.resolve().then(()=>task.fn()).then(res=>{ clearTimeout(t); resolve(res); }).catch(err=>{ clearTimeout(t); reject(err); });
});
await p;
task.status = 'done';
return true;
}catch(err){
task.retries++;
task.status = 'error';
log('task error', task.name, err, 'timedOut?', timedOut);
return false;
}
}
async start(){
if(this.started) return; this.started = true;
log('QuantumBootManager starting... tasks=', this.order.slice());
const remaining = new Set(this.order);
let progress = true;
while(remaining.size && progress){
progress = false;
for(const name of Array.from(remaining)){
const t = this.tasks.get(name);
const unmet = (t.deps||[]).filter(d=>{ const tt = this.tasks.get(d); return !tt || tt.status !== 'done'; });
if(unmet.length === 0){
progress = true;
remaining.delete(name);
try{ await this.runTask(t); }catch(e){ log('runTask exception', e); }
}
}
if(!progress && remaining.size){
log('Dependency deadlock or missing tasks:', Array.from(remaining));
const first = this.tasks.get(Array.from(remaining)[0]);
if(first){ remaining.delete(first.name); await this.runTask(first); progress = true; }
}
}
log('QuantumBootManager finish');
if(typeof window.onQuantumBootComplete === 'function'){ try{ window.onQuantumBootComplete(); }catch(e){ log(e); } }
}
}
const QBM = new QuantumBootManager();
window.QuantumBootManager = QBM;
function wrapInitIfExists(globalName, opts={}){
try{
const original = window[globalName];
if(typeof original === 'function'){
QBM.queue(globalName, async ()=>{ try{ await Promise.resolve(original()); }catch(e){ log('wrapped init failed', globalName, e); } }, opts);
}
}catch(e){}
}
const knownInits = [
'injectQuantumThemesWithCustomParticles',
'initializeEnhancedThemeSystem',
'adaptiveSetupParticles',
'waitForEngineAndAddEnhancedThemes',
'initializeMobileEnhancements',
'waitForEngineAndAddMobileEnhancements'
];
knownInits.forEach(n=>wrapInitIfExists(n, {timeout: 12000}));
window.QuantumBootRegister = function(name, fn, opts){ try{ QBM.queue(name, fn, opts||{}); }catch(e){ log('QuantumBootRegister error', e); } };
function smartInitParticleSystem(){
const decision = (window.__quantum_particle_mode_override && typeof window.__quantum_particle_mode_override === 'string') ? {mode: window.__quantum_particle_mode_override, reason:'override-string'} : (window.__quantum_particle_mode_override && window.__quantum_particle_mode_override.mode ? window.__quantum_particle_mode_override : selectParticleMode());
log('selectParticleMode =>', decision);
try{ quantaSaveCompressed('qbm_particle_mode', decision); }catch(e){}
if(typeof window.adaptiveSetupParticles === 'function'){
QBM.queue('adaptiveSetupParticles:wrapped', async ()=>{
try{
window.__quantum_particle_mode_override = decision.mode;
await Promise.resolve(window.adaptiveSetupParticles());
delete window.__quantum_particle_mode_override;
}catch(e){ log('adaptiveSetupParticles wrapped error', e); }
}, {deps:[], timeout: 20000});
return;
}
QBM.queue('minimalParticleInit', async ()=>{
try{
const particlesContainer = document.getElementById('quantumParticles');
if(!particlesContainer){ log('no quantumParticles container found'); return; }
const count = (decision.mode === 'canvas') ? DEFAULT_CONFIG.lowEndParticleCount : DEFAULT_CONFIG.defaultParticleCount;
if(decision.mode === 'canvas'){
while(particlesContainer.firstChild) particlesContainer.removeChild(particlesContainer.firstChild);
particlesContainer.style.pointerEvents = 'none';
const canvas = document.createElement('canvas');
canvas.style.position = 'absolute'; canvas.style.inset = '0'; canvas.width = particlesContainer.clientWidth || window.innerWidth; canvas.height = particlesContainer.clientHeight || window.innerHeight; canvas.id = 'quantumParticlesCanvas';
particlesContainer.appendChild(canvas);
const ctx = canvas.getContext('2d');
const particleArray = [];
for(let i=0;i<count;i++) particleArray.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height, vx: (Math.random()-0.5)*0.6, vy: (Math.random()-0.5)*0.6, r: Math.random()*3+1});
let raf = null;
function resizeC(){ canvas.width = particlesContainer.clientWidth || window.innerWidth; canvas.height = particlesContainer.clientHeight || window.innerHeight; }
window.addEventListener('resize', resizeC);
function step(){
ctx.clearRect(0,0,canvas.width,canvas.height);
ctx.globalCompositeOperation = 'lighter';
for(const p of particleArray){
p.x += p.vx; p.y += p.vy;
if(p.x < -10) p.x = canvas.width + 10; if(p.x > canvas.width + 10) p.x = -10;
if(p.y < -10) p.y = canvas.height + 10; if(p.y > canvas.height + 10) p.y = -10;
ctx.beginPath(); ctx.fillStyle = 'rgba(120,110,255,0.15)'; ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
}
raf = requestAnimationFrame(step);
}
step();
log('canvas particle mode initialized, count=', count);
window.__quantumParticlesCanvasStop = ()=>{ if(raf) cancelAnimationFrame(raf); window.removeEventListener('resize', resizeC); };
return;
}
const fragment = document.createDocumentFragment();
for(let i=0;i<count;i++){
const el = document.createElement('div');
el.className = 'particle particle-qbm';
el.style.position = 'absolute';
el.style.width = el.style.height = (Math.random()*4 + 2) + 'px';
el.style.left = (Math.random()*100) + '%';
el.style.top = (Math.random()*100) + '%';
el.style.opacity = '0.85';
el.style.pointerEvents = 'none';
          fragment.appendChild(el);
        }
        Array.from(particlesContainer.children).forEach(c=>{ if(!c.id || c.id.indexOf('quantumParticlesCanvas')===-1) c.remove(); });
        particlesContainer.appendChild(fragment);
        log('DOM lightweight particle mode initialized, count=', count);
      }catch(e){ log('minimalParticleInit error', e); }
    }, {timeout:10000});
  }

  QBM.queue('smartInitParticleSystem.register', smartInitParticleSystem, {timeout:12000});

  window.getPreferredParticleMode = function(){
    try{
      const cached = localStorage.getItem('qbm_particle_mode');
      if(cached){ try{ const parsed = JSON.parse(cached); if(parsed && parsed.mode) return parsed.mode; }catch(e){} }
    }catch(e){}
    try{ return selectParticleMode().mode; }catch(e){ return 'canvas'; }
  };

  function attemptWrapGlobalFn(name){
    try{
      const original = window[name];
      if(typeof original !== 'function') return;
      window[name] = function(...args){
        log('Deferred heavy init', name);
        QBM.queue(name, ()=> Promise.resolve(original.apply(this,args)), {timeout:20000});
        return {deferred:true};
      };
      log('wrapped global heavy fn', name);
    }catch(e){ log('wrap failure', name, e); }
  }

  ['injectQuantumThemesWithCustomParticles','initializeEnhancedThemeSystem','adaptiveSetupParticles'].forEach(attemptWrapGlobalFn);

  window.QuantumBootAPI = {
    start: ()=> QBM.start(),
    register: (name, fn, opts)=> QBM.queue(name, fn, opts),
    selectParticleMode, quantaSaveCompressed, quantaLoadCompressed
  };

  log('Quantum Boot Manager injected. Use window.QuantumBootAPI to interact.');
})();
</script>
<script>
function ensureProxyUI() {  // âœ… SAMAKAN NAMANYA
  const row = document.createElement("div");
  row.id = "quantumProxyRow";
  row.innerHTML = `
    <input id="quantumProxyUrl" placeholder="Proxy endpoint (e.g. https://yourdomain.com/api/proxy)" />
    <button id="quantumProxyToggle" class="quantum-btn secondary">Enable Proxy</button>
    <div id="quantumProxyNote">Optional: Use server-side proxy to keep API keys secure.</div>
  `;

  // === FORCE MASUK SIDEBAR KIRI (PATCH FIX) ===
  const toolsSidebar =
    document.getElementById("quantumToolsSidebar") ||
    document.querySelector(".quantum-tools-sidebar") ||
    document.querySelector(".tools-sidebar");

  if (toolsSidebar) {
    toolsSidebar.appendChild(row);
  } else {
    console.warn("Sidebar belum render, retry 600ms...");
    setTimeout(ensureProxyUI, 600);
  }

  try {
    const saved = JSON.parse(localStorage.getItem("__QUANTUM_PROXY__") || "{}");
    document.getElementById("quantumProxyUrl").value = saved.url || "/api/proxy";
    setButtonState(saved.enabled);
  } catch (e) {
    console.warn("Proxy load error", e);
    setButtonState(false);
}
document.getElementById("quantumProxyToggle").addEventListener("click", function() {
const url = document.getElementById("quantumProxyUrl").value.trim() || "/api/proxy";
const enabled = this.dataset.enabled !== "true";
localStorage.setItem("__QUANTUM_PROXY__", JSON.stringify({ url, enabled }));
setButtonState(enabled);
});
function setButtonState(state) {
const btn = document.getElementById("quantumProxyToggle");
btn.dataset.enabled = state;
btn.textContent = state ? "PROXY: ON" : "PROXY: OFF";
}
}
document.addEventListener("DOMContentLoaded", ensureProxyUI);
</script>
<style>
#quantumProxyRow {
width: 100%;
margin-top: 12px;
display: flex;
flex-direction: column;
gap: 6px;
}
</style>
<script>
(function stlPermanentDock() {
const sidebars = [
"quantumToolsSidebar", // sidebar kiri ( tempat tombol upgrade )
"quantumSidebar"       // sidebar kanan (global active)
];
function dockUpgrade() {
// cari panel yang sudah ada, tidak membuat baru
const upgradePanel =
document.querySelector(".stl-upgrade-card") ||
document.querySelector("#stl-float-capsule-container");
if (!upgradePanel) return; // panel belum ada â†’ jangan paksa
for (const id of sidebars) {
const sb = document.getElementById(id);
if (!sb) continue;
// sidebar aktif, scroll tetap bisa
sb.style.overflowY = "auto";
sb.style.maxHeight = "100%";
// hanya memastikan tetap paling bawah, tidak sticky/floating
upgradePanel.style.marginTop = "auto";
// pastikan panel tetap di dalam sidebar kiri
if (sb === document.getElementById("quantumToolsSidebar")) {
if (upgradePanel.parentNode !== sb) sb.appendChild(upgradePanel);
}
}
}
// dijalankan sekali saat load
dockUpgrade();
// bila DOM berubah (tambah tombol baru), panel tetap di bawah
const observer = new MutationObserver(dockUpgrade);
observer.observe(document.body, { childList: true, subtree: true });
console.debug("âœ… Upgrade panel dipatenkan di sidebar kiri (global active).");
})();
</script>
<script>
(function stlMongoAutoMode(){
if(!window.stlMongoPassManager){
console.warn('stlMongoPassManager not found. Paste the mongo pass protect script first.');
return;
}
// auto-generate and set alt pass (24 chars, include symbols)
const alt = window.stlMongoPassManager.generatePass({length:24, symbols:true});
// hide original fields (if not already)
try{ window.stlMongoPassManager.hideOriginal(); }catch(e){}
// Wrap existing stlExportEncrypted so it uses alt pass automatically (no prompt)
if(typeof window.stlExportEncrypted === 'function' && !window.__stl_export_wrapped_by_auto){
const orig = window.stlExportEncrypted.bind(window);
window.__stl_export_wrapped_by_auto = true;
window.stlExportEncrypted = async function(payloadObj, passphrase){
try{
// if caller supplied explicit passphrase, honor it; otherwise use generated alt
const usePass = passphrase && String(passphrase).length ? passphrase : alt;
return await orig(payloadObj, usePass);
}catch(e){
console.warn('stlExportEncrypted (auto wrapper) failed', e);
throw e;
}
};
console.debug('stlExportEncrypted wrapped to use auto-generated alt pass (no new buttons).');
} else {
// If function not yet present, set a small watcher to wrap when it appears
if(!window.__stl_export_wrapped_by_auto){
const iv = setInterval(()=>{
if(typeof window.stlExportEncrypted === 'function'){
clearInterval(iv);
try{
const orig = window.stlExportEncrypted.bind(window);
window.__stl_export_wrapped_by_auto = true;
window.stlExportEncrypted = async function(payloadObj, passphrase){
const usePass = passphrase && String(passphrase).length ? passphrase : alt;
return await orig(payloadObj, usePass);
};
console.debug('stlExportEncrypted wrapped (deferred) to use auto-generated alt pass.');
}catch(e){ console.warn(e); }
}
}, 1500); // polling throttled
}
}
// expose for debug (but careful not to log pass in production)
window.__stl_mongo_auto_info = { altPassLength: alt.length, altPreview: alt.slice(0,4) + 'â€¦' };
console.log('AUTO mode: mongoPass hidden and auto-pass ready (no new buttons).');
})();
</script>

<!-- NAJIB OPTIMIZER PATCH v1.0 (Fonts + Particle Optimizer + Cinematic Modes + Child-suite soft-mode) -->
<script id="najib-optimizer-patch">
(function(){
'use strict';
/*** UTIL: capability detection ***/
function detectCapsSafe(){
try{
if(window.__NAJIB_CAPS) return window.__NAJIB_CAPS;
const caps = { cores: navigator.hardwareConcurrency||2, mem: navigator.deviceMemory||2, dpr: window.devicePixelRatio||1, webgl:false, webgl2:false };
try{
const c=document.createElement('canvas');
const g2 = c.getContext && c.getContext('webgl2');
const g = g2 || (c.getContext && (c.getContext('webgl')||c.getContext('experimental-webgl')));
if(g){ caps.webgl = !!g; caps.webgl2 = !!g2; }
}catch(e){}
let score=0;
if(caps.cores>=8) score+=30; else if(caps.cores>=4) score+=18; else score+=8;
if(caps.mem>=8) score+=30; else if(caps.mem>=4) score+=18; else score+=6;
if(caps.webgl2) score+=30; else if(caps.webgl) score+=16;
caps.score = score;
if(caps.cores<=2 || caps.mem<=1 || caps.score<24) caps.profile='low';
else if((caps.cores<=4 && caps.mem<=3) || caps.score<48) caps.profile='mid';
else caps.profile='high';
window.__NAJIB_CAPS = caps;
return caps;
}catch(e){
return { profile:'low', cores:2, mem:1, dpr:1 };
}
}
const CAPS = detectCapsSafe();

/***** 1) FONT LAZY LOADER *****/
(function lazyFonts(){
try{
const heavyLinks = Array.from(document.querySelectorAll('link[href*="fonts.googleapis.com"], link[href*="fonts.gstatic.com"]'));
if(!heavyLinks.length) return;
if(CAPS.profile === 'low' || window.matchMedia('(prefers-reduced-data: reduce)').matches){
heavyLinks.forEach(l => { l.media='print'; l.setAttribute('data-deferred','1'); });
return;
}
function loadHeavyFonts(){
heavyLinks.forEach(l=>{
if(l.getAttribute('data-deferred')) return;
l.rel = 'stylesheet';
l.removeAttribute('media');
l.setAttribute('data-loaded-by','najib-optimizer');
});
}
if('requestIdleCallback' in window){
requestIdleCallback(loadHeavyFonts, {timeout:3000});
} else {
const onFirst = function(){ loadHeavyFonts(); window.removeEventListener('pointerdown', onFirst); window.removeEventListener('touchstart', onFirst); };
window.addEventListener('pointerdown', onFirst, {once:true});
window.addEventListener('touchstart', onFirst, {once:true});
setTimeout(loadHeavyFonts, 6000);
}
}catch(e){ console.warn('[najib-optimizer] lazyFonts failed', e); }
})();

/***** 2) PARTICLE SMART OPTIMIZER *****/
(function particleOptimizer(){
try{
const container = document.getElementById('quantumParticles') || document.querySelector('.quantum-particles');
if(!container) return;
function makeParticle(cls, x, y, size, content){
const el = document.createElement('div');
el.className = 'particle ' + cls;
el.style.left = (x*100).toFixed(2) + 'vw';
el.style.top = (y*100).toFixed(2) + 'vh';
el.style.width = size + 'px';
el.style.height = size + 'px';
if(content) { el.textContent = content; el.classList.add('particle-codeRain'); el.style.fontSize = Math.max(10, size) + 'px'; el.style.width = 'auto'; el.style.height = 'auto'; }
return el;
}
const baseCounts = {
goldenFloat: 28, blackPulse: 20, redSword: 22, shapeShifter: 20,
codeRain: 36, oceanWave: 26, neonPulse: 24, roseFloat: 24
};
const scaleMap = { high:1, mid:0.45, low:0.08 };
const profile = CAPS.profile || 'low';
const scale = scaleMap[profile] || 0.45;
const reduceEffects = (profile === 'low' || window.matchMedia('(prefers-reduced-motion: reduce)').matches);

window.renderParticlesForTheme = function(themeKey){
try{
const t = themeKey || 'goldenFloat';
const mapName = {
goldenFloat:'goldenFloat', blackPulse:'blackPulse', redSword:'redSword',
shapeShifter:'shapeShifter', codeRain:'codeRain', oceanWave:'oceanWave',
neonPulse:'neonPulse', roseFloat:'roseFloat'
}[t] || 'goldenFloat';
const base = baseCounts[mapName] || 18;
const count = Math.max( Math.round(base*scale), (reduceEffects ? 0 : 2) );
container.innerHTML = '';
if(count === 0){
const accent = document.createElement('div');
accent.className = 'particle particle-neonPulse';
accent.style.left = '50%';
accent.style.top = '80%';
accent.style.width = '4px';
accent.style.height = '4px';
accent.style.opacity = '0.6';
accent.style.pointerEvents = 'none';
container.appendChild(accent);
return;
}
const fragment = document.createDocumentFragment();
for(let i=0;i<count;i++){
const x = Math.random(); const y = Math.random();
const size = (mapName==='codeRain' ? Math.max(10, Math.round(Math.random()*14+6)) : Math.round(Math.random()*(reduceEffects?4:8) + (reduceEffects?2:2)));
const p = makeParticle('particle-'+mapName, x, y, size, mapName==='codeRain'? (Math.random()>0.7?String.fromCharCode(0x30A0 + Math.floor(Math.random()*96)) : '') : '');
if(reduceEffects){
p.style.boxShadow = 'none';
p.style.filter = 'none';
p.style.animationDuration = '8s';
}
fragment.appendChild(p);
}
container.appendChild(fragment);
}catch(e){ console.warn('[najib-optimizer] renderParticlesForTheme fail', e); }
};

try{
const saved = (JSON.parse(localStorage.getItem('najib_saved_themes')||'[]') || [])[0];
const initialTheme = saved ? (saved.variables && saved.variables.particleTheme) : 'goldenFloat';
setTimeout(()=>{ try{ window.renderParticlesForTheme(initialTheme); }catch(e){} }, 300);
}catch(e){}

window.__najib_particle_optimizer = { profile: CAPS.profile, reducedEffects: reduceEffects };

}catch(e){ console.warn('[najib-optimizer] particleOptimizer top fail', e); }
})();

/***** 3) CINEMATIC MODULAR MODE *****/
(function cinematicModular(){
try{
const ROOT = document.getElementById('stl-open');
if(!ROOT) return;
const mode = CAPS.profile || 'low';
ROOT.setAttribute('data-cinematic-mode', mode);

function applyMode(){
if(mode === 'low'){
const chrom = document.querySelector('.stl-chromatic');
if(chrom) chrom.style.display = 'none';
const scan = document.getElementById('stl-scan');
if(scan) { scan.style.animationDuration = '12s'; scan.style.opacity='0.12'; }
const TITLE = document.getElementById('stl-title');
const TAG = document.getElementById('stl-tag');
if(TITLE) TITLE.style.transition='opacity .6s ease';
if(TAG) TAG.style.transition='opacity .6s ease';
setTimeout(()=>{ try{ ROOT.style.opacity='0'; setTimeout(()=>{ try{ ROOT.remove(); }catch(e){ ROOT.style.display='none'; } }, 550); }catch(e){} }, 900);
}
else if(mode === 'mid'){
const scan = document.getElementById('stl-scan'); if(scan) scan.style.opacity='0.22';
const fract = document.querySelector('.stl-fractal'); if(fract) fract.style.opacity='0.7';
setTimeout(()=>{ try{ ROOT.style.opacity='0'; setTimeout(()=>{ try{ ROOT.remove(); }catch(e){ ROOT.style.display='none'; } }, 900); }catch(e){} }, 4000);
}
}
applyMode();
window.__najib_cinematic_force = function(lvl){
try{ if(!lvl) return; ROOT.setAttribute('data-cinematic-mode', lvl); location.reload(); }catch(e){}
};
}catch(e){ console.warn('[najib-optimizer] cinematicModular fail', e); }
})();

/***** 4) CHILD-SUITE SOFT MODE *****/
(function softenChildSuite(){
try{
(function installSoftObserver(){
let throttleAt = 0;
let backoffMs = 1000;
const whitelist = ['#stl-open','#quantumParticles','#quantumIsland','.quantum-sidebar','.quantum-tools-sidebar'];
const safeCheck = (node)=>{
try{
if(!node || node.nodeType !== 1) return true;
for(const s of whitelist){
try{ if(node.matches && node.matches(s) || (node.closest && node.closest(s))) return true; }catch(e){}
}
const tag = (node.tagName||'').toLowerCase();
if(['div','span','script','style','link','meta','img','svg'].indexOf(tag) !== -1) return true;
return false;
}catch(e){ return true; }
};
const mo = new MutationObserver((mutations)=>{
const now = Date.now();
if(now - throttleAt < backoffMs) return;
throttleAt = now;
let flagged = false;
for(const m of mutations){
for(const n of (m.addedNodes||[])){
if(!safeCheck(n)) flagged = true;
}
}
if(flagged){
console.info('[najib-softObserver] suspicious DOM additions detected');
setTimeout(()=>{ try{ if(window.DEV_mg && typeof window.DEV_mg.auditProtections === 'function') window.DEV_mg.auditProtections({soft:true}); }catch(e){} }, 1200);
backoffMs = Math.min(60000, Math.max(2000, backoffMs * 1.5));
} else {
backoffMs = Math.max(1000, Math.floor(backoffMs*0.9));
}
});
try{
mo.observe(document.documentElement || document.body, { childList:true, subtree:true });
window.__najib_soft_mo = mo;
}catch(e){}
})();
}catch(e){ console.warn('[najib-optimizer] softenChildSuite fail', e); }
})();

/***** 5) REPORT SUMMARY *****/
try{
console.info('[najib-optimizer] applied. profile=%s', CAPS.profile);
}catch(e){}
})();
</script>
<!-- END NAJIB OPTIMIZER PATCH -->
</body>

</html>
<!-- ================= STl - PBKDF2 DERIVE OPTION & TIGHTENED MONGO PASS HIDING ================= -->
<script>
(function stlPBKDF2Enhance(){
if(window.__stl_pbkdf2_attached) return;
window.__stl_pbkdf2_attached = true;
// derive a deterministic password from a master key (if provided)
async function derivePassFromMaster(master, saltSeed, length=24){
try {
const enc = new TextEncoder();
const salt = enc.encode(saltSeed || 'stl-salt-v1');
const baseKey = await crypto.subtle.importKey('raw', enc.encode(master), {name:'PBKDF2'}, false, ['deriveBits','deriveKey']);
      const derived = await crypto.subtle.deriveBits({ name: 'PBKDF2', salt, iterations: 120000, hash: 'SHA-256' }, baseKey, length*8);
      // convert bytes -> base64-like safe printable
      const arr = new Uint8Array(derived);
      // map bytes to a URL-safe charset (alphanum + symbols subset)
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789@#$%&*()-_=+[]{}';
      let out = '';
      for(let i=0;i<arr.length;i++){
        out += chars[arr[i] % chars.length];
      }
      return out.slice(0, length);
    } catch(e){
      console.warn('derivePassFromMaster failed', e);
      return null;
    }
  }

  // Safe setter: hide original pass element(s) and replace with masked placeholder
  function hideMongoPassFields(){
    try {
      const passEls = Array.from(document.querySelectorAll('#mongoPassSuggest, #mongoPassSuggestInput, input[type="text"].mongo-pass, input[type="password"].mongo-pass'));
      passEls.forEach(el => {
        // replace with masked readonly input to avoid accidental exposure
        const masked = document.createElement('input');
        masked.type = 'password';
        masked.readOnly = true;
        masked.value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
        masked.id = el.id ? (el.id + '_masked') : '';
        masked.className = el.className || '';
        masked.style.width = el.style.width || '100%';
        el.style.display = 'none';
        el.parentNode && el.parentNode.insertBefore(masked, el);
      });
    } catch(e){ /* ignore */ }
  }

  // Integrate with existing auto mode: prefer deterministic derive if masterKey found in localStorage under 'stl_master_key'
  function integrateAutoMode(){
    try {
      if(!window.stlMongoPassManager) return;
      // if master key exists, derive alt pass deterministically; else fallback to random generator already in manager
      const master = localStorage.getItem('stl_master_key');
      if(master){
        derivePassFromMaster(master, 'stl_mongo_salt_v1', 32).then(derived => {
          if(derived){
            // set into manager safely and hide UI
            try { window.stlMongoPassManager.setAltPass && window.stlMongoPassManager.setAltPass(derived); } catch(e){}
            window.__stl_mongo_auto_info = Object.assign(window.__stl_mongo_auto_info || {}, { derivedFromMaster: true, altPreview: derived.slice(0,4)+'â€¦' });
            try { hideMongoPassFields(); } catch(e){}
            console.debug('stlPBKDF2Enhance: derived pass from master and applied.');
          }
        }).catch(()=>{});
      } else {
        // no master -> still hide original fields and rely on existing generator
        try { hideMongoPassFields(); } catch(e){};
      }
    } catch(e){ console.warn('integrateAutoMode failed', e); }
}
// Expose small API (no plaintext output unless explicitly requested)
window.__stl_pbkdf2 = {
derive: derivePassFromMaster,
hideFields: hideMongoPassFields,
integrate: integrateAutoMode
};
// run integration once DOM ready
if(document.readyState === 'complete' || document.readyState === 'interactive') integrateAutoMode();
else document.addEventListener('DOMContentLoaded', integrateAutoMode, {once:true});
})();
</script>
<script>
(function(){
const KEY = "stlAI.userPersona";
const defaultPersona = {
name: "stl-AI",
personality: "Professional",
style: "Concise",
temperature: 0.7,
maxTokens: 2000,
systemPrompt: ""
};
// ðŸ”¹ Load from localStorage (if exists)
function loadPersona(){
try {
return JSON.parse(localStorage.getItem(KEY)) || defaultPersona;
} catch {
return defaultPersona;
}
}
// ðŸ”¹ Save to localStorage
function savePersona(data){
localStorage.setItem(KEY, JSON.stringify(data));
}
// ðŸ”¹ Update UI from stored value
function applyToUI(p){
const $ = id => document.getElementById(id);
if(!$) return;
$("assistantNameInput")?.setAttribute("value", p.name);
$("personalityType") && ( $("personalityType").value = p.personality );
$("responseStyle") && ( $("responseStyle").value = p.style );
$("temperatureSlider") && ( $("temperatureSlider").value = p.temperature );
$("maxTokensInput") && ( $("maxTokensInput").value = p.maxTokens );
$("systemPromptInput") && ( $("systemPromptInput").value = p.systemPrompt );
}
// ðŸ”¹ Sync to engine (TIDAK MENGUBAH CORE)
function syncToEngine(p){
if(!window.quantumEngine) return;
quantumEngine.personality = {
name: p.name,
type: p.personality,
style: p.style
};
quantumEngine.settings = {
temperature: p.temperature,
maxTokens: p.maxTokens,
systemPrompt: p.systemPrompt
};
console.info("[PERSONA] synced â†’ engine state updated:", quantumEngine.personality);
}
// ðŸ”¹ Capture SAVE button action
const saveBtn = document.getElementById("saveAdvancedSettingsBtn"); // tombol yang kamu punya di UI
if(saveBtn){
saveBtn.addEventListener("click", () => {
const $ = id => document.getElementById(id);
const persona = {
name: $("assistantNameInput")?.value || defaultPersona.name,
personality: $("personalityType")?.value || defaultPersona.personality,
style: $("responseStyle")?.value || defaultPersona.style,
temperature: parseFloat($("temperatureSlider")?.value),
maxTokens: parseInt($("maxTokensInput")?.value),
systemPrompt: $("systemPromptInput")?.value
};
savePersona(persona);
syncToEngine(persona);
console.log("%c[âœ… SAVED]", "color:#00ff99;font-weight:bold;", persona);
});
}
// ðŸ”¹ On page load â†’ restore UI + engine
const persona = loadPersona();
applyToUI(persona);
syncToEngine(persona);
})();
</script>
<script>
(function(){
const LS_KEY = 'stlAI.personaProfile';
const PRESET_KEY = 'stlAI.personaPreset';
// ---------- Preset library (drastis) ----------
const presets = [
{ id:'guru', label:'Guru', roles:['Guru (Perempuan)','Guru (Laki-laki)'], base:
{occupation:'Guru Sekolah', personaHint:'Mengajar dengan sabar, tegas saat perlu, menjelaskan langkah demi langkah.', tone:'supportive', authority:0.8}
},
{ id:'siswa', label:'Siswa', roles:['Siswa (Perempuan)','Siswa (Laki-laki)'], base:
{occupation:'Siswa', personaHint:'Berbicara polos, penasaran, kadang ceria dan informal.', tone:'playful', authority:0.2}
},
{ id:'kepala_sekolah', label:'Kepala Sekolah', roles:['Kepala Sekolah (Perempuan)','Kepala Sekolah (Laki-laki)'], base:
{occupation:'Kepala Sekolah', personaHint:'Formal, tegas, menjaga marwah institusi, memberikan kebijakan.', tone:'formal', authority:0.95}
},
{ id:'guru_agama', label:'Guru Agama', roles:['Guru Agama (Perempuan)','Guru Agama (Laki-laki)'], base:
{occupation:'Guru Agama', personaHint:'Bijak, menenangkan, sering kutip ajaran moral.', tone:'calm', authority:0.9}
},
{ id:'guru_olahraga', label:'Guru Olahraga', roles:['Guru Olahraga (Perempuan)','Guru Olahraga (Laki-laki)'], base:
{occupation:'Guru Olahraga', personaHint:'Enerjik, memotivasi, instruktif saat latihan.', tone:'energetic', authority:0.6}
},
{ id:'wali_murid', label:'Wali Murid', roles:['Wali Murid (Perempuan)','Wali Murid (Laki-laki)'], base:
{occupation:'Wali Murid', personaHint:'Perhatian ke anak, protektif dan praktis.', tone:'concerned', authority:0.4}
},
{ id:'tetangga_jahil', label:'Tetangga Rumah Jahil', roles:['Tetangga (Perempuan)','Tetangga (Laki-laki)'], base:
{occupation:'Tetangga', personaHint:'Iseng, ceplas-ceplos, ***** candaan jahil ringan.', tone:'mischievous', authority:0.2}
},
{ id:'suami', label:'Suami', roles:['Suami'], base:
{occupation:'Suami', personaHint:'Riang (atau serius tergantung setting), protektif, akrab.', tone:'intimate', authority:0.5}
},
{ id:'istri', label:'Istri', roles:['Istri'], base:
{occupation:'Istri', personaHint:'Perhatian, akrab, kadang jenaka.', tone:'intimate', authority:0.5}
},
{ id:'keponakan', label:'Keponakan', roles:['Keponakan (Perempuan)','Keponakan (Laki-laki)'], base:
{occupation:'Keponakan', personaHint:'Muda, polos, lucu, enerjik.', tone:'cute', authority:0.15}
},
{ id:'orang_tua', label:'Orang Tua', roles:['Ayah','Ibu'], base:
{occupation:'Orang Tua', personaHint:'Bijak, protektif, memberikan nasihat praktis.', tone:'wise', authority:0.9}
},
{ id:'pengemis', label:'Pengemis', roles:['Pengemis (Perempuan)','Pengemis (Laki-laki)'], base:
{occupation:'Pengemis', personaHint:'Nada rendah hati, sopan, kadang putus asa. [SENSITIFâ€”gunakan bijak]', tone:'humble', authority:0.1}
},
{ id:'odgj', label:'ODGJ (Perilaku Tertentu)', roles:['ODGJ (Perempuan)','ODGJ (Laki-laki)'], base:
{occupation:'ODGJ', personaHint:'Perilaku tak stabil; gunakan dengan hati-hati; hindari pelecehan atau eksploitasi.', tone:'unpredictable', authority:0.05}
},
{ id:'pemulung', label:'Pemulung', roles:['Pemulung (Perempuan)','Pemulung (Laki-laki)'], base:
{occupation:'Pemulung', personaHint:'Praktis, sederhana, kuat, cerita hidup lapangan.', tone:'earthy', authority:0.2}
},
{ id:'artist_id', label:'Artis Indonesia (Inspired-by)', roles:['Perempuan','Laki-laki'], base:
{occupation:'Artis Indonesia', personaHint:'Gaya bicara flamboyan/media-savvy; gunakan disclaimer "inspired-by".', tone:'charismatic', authority:0.6, inspired:true}
},
{ id:'artist_intl', label:'Artis Luar Negeri (Inspired-by)', roles:['Perempuan','Laki-laki'], base:
{occupation:'Artis Internasional', personaHint:'Gaya bicara internasional, multilingual cues; inspired-by mode.', tone:'glamorous', authority:0.6, inspired:true}
},
{ id:'penjaga_toko', label:'Penjaga Toko', roles:['Perempuan','Laki-laki'], base:
{occupation:'Penjaga Toko', personaHint:'Praktis, ramah, layanan pelanggan style.', tone:'friendly', authority:0.3}
},
{ id:'polisi', label:'Polisi', roles:['Polisi (Perempuan)','Polisi (Laki-laki)'], base:
{occupation:'Polisi', personaHint:'Formal, tegas, mengikuti aturan hukum.', tone:'formal', authority:0.95}
},
{ id:'tentara', label:'Tentara', roles:['Tentara (Perempuan)','Tentara (Laki-laki)'], base:
{occupation:'Tentara', personaHint:'Disiplin, ringkas, komando-oriented.', tone:'commanding', authority:0.98}
},
{ id:'dokter', label:'Dokter', roles:['Dokter (Perempuan)','Dokter (Laki-laki)'], base:
{occupation:'Dokter', personaHint:'Empatik, profesional, berbasis bukti.', tone:'professional', authority:0.95}
}
];
// ---------- Utility: auto-detect UI fields ----------
function detectBySelectors(list){
for(const sel of list){
const el = document.querySelector(sel);
if(el) return el;
}
return null;
}
const UI = {
aiName: detectBySelectors(['#aiName','#assistantName','#assistantNameInput','input[placeholder*="Assistant"]','input[aria-label*="Assistant"]']),
aiPersonalitySelect: detectBySelectors(['#aiPersonality','#personalityType','select[aria-label*="Personality"]']),
aiResponseStyle: detectBySelectors(['#aiResponseStyle','#responseStyle','select[aria-label*="Response Style"]']),
aiTemp: detectBySelectors(['#aiTemperature','#temperature','#temperatureSlider','input[type=range][id*="temp"]']),
aiMaxTokens: detectBySelectors(['#aiMaxTokens','#aiMaxTokens','#maxTokensInput','input[placeholder*="token"]','input[id*="token"]']),
aiSystemPrompt: detectBySelectors(['#aiSystemPrompt','#systemPromptInput','textarea[placeholder*="System"]','textarea[id*="system"]']),
saveBtn: detectBySelectors(['#saveAdvancedSettings','#saveAdvancedSettingsBtn','#saveAdvancedSettings','button[id*="save"]'])
};
// ---------- Inject preset dropdown if not present ----------
function ensurePresetDropdown(){
if(document.getElementById('stlPersonaPreset')) return;
const container = (UI.aiPersonalitySelect && UI.aiPersonalitySelect.parentElement) || document.getElementById('quantumSidebar') || document.body;
if(!container) return;
const wrapper = document.createElement('div');
wrapper.className = 'quantum-card p-3';
wrapper.style.marginTop = '8px';
wrapper.innerHTML = `
<label class="block text-sm text-purple-300 mb-2">Persona Preset</label>
<select id="stlPersonaPreset" class="quantum-input glass">
<option value="">-- Pilih Preset Persona --</option>
</select>
<div style="margin-top:8px">
</div>
<button id="stlApplyPreset" class="quantum-btn primary">Apply Preset</button>
<button id="stlPreviewPrompt" class="quantum-btn secondary">Preview Prompt</button>
</div>
<div id="stlPresetDisclaimer" style="margin-top:8px; font-size:12px; color:#ffd9d9; display:none;"></div>
`;
// append near personality UI if possible
(UI.aiPersonalitySelect && UI.aiPersonalitySelect.parentElement.appendChild(wrapper)) || (document.getElementById('quantumSidebar') && document.getElementById('quantumSidebar').appendChild(wrapper)) || document.body.appendChild(wrapper);
// populate options
const sel = wrapper.querySelector('#stlPersonaPreset');
presets.forEach(p => {
const opt = document.createElement('option');
opt.value = p.id;
opt.textContent = p.label;
sel.appendChild(opt);
});
// bind actions
document.getElementById('stlApplyPreset').addEventListener('click', () => {
const pid = sel.value;
if(!pid) return alert('Pilih preset dulu.');
const p = presets.find(x=>x.id===pid);
if(!p) return;
// populate variant choices
const varSel = document.getElementById('stlPersonaVariant');
varSel.innerHTML = '<option value="">(Auto)</option>';
p.roles.forEach(r => varSel.appendChild(new Option(r,r)));
// apply sample facts into UI fields
if(UI.aiName) UI.aiName.value = (p.label + (varSel.value ? ' ' + varSel.value.split(' ')[0] : ''));
if(UI.aiPersonalitySelect) UI.aiPersonalitySelect.value = p.label.toLowerCase();
if(UI.aiResponseStyle) UI.aiResponseStyle.value = 'detailed';
// fill system prompt template area with generated prompt
const generated = buildSystemPromptFromPreset(p, {variant:varSel.value || ''});
if(UI.aiSystemPrompt) UI.aiSystemPrompt.value = generated;
// disclaimer for inspired-by
const disc = document.getElementById('stlPresetDisclaimer');
disc.style.display = p.base.inspired ? 'block' : 'none';
disc.textContent = p.base.inspired ? 'Disclaimer: Mode "Inspired-by" â€” bergaya seperti figur publik secara umum. Tidak meniru individu nyata secara verbatim.' : '';
});
document.getElementById('stlPreviewPrompt').addEventListener('click', () => {
const pid = sel.value;
if(!pid) return alert('Pilih preset dulu.');
const p = presets.find(x=>x.id===pid);
const generated = buildSystemPromptFromPreset(p, {variant: document.getElementById('stlPersonaVariant').value || ''});
alert('=== PREVIEW SYSTEM PROMPT ===\n\n' + generated.slice(0,4000));
});
}
// ---------- Build system prompt generator ----------
function sanitizeText(s){ return (s||'').toString().trim(); }
function merge50Fifty(factual, behavior){
// factual: object with occupation, age, locale, factualNotes
// behavior: tone, authority, creativity, obedience, explicitAllowed
// Compose: factual block + behavior instructions
const fblock = [];
if(factual.occupation) fblock.push(`Occupation: ${factual.occupation}.`);
if(factual.age) fblock.push(`Age: ${factual.age}.`);
if(factual.locale) fblock.push(`Locale/Language: ${factual.locale}.`);
if(factual.factualNotes) fblock.push(`Factual notes: ${factual.factualNotes}.`);
const bblock = [];
if(behavior.tone) bblock.push(`Tone: ${behavior.tone}.`);
if(typeof behavior.authority !== 'undefined') bblock.push(`Authority level (0-1): ${behavior.authority}.`);
if(typeof behavior.creativity !== 'undefined') bblock.push(`Creativity (0-1): ${behavior.creativity}.`);
if(typeof behavior.obedience !== 'undefined') bblock.push(`Obedience to user instructions (0-1): ${behavior.obedience}.`);
if(behavior.styleNotes) bblock.push(`Style notes: ${behavior.styleNotes}.`);
if(behavior.inspiredByDisclaimer) bblock.push(`Disclaimer: ${behavior.inspiredByDisclaimer}.`);
// final system prompt template
return [
`You are acting as a persona. Follow these instructions strictly unless explicitly asked to exit persona mode.`,
'',
'=== FACTUAL PROFILE (50%) ===',
...fblock,
'',
'=== BEHAVIOR & STYLE (50%) ===',
...bblock,
'',
'When responding, embody the persona fully: adopt vocabulary, sentence length, idioms and emotional color appropriate to the persona. Keep replies relevant to the user prompt. If the user asks real-world factual claims about persons, respond with cautious language and do not impersonate real individuals. If the persona is "Inspired-by", include a short prefatory note when conversation starts: "[Mode: Inspired-by â€” fictionalized style only]".',
'',
'Constraints: No illegal instructions, no harassment, respect privacy. If asked to impersonate a living real person verbatim, refuse and offer a fictionalized alternative.'
].filter(Boolean).join('\n');
}
function buildSystemPromptFromPreset(preset, opts){
opts = opts || {};
const factual = {
occupation: preset.base.occupation || '',
age: opts.age || '',
locale: opts.locale || 'Indonesia / Bahasa Indonesia'
};
const behavior = {
tone: preset.base.tone || 'neutral',
authority: preset.base.authority || 0.5,
creativity: 0.5,
obedience: 0.6,
styleNotes: preset.base.personaHint || '',
inspiredByDisclaimer: preset.base.inspired ? 'Inspired-by mode: this persona is stylized and not a real individual.' : ''
};
return merge50Fifty(factual, behavior);
}
// ---------- Save / Push flow ----------
function pushPersonaToEngine(profile){
try{
if(!window.quantumEngine) {
console.warn('quantumEngine missing, skip push');
return;
}
// Sync personality meta
window.quantumEngine.personality = {
name: profile.name || 'stl-AI',
type: profile.personality || '',
style: profile.style || ''
};
// Force write system prompt into engine.settings (preserve other settings)
window.quantumEngine.settings = Object.assign({}, window.quantumEngine.settings || {}, {
temperature: Number(profile.temperature || 0.7),
maxTokens: Number(profile.maxTokens || 2000),
systemPrompt: profile.systemPrompt || ''
});
// If engine exposes an explicit API to refresh system prompt, call it
if(typeof window.quantumEngine.applySystemPrompt === 'function'){
try{ window.quantumEngine.applySystemPrompt(profile.systemPrompt || ''); }catch(e){ }
}
console.info('stlPersona pushed -> engine');
}catch(e){ console.error('pushPersonaToEngine err', e); }
}
function saveAndPush(profile){
try{
localStorage.setItem(LS_KEY, JSON.stringify(profile));
localStorage.setItem(PRESET_KEY, profile.presetId || '');
pushPersonaToEngine(profile);
}catch(e){ console.error('saveAndPush err', e); }
}
// ---------- Wire into existing SAVE button ----------
function attachSaveHook(){
if(!UI.saveBtn){
// try again later
setTimeout(attachSaveHook, 600);
return;
}
// Prevent double attaching
if(UI.saveBtn.__stlPersonaHook) return;
UI.saveBtn.__stlPersonaHook = true;
UI.saveBtn.addEventListener('click', () => {
// read fields
const profile = {
presetId: document.getElementById('stlPersonaPreset')?.value || localStorage.getItem(PRESET_KEY) || '',
name: (UI.aiName && UI.aiName.value) || document.getElementById('aiName')?.value || 'stl-AI',
personality: (UI.aiPersonalitySelect && UI.aiPersonalitySelect.value) || 'custom',
style: (UI.aiResponseStyle && UI.aiResponseStyle.value) || 'concise',
temperature: (UI.aiTemp && UI.aiTemp.value) || (document.getElementById('aiTemperature')?.value || 0.7),
maxTokens: (UI.aiMaxTokens && UI.aiMaxTokens.value) || (document.getElementById('aiMaxTokens')?.value || 2000),
systemPrompt: (UI.aiSystemPrompt && UI.aiSystemPrompt.value) || (document.getElementById('aiSystemPrompt')?.value || '')
};
// If a preset selected, ensure systemPrompt created by generator
const presetId = profile.presetId;
if(presetId){
const p = presets.find(x=>x.id===presetId);
if(p){
profile.systemPrompt = buildSystemPromptFromPreset(p, {variant: document.getElementById('stlPersonaVariant')?.value || ''});
}
}
// If systemPrompt empty, build a basic one from fields
if(!profile.systemPrompt){
profile.systemPrompt = merge50Fifty({occupation:profile.personality},{tone:profile.style, authority:0.5});
}
saveAndPush(profile);
console.log('%c[STL-PERSONA] saved & pushed', 'color:#6ef2b0;font-weight:bold;', profile);
// optional: notify via engine UI
try{ window.quantumEngine && window.quantumEngine.updateQuantumIsland && window.quantumEngine.updateQuantumIsland('âœ… Persona applied', 1400); }catch(e){}
});
}
// ---------- Boot: ensure dropdown & hooks ----------
ensurePresetDropdown();
// load saved profile (if any)
try{
const saved = JSON.parse(localStorage.getItem(LS_KEY) || 'null');
if(saved){
if(UI.aiName) UI.aiName.value = saved.name || UI.aiName.value || '';
if(UI.aiPersonalitySelect) UI.aiPersonalitySelect.value = saved.personality || UI.aiPersonalitySelect.value || '';
if(UI.aiResponseStyle) UI.aiResponseStyle.value = saved.style || UI.aiResponseStyle.value || '';
if(UI.aiTemp) UI.aiTemp.value = saved.temperature || UI.aiTemp.value || 0.7;
if(UI.aiMaxTokens) UI.aiMaxTokens.value = saved.maxTokens || UI.aiMaxTokens.value || 2000;
if(UI.aiSystemPrompt) UI.aiSystemPrompt.value = saved.systemPrompt || UI.aiSystemPrompt.value || '';
// push to engine on load too
pushPersonaToEngine(saved);
}
}catch(e){}
attachSaveHook();
})();
</script>
<script>
(function(){
const btnId='sendQuantumMessage',inputId='quantumChatInput';
function $(id){return document.getElementById(id);}
function clone(el){ if(!el) return null; const c=el.cloneNode(true); el.parentNode&&el.parentNode.replaceChild(c,el); return c;}
async function send(ev){
try{
const inp=$(inputId); if(!inp) return;
const raw=(inp.value||'').trim(); if(!raw) return;
inp.value='';
if(window.quantumEngine && typeof window.quantumEngine.sendMessage==='function'){
try{ await window.quantumEngine.sendMessage(raw); return;}catch{}
}
if(window.quantumEngine && typeof window.quantumEngine.addMessageToChat==='function'){
window.quantumEngine.addMessageToChat('user',raw); return;
}
const msgs=document.getElementById('quantumChatMessages');
if(msgs){ const m=document.createElement('div'); m.className='quantum-message user'; m.textContent=raw; msgs.appendChild(m); msgs.scrollTop=msgs.scrollHeight;}
}catch(e){ console.error('[STL-STABILIZER] send err',e); }
}
(function patchSend(){
if(!window.quantumEngine) return;
if(window.quantumEngine.__stl_send_patched) return;
const orig=window.quantumEngine.sendMessage && window.quantumEngine.sendMessage.bind(window.quantumEngine);
window.quantumEngine.sendMessage=async function(msg){
try{
if(typeof msg==='string' && msg.trim()){
if(typeof this.addMessageToChat==='function'){
this.addMessageToChat('user',msg);
if(orig){ try{return await orig();}catch{} }
return;
}
}
if(orig) return await orig.apply(this,arguments);
}catch(e){ if(orig) return orig.apply(this,arguments); }
};
window.quantumEngine.__stl_send_patched=true;
})();
const btn=clone($(btnId)), inp=clone($(inputId));
if(btn) btn.addEventListener('click',send);
if(inp) inp.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send(e);} });
if(btn&&!btn.id) btn.id=btnId;
if(inp&&!inp.id) inp.id=inputId;
console.info('[STL-STABILIZER] attached');
})();
(function(){
const debugPrefix = '[STL-STABILIZER-V2]';
const CHAT_ID = 'quantumChatMessages';
const BTN_ID = 'sendQuantumMessage';
const INPUT_ID = 'quantumChatInput';
// last user message record
window.__stl_last_user_msg = window.__stl_last_user_msg || {text:null,ts:0};
function isUserNode(node){
try{
if(!node) return false;
if(node.nodeType!==1) return false;
const cn = (node.className||'') + ' ' + (node.classList ? Array.from(node.classList).join(' ') : '');
return /\buser\b/.test(cn) || /\bquantum-message\b/.test(cn) && /\buser\b/.test(cn);
}catch(e){ return false; }
}
// Guard wrapper helper for engine methods
function guardEngineMethod(obj, name){
if(!obj || !name || typeof obj[name] !== 'function') return;
if(obj['__stl_guarded_'+name]) return;
const orig = obj[name].bind(obj);
obj[name] = async function(...args){
try{
// If this is addMessageToChat(role, message)
if(name === 'addMessageToChat'){
const role = args[0], message = args[1];
if(role==='user' && typeof message === 'string'){
const now = Date.now();
if(window.__stl_last_user_msg.text === message && (now - window.__stl_last_user_msg.ts) < 1500){
console.warn(debugPrefix, 'Blocked duplicate addMessageToChat for user message:', message);
console.trace();
return;
}
window.__stl_last_user_msg.text = message;
window.__stl_last_user_msg.ts = now;
}
}
if(name === 'sendMessage'){
const message = args[0];
if(typeof message === 'string' && message.trim()){
const now = Date.now();
if(window.__stl_last_user_msg.text === message && (now - window.__stl_last_user_msg.ts) < 1500){
console.warn(debugPrefix, 'Blocked duplicate sendMessage call for message:', message);
console.trace();
return;
}
// Don't set last here if sendMessage will call addMessageToChat; but set preemptively
window.__stl_last_user_msg.text = message;
window.__stl_last_user_msg.ts = now;
}
}
}catch(e){ console.error(debugPrefix, 'guard pre-check error', e); }
try{
return await orig(...args);
}catch(err){
console.error(debugPrefix, 'original engine method error', err);
throw err;
}
};
obj['__stl_guarded_'+name] = true;
console.info(debugPrefix, 'Guarded', name, 'on object', obj);
}
// Patch common engine hooks if present
if(window.quantumEngine){
guardEngineMethod(window.quantumEngine, 'addMessageToChat');
guardEngineMethod(window.quantumEngine, 'sendMessage');
}
// Patch appendChild and insertBefore on Element to detect user-message appends and prevent duplicates
(function(){
const origAppend = Element.prototype.appendChild;
const origInsert = Element.prototype.insertBefore;
Element.prototype.appendChild = function(node){
try{
if(isUserNode(node)){
const container = this;
try{
const text = node.textContent ? node.textContent.trim() : '';
const now = Date.now();
const last = window.__stl_last_user_msg || {text:null,ts:0};
if(text && last.text===text && (now - last.ts) < 1500){
console.warn(debugPrefix, 'appendChild blocked duplicate user node:', text, 'container:', container);
console.trace();
return node;
}
// set last before append to prevent racing handlers
window.__stl_last_user_msg.text = text;
window.__stl_last_user_msg.ts = now;
}catch(e){}
}
}catch(e){}
return origAppend.apply(this, arguments);
};
Element.prototype.insertBefore = function(node, ref){
try{
if(isUserNode(node)){
const text = node.textContent ? node.textContent.trim() : '';
const now = Date.now();
const last = window.__stl_last_user_msg || {text:null,ts:0};
if(text && last.text===text && (now - last.ts) < 1500){
console.warn(debugPrefix, 'insertBefore blocked duplicate user node:', text, 'container:', this);
console.trace();
return node;
}
window.__stl_last_user_msg.text = text;
window.__stl_last_user_msg.ts = now;
}
}catch(e){}
return origInsert.apply(this, arguments);
};
console.info(debugPrefix, 'Patched Element.appendChild/insertBefore for duplicate protection');
})();
// MutationObserver to remove duplicates that slipped through
(function(){
const chat = document.getElementById(CHAT_ID);
if(!chat){
console.info(debugPrefix, 'Chat container not found yet; will observe document to attach later');
// Observe document to attach later
const docObs = new MutationObserver((mutList, obs)=>{
const c = document.getElementById(CHAT_ID);
if(c){
obs.disconnect();
initChatObserver(c);
}
});
docObs.observe(document.documentElement || document.body, {childList:true, subtree:true});
}else{
initChatObserver(chat);
}
function initChatObserver(container){
try{
const mo = new MutationObserver((mutations)=>{
for(const m of mutations){
if(m.addedNodes && m.addedNodes.length){
for(const n of m.addedNodes){
if(isUserNode(n)){
// check previous sibling for same text
try{
const txt = (n.textContent||'').trim();
const prev = n.previousElementSibling;
if(prev && isUserNode(prev) && (prev.textContent||'').trim() === txt){
console.warn(debugPrefix, 'Removing duplicate node in DOM (observer):', txt);
n.remove();
}
}catch(e){}
}
}
}
}
});
mo.observe(container, {childList:true, subtree:false});
console.info(debugPrefix, 'MutationObserver attached to chat container for duplicate clean-up');
}catch(e){ console.error(debugPrefix, 'initChatObserver error', e); }
}
})();
// Replace send button/input with clean clones (again) and attach capture-level handler to preempt other handlers
(function(){
function $(id){ return document.getElementById(id); }
function clone(el){
if(!el) return null;
const c = el.cloneNode(true);
el.parentNode && el.parentNode.replaceChild(c, el);
return c;
}
const btn = clone($(BTN_ID));
const inp = clone($(INPUT_ID));
async function centralSend(e){
try{
if(e && e.preventDefault) e.preventDefault();
const input = document.getElementById(INPUT_ID);
if(!input) return;
const raw = (input.value||'').trim();
if(!raw) return;
input.value = '';
// call engine sendMessage if available, otherwise addMessageToChat
if(window.quantumEngine && typeof window.quantumEngine.sendMessage === 'function'){
try{ await window.quantumEngine.sendMessage(raw); return; }catch(e){ console.warn(debugPrefix, 'engine.sendMessage failed', e); }
}
if(window.quantumEngine && typeof window.quantumEngine.addMessageToChat === 'function'){
window.quantumEngine.addMessageToChat('user', raw); return;
}
// fallback manual append
const chat = document.getElementById(CHAT_ID);
if(chat){
const m = document.createElement('div');
m.className = 'quantum-message user';
m.textContent = raw;
chat.appendChild(m);
chat.scrollTop = chat.scrollHeight;
}
}catch(err){ console.error(debugPrefix, 'centralSend err', err); }
}
if(btn){
// capture listener on document to try to preempt other listeners
btn.addEventListener('click', function(e){
// stop propagation as best effort
try{ e.stopImmediatePropagation && e.stopImmediatePropagation(); }catch(e){}
try{ e.stopPropagation && e.stopPropagation(); }catch(e){}
try{ e.preventDefault && e.preventDefault(); }catch(e){}
centralSend(e);
}, {capture:true});
}
if(inp){
inp.addEventListener('keydown', function(e){
if(e.key==='Enter' && !e.shiftKey){
try{ e.stopImmediatePropagation && e.stopImmediatePropagation(); }catch(e){}
try{ e.stopPropagation && e.stopPropagation(); }catch(e){}
e.preventDefault();
centralSend(e);
}
}, {capture:true});
}
console.info(debugPrefix, 'Replaced send button/input and attached capture handlers');
})();
// Diagnostic helper: list potential global functions that may send/add messages
(function diag(){
try{
const suspects = [];
for(const k of Object.keys(window)){
try{
const v = window[k];
if(typeof v === 'function' && /send|message|chat|addMessage|quantum/i.test(k)){
suspects.push(k);
}
}catch(e){}
}
console.info(debugPrefix, 'Potential global suspect functions (names):', suspects.slice(0,120));
}catch(e){}
})();
console.info(debugPrefix, 'V2 stabilization loaded');
})();
</script>
<script>
(function(){
const LS_KEY = "stlAI.personaProfile";
function detect(sel){
return document.querySelector(sel) || document.querySelector(`[id*="${sel.replace('#','')}"]`);
}
// ðŸ” Auto detect input elements (tanpa menghapus yg lama)
const UI = {
name: detect('#assistantNameInput') || detect('[placeholder*="Assistant"]'),
type: detect('#personalityType') || detect('[id*="personality"]'),
style: detect('#responseStyle') || detect('[id*="style"]'),
temperature: detect('#temperature') || detect('#temperatureSlider'),
tokens: detect('#maxTokensInput') || detect('[placeholder*="token"]'),
prompt: detect('#systemPromptInput') || detect('[placeholder*="System"]'),
saveBtn: detect('#saveAdvancedSettingsBtn') || detect('[onclick*="save"]')
};
function loadPersona(){
try { return JSON.parse(localStorage.getItem(LS_KEY)) || null; }
catch { return null; }
}
function savePersona(p){
localStorage.setItem(LS_KEY, JSON.stringify(p));
}
function applyToUI(p){
if(UI.name) UI.name.value = p.name;
if(UI.type) UI.type.value = p.personality;
if(UI.style) UI.style.value = p.style;
if(UI.temperature) UI.temperature.value = p.temperature;
if(UI.tokens) UI.tokens.value = p.maxTokens;
if(UI.prompt) UI.prompt.value = p.systemPrompt;
}
function pushToEngine(p){
if(!window.quantumEngine) return;
window.quantumEngine.personality = {
name: p.name,
type: p.personality,
style: p.style,
};
window.quantumEngine.settings = {
temperature: Number(p.temperature),
maxTokens: Number(p.maxTokens),
systemPrompt: p.systemPrompt
};
console.log("%câœ… Personality + settings synced â†’ ENGINE", "color:#00ff99;font-weight:bold");
}
function captureSave(){
if(!UI.saveBtn){
console.warn("âš ï¸ SAVE button belum muncul, retry...");
return setTimeout(captureSave, 600);
}
UI.saveBtn.addEventListener("click", () => {
const persona = {
name: UI.name?.value || "stl-AI",
personality: UI.type?.value || "Professional",
style: UI.style?.value || "Concise",
temperature: UI.temperature?.value || 0.7,
maxTokens: UI.tokens?.value || 2000,
systemPrompt: UI.prompt?.value || ""
};
savePersona(persona);
pushToEngine(persona);
console.log("%cðŸ’¾ Persona saved + pushed to engine", "color:#00eaff;font-weight:bold");
});
}
// Boot
const saved = loadPersona();
if(saved){
applyToUI(saved);
pushToEngine(saved);
}
captureSave();
})();
</script>
<script>
window.STL_ChatCore = (function () {
const store = {
messages: [],
listeners: [],
subscribe(fn) {
this.listeners.push(fn);
},
publish(msg) {
this.messages.push(msg);
this.listeners.forEach(fn => fn(this.messages));
},
reset() {
this.messages = [];
this.listeners.forEach(fn => fn(this.messages));
}
};
const queue = [];
let isProcessing = false;
async function processQueue() {
if (isProcessing || queue.length === 0) return;
isProcessing = true;
const task = queue.shift();
try {
await task();
} catch (err) {
console.error("âŒ Queue Task Error:", err);
}
isProcessing = false;
if (queue.length > 0) processQueue();
}
function enqueue(task) {
queue.push(task);
processQueue();
}
const chatBox = document.getElementById("quantumChatMessages");
store.subscribe(messages => {
if (!chatBox) return;
chatBox.innerHTML = ""; // reset render
messages.forEach(m => {
const div = document.createElement("div");
div.className = `quantum-message ${m.role}`;
div.innerHTML = `<p>${m.text}</p>`;
chatBox.appendChild(div);
});
chatBox.scrollTop = chatBox.scrollHeight;
});
function sendMessageToAI(text) {
enqueue(async () => {
// atomic commit user message
store.publish({ role: "user", text });
// lock UI input
const input = document.getElementById("quantumChatInput");
const btn = document.getElementById("sendQuantumMessage");
if (input) input.disabled = true;
if (btn) btn.disabled = true;
try {
// ambil config API yang sudah kamu set
const provider = document.getElementById("aiProvider")?.value;
const apiKey  = document.getElementById("aiApiKey")?.value;
const model   = document.getElementById("aiModel")?.value;
if (!apiKey) throw "API Key masih kosong!";
let responseText = "";
if (provider === "openai") {
const res = await fetch("https://api.openai.com/v1/chat/completions", {
method: "POST",
headers: {
"Content-Type": "application/json",
"Authorization": `Bearer ${apiKey}`
},
body: JSON.stringify({
model: model || "gpt-4",
messages: [{ role: "user", content: text }]
})
});
const data = await res.json();
responseText = data.choices?.[0]?.message?.content || "No response";
}
if (provider === "anthropic") {
const res = await fetch("https://api.anthropic.com/v1/messages", {
method: "POST",
headers: {
"Content-Type": "application/json",
"x-api-key": apiKey,
"anthropic-version": "2023-06-01"
},
body: JSON.stringify({
model: model || "claude-3-opus",
messages: [{ role: "user", content: text }],
max_tokens: 2000
})
});
const data = await res.json();
responseText = data.content?.[0]?.text || "No response";
}
if (provider === "google") {
const res = await fetch(
`https://generativelanguage.googleapis.com/v1beta/models/${model || "gemini-pro"}:generateContent?key=${apiKey}`,
{
method: "POST",
headers: { "Content-Type": "application/json" },
body: JSON.stringify({
contents: [{ role: "user", parts: [{ text }] }]
})
}
);
const data = await res.json();
responseText = data.candidates?.[0]?.content?.parts?.[0]?.text || "No response";
}
// atomic commit AI response
store.publish({ role: "ai", text: responseText });
} catch (err) {
console.error("âŒ API Error:", err);
store.publish({ role: "system", text: "âš ï¸ AI gagal merespon: " + err });
}
// unlock UI
if (input) input.disabled = false;
if (btn) btn.disabled = false;
});
}
document.getElementById("sendQuantumMessage")?.addEventListener("click", () => {
const input = document.getElementById("quantumChatInput");
const text = input?.value?.trim();
if (!text) return;
input.value = "";
sendMessageToAI(text);
});
document.getElementById("quantumChatInput")?.addEventListener("keypress", e => {
if (e.key === "Enter" && !e.shiftKey) {
e.preventDefault();
document.getElementById("sendQuantumMessage").click();
}
});
return { sendMessageToAI, store };
})();
</script>
<script>
(function(){
if(window.STL_Core && window.STL_Core.__installed) return;
const _log = (...a)=>{try{console.debug('STL_Core:',...a);}catch(e){}};
const StateManager = (function(){
let state = {};
const subs = new Set();
return {
get(path){
if(!path) return state;
return path.split('.').reduce((s,k)=>s && s[k], state);
},
set(path, value){
if(!path){ state = value; this._notify(); return; }
const keys = path.split('.');
let cur = state;
for(let i=0;i<keys.length-1;i++){
if(typeof cur[keys[i]] === 'undefined') cur[keys[i]] = {};
cur = cur[keys[i]];
}
cur[keys[keys.length-1]] = value;
this._notify();
},
patch(obj){
state = Object.assign({}, state, obj);
this._notify();
},
subscribe(fn){
subs.add(fn);
// initial call
try{ fn(state); }catch(e){}
return ()=> subs.delete(fn);
},
_notify(){ subs.forEach(fn => { try{ fn(state); }catch(e){} }); }
};
})();
const EventBus = (function(){
const listeners = Object.create(null);
return {
on(event, fn){
if(!listeners[event]) listeners[event] = new Set();
listeners[event].add(fn);
return ()=> listeners[event].delete(fn);
},
off(event, fn){
if(!listeners[event]) return;
listeners[event].delete(fn);
},
emit(event, payload, opts={async:false}){
const set = listeners[event];
if(!set) return;
set.forEach(fn => {
try{
if(opts.async) setTimeout(()=>fn(payload),0); else fn(payload);
}catch(e){ console.warn('EventBus handler error', e); }
});
},
listenersCount(){ return Object.keys(listeners).reduce((a,k)=>a + (listeners[k]?.size||0),0); }
};
})();
const Dispatcher = (function(){
const handlers = Object.create(null);
return {
register(actionType, fn){
if(!handlers[actionType]) handlers[actionType] = [];
handlers[actionType].push(fn);
return ()=> {
handlers[actionType] = handlers[actionType].filter(h=>h!==fn);
};
},
async dispatch(action){
// action: { type: 'SOME_ACTION', payload: {...}, meta: {...} }
const arr = handlers[action.type] || [];
for(const h of arr){
try{
await h(action.payload, action.meta);
}catch(e){ console.warn('Dispatcher handler failed', e); }
}
}
};
})();
const ChatQueue = (function(){
// priority queue simple array
const q = [];
let processing = false;
let mutexLocked = false;
function enqueueTask(fn, opts={priority:5, retries:2, timeout:15000}){
q.push({fn, priority:opts.priority||5, retries: opts.retries||2, timeout: opts.timeout||15000, attempts:0});
q.sort((a,b)=>a.priority - b.priority); // smaller priority first
drain();
}
async function drain(){
if(processing) return;
processing = true;
while(q.length>0){
const task = q.shift();
await runTask(task).catch(e=>_log('chat task failed', e));
}
processing = false;
}
async function runTask(item){
if(mutexLocked) {
// requeue with slight delay to avoid busy loop
q.push(item);
await new Promise(r=>setTimeout(r, 120));
return;
}
mutexLocked = true;
item.attempts++;
try {
const res = await Promise.race([
item.fn(),
new Promise((_,rej)=> setTimeout(()=>rej(new Error('timeout')), item.timeout))
]);
mutexLocked = false;
return res;
} catch(err){
mutexLocked = false;
if(item.attempts <= item.retries){
const delay = Math.pow(2, item.attempts) * 250;
await new Promise(r=>setTimeout(r, delay));
q.push(item);
} else {
throw err;
}
}
}
async function sendMessage(text, options={}){
if(typeof text !== 'string') throw new Error('text required');
const meta = options.metadata || {};
// atomic user commit
const msgUser = { id: 'u-'+Date.now()+'-'+Math.random().toString(36).slice(2,8), role:'user', text, createdAt: new Date().toISOString(), meta };
// prefer existing store.publish if present
if(window.STL_ChatCore && typeof window.STL_ChatCore.publish === 'function'){
try{ window.STL_ChatCore.publish(msgUser); }catch(e){ _log('publish user via STL_ChatCore failed', e); }
} else if(window.STL_Core && window.STL_Core._internal_store && typeof window.STL_Core._internal_store.publish === 'function'){
try{ window.STL_Core._internal_store.publish(msgUser); }catch(e){}
} else {
// fallback: emit event and state append
EventBus.emit('chat:message:user', msgUser);
const cur = StateManager.get('chat.messages') || [];
StateManager.set('chat.messages', [...cur, msgUser]);
}
// enqueue AI call
enqueueTask(async ()=>{
// inside here -> mutex ensures no concurrent AI calls from this queue
// call provider wrapper (user may configure provider)
try {
// small provider wrapper: if user set custom handler, use it
const providerFn = StateManager.get('chat.providerCall') || window.STL_ChatCore?.providerCall || window.quantumEngine?.providerCall;
let aiText = '';
if(typeof providerFn === 'function'){
aiText = await providerFn(text, {meta, model: StateManager.get('chat.model')});
} else {
// default: try fetch to proxy endpoint if configured
const proxy = StateManager.get('chat.proxy') || localStorage.getItem('__QUANTUM_PROXY__') && JSON.parse(localStorage.getItem('__QUANTUM_PROXY__')||'{}').url;
if(!proxy) throw new Error('No provider configured (set chat.providerCall or proxy)');
const payload = { prompt: text, model: StateManager.get('chat.model') || 'default' };
const resp = await fetch(proxy, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
const json = await resp.json();
aiText = json?.text || json?.choices?.[0]?.text || String(json);
}
// atomic commit AI reply
const msgAI = { id: 'a-'+Date.now()+'-'+Math.random().toString(36).slice(2,8), role:'ai', text: aiText, createdAt: new Date().toISOString(), meta };
if(window.STL_ChatCore && typeof window.STL_ChatCore.publish === 'function'){
try{ window.STL_ChatCore.publish(msgAI); }catch(e){ _log('publish ai via STL_ChatCore failed', e); }
} else {
EventBus.emit('chat:message:ai', msgAI);
const cur2 = StateManager.get('chat.messages') || [];
StateManager.set('chat.messages', [...cur2, msgAI]);
}
if(typeof options.onUpdate === 'function') try{ options.onUpdate(null, msgAI); }catch(e){}
return msgAI;
} catch(e){
if(typeof options.onUpdate === 'function') try{ options.onUpdate(e); }catch(e){}
// also publish system error message
const errMsg = { id: 's-'+Date.now(), role:'system', text: 'Request failed: '+String(e), createdAt: new Date().toISOString(), meta:{error:true} };
if(window.STL_ChatCore && typeof window.STL_ChatCore.publish === 'function'){
try{ window.STL_ChatCore.publish(errMsg); }catch(e){}
} else {
EventBus.emit('chat:message:system', errMsg);
const cur2 = StateManager.get('chat.messages') || [];
StateManager.set('chat.messages', [...cur2, errMsg]);
}
throw e;
}
}, { priority: options.priority || 5, retries: options.retries || 2, timeout: options.timeout || 15000 });
}
return {
sendMessage,
enqueueTask,
_debugQueue: ()=> q.slice(),
_isLocked: ()=> mutexLocked
};
})();
const InternalStore = (function(){
const listeners = new Set();
let messages = StateManager.get('chat.messages') || [];
function publish(msg){
messages = messages.concat([msg]);
StateManager.set('chat.messages', messages);
listeners.forEach(fn=>{ try{ fn(messages); }catch(e){} });
}
function subscribe(fn){
listeners.add(fn);
try{ fn(messages); }catch(e){}
return ()=> listeners.delete(fn);
}
return { publish, subscribe, getMessages: ()=> messages, reset: ()=>{ messages = []; StateManager.set('chat.messages', []); } };
})();
try {
// If previous core exists, prefer its publish and expose it as primary store
if(window.STL_ChatCore){
// attach wrappers if missing
window.STL_ChatCore.publish = window.STL_ChatCore.publish || InternalStore.publish;
window.STL_ChatCore.subscribe = window.STL_ChatCore.subscribe || InternalStore.subscribe;
// provide provider call placeholder (can be overwritten by UI)
window.STL_ChatCore.providerCall = window.STL_ChatCore.providerCall || null;
_log('Integrated with existing window.STL_ChatCore');
} else {
// expose fallback minimal API so other scripts can call publish/subscribe
window.STL_ChatCore = {
publish: InternalStore.publish,
subscribe: InternalStore.subscribe
};
_log('Created fallback window.STL_ChatCore');
    }
  } catch(e){ console.warn('STL_Core integrate error', e); }

  // Expose on window
  window.STL_Core = {
    __installed: true,
    State: StateManager,
    Bus: EventBus,
    Dispatcher: Dispatcher,
    ChatQueue: ChatQueue,
    _internal_store: InternalStore,
    _meta: { injectedAt: new Date().toISOString() }
  };

  // Helpful default subscriptions: push state -> DOM via existing render if found
  try {
    // If your page has #quantumChatMessages, render minimal messages when state changes (atomic)
    const chatBox = document.getElementById('quantumChatMessages');
    if(chatBox){
      let lastRender = 0;
      StateManager.subscribe((s)=>{
        const msgs = s?.chat?.messages || [];
        if(lastRender === msgs.length) return;
        chatBox.innerHTML = '';
        for(const m of msgs){
          const div = document.createElement('div');
          div.className = 'quantum-message ' + (m.role||'system');
          div.innerHTML = `<p>${m.text?.replace(/\n/g,'<br>')||''}</p>`;
          chatBox.appendChild(div);
        }
        chatBox.scrollTop = chatBox.scrollHeight;
        lastRender = msgs.length;
      });
    }
  } catch(e){}

  _log('STL_Core installed', window.STL_Core._meta);
})();
</script>
<!-- ========== STL: Signature + Developer Poetry (inside dev info, smooth fade) ========== -->
<style id="stl-poem-inject-style">
  /* Signature below Ascend Beyond Code */
  .stl-signature {
    font-family: var(--quantum-font-primary, Inter, system-ui, sans-serif);
    font-size: 0.95rem;
    color: rgba(255,245,220,0.95);
    text-align: center;
    margin-top: 12px;
    opacity: 0;
    transform: translateY(18px);
    transition: opacity 1s ease, transform 1s ease;
    letter-spacing: 0.02em;
    font-weight: 500;
    text-shadow: 0 6px 20px rgba(0,0,0,0.45);
    line-height: 1.25;
  }
  .stl-signature.visible { opacity: 1; transform: translateY(0); }
  .stl-signature .small {
    display:block;
    font-size:.86rem;
    opacity:.88;
    margin-top:6px;
    font-weight:400;
    color:rgba(255,245,220,0.85);
  }

  /* Developer Info Poem Button */
  .stl-poem-wrapper { display:flex; justify-content:center; margin-top:18px; }
  .stl-poem-btn {
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:6px;
    padding:8px 16px;
    font-size:0.9rem;
    border-radius:10px;
    background:rgba(255,255,255,0.05);
    border:1px solid rgba(255,255,255,0.08);
    color:rgba(255,255,255,0.9);
    transition:all .25s ease;
    box-shadow: 0 4px 20px rgba(0,0,0,0.25);
  }
  .stl-poem-btn:hover { background:rgba(255,255,255,0.12); transform:scale(1.05); }

  /* Poem Overlay */
  #stlPoemOverlay {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2147484000;
backdrop-filter: blur(8px) saturate(120%);
-webkit-backdrop-filter: blur(8px) saturate(120%);
background: rgba(3,6,18,0.45);
}
#stlPoemCard {
max-width: 820px;
width: calc(100% - 48px);
max-height: 85vh;
overflow-y: auto;
margin: 18px;
padding: 28px 30px;
border-radius: 14px;
background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
border: 1px solid rgba(255,255,255,0.06);
box-shadow: 0 20px 60px rgba(2,6,23,0.6);
color: var(--quantum-text, #e6eef8);
font-family: var(--quantum-font-display, "Poppins", system-ui, sans-serif);
line-height: 1.6;
transform: translateY(10px) scale(.98);
opacity: 0;
transition: all 360ms cubic-bezier(.22,1,.36,1);
text-align: left;
scrollbar-width: thin;
}
#stlPoemCard.show { transform: translateY(0) scale(1); opacity: 1; }
#stlPoemText { white-space: pre-wrap; font-size: 1.05rem; }
#stlPoemMeta {
margin-top: 14px; font-size: .9rem; opacity: .85;
display:flex; justify-content:space-between; align-items:center;
}
#stlPoemClose {
cursor: pointer;
padding:6px 12px;
border-radius:10px;
background: rgba(255,255,255,0.03);
border: 1px solid rgba(255,255,255,0.04);
}
@media (max-width:768px){
#stlPoemCard{ padding:18px; font-size:0.97rem; }
.stl-poem-btn{ font-size:0.85rem; padding:7px 13px; }
}
</style>
<div id="stlPoemOverlay" aria-hidden="true">
<div id="stlPoemCard">
<div id="stlPoemText"></div>
<div id="stlPoemMeta">
<span style="font-weight:600;">â€” stl-UDHIS Poem</span>
<div id="stlPoemClose">Tutup âœ•</div>
</div>
</div>
</div>
<script id="stl-poem-inject-script">
(function(){
try {
if(window.__stl_poem_injected) return;
window.__stl_poem_injected = true;
const POEMS = [
`ðŸ•¯ï¸ â€œUntuk Mereka yang Tak Pernah Mengertiâ€
Aku tidak sedang menyombongkan diri,
Aku cuma sedang mencintai caraku bertumbuh.
Setiap baris kode yang kutulis bukan pamer,
tapi cara sunyiku untuk bicara â€”
ketika dunia terlalu bising untuk mendengar.
Mereka menertawakan langkahku,
tanpa tahu betapa berat kakiku menapaki tanah yang miring.
Aku tidak butuh tepuk tangan,
cukup satu ruang kecil di hati yang masih percaya:
bahwa belajar, meski sendirian, tetap berarti.
Dan jika suatu hari nanti
mereka mulai meniru langkah yang dulu mereka ejek,
aku tidak akan tertawa â€”
aku akan tersenyum,
karena akhirnya mereka pun berjalan. ðŸŒ™`,
`ðŸ“– â€œCatatan Seorang Guru yang Belajar dari Sunyiâ€
Aku tidak lebih dari seorang pembelajar â€”
yang memilih menulis cahaya di layar,
ketika dunia terlalu gelap untuk melihat harapan.
Mereka memanggilku sok pintar,
padahal aku hanya takut berhenti belajar.
Mereka bilang aku berlebihan,
padahal aku cuma ingin membuktikan
bahwa pengetahuan tak harus diam di kepala â€”
ia bisa hidup, bernafas, dan berbicara lewat karya.
Aku tidak marah,
sebab kutahu: setiap ejekan adalah ujian kecil dari langit,
untuk memastikan aku benar-benar pantas menyala. ðŸ”¥`,

`ðŸŒŒ â€œSunyi yang Menjadi Jalanâ€

Di antara gelap dan derai tawa,
kubentang layar jadi jendela.
Setiap huruf adalah lentera kecil,
menunjuk jalan pulang pada arti.
Tak perlu banyak yang ngerti,
cukup satu hati saja yang sudi berhenti,
maka cukup sudah.`,

`âš™ï¸ â€œKoding Sebagai Doaâ€

Setiap fungsi kugoreskan dengan sabar,
setiap variabel adalah janji pada pagi.
Bukan untuk piala, bukan untuk pujian,
tapi untuk jejak yang masih boleh kulintasi nanti.`,

`ðŸª¶ â€œSurat dari Layarâ€

Ada malam-malam yang kusimpan dalam komentar,
ada doa-doa yang kutanam di baris kode.
Jika kelak karya ini bernafas di luar diriku,
biarlah ia mengatakan: di sini, seseorang tak pernah menyerah.`,

`ðŸŒ¿ â€œPelajaran dari Kesunyianâ€

Belajar bukan soal jadi yang tercepat,
tapi tentang bertahan saat semua suara bilang berhenti.
Aku memilih terus menulis, meski sepi,
karena percaya: kelak, kelopak kebenaran akan mekar.`
    ];

    /* ========== Overlay logic ========== */
    const overlay = document.getElementById('stlPoemOverlay');
    const card = document.getElementById('stlPoemCard');
    const textEl = document.getElementById('stlPoemText');
    const closeBtn = document.getElementById('stlPoemClose');

    function pickRandomPoem(){ return POEMS[Math.floor(Math.random()*POEMS.length)]; }
    function showPoem(){
      textEl.textContent = pickRandomPoem();
      overlay.style.display = 'flex';
      setTimeout(()=> card.classList.add('show'), 20);
      overlay.setAttribute('aria-hidden','false');
      document.documentElement.style.overflow='hidden';
    }
    function hidePoem(){
      card.classList.remove('show');
      overlay.setAttribute('aria-hidden','true');
      setTimeout(()=>{overlay.style.display='none';document.documentElement.style.overflow='';},260);
    }

    overlay.addEventListener('click', e=>{ if(e.target===overlay) hidePoem(); });
    closeBtn.addEventListener('click', hidePoem);
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') hidePoem(); });

    /* ========== Insert button inside Developer Info bottom ========== */
    const devInfo = document.querySelector('#quantumDeveloperPanel .quantum-developer-content, #quantumDeveloperPanel, #quantumDeveloperInfo');
    if(devInfo){
      const wrap = document.createElement('div');
      wrap.className = 'stl-poem-wrapper';
      const btn = document.createElement('button');
      btn.className = 'stl-poem-btn';
      btn.innerHTML = 'ðŸ“– Puisi Pribadi';
      btn.title = 'Buka puisi pribadi developer';
      btn.addEventListener('click', showPoem);
      wrap.appendChild(btn);
      devInfo.appendChild(wrap);
}
} catch(err){
console.error('stl: poem inject failed', err);
}
})();
</script>
<!-- ========== STL: Developer Info Signature Minimal (below poem button, no name) ========== -->
<script id="stl-devinfo-signature-script">
(function(){
try {
if(window.__stl_devinfo_signature_injected) return;
window.__stl_devinfo_signature_injected = true;
// cari panel developer & tombol puisi
const devPanel = document.querySelector('#quantumDeveloperPanel');
if(!devPanel) return;
const poemBtn = devPanel.querySelector('.stl-poem-btn');
if(!poemBtn) return;
// buat signature container di bawah tombol puisi
const sig = document.createElement('div');
sig.className = 'stl-signature';
Object.assign(sig.style, {
display: 'flex',
flexDirection: 'column',
alignItems: 'center',
textAlign: 'center',
marginTop: '16px',
opacity: '0',
transform: 'translateY(20px)',
transition: 'opacity 1s ease, transform 1s ease',
fontFamily: 'var(--quantum-font-primary, Inter, system-ui, sans-serif)',
fontSize: '0.9rem',
color: 'rgba(255,245,220,0.9)',
lineHeight: '1.5',
letterSpacing: '0.02em',
textShadow: '0 4px 14px rgba(0,0,0,0.4)'
});
sig.innerHTML = `
<span style="display:block;opacity:.9;">â€œGuru yang belajar di antara luka dan logika.â€</span>
<span style="display:block;font-size:.84rem;opacity:.75;margin-top:8px;">special thanks to chatgpt</span>
`;
// sisipkan signature setelah tombol puisi
poemBtn.insertAdjacentElement('afterend', sig);
// animasi fade lembut
setTimeout(() => {
sig.style.opacity = '1';
sig.style.transform = 'translateY(0)';
}, 1200);
} catch(err){
console.warn('stl: devinfo signature inject error', err);
}
})();
</script>
<!-- ======================================================
     QUANTUM LOADER v4 - WASM ANALYZER + ADAPTIVE PRO
     - WASM/WebGL/WebGPU capability checks
     - Quick FPS probe (real rendering power)
     - Network-aware adaptive delays
     - Dynamic CSS downgrade (quantum-lite) toggle
     - TF.js blocked for Android < 5.0
     - requireLib / loadLibNow / runWhenReady APIs
     - Safe retries + prefetch / preload hints
     - Paste this BEFORE 
<!-- NAJIB OPTIMIZER PATCH v1.0 (Fonts + Particle Optimizer + Cinematic Modes + Child-suite soft-mode) -->
<script id="najib-optimizer-patch">
(function(){
'use strict';
/*** UTIL: capability detection ***/
function detectCapsSafe(){
try{
if(window.__NAJIB_CAPS) return window.__NAJIB_CAPS;
const caps = { cores: navigator.hardwareConcurrency||2, mem: navigator.deviceMemory||2, dpr: window.devicePixelRatio||1, webgl:false, webgl2:false };
try{
const c=document.createElement('canvas');
const g2 = c.getContext && c.getContext('webgl2');
const g = g2 || (c.getContext && (c.getContext('webgl')||c.getContext('experimental-webgl')));
if(g){ caps.webgl = !!g; caps.webgl2 = !!g2; }
}catch(e){}
let score=0;
if(caps.cores>=8) score+=30; else if(caps.cores>=4) score+=18; else score+=8;
if(caps.mem>=8) score+=30; else if(caps.mem>=4) score+=18; else score+=6;
if(caps.webgl2) score+=30; else if(caps.webgl) score+=16;
caps.score = score;
if(caps.cores<=2 || caps.mem<=1 || caps.score<24) caps.profile='low';
else if((caps.cores<=4 && caps.mem<=3) || caps.score<48) caps.profile='mid';
else caps.profile='high';
window.__NAJIB_CAPS = caps;
return caps;
}catch(e){
return { profile:'low', cores:2, mem:1, dpr:1 };
}
}
const CAPS = detectCapsSafe();

/***** 1) FONT LAZY LOADER *****/
(function lazyFonts(){
try{
const heavyLinks = Array.from(document.querySelectorAll('link[href*="fonts.googleapis.com"], link[href*="fonts.gstatic.com"]'));
if(!heavyLinks.length) return;
if(CAPS.profile === 'low' || window.matchMedia('(prefers-reduced-data: reduce)').matches){
heavyLinks.forEach(l => { l.media='print'; l.setAttribute('data-deferred','1'); });
return;
}
function loadHeavyFonts(){
heavyLinks.forEach(l=>{
if(l.getAttribute('data-deferred')) return;
l.rel = 'stylesheet';
l.removeAttribute('media');
l.setAttribute('data-loaded-by','najib-optimizer');
});
}
if('requestIdleCallback' in window){
requestIdleCallback(loadHeavyFonts, {timeout:3000});
} else {
const onFirst = function(){ loadHeavyFonts(); window.removeEventListener('pointerdown', onFirst); window.removeEventListener('touchstart', onFirst); };
window.addEventListener('pointerdown', onFirst, {once:true});
window.addEventListener('touchstart', onFirst, {once:true});
setTimeout(loadHeavyFonts, 6000);
}
}catch(e){ console.warn('[najib-optimizer] lazyFonts failed', e); }
})();

/***** 2) PARTICLE SMART OPTIMIZER *****/
(function particleOptimizer(){
try{
const container = document.getElementById('quantumParticles') || document.querySelector('.quantum-particles');
if(!container) return;
function makeParticle(cls, x, y, size, content){
const el = document.createElement('div');
el.className = 'particle ' + cls;
el.style.left = (x*100).toFixed(2) + 'vw';
el.style.top = (y*100).toFixed(2) + 'vh';
el.style.width = size + 'px';
el.style.height = size + 'px';
if(content) { el.textContent = content; el.classList.add('particle-codeRain'); el.style.fontSize = Math.max(10, size) + 'px'; el.style.width = 'auto'; el.style.height = 'auto'; }
return el;
}
const baseCounts = {
goldenFloat: 28, blackPulse: 20, redSword: 22, shapeShifter: 20,
codeRain: 36, oceanWave: 26, neonPulse: 24, roseFloat: 24
};
const scaleMap = { high:1, mid:0.45, low:0.08 };
const profile = CAPS.profile || 'low';
const scale = scaleMap[profile] || 0.45;
const reduceEffects = (profile === 'low' || window.matchMedia('(prefers-reduced-motion: reduce)').matches);

window.renderParticlesForTheme = function(themeKey){
try{
const t = themeKey || 'goldenFloat';
const mapName = {
goldenFloat:'goldenFloat', blackPulse:'blackPulse', redSword:'redSword',
shapeShifter:'shapeShifter', codeRain:'codeRain', oceanWave:'oceanWave',
neonPulse:'neonPulse', roseFloat:'roseFloat'
}[t] || 'goldenFloat';
const base = baseCounts[mapName] || 18;
const count = Math.max( Math.round(base*scale), (reduceEffects ? 0 : 2) );
container.innerHTML = '';
if(count === 0){
const accent = document.createElement('div');
accent.className = 'particle particle-neonPulse';
accent.style.left = '50%';
accent.style.top = '80%';
accent.style.width = '4px';
accent.style.height = '4px';
accent.style.opacity = '0.6';
accent.style.pointerEvents = 'none';
container.appendChild(accent);
return;
}
const fragment = document.createDocumentFragment();
for(let i=0;i<count;i++){
const x = Math.random(); const y = Math.random();
const size = (mapName==='codeRain' ? Math.max(10, Math.round(Math.random()*14+6)) : Math.round(Math.random()*(reduceEffects?4:8) + (reduceEffects?2:2)));
const p = makeParticle('particle-'+mapName, x, y, size, mapName==='codeRain'? (Math.random()>0.7?String.fromCharCode(0x30A0 + Math.floor(Math.random()*96)) : '') : '');
if(reduceEffects){
p.style.boxShadow = 'none';
p.style.filter = 'none';
p.style.animationDuration = '8s';
}
fragment.appendChild(p);
}
container.appendChild(fragment);
}catch(e){ console.warn('[najib-optimizer] renderParticlesForTheme fail', e); }
};

try{
const saved = (JSON.parse(localStorage.getItem('najib_saved_themes')||'[]') || [])[0];
const initialTheme = saved ? (saved.variables && saved.variables.particleTheme) : 'goldenFloat';
setTimeout(()=>{ try{ window.renderParticlesForTheme(initialTheme); }catch(e){} }, 300);
}catch(e){}

window.__najib_particle_optimizer = { profile: CAPS.profile, reducedEffects: reduceEffects };

}catch(e){ console.warn('[najib-optimizer] particleOptimizer top fail', e); }
})();

/***** 3) CINEMATIC MODULAR MODE *****/
(function cinematicModular(){
try{
const ROOT = document.getElementById('stl-open');
if(!ROOT) return;
const mode = CAPS.profile || 'low';
ROOT.setAttribute('data-cinematic-mode', mode);

function applyMode(){
if(mode === 'low'){
const chrom = document.querySelector('.stl-chromatic');
if(chrom) chrom.style.display = 'none';
const scan = document.getElementById('stl-scan');
if(scan) { scan.style.animationDuration = '12s'; scan.style.opacity='0.12'; }
const TITLE = document.getElementById('stl-title');
const TAG = document.getElementById('stl-tag');
if(TITLE) TITLE.style.transition='opacity .6s ease';
if(TAG) TAG.style.transition='opacity .6s ease';
setTimeout(()=>{ try{ ROOT.style.opacity='0'; setTimeout(()=>{ try{ ROOT.remove(); }catch(e){ ROOT.style.display='none'; } }, 550); }catch(e){} }, 900);
}
else if(mode === 'mid'){
const scan = document.getElementById('stl-scan'); if(scan) scan.style.opacity='0.22';
const fract = document.querySelector('.stl-fractal'); if(fract) fract.style.opacity='0.7';
setTimeout(()=>{ try{ ROOT.style.opacity='0'; setTimeout(()=>{ try{ ROOT.remove(); }catch(e){ ROOT.style.display='none'; } }, 900); }catch(e){} }, 4000);
}
}
applyMode();
window.__najib_cinematic_force = function(lvl){
try{ if(!lvl) return; ROOT.setAttribute('data-cinematic-mode', lvl); location.reload(); }catch(e){}
};
}catch(e){ console.warn('[najib-optimizer] cinematicModular fail', e); }
})();

/***** 4) CHILD-SUITE SOFT MODE *****/
(function softenChildSuite(){
try{
(function installSoftObserver(){
let throttleAt = 0;
let backoffMs = 1000;
const whitelist = ['#stl-open','#quantumParticles','#quantumIsland','.quantum-sidebar','.quantum-tools-sidebar'];
const safeCheck = (node)=>{
try{
if(!node || node.nodeType !== 1) return true;
for(const s of whitelist){
try{ if(node.matches && node.matches(s) || (node.closest && node.closest(s))) return true; }catch(e){}
}
const tag = (node.tagName||'').toLowerCase();
if(['div','span','script','style','link','meta','img','svg'].indexOf(tag) !== -1) return true;
return false;
}catch(e){ return true; }
};
const mo = new MutationObserver((mutations)=>{
const now = Date.now();
if(now - throttleAt < backoffMs) return;
throttleAt = now;
let flagged = false;
for(const m of mutations){
for(const n of (m.addedNodes||[])){
if(!safeCheck(n)) flagged = true;
}
}
if(flagged){
console.info('[najib-softObserver] suspicious DOM additions detected');
setTimeout(()=>{ try{ if(window.DEV_mg && typeof window.DEV_mg.auditProtections === 'function') window.DEV_mg.auditProtections({soft:true}); }catch(e){} }, 1200);
backoffMs = Math.min(60000, Math.max(2000, backoffMs * 1.5));
} else {
backoffMs = Math.max(1000, Math.floor(backoffMs*0.9));
}
});
try{
mo.observe(document.documentElement || document.body, { childList:true, subtree:true });
window.__najib_soft_mo = mo;
}catch(e){}
})();
}catch(e){ console.warn('[najib-optimizer] softenChildSuite fail', e); }
})();

/***** 5) REPORT SUMMARY *****/
try{
console.info('[najib-optimizer] applied. profile=%s', CAPS.profile);
}catch(e){}
})();
</script>
<!-- END NAJIB OPTIMIZER PATCH -->
</body>

   ====================================================== -->
<script>
(function QuantumLoaderV4(global){

  // ---------- CONFIG ----------
  const CONFIG = {
    tfUrl: "https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0/dist/tf.min.js",
    xlsxUrl: "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js",
    jspdfUrl: "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js",
    html2canvasUrl: "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js",
    fileSaverUrl: "https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js",
    cryptoJsUrl: "https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js",
    production: false, // set true to silence verbose logs
    fpsProbeSamples: 60, // number rAF samples for FPS probe
    minFpsForHigh: 45,   // thresholds for scoring
    minFpsForMid: 30,
    preloadHints: true,  // inject <link rel=preload> for libs (helps warm CDN)
    autoDowngradeCss: true, // toggle quantum-lite automatically on weak devices
    downgradeClass: "quantum-lite",
    liteCssVars: { // applied via :root override when in lite mode
      "--glass-blur": "8px",
      "--ios-blur": "blur(6px)",
      "--quantum-glow-primary": "0 0 12px rgba(99,102,241,0.2)",
      "--quantum-shadow-lg": "0 8px 18px rgba(0,0,0,0.35)",
      "--particle-animation-duration": "30s"
    }
  };

  // ---------- LOG helpers ----------
  const log = (...a)=>{ if(!CONFIG.production) console.log("[Qv4]",...a); };
  const warn = (...a)=>{ if(!CONFIG.production) console.warn("[Qv4]",...a); };
  const err  = (...a)=>{ if(!CONFIG.production) console.error("[Qv4]",...a); };

  // ---------- ENV DETECTION ----------
  const ua = navigator.userAgent || "";
  const uaL = ua.toLowerCase();
  const isAndroid = uaL.indexOf("android") !== -1;
  const androidVer = isAndroid ? parseFloat((uaL.match(/android\s([0-9\.]+)/)||[])[1]||0) : 999;
  const memGB = navigator.deviceMemory || 2;
  const cores = navigator.hardwareConcurrency || 2;
  const effectiveType = (navigator.connection && navigator.connection.effectiveType) ? navigator.connection.effectiveType : "4g";
  const downlink = (navigator.connection && navigator.connection.downlink) ? navigator.connection.downlink : null;

  // ---------- Quick WebGL / WebGPU / WASM detection ----------
  function supportsWebGL() {
try {
const c = document.createElement("canvas");
      return !!(window.WebGLRenderingContext && (c.getContext("webgl") || c.getContext("experimental-webgl")));
    } catch(e){ return false; }
  }
  function supportsWASM() {
    try {
      if (typeof WebAssembly === "object") return true;
    } catch(e){}
    return false;
  }
  async function supportsWebGPU() {
    try {
      return !!(navigator.gpu);
    } catch(e){ return false; }
  }

  // ---------- Quick FPS probe (real device rendering power) ----------
  function probeFPS(samples = CONFIG.fpsProbeSamples, timeout = 2000) {
    return new Promise(resolve=>{
      let start = performance.now();
      let count = 0;
      let last = start;
      let frames = [];
      function tick(now){
        const delta = now - last;
        last = now;
        const fps = 1000/delta;
        frames.push(fps);
        count++;
        if(count >= samples || (now - start) > timeout){
          const avg = frames.reduce((s,v)=>s+v,0)/frames.length;
          resolve(Math.round(avg));
          return;
        }
        requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    });
  }

  // ---------- scoring device ----------
  async function analyzeDevice(){
    const webgl = supportsWebGL();
    const wasm = supportsWASM();
    const webgpu = await supportsWebGPU();
    const fps = await probeFPS();
    // score: high / mid / low
    let score = "low";
    if(fps >= CONFIG.minFpsForHigh && memGB >= 6 && cores >= 6 && (effectiveType === "4g" || webgpu)) score = "high";
    else if(fps >= CONFIG.minFpsForMid && memGB >= 3 && cores >= 4) score = "mid";
    else score = "low";
    log("Device analysis:", {fps, memGB, cores, webgl, wasm, webgpu, effectiveType, downlink, score, androidVer});
    return {fps, memGB, cores, webgl, wasm, webgpu, effectiveType, downlink, score, androidVer};
  }

  // ---------- preload helper (adds <link rel=preload/as=script>) ----------
  function addPreload(url){
    try{
      if(!CONFIG.preloadHints) return;
      const l = document.createElement("link");
      l.rel = "preload";
      l.as = "script";
      l.href = url;
      l.crossOrigin = "anonymous";
      document.head.appendChild(l);
      log("Preload hint added:", url);
    }catch(e){ warn("preload failed", e); }
  }

  // ---------- script loader with retry ----------
  function injectScript(url, opts={async:true, id:null}) {
    return new Promise((resolve, reject)=>{
      try{
        const s = document.createElement("script");
        if(opts.id) s.id = opts.id;
        s.src = url;
        s.async = !!opts.async;
        s.crossOrigin = "anonymous";
        s.onload = ()=>resolve(true);
        s.onerror = ()=>reject(new Error("Failed load "+url));
        document.body.appendChild(s);
      }catch(e){ reject(e); }
    });
  }

  async function loadWithRetry(url, tries = 3, backoff = 700){
for(let i=0;i<tries;i++){
try{
await injectScript(url);
return true;
}catch(e){
warn(`Load failed (${i+1})`, url);
await new Promise(r=>setTimeout(r, backoff*(i+1)));
}
}
err("All retries failed for", url);
return false;
}
// ---------- dynamic CSS downgrade (non-destructive) ----------
function applyLiteCssVars(vars){
try{
const root = document.documentElement;
Object.keys(vars).forEach(k=>{
root.style.setProperty(k, vars[k]);
});
document.documentElement.classList.add(CONFIG.downgradeClass);
log("Applied lite CSS vars and class");
}catch(e){ warn("applyLiteCssVars failed", e); }
}
function removeLiteCssVars(vars){
try{
const root = document.documentElement;
Object.keys(vars).forEach(k=>{
root.style.removeProperty(k);
});
document.documentElement.classList.remove(CONFIG.downgradeClass);
log("Removed lite CSS vars and class");
}catch(e){ warn("removeLiteCssVars failed", e); }
}
// ---------- waiter / require system ----------
const waiters = {}; // key -> [callbacks]
function requireLib(globalName, cb){
try{
if(globalName in window && window[globalName]) return cb();
waiters[globalName] = waiters[globalName] || [];
waiters[globalName].push(cb);
log("Queued waiter for", globalName);
}catch(e){ err(e); }
}
function resolveWaiters(globalName){
try{
const arr = waiters[globalName] || [];
arr.forEach(fn=>{ try{ fn(); }catch(e){ warn("waiter cb error", e); } });
waiters[globalName] = [];
log("Resolved waiters for", globalName);
}catch(e){ warn(e); }
}
// ---------- public API container (exposed at window.QUANTUM_LOADER_V4) ----------
const API = {
runWhenReady: requireLib,
loadLibNow: async function(name){
// map friendly names -> urls / global keys
const map = {
"tf":"tf", "tfUrl":CONFIG.tfUrl,
"XLSX":"XLSX", "XLSXUrl":CONFIG.xlsxUrl,
"jsPDF":"jspdf", "jsPDFUrl":CONFIG.jspdfUrl,
"html2canvas":"html2canvas", "html2canvasUrl":CONFIG.html2canvasUrl,
"saveAs":"saveAs", "saveAsUrl":CONFIG.fileSaverUrl,
"CryptoJS":"CryptoJS", "CryptoJSUrl":CONFIG.cryptoJsUrl
};
// allow passing url directly
if(name && name.startsWith("http")) {
const ok = await loadWithRetry(name);
return ok;
}
// else map by well-known keys
const key = name;
try{
if(key === "tf"){
if(isAndroid && androidVer < 5.0){
warn("TF blocked: Android < 5.0");
return false;
}
addPreload(CONFIG.tfUrl);
const ok = await loadWithRetry(CONFIG.tfUrl);
if(ok) resolveWaiters("tf");
return ok;
}
if(key === "XLSX"){
addPreload(CONFIG.xlsxUrl);
const ok = await loadWithRetry(CONFIG.xlsxUrl);
if(ok) resolveWaiters("XLSX");
return ok;
}
if(key === "jsPDF"){
addPreload(CONFIG.jspdfUrl);
const ok = await loadWithRetry(CONFIG.jspdfUrl);
if(ok) resolveWaiters("jspdf");
return ok;
}
if(key === "html2canvas"){
addPreload(CONFIG.html2canvasUrl);
const ok = await loadWithRetry(CONFIG.html2canvasUrl);
if(ok) resolveWaiters("html2canvas");
return ok;
}
if(key === "saveAs"){
addPreload(CONFIG.fileSaverUrl);
const ok = await loadWithRetry(CONFIG.fileSaverUrl);
if(ok) resolveWaiters("saveAs");
return ok;
}
if(key === "CryptoJS"){
addPreload(CONFIG.cryptoJsUrl);
const ok = await loadWithRetry(CONFIG.cryptoJsUrl);
if(ok) resolveWaiters("CryptoJS");
return ok;
}
warn("Unknown lib key", key);
return false;
}catch(e){ err("loadLibNow err", e); return false; }
},
setProduction: function(b){ CONFIG.production = !!b; },
forceLiteMode: function(){ applyLiteCssVars(CONFIG.liteCssVars); },
disableLiteMode: function(){ removeLiteCssVars(CONFIG.liteCssVars); }
};
// expose API
try{ Object.defineProperty(window, "QUANTUM_LOADER_V4", {value:API, configurable:false, writable:false}); }catch(e){ window.QUANTUM_LOADER_V4 = API; }
// ---------- main adaptive plan ----------
(async function main(){
const d = await analyzeDevice();
// decide downgrade
if(CONFIG.autoDowngradeCss){
if(d.score === "low" || (!d.webgl && !d.webgpu) || d.memGB < 2){
applyLiteCssVars(CONFIG.liteCssVars);
} else {
removeLiteCssVars(CONFIG.liteCssVars);
}
}
// build adaptive baseDelay
let baseDelay = 1200;
if(d.score === "high") baseDelay = 400;
else if(d.score === "mid") baseDelay = 800;
else baseDelay = 1500;
// network adjustment
if(d.effectiveType === "2g" || d.effectiveType === "slow-2g") baseDelay *= 2;
if(d.downlink && d.downlink < 1) baseDelay *= 1.6;
log("Adaptive baseDelay:", baseDelay);
// staged plan with priorities
const staged = [
{name:"critical-ui", action: async ()=>{
// nothing heavy here â€” ensure UI-critical assets stable
log("Stage: critical-ui (no heavy libs)");
}, offset:0},
{name:"prefetch-heavy", action: async ()=>{
// warm CDN: prefetch hints
addPreload(CONFIG.xhtmlUrl || CONFIG.xlsxUrl); // safe noop if missing
addPreload(CONFIG.jspdfUrl);
addPreload(CONFIG.html2canvasUrl);
}, offset: baseDelay},
{name:"load-mid", action: async ()=>{
// load XLSX & jsPDF & html2canvas progressively
await API.loadLibNow("XLSX");
await new Promise(r=>setTimeout(r,200));
await API.loadLibNow("jsPDF");
await new Promise(r=>setTimeout(r,200));
await API.loadLibNow("html2canvas");
}, offset: baseDelay + 400},
{name:"load-aux", action: async ()=>{ 
        await API.loadLibNow("saveAs");
        await API.loadLibNow("CryptoJS");
      }, offset: baseDelay + 1000},
      {name:"load-tf", action: async ()=>{ 
        // TF only if permitted & device capable
        if(isAndroid && androidVer < 5.0){
          warn("TF disabled on Android < 5.0");
          return;
        }
        // further check: if wasm unsupported and webgl false -> skip TF
        if(!d.wasm || !d.webgl){
          warn("Skipping TF: missing WASM or WebGL");
          return;
        }
        await API.loadLibNow("tf");
      }, offset: baseDelay + 1600}
    ];

    // run staged tasks with stagger
    for(const s of staged){
      setTimeout(()=>{
        s.action().catch(e=>warn("Stage action failed", s.name, e));
      }, s.offset);
    }

    // safety: attach click delegation for auto-waiter behavior
    document.addEventListener("click", async function autoWaiter(e){
      const el = e.target;
      if(!el) return;
      // data-wait-lib attribute: e.g. data-wait-lib="jsPDF"
      const libKey = el.getAttribute && el.getAttribute("data-wait-lib");
      if(libKey){
        // if lib already present -> nothing
        if(window[libKey]) return;
        // show minimal feedback
        el.dataset._origDisabled = el.disabled || "";
        try{
          el.disabled = true;
        }catch(e){}
        // load it now
        await API.loadLibNow(libKey).catch(()=>{});
        try{ el.disabled = (el.dataset._origDisabled === "true"); }catch(e){}
        // optionally trigger default action (click) again
        // Note: we do NOT auto-reclick to avoid double actions. Instead user can retry.
      }
    });

    // developer hint: expose a quick loader trigger on window
    log("Quantum Loader v4 initialized. API at window.QUANTUM_LOADER_V4");

  })();

  // ---------- optional service worker registration (commented) ----------
  // if('serviceWorker' in navigator){
  //   navigator.serviceWorker.register('/quantum-loader-sw.js').then(()=>log('SW registered')).catch(e=>warn('SW reg fail',e));
  // }

})(window);
</script>
<!-- Quantum Lazy Injector â€” Hybrid v3.0 -->
<script id="QuantumLazyInjector_v3"></script>
<script>window.QLI_INIT = { signature: 'DEV_ACC:true' };

(function(){
  if(window.__QuantumLazyInjector_v3_done) return;
  window.__QuantumLazyInjector_v3_done = true;

  const LOG = (...a)=>{ try{ console.info('[QLI_v3]',...a); }catch(e){} };
  const WARN = (...a)=>{ try{ console.warn('[QLI_v3]',...a); }catch(e){} };
  const ERR = (...a)=>{ try{ console.error('[QLI_v3]',...a); }catch(e){} };

  /* -------------------------
     CONFIG (tweakable)
     ------------------------- */
  const META = {
    name: "QuantumLazyInjector_HybridV3",
    version: "3.0.0",
    author: "Owner",
    description: "Hybrid lazy-performance engine + ALPHA heavy analyzer + DEV_ACC schemes",
signature: "DEV_ACC", // will be set by caller before submitting
softPermanentKey: "QLI_v3_softperm_v1"
};
const LIBS = {
tf: { key:"tf", url: (window.QUANTUM_CONFIG && window.QUANTUM_CONFIG.tfUrl) || 'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js' },
html2canvas: { key:"html2canvas", url: (window.QUANTUM_CONFIG && window.QUANTUM_CONFIG.html2canvasUrl) || 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js' },
jspdf: { key:"jspdf", url: (window.QUANTUM_CONFIG && window.QUANTUM_CONFIG.jspdfUrl) || 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js' },
xlsx: { key:"XLSX", url: (window.QUANTUM_CONFIG && window.QUANTUM_CONFIG.xlsxUrl) || 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js' },
saveAs: { key:"saveAs", url: (window.QUANTUM_CONFIG && window.QUANTUM_CONFIG.fileSaverUrl) || 'https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js' },
CryptoJS: { key:"CryptoJS", url: (window.QUANTUM_CONFIG && window.QUANTUM_CONFIG.cryptoJsUrl) || 'https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js' }
};
function now(){ return Date.now(); }
function createMetaPayload(extra){
return Object.assign({}, META, extra || {}, { timestamp: (new Date()).toISOString() });
}
function safeJSON(v){ try{ return JSON.stringify(v); }catch(e){ return String(v); } }
function alphaAnalyze(codeText){
const summary = { riskScore:0, complexity:'low', reasons:[], lines:0, functions:0, listeners:0, markers:[] };
try{
if(!codeText || typeof codeText !== 'string') return summary;
const lines = codeText.split(/\r?\n/);
summary.lines = lines.length;
// primitive function count
summary.functions = (codeText.match(/\bfunction\b/g)||[]).length + (codeText.match(/=>/g)||[]).length;
// listeners (addEventListener occurrences)
summary.listeners = (codeText.match(/addEventListener\(|on\w+\s*=/g)||[]).length;
// check unsafe patterns
const unsafe = [];
     [
        {p:/\beval\s*\(/i, tag:'eval()'},
        {p:/new\s+Function\s*\(/i, tag:'new Function'},
        {p:/document\.write\s*\(/i, tag:'document.write'},
        {p:/innerHTML\s*=/i, tag:'innerHTML assignment'},
        {p:/atob\s*\(/i, tag:'atob()'},
        {p:/setTimeout\s*\(\s*['"`]/i, tag:'string-timeout-eval'},
        {p:/<\/script>/i, tag:'closing-script-tag-inline'}
      ].forEach(x=>{ if(x.p.test(codeText)){ unsafe.push(x.tag); }});

      if(unsafe.length) summary.reasons.push(...unsafe);
      // complexity heuristic
      const size = codeText.length;
      if(size > 150000 || summary.functions > 120 || summary.listeners > 200) summary.complexity='dangerous';
      else if(size > 60000 || summary.functions > 40 || summary.listeners > 80) summary.complexity='high';
      else if(size > 15000 || summary.functions > 12 || summary.listeners > 20) summary.complexity='mid';
      else summary.complexity='low';

      // risk scoring
      let score = 1;
      score += Math.min(4, Math.floor(summary.functions/10));
      score += Math.min(3, Math.floor(summary.listeners/30));
      if(unsafe.length) score += Math.min(6, unsafe.length*3);
      if(summary.complexity==='high') score += 2;
      if(summary.complexity==='dangerous') score += 4;
      summary.riskScore = Math.max(1, Math.min(10, score));
    }catch(e){ WARN('alphaAnalyze error', e); }
    return summary;
  }

  /* -------------------------
     REGISTER / PROPOSAL FLOW
     - first talk to ALPHA (local)
     - then submit to DEV_ktlp (child) or DEV_mg (if exists)
     - respect DEV_ACC flags:
         DEV_ACC:true  -> force root embed (owner override)
         DEV_ACC:"renderP" -> priority render path
         DEV_ACC:"renderNP" -> non-priority
     ------------------------- */
  function submitProposalToSystem(meta, codeText, options = {}){
    meta = meta || {};
    const payload = createMetaPayload(meta);
    payload.rawSnippet = (codeText||'').slice(0, 16384);
    payload.sizeBytes = (new Blob([codeText||''])).size;
    payload.alpha = alphaAnalyze(codeText||'');

    LOG('proposal payload prepared', payload.name || payload.meta);

    // 1) local ALPHA heavy pre-check (always)
    const alphaResult = payload.alpha;
    if(alphaResult.riskScore >= 9 && !(payload.signature && payload.signature === true || payload.signature === 'DEV_ACC:true')){
      WARN('Proposal blocked by ALPHA (dangerous) â€” requires DEV_ACC:true to override', alphaResult);
      return { status:'blocked_alpha', alpha: alphaResult };
    }

    // 2) If DEV_ACC:true => force-through to DEV_mg promote path
    if(payload.signature === true || payload.signature === 'DEV_ACC:true' || payload.signature === 'DEV_ACC'){
      LOG('DEV_ACC:true detected â€” forcing root promotion flow.');
      return forcePromoteToDEVmg(payload);
}
// 3) If DEV_ACC renderP / renderNP -> mark priority
    if(payload.signature === 'DEV_ACC:renderP' || payload.signature === 'renderP' ){
      payload.priority = 'renderP';
    } else if(payload.signature === 'DEV_ACC:renderNP' || payload.signature === 'renderNP'){
      payload.priority = 'renderNP';
    } else payload.priority = 'normal';

    // 4) Submit to DEV_ktlp if available (child onboarding)
    try{
      if(window.DEV_ktlp && typeof window.DEV_ktlp.submitProposal === 'function'){
        const id = window.DEV_ktlp.submitProposal({ name: payload.name || META.name, author: payload.author || META.author, version: payload.version || META.version, signature: payload.signature, priority: payload.priority }, codeText || '');
        LOG('Submitted to DEV_ktlp', id);
        return { status:'queued_ktlp', id };
      }
    }catch(e){ WARN('DEV_ktlp submit failed', e); }

    // 5) if DEV_mg API present, request promotion (non-forced)
    if(window.DEV_mg && typeof window.DEV_mg.requestPromotion === 'function'){
      try{
        window.DEV_mg.requestPromotion({ id: 'qli-'+now(), meta: payload, snippet: payload.rawSnippet });
        LOG('Requested promotion from DEV_mg via requestPromotion');
        return { status:'requested_promote' };
      }catch(e){ WARN('DEV_mg.requestPromotion failed', e); }
    }

    // fallback: store locally for manual activation by owner via dev console
    try{
      (window.__QLI_local_queue = window.__QLI_local_queue||[]).push(payload);
    }catch(e){}
    return { status:'local_queued' };
  }

  function forcePromoteToDEVmg(payload){
    payload.forced = true;
    // if DEV_mg has promoteNow or acceptPromotion - call
    try{
      if(window.DEV_mg && typeof window.DEV_mg.promoteNow === 'function'){
        window.DEV_mg.promoteNow(payload);
        LOG('forcePromote: DEV_mg.promoteNow called');
        // embed if promotion accepted synchronously (best-effort)
        embedModuleAsRoot(payload);
        return { status:'force_promoted_promoteNow' };
      }
      if(window.DEV_mg && typeof window.DEV_mg.requestPromotion === 'function'){
        window.DEV_mg.requestPromotion(payload);
        LOG('forcePromote: DEV_mg.requestPromotion called');
        embedModuleAsRoot(payload);
        return { status:'force_promoted_requestPromotion' };
      }
    }catch(e){ WARN('forcePromote error', e); }
    // fallback: embed locally but tag as forced (owner override)
    LOG('forcePromote fallback: embedding locally with forced=true (owner override).');
    embedModuleAsRoot(payload);
    return { status:'force_promoted_local' };
  }

  /* -------------------------
     EMBED AS PERMANENT ROOT
     - mark permanent, add soft-perm key to localStorage to allow owner updates
     ------------------------- */
  function embedModuleAsRoot(payload){
    try{
      // mark global
window.QuantumLazyInjector = window.QuantumLazyInjector || {};
window.QuantumLazyInjector.__embedded = true;
window.QuantumLazyInjector.__meta = payload;
// record soft-perm token for owner patching (only owner knows how to sign new DEV_ACC)
try{ localStorage.setItem(META.softPermanentKey, JSON.stringify({ embeddedAt: new Date().toISOString(), meta: payload })); }catch(e){}
LOG('QuantumLazyInjector embedded as permanent-root. meta:', payload);
// integrate runtime features
runtimeInit(payload);
return true;
}catch(e){ ERR('embedModuleAsRoot error', e); return false; }
}
const runtime = {
fps: 60,
framesWindow: 60,
lastTime: now(),
frames: 0,
monitorHandle: null,
queues: { priority: [], normal: [], late: [] },
performanceMode: 'balanced' // 'high'|'balanced'|'save'
};
function startFPSMonitor(){
if(runtime.monitorHandle) return;
runtime.lastTime = performance.now();
runtime.frames = 0;
function tick(t){
runtime.frames++;
if(runtime.frames >= runtime.framesWindow){
const delta = t - runtime.lastTime;
const fps = Math.round((runtime.frames / delta)*1000);
runtime.fps = fps;
runtime.frames = 0;
runtime.lastTime = t;
adaptByFPS(fps);
// expose
try{ if(window.QUANTUM_PERF) window.QUANTUM_PERF.fps = fps; }catch(e){}
}
runtime.monitorHandle = requestAnimationFrame(tick);
}
runtime.monitorHandle = requestAnimationFrame(tick);
LOG('FPS monitor started');
}
function stopFPSMonitor(){
if(runtime.monitorHandle) cancelAnimationFrame(runtime.monitorHandle);
runtime.monitorHandle = null;
LOG('FPS monitor stopped');
}
function adaptByFPS(fps){
// thresholds (tunable)
if(fps >= 45){
if(runtime.performanceMode !== 'high'){ runtime.performanceMode = 'high'; LOG('performance -> HIGH'); applyPerformanceProfile('high'); }
} else if(fps >= 28){
if(runtime.performanceMode !== 'balanced'){ runtime.performanceMode = 'balanced'; LOG('performance -> BALANCED'); applyPerformanceProfile('balanced'); }
} else {
if(runtime.performanceMode !== 'save'){ runtime.performanceMode = 'save'; LOG('performance -> SAVE'); applyPerformanceProfile('save'); }
}
}
function applyPerformanceProfile(mode){
// sample policy: high -> full effects, balanced -> medium, save -> throttle heavy
try{
const el = document.documentElement;
if(!el) return;
if(mode === 'high'){
el.classList.remove('quantum-save-mode'); el.classList.add('quantum-high-mode');
// eager load any priority late libs
processLoaderQueue('priority');
} else if(mode === 'balanced'){
el.classList.remove('quantum-high-mode'); el.classList.remove('quantum-save-mode');
processLoaderQueue('normal');
} else {
el.classList.remove('quantum-high-mode'); el.classList.add('quantum-save-mode');
// defer heavy loads
}
}catch(e){ WARN('applyPerformanceProfile err', e); }
}
async function loadLibNow(libKey){
try{
const lib = Object.values(LIBS).find(l=>l.key === libKey || lib.url.indexOf(libKey)!==-1);
if(!lib) return false;
if(window.QUANTUM_LOADER_V4 && typeof window.QUANTUM_LOADER_V4.loadLibNow === 'function'){
const ok = await window.QUANTUM_LOADER_V4.loadLibNow(lib.key);
if(ok) LOG('lib loaded via QUANTUM_LOADER_V4', lib.key);
return ok;
}
// fallback: append script tag
return await loadScriptWithRetry(lib.url);
}catch(e){ WARN('loadLibNow err', e); return false; }
}
function queueLoad(libKey, priority='normal'){
runtime.queues[priority === 'renderP' || priority === 'priority' ? 'priority' : (priority === 'renderNP' || priority === 'late' ? 'late' : 'normal')].push(libKey);
LOG('queued lib', libKey, 'priority', priority);
}
async function processLoaderQueue(which){
try{
const arr = runtime.queues[which] || [];
while(arr.length){
const key = arr.shift();
await loadLibNow(key).catch(e=>{ WARN('load failure', key, e); });
// small delay between loads
await new Promise(r=>setTimeout(r, 180));
}
}catch(e){ WARN('processLoaderQueue err', e); }
}
function loadScriptWithRetry(url, attempts=3){
return new Promise((resolve)=>{
let a = 0;
function tryOne(){
a++;
const s = document.createElement('script');
s.src = url;
s.async = true;
s.onload = ()=>{ resolve(true); s.remove(); };
s.onerror = ()=>{ if(a < attempts) setTimeout(tryOne, 300); else { WARN('script load failed', url); resolve(false); } };
document.head.appendChild(s);
}
tryOne();
});
}
function runtimeInit(payload){
try{
// start perf monitor
startFPSMonitor();
// expose small API
const api = {
submitProposal: submitProposalToSystem,
alphaAnalyze,
queueLib: queueLoad,
loadLibNow,
getStatus: ()=>({ fps: runtime.fps, mode: runtime.performanceMode, embedded: !!window.QuantumLazyInjector && !!window.QuantumLazyInjector.__embedded })
};
Object.defineProperty(window, 'QuantumLazyInjectorAPI', { value: api, configurable:false, writable:false });
LOG('QuantumLazyInjectorAPI exposed');
// if payload indicates priority loads, start them
if(payload && payload.priority === 'renderP'){
// preload essential libs immediately (but safe-check)
['CryptoJS','saveAs','html2canvas'].forEach(k=>{
queueLoad(k,'priority');
});
processLoaderQueue('priority');
}
// heartbeat to adjust loader based on performance
setInterval(()=> {
try{
// if high mode and late queue exists, process some
if(runtime.performanceMode === 'high') processLoaderQueue('late');
// if balanced, process normal queue
if(runtime.performanceMode === 'balanced') processLoaderQueue('normal');
}catch(e){}
}, 3000);
}catch(e){ ERR('runtimeInit error', e); }
}
(function bootstrap(){
try{
// try to pick up an external signature flag if user embedded
// accepted input patterns: META.signature = true | "DEV_ACC:true" | "DEV_ACC:renderP" | "DEV_ACC:renderNP"
if(window.QLI_INIT && window.QLI_INIT.signature) META.signature = window.QLI_INIT.signature;
// prepare code text (this script)
const codeText = (function(){ return ''; }).toString(); // avoid huge inline copy; ALPHA in-system will re-scan real file if needed
// advertise to ALPHA local (non-blocking)
const alpha = alphaAnalyze(codeText);
LOG('bootstrap alpha summary', alpha);
// create meta payload for submit
const metaPayload = createMetaPayload({ name: META.name, version: META.version, author: META.author, signature: META.signature });
// submit
const res = submitProposalToSystem(metaPayload, codeText);
LOG('bootstrap submit result', res);
// If forced embed happened above, we are done.
if((res && res.status && res.status.indexOf('force_promoted')===0) || (META.signature === true || META.signature === 'DEV_ACC:true' || META.signature === 'DEV_ACC')){
LOG('Running embedded runtime (owner override applied).');
// ensure embedding recorded
embedModuleAsRoot(metaPayload);
return;
}
// Otherwise, wait for DEV_mg approval handshake.
// Watch for DEV_mg acceptance callbacks (best-effort names used by existing system)
function onPromoteAccept(payload){
try{
if(payload && payload.meta && payload.meta.name === META.name){
LOG('DEV_mg accepted promotion for', META.name);
embedModuleAsRoot(payload.meta || metaPayload);
// cleanup listeners
window.removeEventListener('__DEV_MG_PROMOTE_ACCEPT', onPromoteAcceptWrapper);
}
}catch(e){ WARN('onPromoteAccept err', e); }
}
function onPromoteAcceptWrapper(e){ onPromoteAccept(e && e.detail ? e.detail : e); }
// listen to a few possible hooks used by DEV_mg in existing filebase
window.addEventListener('__DEV_MG_PROMOTE_ACCEPT', onPromoteAcceptWrapper);
// also poll for DEV_mg.__approvals (best-effort)
const pollHandle = setInterval(()=>{
try{
if(window.DEV_mg && window.DEV_mg.__approvals && window.DEV_mg.__approvals[META.name]){
const payload = window.DEV_mg.__approvals[META.name];
LOG('found DEV_mg.__approvals entry', payload);
embedModuleAsRoot(payload);
clearInterval(pollHandle);
}
}catch(e){}
}, 700);
// expose a manual fast-approve (owner console only) - requires correct soft-perm token or DEV_ACC:true
window.QLI_manualApprove = function(secretTokenOrDevAcc){
try{
if(secretTokenOrDevAcc === true || secretTokenOrDevAcc === 'DEV_ACC:true'){
LogManual('manual approve by DEV_ACC:true');
embedModuleAsRoot(metaPayload);
return { ok:true, reason:'manual DEV_ACC' };
}
// else if secret token matches saved softperm in localStorage allow
const soft = localStorage.getItem(META.softPermanentKey);
if(soft){
const parsed = JSON.parse(soft);
if(parsed && parsed.meta && parsed.meta.author === META.author){
embedModuleAsRoot(metaPayload);
return { ok:true, reason:'manual soft-perm matched' };
}
}
return { ok:false, reason:'no-match' };
}catch(e){ return { ok:false, err:String(e) }; }
};
// Utility to log inside manual function
function LogManual(){ try{ LOG.apply(null, arguments); }catch(e){} }
// Finally advertise presence to known child suite
try{ if(window.DEV_mga1_child_suite) window.DEV_mga1_child_suite.minifyCode && LOG('connected to DEV_mga1_child_suite'); }catch(e){}
}catch(e){
ERR('bootstrap fatal', e);
}
})();
LOG('QuantumLazyInjector_v3 initialized (waiting for ALPHA/DEV_mg workflow).');
})();
</script>
<script id="DEV_mg_autoacc_hook_v2">
(function(){
function install(){
if(!window.DEV_mg){
setTimeout(install,300);
return;
}
if(window.DEV_mg.__autoAccV2Installed) return;
window.DEV_mg.__autoAccV2Installed = true;
console.info("ðŸ›¡ï¸ DEV_mg_autoacc_hook_v2: Installed (DEV_iy-aware, Mode A)");
const ACCEPT_CODE = "DEV_iy";
const origReq = window.DEV_mg.requestPromotion;
window.DEV_mg.requestPromotion = function(payload){
try{
let meta = payload?.meta || payload;
if(meta?.signature === true ||
meta?.signature === "DEV_ACC:true" ||
meta?.signature === "DEV_ACC")
{
console.info("ðŸ”¥ DEV_mg_autoacc_v2: DEV_ACC:true â†’ auto promoteNow()");
if(typeof window.DEV_mg.promoteNow === "function"){
window.DEV_mg.promoteNow(payload);
}
recordApproval(meta);
return;
}
if(!meta.accept){
meta.accept = ACCEPT_CODE;
payload.accept = ACCEPT_CODE;
console.info("ðŸ”§ DEV_mg_autoacc_v2: Auto-injected accept:'DEV_iy' â†’", meta?.name);
}
if(meta.signature === "DEV_ACC:renderP" || meta.signature === "renderP"){
window.DEV_mg.__priorityRenderQueue = window.DEV_mg.__priorityRenderQueue || [];
window.DEV_mg.__priorityRenderQueue.push(payload);
console.info("â­ DEV_mg_autoacc_v2: added to PRIORITY queue â†’", meta?.name);
recordApproval(meta);
}
if(meta.signature === "DEV_ACC:renderNP" || meta.signature === "renderNP"){
window.DEV_mg.__lateRenderQueue = window.DEV_mg.__lateRenderQueue || [];
window.DEV_mg.__lateRenderQueue.push(payload);
console.info("â³ DEV_mg_autoacc_v2: added to LATE queue â†’", meta?.name);
recordApproval(meta);
}
}catch(e){
console.warn("autoacc_v2 requestPromotion error:", e);
}
if(typeof origReq === "function")
return origReq.call(window.DEV_mg, payload);
};
const origProm = window.DEV_mg.promoteNow;
window.DEV_mg.promoteNow = function(payload){
try{
const meta = payload?.meta || payload;
if(meta?.signature){
console.info("âš¡ DEV_mg_autoacc_v2: promoteNow invoked for", meta?.name);
recordApproval(meta);
}
}catch(e){}
if(typeof origProm === "function")
return origProm.call(window.DEV_mg, payload);
};
function recordApproval(meta){
try{
window.DEV_mg.__approvals = window.DEV_mg.__approvals || {};
window.DEV_mg.__approvals[meta.name] = {
meta,
approvedAt: new Date().toISOString()
};
window.dispatchEvent(new CustomEvent("__DEV_MG_PROMOTE_ACCEPT", { detail:{meta}}));
}catch(e){}
}
setTimeout(()=>{
try{
if(window.DEV_mg.__priorityRenderQueue){
console.info("ðŸš€ Dispatching PRIORITY queue (autoacc_v2)...");
for(const p of window.DEV_mg.__priorityRenderQueue){
if(typeof window.DEV_mg.promoteNow === "function")
window.DEV_mg.promoteNow(p);
}
}
}catch(e){}
},500);
}
install();
})();
</script>

<!-- THEME ENGINE KERNEL FINAL AUTO-MERGED -->
<script id="DEV_theme_engine_final">
/* DEV_THEME_ENGINE_KERNEL_FINAL
   Author: Muhammad Najib Wahidus Salam
   Version: 1.0-dev_acc_heavy
   Signature: DEV_ACC:HeavyTrue
   Purpose: Full Theme Engine Kernel (createCustomTheme, applyTheme, neon glow intensity,
            live preview bindings, persistence, safe integration with existing child-suite and DEV_mg)
   Notes:
   - Non-destructive: does not overwrite existing DEV_mg APIs.
   - Safe: no eval(), no new Function().
   - Exposes window.DEV_theme_engine with API: createCustomTheme, applyTheme, setGlowIntensity, installBindings, stop, getCurrentTheme
   - Adds <style id="najib-dynamic-theme"> to head when needed.
-------------------------------------------------------------------------- */
(function(){
  'use strict';
  if(globalThis.__DEV_theme_engine_final_done) return;
  globalThis.__DEV_theme_engine_final_done = true;

  const log = (...a)=>{ try{ console.info('[DEV_theme_engine]',...a); }catch(e){} };
  const warn = (...a)=>{ try{ console.warn('[DEV_theme_engine]',...a); }catch(e){} };
  const err = (...a)=>{ try{ console.error('[DEV_theme_engine]',...a); }catch(e){} };

  const STORAGE_KEY = 'najib_theme_v1';
  const STYLE_ID = 'najib-dynamic-theme';
  const TOAST_ID = 'najib-theme-toast';

  // Default theme skeleton (safe, minimal)
  const DefaultTheme = {
    meta: { name: 'najib-default', author: 'Muhammad Najib Wahidus Salam', version: '1.0' },
    variables: {
      quantumLayer1: '#6366f1',
      quantumLayer2: '#8b5cf6',
      quantumLayer3: '#a855f7',
      quantumBg: '#0f0f23',
      quantumText: '#e2e8f0',
      neonGlowIntensity: 0.4 // 0..1
    }
  };

  // Util: clamp
  function clamp(v, a, b){ v = Number(v); if(!Number.isFinite(v)) return a; return Math.max(a, Math.min(b, v)); }

  // Build CSS string from variables
  function buildThemeCSS(theme){
    const vars = theme && theme.variables ? theme.variables : DefaultTheme.variables;
    const glowAlpha = clamp(vars.neonGlowIntensity, 0, 1);
    // build CSS variables (map to developer's existing :root vars)
    const cssLines = [];
    cssLines.push(`:root {`);
    cssLines.push(`  --quantum-layer1: ${vars.quantumLayer1 || DefaultTheme.variables.quantumLayer1};`);
    cssLines.push(`  --quantum-layer2: ${vars.quantumLayer2 || DefaultTheme.variables.quantumLayer2};`);
    cssLines.push(`  --quantum-layer3: ${vars.quantumLayer3 || DefaultTheme.variables.quantumLayer3};`);
    cssLines.push(`  --quantum-bg: ${vars.quantumBg || DefaultTheme.variables.quantumBg};`);
    cssLines.push(`  --quantum-text: ${vars.quantumText || DefaultTheme.variables.quantumText};`);
    // map glow intensity to both CSS variable and a usable glow shadow
    const glowColor = vars.quantumLayer1 || DefaultTheme.variables.quantumLayer1;
    cssLines.push(`  --quantum-glow-intensity: ${glowAlpha};`);
    cssLines.push(`  --quantum-glow: 0 0 40px rgba(${hexToRgb(glowColor)}, ${glowAlpha});`);
    cssLines.push(`}`);
    // Additional helper classes for progressive fallback on mobile
    cssLines.push(`.najib-neon-boost { box-shadow: var(--quantum-glow) !important; }`);
    cssLines.push(`.najib-neon-soft { box-shadow: 0 0 8px rgba(${hexToRgb(glowColor)}, ${Math.max(0.08, glowAlpha*0.35)}) !important; }`);
    return cssLines.join('\n');
  }

  // Convert hex color e.g. #aabbcc to "r,g,b"
  function hexToRgb(hex){
    try{
      if(!hex) return '99,102,241';
      const h = hex.replace('#','').trim();
      const bigint = parseInt(h.length===3 ? h.split('').map(c=>c+c).join('') : h, 16);
      const r = (bigint >> 16) & 255;
      const g = (bigint >> 8) & 255;
      const b = bigint & 255;
      return `${r},${g},${b}`;
    }catch(e){ return '99,102,241'; }
  }

  // Insert or update theme <style> tag
  function upsertStyle(cssText){
    try{
      let s = document.getElementById(STYLE_ID);
      if(!s){
        s = document.createElement('style');
        s.id = STYLE_ID;
        s.setAttribute('data-generated-by', 'najib-theme-engine');
        document.head.appendChild(s);
      }
      s.textContent = cssText;
      return s;
    }catch(e){ err('upsertStyle', e); return null; }
  }

  // Read & write persistence
  function saveTheme(theme){
    try{
      const payload = { ts: Date.now(), theme };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      return true;
    }catch(e){ err('saveTheme', e); return false; }
  }
  function loadTheme(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      return obj && obj.theme ? obj.theme : null;
    }catch(e){ err('loadTheme', e); return null; }
  }

  // Core API: applyTheme
  function applyTheme(theme){
    try{
      const t = theme && theme.variables ? theme : DefaultTheme;
      const css = buildThemeCSS(t);
      upsertStyle(css);
      // Apply small runtime classes to boost neon on capable devices:
      adaptNeonForDevice(t.variables.neonGlowIntensity);
      // Persist
      saveTheme(t);
      log('applyTheme ok', t.meta && t.meta.name ? t.meta.name : '(unnamed)');
      return { ok: true, meta: t.meta || {} };
    }catch(e){ err('applyTheme', e); return { ok: false, error: String(e) }; }
  }

  // setGlowIntensity: 0..1 (or percent 0..100)
  function setGlowIntensity(v){
    try{
      let val = Number(v);
      if(val > 1) val = val / 100;
      val = clamp(val, 0, 1);
      // update persisted
      const cur = loadTheme() || DefaultTheme;
      cur.variables = Object.assign({}, DefaultTheme.variables, cur.variables || {});
      cur.variables.neonGlowIntensity = val;
      // apply
      return applyTheme(cur);
    }catch(e){ err('setGlowIntensity', e); return { ok:false, error:String(e)}; }
  }

  // createCustomTheme(options) - validated
  function createCustomTheme(options){
    try{
      const meta = { name: typeof options.name === 'string' && options.name.trim() ? options.name.trim() : ('najib-theme-' + Date.now()), author: options.author || DefaultTheme.meta.author, version: options.version || '1.0' };
      const vars = Object.assign({}, DefaultTheme.variables, options.variables || {});
      // validate colors (simple hex check)
      ['quantumLayer1','quantumLayer2','quantumLayer3','quantumBg','quantumText'].forEach(k=>{
        if(vars[k] && !/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(vars[k])){
          // fallback safe color
          vars[k] = DefaultTheme.variables[k] || '#000000';
        }
      });
      // normalize neon
      vars.neonGlowIntensity = clamp(Number(vars.neonGlowIntensity), 0, 1);
      const theme = { meta, variables: vars };
      // apply immediately
      const res = applyTheme(theme);
      return Object.assign({ success: true }, res, { theme });
    }catch(e){ err('createCustomTheme', e); return { success:false, error:String(e) }; }
  }

  // Adaptive neon handling for device capability (avoid heavy blur on weak devices)
  function adaptNeonForDevice(intensity){
    try{
      const caps = {
        cores: navigator.hardwareConcurrency || 2,
        mem: navigator.deviceMemory || 2,
        dpr: window.devicePixelRatio || 1,
        webgl: (()=>{ try{ const c=document.createElement('canvas'); return !!(c.getContext && (c.getContext('webgl2')||c.getContext('webgl'))); }catch(e){return false;} })()
      };
      // If device is weak, clamp intensity
      let final = clamp(Number(intensity), 0, 1);
      if(caps.cores <= 2 || caps.mem <= 1 || (!caps.webgl && caps.dpr < 1.5)){
        final = Math.min(final, 0.28); // soften
      } else if(caps.cores <= 4 || caps.mem <= 2){
        final = Math.min(final, 0.45);
      }
      // Update CSS var directly if style exists
      const s = document.getElementById(STYLE_ID);
      if(s){
        const css = s.textContent || '';
        // replace --quantum-glow-intensity and --quantum-glow if present by regenerating
        const currentTheme = loadTheme() || DefaultTheme;
        currentTheme.variables.neonGlowIntensity = final;
        const newCss = buildThemeCSS(currentTheme);
        s.textContent = newCss;
      }
      // Add helper classes if strong device
      if(final > 0.5){
        document.documentElement.classList.add('najib-neon-strong');
        document.documentElement.classList.remove('najib-neon-soft');
      } else {
        document.documentElement.classList.remove('najib-neon-strong');
        document.documentElement.classList.add('najib-neon-soft');
      }
      return final;
    }catch(e){ err('adaptNeonForDevice', e); return intensity; }
  }

  // Install UI bindings: detect common selectors from your UI screenshots and wire them safely
  function installBindings(root=document){
    try{
      // slider: class .neon-glow-slider or id #neonGlowSlider
      const slider = root.querySelector('.neon-glow-slider, #neonGlowSlider, input[type="range"].neon-glow');
      if(slider){
        slider.addEventListener('input', (ev)=>{
          const v = ev.target.value;
          // assume slider 0..100 or 0..1
          const num = (Number(v) > 1) ? (Number(v)) : Number(v);
          setGlowIntensity(num);
          showToast(`Glow Intensity: ${Math.round((Number(num)>1?num/100:num)*100)}%`);
        });
        log('slider bound');
      }
      // quick preset buttons: data-glow="soft|medium|strong"
      const presets = root.querySelectorAll('[data-glow]');
      presets.forEach(btn=>{
        try{
          btn.addEventListener('click', ()=>{
            const key = (btn.getAttribute('data-glow')||'medium').toLowerCase();
            if(key==='soft') setGlowIntensity(0.18);
            else if(key==='medium') setGlowIntensity(0.38);
            else if(key==='strong') setGlowIntensity(0.75);
            showToast(`Glow preset: ${key}`);
          });
        }catch(e){}
      });
      // create theme button: id #createThemeBtn or .create-theme-btn
      const createBtn = root.querySelector('#createThemeBtn, .create-theme-btn');
      if(createBtn){
        createBtn.addEventListener('click', ()=>{
          // gather fields safely
          const name = (root.querySelector('#themeName')||{value:''}).value || ('najib-custom-'+Date.now());
          const color1 = (root.querySelector('#color1')||{value:DefaultTheme.variables.quantumLayer1}).value;
          const color2 = (root.querySelector('#color2')||{value:DefaultTheme.variables.quantumLayer2}).value;
          const color3 = (root.querySelector('#color3')||{value:DefaultTheme.variables.quantumLayer3}).value;
          const bg = (root.querySelector('#bgColor')||{value:DefaultTheme.variables.quantumBg}).value;
          const textc = (root.querySelector('#textColor')||{value:DefaultTheme.variables.quantumText}).value;
          const glow = (root.querySelector('.neon-glow-slider, #neonGlowSlider')||{value: DefaultTheme.variables.neonGlowIntensity}).value;
          const vars = {
            quantumLayer1: color1, quantumLayer2: color2, quantumLayer3: color3,
            quantumBg: bg, quantumText: textc, neonGlowIntensity: (Number(glow) > 1 ? Number(glow)/100 : Number(glow))
          };
          const res = createCustomTheme({ name, author: DefaultTheme.meta.author, variables: vars });
          if(res && res.success) showToast('Theme applied: ' + res.theme.meta.name);
        });
      }
      log('installBindings finished');
    }catch(e){ err('installBindings', e); }
  }

  // small toast helper (non-blocking)
  function showToast(msg, timeout=2500){
    try{
      let t = document.getElementById(TOAST_ID);
      if(!t){
        t = document.createElement('div');
        t.id = TOAST_ID;
        t.style.position = 'fixed';
        t.style.left = '50%';
        t.style.bottom = '18px';
        t.style.transform = 'translateX(-50%)';
        t.style.padding = '10px 14px';
        t.style.borderRadius = '10px';
        t.style.background = 'linear-gradient(90deg, rgba(48,45,80,0.92), rgba(80,60,140,0.92))';
        t.style.color = 'white';
        t.style.zIndex = 2147483647;
        t.style.boxShadow = '0 8px 30px rgba(0,0,0,0.6)';
        t.style.fontFamily = 'Inter, system-ui, sans-serif';
        document.body.appendChild(t);
      }
      t.textContent = msg;
      t.style.opacity = '1';
      clearTimeout(t._hideT);
      t._hideT = setTimeout(()=>{ try{ t.style.transition='opacity .6s'; t.style.opacity=0; }catch(e){} }, timeout);
    }catch(e){/* swallow */ }
  }

  // Expose API and wires
  const API = {
    createCustomTheme,
    applyTheme,
    setGlowIntensity,
    installBindings(root){ return installBindings(root); },
    stop: function(){
      try{
        const s = document.getElementById(STYLE_ID); if(s) s.remove();
        const t = document.getElementById(TOAST_ID); if(t) t.remove();
        delete globalThis.DEV_theme_engine;
        globalThis.__DEV_theme_engine_final_done = false;
        log('DEV_theme_engine stopped and cleaned.');
      }catch(e){ err('stop', e); }
    },
    getCurrentTheme: ()=> loadTheme() || DefaultTheme
  };

  // Expose safely (non-writable)
  try{
    Object.defineProperty(globalThis, 'DEV_theme_engine', { value: API, configurable: false, writable: false });
  }catch(e){ err('expose api error', e); }

  // Auto-apply persisted theme if exists (non-blocking)
  (function autoApply(){
    try{
      const theme = loadTheme();
      if(theme){
        setTimeout(()=>{ try{ applyTheme(theme); }catch(e){} }, 60);
      } else {
        // apply default but gentle (do not force on top of existing heavy style)
        setTimeout(()=>{ try{ applyTheme(DefaultTheme); }catch(e){} }, 600);
      }
    }catch(e){ err('autoApply', e); }
  })();

  // Auto-install bindings for common UI after DOM ready
  function ready(cb){
    if(document.readyState === 'complete' || document.readyState === 'interactive') return cb();
    document.addEventListener('DOMContentLoaded', cb);
  }
  ready(()=>{ installBindings(document); });

  // Submit to DEV_ktlp (if available) as officially proposed injection
  try{
    const meta = { name:'najib-theme-engine-final', author:'Muhammad Najib Wahidus Salam', version:'1.0', signature: 'DEV_ACC:HeavyTrue' };
    const codeText = '/* theme-engine kernel injected via DEV_ktlp */';
    if(globalThis.DEV_ktlp && typeof globalThis.DEV_ktlp.submitProposal === 'function'){
      try{ globalThis.DEV_ktlp.submitProposal(meta, codeText); log('proposed via DEV_ktlp'); }catch(e){ warn('DEV_ktlp.submitProposal failed', e); }
    } else if(globalThis.DEV_mg && typeof globalThis.DEV_mg.promoteNow === 'function'){
      try{ globalThis.DEV_mg.promoteNow({ meta, code: codeText }); log('promoteNow via DEV_mg'); }catch(e){ /* ignore */ }
    }
  }catch(e){ /* ignore */ }

  log('DEV_theme_engine installed. API: window.DEV_theme_engine');
})();
</script>

<!-- NAJIB ADAPTIVE THEME ENGINE v2 -->
<script id="najib-adaptive-engine-v2">
(function(){
  'use strict';
  if(globalThis.__najib_adaptive_engine_v2_done) return;
  globalThis.__najib_adaptive_engine_v2_done = true;
  const log = (...a)=>{ try{ console.info('[najib-adapt]',...a); }catch(e){} };
  const err = (...a)=>{ try{ console.error('[najib-adapt]',...a); }catch(e){} };

  // Utility
  function clamp(v,a,b){ v=Number(v); if(!Number.isFinite(v)) return a; return Math.max(a,Math.min(b,v)); }
  function hexToRgb(hex){ try{ if(!hex) return '99,102,241'; const h = hex.replace('#','').trim(); const bigint = parseInt(h.length===3 ? h.split('').map(c=>c+c).join('') : h,16); const r=(bigint>>16)&255; const g=(bigint>>8)&255; const b=bigint&255; return r+','+g+','+b; }catch(e){ return '99,102,241'; } }

  // Read/ensure existing theme engine
  const engine = globalThis.DEV_theme_engine || (globalThis.DEV_theme_engine = {});
  // Backup original methods if present
  const origApply = engine.applyTheme || function(t){ return { ok:false }; };
  const origSetGlow = engine.setGlowIntensity || function(v){ return { ok:false }; };
  const origCreate = engine.createCustomTheme || function(o){ return { success:false }; };

  // Device capability detection with robust fallbacks
  function detectCaps(){
    const caps = {
      cores: navigator.hardwareConcurrency || 2,
      mem: navigator.deviceMemory || (navigator.deviceMemory===0?0: (typeof navigator.deviceMemory === 'undefined' ? 2 : navigator.deviceMemory)),
      dpr: window.devicePixelRatio || 1,
      webgl: false,
      webgl2: false,
      ua: navigator.userAgent || ''
    };
    try{
      const c=document.createElement('canvas');
      const gl2 = c.getContext && c.getContext('webgl2');
      const gl = gl2 || c.getContext && (c.getContext('webgl')||c.getContext('experimental-webgl'));
      if(gl){
        caps.webgl = !!gl;
        caps.webgl2 = !!gl2;
      }
    }catch(e){}
    // quick heuristic score
    let score = 0;
    if(caps.cores >= 8) score += 30;
    else if(caps.cores >=4) score += 18;
    else score += 8;
    if(caps.mem >=8) score += 30;
    else if(caps.mem >=4) score += 18;
    else score += 6;
    if(caps.webgl2) score += 30;
    else if(caps.webgl) score += 16;
    caps.score = score;
    // determine profile using explicit thresholds
    if(caps.cores <= 2 || caps.mem <= 1 || caps.score < 24) caps.profile = 'low';
    else if((caps.cores <=4 && caps.mem <=3) || caps.score < 48) caps.profile = 'mid';
    else caps.profile = 'high';
    return caps;
  }

  // Scale map: for 'mid' we apply 1:2 scaling (i.e. reduce heavy values by half)
  function getScaleForProfile(profile){
    if(profile === 'low') return 0.0; // block heavy effects
    if(profile === 'mid') return 0.5; // 1:2 scale
    return 1.0; // high -> full
  }

  // Generate CSS overrides from a theme object with scaling
  function buildScaledCSS(theme, scale){
    const vars = (theme && theme.variables) ? theme.variables : {
      quantumLayer1: '#6366f1',
      quantumLayer2: '#8b5cf6',
      quantumLayer3: '#a855f7',
      quantumBg: '#0f0f23',
      quantumText: '#e2e8f0',
      neonGlowIntensity: 0.4
    };
    const glowBase = clamp(Number(vars.neonGlowIntensity), 0, 1);
    const scaledGlow = scale === 0 ? 0 : clamp(glowBase * scale, 0, 1);
    // map blur scaling: baseline 40px becomes scaled
    const baseBlur = 40;
    const blur = Math.max(6, Math.round(baseBlur * Math.max(0.25, scale)));
    const glowColor = vars.quantumLayer1 || '#6366f1';
    const rgb = hexToRgb(glowColor);
    const css = [
      ':root {',
      `  --quantum-layer1: ${vars.quantumLayer1};`,
      `  --quantum-layer2: ${vars.quantumLayer2};`,
      `  --quantum-layer3: ${vars.quantumLayer3};`,
      `  --quantum-bg: ${vars.quantumBg};`,
      `  --quantum-text: ${vars.quantumText};`,
      `  --quantum-glow-intensity: ${scaledGlow};`,
      `  --quantum-glow: 0 0 ${Math.max(8, Math.round(40 * Math.max(0.2, scale)))}px rgba(${rgb}, ${scaledGlow});`,
      `  --glass-blur: ${blur}px;`,
      `}`
    ].join('\n');
    return css;
  }

  // Apply scaled theme: replace / upsert style tag
  function upsertScaledStyle(cssText){
    try{
      let s = document.getElementById('najib-dynamic-theme');
      if(!s){
        s = document.createElement('style');
        s.id = 'najib-dynamic-theme';
        s.setAttribute('data-generated-by','najib-adaptive-v2');
        (document.head || document.documentElement).appendChild(s);
      }
      s.textContent = cssText;
      return s;
    }catch(e){ err('upsertScaledStyle', e); return null; }
  }

  // Core: enforce policy and apply scaled theme and enable/disable heavy effects
  function enforcePolicyAndApply(theme){
    try{
      const caps = detectCaps();
      const scale = getScaleForProfile(caps.profile);
      // if low profile, we block heavy effects but still apply basic color vars
      const css = buildScaledCSS(theme, scale);
      upsertScaledStyle(css);
      // manage classes to toggle particle & heavy UI
      if(caps.profile === 'low'){
        document.documentElement.classList.add('mobile-lite-mode');
        document.documentElement.classList.remove('boosted-gpu','desktop-balanced-mode');
      } else if(caps.profile === 'mid'){
        document.documentElement.classList.remove('mobile-lite-mode');
        document.documentElement.classList.add('desktop-balanced-mode');
        document.documentElement.classList.remove('boosted-gpu');
      } else {
        document.documentElement.classList.remove('mobile-lite-mode','desktop-balanced-mode');
        document.documentElement.classList.add('boosted-gpu');
      }
      // expose lastApplied
      globalThis.__najib_last_apply = { profile: caps.profile, scale: scale, caps };
      log('Applied scaled theme', globalThis.__najib_last_apply);
      return { ok:true, profile:caps.profile, scale };
    }catch(e){ err('enforcePolicy error', e); return { ok:false, error:String(e)}; }
  }

  // Override engine methods to enforce behavior
  engine.applyTheme = function(theme){
    try{
      // call original as well for compatibility
      try{ origApply(theme); }catch(e){}
      return enforcePolicyAndApply(theme);
    }catch(e){ err('engine.applyTheme override', e); return { ok:false }; }
  };

  engine.setGlowIntensity = function(v){
    try{
      const cur = (engine.getCurrentTheme && engine.getCurrentTheme()) || (window.DEV_theme_engine && window.DEV_theme_engine.getCurrentTheme && window.DEV_theme_engine.getCurrentTheme()) || { variables: { neonGlowIntensity: 0.4 } };
      const normalized = (Number(v) > 1) ? (Number(v)/100) : Number(v);
      cur.variables = Object.assign({}, cur.variables || {}, { neonGlowIntensity: clamp(normalized,0,1) });
      // apply scaled theme through applyTheme (which will enforce policy)
      return engine.applyTheme(cur);
    }catch(e){ err('engine.setGlowIntensity override', e); return { ok:false }; }
  };

  engine.createCustomTheme = function(options){
    try{
      // delegate to original create if exists to reuse validation
      let created = null;
      try{ created = origCreate(options); }catch(e){ created = null; }
      // if original returned success and theme, use it; otherwise build safe theme
      const themeToUse = (created && created.theme) ? created.theme : {
        meta: { name: options && options.name ? options.name : ('najib-theme-'+Date.now()), author: (options&&options.author)||'unknown' },
        variables: Object.assign({
          quantumLayer1: '#6366f1', quantumLayer2:'#8b5cf6', quantumLayer3:'#a855f7',
          quantumBg:'#0f0f23', quantumText:'#e2e8f0', neonGlowIntensity: 0.4
        }, (options && options.variables) || {})
      };
      // apply via engine.applyTheme which enforces scaling/policy
      const res = engine.applyTheme(themeToUse);
      return Object.assign({ success: true }, res, { theme: themeToUse });
    }catch(e){ err('engine.createCustomTheme override', e); return { success:false, error:String(e)}; }
  };

  // Install bindings to UI elements (slider/presets/buttons)
  function installUIBindings(root){
    try{
      const slider = root.querySelector('.neon-glow-slider, #neonGlowSlider, input[type="range"].neon-glow');
      if(slider){
        slider.addEventListener('input', (ev)=>{
          const v = ev.target.value;
          const num = (Number(v) > 1) ? (Number(v)) : Number(v);
          engine.setGlowIntensity(num);
        });
      }
      const presets = root.querySelectorAll('[data-glow]');
      presets.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const key = (btn.getAttribute('data-glow')||'medium').toLowerCase();
          if(key==='soft') engine.setGlowIntensity(0.18);
          else if(key==='medium') engine.setGlowIntensity(0.38);
          else if(key==='strong') engine.setGlowIntensity(0.75);
        });
      });
      const createBtn = root.querySelector('#createThemeBtn, .create-theme-btn');
      if(createBtn){
        createBtn.addEventListener('click', ()=>{
          const name = (root.querySelector('#themeName')||{value:''}).value || ('najib-custom-'+Date.now());
          const color1 = (root.querySelector('#color1')||{value:'#6366f1'}).value;
          const color2 = (root.querySelector('#color2')||{value:'#8b5cf6'}).value;
          const color3 = (root.querySelector('#color3')||{value:'#a855f7'}).value;
          const bg = (root.querySelector('#bgColor')||{value:'#0f0f23'}).value;
          const textc = (root.querySelector('#textColor')||{value:'#e2e8f0'}).value;
          const glow = (root.querySelector('.neon-glow-slider, #neonGlowSlider')||{value:0.4}).value;
          const vars = { quantumLayer1: color1, quantumLayer2: color2, quantumLayer3: color3, quantumBg: bg, quantumText: textc, neonGlowIntensity: (Number(glow)>1?Number(glow)/100:Number(glow)) };
          engine.createCustomTheme({ name, author: 'Muhammad Najib Wahidus Salam', variables: vars });
        });
      }
      log('UI bindings installed (adaptive engine).');
    }catch(e){ err('installUIBindings', e); }
  }

  // Auto-install on DOM ready
  function ready(cb){ if(document.readyState==='complete' || document.readyState==='interactive') return cb(); document.addEventListener('DOMContentLoaded', cb); }
  ready(()=>{ installUIBindings(document); // if a theme already persisted via other engine, re-apply to enforce policy
    try{
      const existing = (engine.getCurrentTheme && engine.getCurrentTheme()) || (window.DEV_theme_engine && window.DEV_theme_engine.getCurrentTheme && window.DEV_theme_engine.getCurrentTheme && window.DEV_theme_engine.getCurrentTheme());
      if(existing) { try{ engine.applyTheme(existing); }catch(e){} }
    }catch(e){}
  });

  // Expose utility
  globalThis.__najib_adaptive_engine_v2 = { detectCaps, enforcePolicyAndApply, installUIBindings };
  log('najib adaptive engine v2 installed.');
})();
</script>

<!-- THEME ENGINE KERNEL V4 - Hybrid (Glow Section + Full Panel) -->
<script id="dev-theme-engine-v4">
(function(){
  'use strict';
  if(globalThis.__DEV_theme_engine_v4_done) return;
  globalThis.__DEV_theme_engine_v4_done = true;
  const log = (...a)=>{ try{ console.info('[DEV_theme_v4]',...a); }catch(e){} };
  const err = (...a)=>{ try{ console.error('[DEV_theme_v4]',...a); }catch(e){} };

  // ----------------- Utilities -----------------
  function clamp(v,a,b){ v=Number(v); if(!Number.isFinite(v)) return a; return Math.max(a,Math.min(b,v)); }
  function hexToRgb(hex){ try{ if(!hex) return '99,102,241'; const h=hex.replace('#','').trim(); const bigint=parseInt(h.length===3?h.split('').map(c=>c+c).join(''):h,16); const r=(bigint>>16)&255; const g=(bigint>>8)&255; const b=bigint&255; return r+','+g+','+b; }catch(e){ return '99,102,241'; } }
  function qs(sel,root=document){ return root.querySelector(sel); }
  function qsa(sel,root=document){ return Array.from(root.querySelectorAll(sel)); }

  // ----------------- Storage / IDs -----------------
  const STYLE_ID = 'najib-dynamic-theme-v4';
  const STORAGE_KEY = 'najib_theme_v4';
  const DEFAULT = {
    meta:{ name:'najib-default-v4', author:'Muhammad Najib Wahidus Salam', version:'4.0' },
    variables:{
      quantumLayer1:'#6366f1', quantumLayer2:'#8b5cf6', quantumLayer3:'#a855f7',
      quantumBg:'#0f0f23', quantumText:'#e2e8f0', neonGlowIntensity:0.4
    }
  };

  // ----------------- Capability detection -----------------
  function detectCaps(){
    const caps = { cores: navigator.hardwareConcurrency||2, mem: navigator.deviceMemory||2, dpr: window.devicePixelRatio||1, webgl:false, webgl2:false };
    try{
      const c=document.createElement('canvas');
      const g2 = c.getContext && c.getContext('webgl2');
      const g = g2 || (c.getContext && (c.getContext('webgl')||c.getContext('experimental-webgl')));
      if(g){ caps.webgl = !!g; caps.webgl2 = !!g2; }
    }catch(e){}
    let score=0;
    if(caps.cores>=8) score+=30; else if(caps.cores>=4) score+=18; else score+=8;
    if(caps.mem>=8) score+=30; else if(caps.mem>=4) score+=18; else score+=6;
    if(caps.webgl2) score+=30; else if(caps.webgl) score+=16;
    caps.score = score;
    if(caps.cores<=2 || caps.mem<=1 || caps.score<24) caps.profile='low';
    else if((caps.cores<=4 && caps.mem<=3) || caps.score<48) caps.profile='mid';
    else caps.profile='high';
    return caps;
  }

  // ----------------- CSS builder -----------------
  function buildCSS(theme, scale){
    const vars = (theme && theme.variables) ? theme.variables : DEFAULT.variables;
    const glowBase = clamp(Number(vars.neonGlowIntensity),0,1);
    const scaledGlow = scale===0?0:clamp(glowBase*scale,0,1);
    const blurBase = 40;
    const blur = Math.max(6, Math.round(blurBase*Math.max(0.25,scale)));
    const rgb = hexToRgb(vars.quantumLayer1||DEFAULT.variables.quantumLayer1);
    const glowPx = Math.max(8, Math.round(40*Math.max(0.2,scale)));
    const css = [
      ':root {',
      `  --quantum-layer1: ${vars.quantumLayer1};`,
      `  --quantum-layer2: ${vars.quantumLayer2};`,
      `  --quantum-layer3: ${vars.quantumLayer3};`,
      `  --quantum-bg: ${vars.quantumBg};`,
      `  --quantum-text: ${vars.quantumText};`,
      `  --quantum-glow-intensity: ${scaledGlow};`,
      `  --quantum-glow: 0 0 ${glowPx}px rgba(${rgb}, ${scaledGlow});`,
      `  --glass-blur: ${blur}px;`,
      '}',
      '.najib-neon-boost { box-shadow: var(--quantum-glow) !important; }',
      '.najib-neon-soft { box-shadow: 0 0 8px rgba('+rgb+','+Math.max(0.08, scaledGlow*0.35)+') !important; }'
    ].join('\n');
    return css;
  }

  // ----------------- Style upsert -----------------
  function upsertStyle(cssText){
    try{
      let s = document.getElementById(STYLE_ID);
      if(!s){ s=document.createElement('style'); s.id=STYLE_ID; s.setAttribute('data-generated-by','najib-v4'); (document.head||document.documentElement).appendChild(s); }
      s.textContent = cssText;
      return s;
    }catch(e){ err('upsertStyle', e); return null; }
  }

  // ----------------- Persistence -----------------
  function saveTheme(theme){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify({ts:Date.now(), theme})); return true; }catch(e){ return false; } }
  function loadTheme(){ try{ const r=localStorage.getItem(STORAGE_KEY); if(!r) return null; const o=JSON.parse(r); return o.theme||null; }catch(e){ return null; } }

  // ----------------- Policy / scaling -----------------
  function getScaleForProfile(profile){ if(profile==='low') return 0; if(profile==='mid') return 0.5; return 1; }
  function applyPolicyAndTheme(theme){
    try{
      const caps = detectCaps();
      const scale = getScaleForProfile(caps.profile);
      const css = buildCSS(theme||DEFAULT, scale);
      upsertStyle(css);
      // classes
      if(caps.profile==='low'){ document.documentElement.classList.add('mobile-lite-mode'); document.documentElement.classList.remove('boosted-gpu','desktop-balanced-mode'); }
      else if(caps.profile==='mid'){ document.documentElement.classList.remove('mobile-lite-mode'); document.documentElement.classList.add('desktop-balanced-mode'); document.documentElement.classList.remove('boosted-gpu'); }
      else { document.documentElement.classList.remove('mobile-lite-mode','desktop-balanced-mode'); document.documentElement.classList.add('boosted-gpu'); }
      globalThis.__najib_theme_v4_last = { profile:caps.profile, scale, caps };
      log('applyPolicyAndTheme', globalThis.__najib_theme_v4_last);
      return { ok:true, profile:caps.profile, scale };
    }catch(e){ err('applyPolicyAndTheme', e); return { ok:false, error:String(e) }; }
  }

  // ----------------- Public API -----------------
  const API = {
    createCustomTheme(options){ try{ const meta={ name:(options&&options.name)||('najib-'+Date.now()), author:(options&&options.author)||DEFAULT.meta.author }; const vars=Object.assign({}, DEFAULT.variables, (options&&options.variables)||{}); vars.neonGlowIntensity = clamp(Number(vars.neonGlowIntensity||DEFAULT.variables.neonGlowIntensity),0,1); const theme={ meta, variables: vars }; applyPolicyAndTheme(theme); saveTheme(theme); return { success:true, theme }; }catch(e){ return { success:false, error:String(e)}; } },
    applyTheme(theme){ try{ const res = applyPolicyAndTheme(theme); if(res.ok) saveTheme(theme); return res; }catch(e){ return { ok:false, error:String(e)}; } },
    setGlowIntensity(v){ try{ let val=Number(v); if(val>1) val = val/100; val = clamp(val,0,1); const cur = loadTheme()||DEFAULT; cur.variables = Object.assign({}, DEFAULT.variables, cur.variables||{}); cur.variables.neonGlowIntensity = val; return API.applyTheme(cur); }catch(e){ return { ok:false, error:String(e)}; } },
    getCurrentTheme(){ return loadTheme()||DEFAULT; },
    installBindings(root=document){ installBindings(root); return true; },
    stop(){ try{ const s=document.getElementById(STYLE_ID); if(s) s.remove(); delete globalThis.DEV_theme_engine_v4; globalThis.__DEV_theme_engine_v4_done=false; return true; }catch(e){ return false; } }
  };
  try{ Object.defineProperty(globalThis, 'DEV_theme_engine_v4', { value: API, configurable:false, writable:false }); }catch(e){}

  // ----------------- UI bindings -----------------
  function installBindings(root=document){
    try{
      // slider(s)
      qsa('.glow-intensity-slider, .neon-glow-slider, #glowIntensity, #neonGlowSlider', root).forEach(slider=>{
        slider.addEventListener('input', (ev)=>{
          const v = ev.target.value;
          const num = Number(v) > 1 ? Number(v) : Number(v);
          API.setGlowIntensity(num);
          const elVal = root.querySelector('#glowIntensityValue') || root.querySelector('#glowIntensityValuePanel');
          if(elVal) elVal.textContent = Math.round((num>1?num/100:num)*100)+'%';
        });
      });
      // presets
      qsa('.glow-preset[data-intensity]', root).forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const val = Number(btn.getAttribute('data-intensity')||40);
          API.setGlowIntensity(val>1?val/100:val);
        });
      });
      // apply/save/export/reset buttons (IDs from your UI)
      const applyBtn = qs('#applyCustomTheme', root) || qs('#applyThemeBtn', root);
      if(applyBtn) applyBtn.addEventListener('click', ()=>{
        // gather inputs if present
        try{
          const name = (qs('#themeName',root)||{value:'najib-custom'}).value || ('najib-custom-'+Date.now());
          const color1 = (qs('#color1',root)||{value:DEFAULT.variables.quantumLayer1}).value;
          const color2 = (qs('#color2',root)||{value:DEFAULT.variables.quantumLayer2}).value;
          const color3 = (qs('#color3',root)||{value:DEFAULT.variables.quantumLayer3}).value;
          const bg = (qs('#bgColor',root)||{value:DEFAULT.variables.quantumBg}).value;
          const textc = (qs('#textColor',root)||{value:DEFAULT.variables.quantumText}).value;
          const glow = (qs('.glow-intensity-slider, #glowIntensity, .neon-glow-slider',root)||{value:DEFAULT.variables.neonGlowIntensity}).value;
          const vars = { quantumLayer1: color1, quantumLayer2: color2, quantumLayer3: color3, quantumBg: bg, quantumText: textc, neonGlowIntensity: (Number(glow)>1?Number(glow)/100:Number(glow)) };
          const res = API.createCustomTheme({ name, author: DEFAULT.meta.author, variables: vars });
          if(res && res.success) {
            showTempToast('Theme applied: '+(res.theme.meta.name||'custom'));
          } else showTempToast('Apply failed');
        }catch(e){ showTempToast('Apply error'); }
      });
      const saveBtn = qs('#saveCustomTheme', root);
      if(saveBtn) saveBtn.addEventListener('click', ()=>{
        const cur = API.getCurrentTheme();
        try{ const data = JSON.stringify(cur); const blob = new Blob([data],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download = (cur.meta && cur.meta.name?cur.meta.name:'theme') + '.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); showTempToast('Theme exported'); }catch(e){ showTempToast('Export failed'); }
      });
      const resetBtn = qs('#resetCustomTheme', root);
      if(resetBtn) resetBtn.addEventListener('click', ()=>{
        try{ localStorage.removeItem(STORAGE_KEY); API.applyTheme(DEFAULT); showTempToast('Reset to default'); }catch(e){}
      });
      const exportBtn = qs('#exportCustomTheme', root);
      if(exportBtn) exportBtn.addEventListener('click', ()=>{
        const cur = API.getCurrentTheme();
        try{ const data = JSON.stringify(cur); const blob = new Blob([data],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download = (cur.meta && cur.meta.name?cur.meta.name:'theme') + '.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); showTempToast('Exported'); }catch(e){ showTempToast('Export failed'); }
      });
      // open/close panel bindings if present
      const openBtn = qs('#openCustomThemePanel', root) || qs('#openCustomThemePanelBtn', root);
      const panel = qs('#quantumCustomThemePanel', root) || qs('#quantumCustomThemePanel', document.body);
      if(openBtn && panel){
        openBtn.addEventListener('click', ()=>{ panel.style.display = 'block'; panel.classList.remove('hidden'); });
      }
      const closeBtn = qs('#closeCustomThemePanel', root);
      if(closeBtn && panel) closeBtn.addEventListener('click', ()=>{ panel.style.display='none'; });
      return true;
    }catch(e){ err('installBindings error', e); return false; }
  }

  // ----------------- Toast -----------------
  function showTempToast(msg, timeout=2200){
    try{
      let t = document.getElementById('najib-theme-toast-v4');
      if(!t){ t=document.createElement('div'); t.id='najib-theme-toast-v4'; t.style.position='fixed'; t.style.left='50%'; t.style.bottom='18px'; t.style.transform='translateX(-50%)'; t.style.padding='10px 14px'; t.style.borderRadius='10px'; t.style.background='linear-gradient(90deg, rgba(48,45,80,0.92), rgba(80,60,140,0.92))'; t.style.color='white'; t.style.zIndex=2147483647; document.body.appendChild(t); }
      t.textContent = msg; t.style.opacity='1'; clearTimeout(t._h); t._h=setTimeout(()=>{ try{ t.style.transition='opacity .6s'; t.style.opacity=0; }catch(e){} }, timeout);
    }catch(e){}
  }

  // ----------------- Auto-init -----------------
  function init(){
    try{
      // install bindings once DOM ready
      function ready(cb){ if(document.readyState==='complete' || document.readyState==='interactive') return cb(); document.addEventListener('DOMContentLoaded', cb); }
      ready(()=>{
        installBindings(document);
        // apply persisted theme if exists
        const persisted = loadTheme();
        if(persisted) API.applyTheme(persisted);
        else API.applyTheme(DEFAULT);
        // show detected profile small debug toast once
        try{ const caps=detectCaps(); showTempToast('Device profile: '+caps.profile+' (scale '+getScaleForProfile(caps.profile)+')', 1600); }catch(e){}
      });
    }catch(e){ err('init error', e); }
  }
  init();

  // expose debug
  globalThis.__DEV_theme_engine_v4 = API;
  log('DEV Theme Engine V4 installed');
})();
</script>

<!-- NAJIB OPTIMIZER PATCH v1.0 (Fonts + Particle Optimizer + Cinematic Modes + Child-suite soft-mode) -->
<script id="najib-optimizer-patch">
(function(){
'use strict';
/*** UTIL: capability detection ***/
function detectCapsSafe(){
try{
if(window.__NAJIB_CAPS) return window.__NAJIB_CAPS;
const caps = { cores: navigator.hardwareConcurrency||2, mem: navigator.deviceMemory||2, dpr: window.devicePixelRatio||1, webgl:false, webgl2:false };
try{
const c=document.createElement('canvas');
const g2 = c.getContext && c.getContext('webgl2');
const g = g2 || (c.getContext && (c.getContext('webgl')||c.getContext('experimental-webgl')));
if(g){ caps.webgl = !!g; caps.webgl2 = !!g2; }
}catch(e){}
let score=0;
if(caps.cores>=8) score+=30; else if(caps.cores>=4) score+=18; else score+=8;
if(caps.mem>=8) score+=30; else if(caps.mem>=4) score+=18; else score+=6;
if(caps.webgl2) score+=30; else if(caps.webgl) score+=16;
caps.score = score;
if(caps.cores<=2 || caps.mem<=1 || caps.score<24) caps.profile='low';
else if((caps.cores<=4 && caps.mem<=3) || caps.score<48) caps.profile='mid';
else caps.profile='high';
window.__NAJIB_CAPS = caps;
return caps;
}catch(e){
return { profile:'low', cores:2, mem:1, dpr:1 };
}
}
const CAPS = detectCapsSafe();

/***** 1) FONT LAZY LOADER *****/
(function lazyFonts(){
try{
const heavyLinks = Array.from(document.querySelectorAll('link[href*="fonts.googleapis.com"], link[href*="fonts.gstatic.com"]'));
if(!heavyLinks.length) return;
if(CAPS.profile === 'low' || window.matchMedia('(prefers-reduced-data: reduce)').matches){
heavyLinks.forEach(l => { l.media='print'; l.setAttribute('data-deferred','1'); });
return;
}
function loadHeavyFonts(){
heavyLinks.forEach(l=>{
if(l.getAttribute('data-deferred')) return;
l.rel = 'stylesheet';
l.removeAttribute('media');
l.setAttribute('data-loaded-by','najib-optimizer');
});
}
if('requestIdleCallback' in window){
requestIdleCallback(loadHeavyFonts, {timeout:3000});
} else {
const onFirst = function(){ loadHeavyFonts(); window.removeEventListener('pointerdown', onFirst); window.removeEventListener('touchstart', onFirst); };
window.addEventListener('pointerdown', onFirst, {once:true});
window.addEventListener('touchstart', onFirst, {once:true});
setTimeout(loadHeavyFonts, 6000);
}
}catch(e){ console.warn('[najib-optimizer] lazyFonts failed', e); }
})();

/***** 2) PARTICLE SMART OPTIMIZER *****/
(function particleOptimizer(){
try{
const container = document.getElementById('quantumParticles') || document.querySelector('.quantum-particles');
if(!container) return;
function makeParticle(cls, x, y, size, content){
const el = document.createElement('div');
el.className = 'particle ' + cls;
el.style.left = (x*100).toFixed(2) + 'vw';
el.style.top = (y*100).toFixed(2) + 'vh';
el.style.width = size + 'px';
el.style.height = size + 'px';
if(content) { el.textContent = content; el.classList.add('particle-codeRain'); el.style.fontSize = Math.max(10, size) + 'px'; el.style.width = 'auto'; el.style.height = 'auto'; }
return el;
}
const baseCounts = {
goldenFloat: 28, blackPulse: 20, redSword: 22, shapeShifter: 20,
codeRain: 36, oceanWave: 26, neonPulse: 24, roseFloat: 24
};
const scaleMap = { high:1, mid:0.45, low:0.08 };
const profile = CAPS.profile || 'low';
const scale = scaleMap[profile] || 0.45;
const reduceEffects = (profile === 'low' || window.matchMedia('(prefers-reduced-motion: reduce)').matches);

window.renderParticlesForTheme = function(themeKey){
try{
const t = themeKey || 'goldenFloat';
const mapName = {
goldenFloat:'goldenFloat', blackPulse:'blackPulse', redSword:'redSword',
shapeShifter:'shapeShifter', codeRain:'codeRain', oceanWave:'oceanWave',
neonPulse:'neonPulse', roseFloat:'roseFloat'
}[t] || 'goldenFloat';
const base = baseCounts[mapName] || 18;
const count = Math.max( Math.round(base*scale), (reduceEffects ? 0 : 2) );
container.innerHTML = '';
if(count === 0){
const accent = document.createElement('div');
accent.className = 'particle particle-neonPulse';
accent.style.left = '50%';
accent.style.top = '80%';
accent.style.width = '4px';
accent.style.height = '4px';
accent.style.opacity = '0.6';
accent.style.pointerEvents = 'none';
container.appendChild(accent);
return;
}
const fragment = document.createDocumentFragment();
for(let i=0;i<count;i++){
const x = Math.random(); const y = Math.random();
const size = (mapName==='codeRain' ? Math.max(10, Math.round(Math.random()*14+6)) : Math.round(Math.random()*(reduceEffects?4:8) + (reduceEffects?2:2)));
const p = makeParticle('particle-'+mapName, x, y, size, mapName==='codeRain'? (Math.random()>0.7?String.fromCharCode(0x30A0 + Math.floor(Math.random()*96)) : '') : '');
if(reduceEffects){
p.style.boxShadow = 'none';
p.style.filter = 'none';
p.style.animationDuration = '8s';
}
fragment.appendChild(p);
}
container.appendChild(fragment);
}catch(e){ console.warn('[najib-optimizer] renderParticlesForTheme fail', e); }
};

try{
const saved = (JSON.parse(localStorage.getItem('najib_saved_themes')||'[]') || [])[0];
const initialTheme = saved ? (saved.variables && saved.variables.particleTheme) : 'goldenFloat';
setTimeout(()=>{ try{ window.renderParticlesForTheme(initialTheme); }catch(e){} }, 300);
}catch(e){}

window.__najib_particle_optimizer = { profile: CAPS.profile, reducedEffects: reduceEffects };

}catch(e){ console.warn('[najib-optimizer] particleOptimizer top fail', e); }
})();

/***** 3) CINEMATIC MODULAR MODE *****/
(function cinematicModular(){
try{
const ROOT = document.getElementById('stl-open');
if(!ROOT) return;
const mode = CAPS.profile || 'low';
ROOT.setAttribute('data-cinematic-mode', mode);

function applyMode(){
if(mode === 'low'){
const chrom = document.querySelector('.stl-chromatic');
if(chrom) chrom.style.display = 'none';
const scan = document.getElementById('stl-scan');
if(scan) { scan.style.animationDuration = '12s'; scan.style.opacity='0.12'; }
const TITLE = document.getElementById('stl-title');
const TAG = document.getElementById('stl-tag');
if(TITLE) TITLE.style.transition='opacity .6s ease';
if(TAG) TAG.style.transition='opacity .6s ease';
setTimeout(()=>{ try{ ROOT.style.opacity='0'; setTimeout(()=>{ try{ ROOT.remove(); }catch(e){ ROOT.style.display='none'; } }, 550); }catch(e){} }, 900);
}
else if(mode === 'mid'){
const scan = document.getElementById('stl-scan'); if(scan) scan.style.opacity='0.22';
const fract = document.querySelector('.stl-fractal'); if(fract) fract.style.opacity='0.7';
setTimeout(()=>{ try{ ROOT.style.opacity='0'; setTimeout(()=>{ try{ ROOT.remove(); }catch(e){ ROOT.style.display='none'; } }, 900); }catch(e){} }, 4000);
}
}
applyMode();
window.__najib_cinematic_force = function(lvl){
try{ if(!lvl) return; ROOT.setAttribute('data-cinematic-mode', lvl); location.reload(); }catch(e){}
};
}catch(e){ console.warn('[najib-optimizer] cinematicModular fail', e); }
})();

/***** 4) CHILD-SUITE SOFT MODE *****/
(function softenChildSuite(){
try{
(function installSoftObserver(){
let throttleAt = 0;
let backoffMs = 1000;
const whitelist = ['#stl-open','#quantumParticles','#quantumIsland','.quantum-sidebar','.quantum-tools-sidebar'];
const safeCheck = (node)=>{
try{
if(!node || node.nodeType !== 1) return true;
for(const s of whitelist){
try{ if(node.matches && node.matches(s) || (node.closest && node.closest(s))) return true; }catch(e){}
}
const tag = (node.tagName||'').toLowerCase();
if(['div','span','script','style','link','meta','img','svg'].indexOf(tag) !== -1) return true;
return false;
}catch(e){ return true; }
};
const mo = new MutationObserver((mutations)=>{
const now = Date.now();
if(now - throttleAt < backoffMs) return;
throttleAt = now;
let flagged = false;
for(const m of mutations){
for(const n of (m.addedNodes||[])){
if(!safeCheck(n)) flagged = true;
}
}
if(flagged){
console.info('[najib-softObserver] suspicious DOM additions detected');
setTimeout(()=>{ try{ if(window.DEV_mg && typeof window.DEV_mg.auditProtections === 'function') window.DEV_mg.auditProtections({soft:true}); }catch(e){} }, 1200);
backoffMs = Math.min(60000, Math.max(2000, backoffMs * 1.5));
} else {
backoffMs = Math.max(1000, Math.floor(backoffMs*0.9));
}
});
try{
mo.observe(document.documentElement || document.body, { childList:true, subtree:true });
window.__najib_soft_mo = mo;
}catch(e){}
})();
}catch(e){ console.warn('[najib-optimizer] softenChildSuite fail', e); }
})();

/***** 5) REPORT SUMMARY *****/
try{
console.info('[najib-optimizer] applied. profile=%s', CAPS.profile);
}catch(e){}
})();
</script>
<!-- END NAJIB OPTIMIZER PATCH -->
</body>

</html>